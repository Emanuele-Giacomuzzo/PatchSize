---
title: "Data manipulation of body size data"
author: "Emanuele Giacomuzzo"
date: "2022-08-07"
output: html_document
editor_options: 
  chunk_output_type: console
---

### Individuals (ds_individuals)

In this dataset (`ds_individuals`) each row represents an individual at a time point.

```{r}

# --- IMPORT T0 --- #

# Import the individual data of t0. We considered cultures to be all the same at 
# the beginning (t0). Because of this reason, we filmed only the bottles from
# which cultures were assembled. Because we want to plot also t0 for the 
# different treatments, we want to assign the video of bottles to all cultures 
# at t0.

ds_individuals_t0_not_elongated = read.csv(here("..",
                                                "1_data", 
                                                "individuals_13_threshold", 
                                                "t0.csv")) %>%
  mutate(time_point =  as.numeric(str_extract(time_point, "\\d+")),
         day = 0,
         file =  as.numeric(str_extract(file, "\\d+")),
         video_replicate = file) %>%
  select(time_point,
         day,
         video_replicate,
         file,
         id,
         N_frames,
         mean_area)

# Elongate t0

ds_individuals_t0_elongated = ds_individuals_t0_not_elongated %>%
  map_dfr(.x = 1 : nrow(ecosystems_info),
          .f = ~ ds_individuals_t0_not_elongated) %>% 
  arrange(id) %>% #Id refers to an individual
  mutate(ecosystem_ID = rep(1 : nrow(ecosystems_info),
                          times = nrow(ds_individuals_t0_not_elongated))) %>%
  select(time_point,
         day,
         video_replicate,
         file,
         ecosystem_ID,
         id,
         N_frames,
         mean_area)

expect_equal(nrow(ds_individuals_t0_not_elongated) * nrow(ecosystems_info),
             nrow(ds_individuals_t0_elongated))
```

```{r}

# --- IMPORT ALL TIME POINTS BUT T0 --- #

# Set up parameters

ds_individuals_t1_to_t7 = list()

# Import all time points but t0

for (time_point_i in time_points_without_t0) {
  
  ds_individuals_t1_to_t7[[time_point_i]] = read.csv(here("..",
                                                          "1_data", 
                                                          "individuals_13_threshold", 
                                                          paste0("t", 
                                                                 time_point_i, 
                                                                 ".csv"))) %>%
    rename(ecosystem_ID = culture_ID) %>%
    mutate(time_point =  as.numeric(str_extract(time_point, "\\d+")),
           day = time_point_day$day[time_point_day$time_point == time_point_i],
           file =  as.numeric(str_extract(file, "\\d+")),
           video_replicate = ceiling(file/n_cultures)) # Until 110 video replicate = 1, then 2
}

# Tidy up all time points but t0

ds_individuals_t1_to_t7 = ds_individuals_t1_to_t7 %>%
  bind_rows() %>%
  select(time_point,
         day,
         video_replicate,
         file,
         ecosystem_ID,
         id,
         N_frames,
         mean_area)
```

```{r}

# --- CREATE DS_INDIVIDUALS --- #

# Bind t0 with other time points and ecosystem information

ds_individuals = rbind(ds_individuals_t0_elongated,
                       ds_individuals_t1_to_t7) %>%
  left_join(ecosystems_info,
            by = "ecosystem_ID") %>%
  rename(body_area_µm2 = mean_area) %>%
  
  # Take off problematic videos & ecosystems
  
  filter(!(time_point %in% videos_to_take_off$time_point & file %in% videos_to_take_off$file),
         !ecosystem_ID %in% ecosystems_to_take_off) %>%
  
  select(disturbance,
         time_point,
         day,
         video_replicate,
         ecosystem_ID,
         system_nr,
         file,
         ecosystem_size,
         ecosystem_size_ml,
         metaecosystem,
         metaecosystem_type,
         body_area_µm2,
         N_frames)
```
