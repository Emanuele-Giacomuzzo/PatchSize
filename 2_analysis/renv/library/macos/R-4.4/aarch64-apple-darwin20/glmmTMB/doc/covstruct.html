<!DOCTYPE html>

<html>

<head>

<meta charset="utf-8" />
<meta name="generator" content="pandoc" />
<meta http-equiv="X-UA-Compatible" content="IE=EDGE" />

<meta name="viewport" content="width=device-width, initial-scale=1" />

<meta name="author" content="Kasper Kristensen and Maeve McGillycuddy" />

<meta name="date" content="2024-09-26" />

<title>Covariance structures with glmmTMB</title>


<style type="text/css">
  code{white-space: pre-wrap;}
  span.smallcaps{font-variant: small-caps;}
  span.underline{text-decoration: underline;}
  div.column{display: inline-block; vertical-align: top; width: 50%;}
  div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
  ul.task-list{list-style: none;}
    </style>



<style type="text/css">
  code {
    white-space: pre;
  }
  .sourceCode {
    overflow: visible;
  }
</style>
<style type="text/css" data-origin="pandoc">
div.sourceCode { overflow-x: auto; }
table.sourceCode, tr.sourceCode, td.lineNumbers, td.sourceCode {
  margin: 0; padding: 0; vertical-align: baseline; border: none; }
table.sourceCode { width: 100%; line-height: 100%; }
td.lineNumbers { text-align: right; padding-right: 4px; padding-left: 4px; color: #aaaaaa; border-right: 1px solid #aaaaaa; }
td.sourceCode { padding-left: 5px; }
code > span.kw { color: #007020; font-weight: bold; } /* Keyword */
code > span.dt { color: #902000; } /* DataType */
code > span.dv { color: #40a070; } /* DecVal */
code > span.bn { color: #40a070; } /* BaseN */
code > span.fl { color: #40a070; } /* Float */
code > span.ch { color: #4070a0; } /* Char */
code > span.st { color: #4070a0; } /* String */
code > span.co { color: #60a0b0; font-style: italic; } /* Comment */
code > span.ot { color: #007020; } /* Other */
code > span.al { color: #ff0000; font-weight: bold; } /* Alert */
code > span.fu { color: #06287e; } /* Function */
code > span.er { color: #ff0000; font-weight: bold; } /* Error */
code > span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
code > span.cn { color: #880000; } /* Constant */
code > span.sc { color: #4070a0; } /* SpecialChar */
code > span.vs { color: #4070a0; } /* VerbatimString */
code > span.ss { color: #bb6688; } /* SpecialString */
code > span.im { } /* Import */
code > span.va { color: #19177c; } /* Variable */
code > span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code > span.op { color: #666666; } /* Operator */
code > span.bu { } /* BuiltIn */
code > span.ex { } /* Extension */
code > span.pp { color: #bc7a00; } /* Preprocessor */
code > span.at { color: #7d9029; } /* Attribute */
code > span.do { color: #ba2121; font-style: italic; } /* Documentation */
code > span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code > span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code > span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */

</style>
<script>
// apply pandoc div.sourceCode style to pre.sourceCode instead
(function() {
  var sheets = document.styleSheets;
  for (var i = 0; i < sheets.length; i++) {
    if (sheets[i].ownerNode.dataset["origin"] !== "pandoc") continue;
    try { var rules = sheets[i].cssRules; } catch (e) { continue; }
    var j = 0;
    while (j < rules.length) {
      var rule = rules[j];
      // check if there is a div.sourceCode rule
      if (rule.type !== rule.STYLE_RULE || rule.selectorText !== "div.sourceCode") {
        j++;
        continue;
      }
      var style = rule.style.cssText;
      // check if color or background-color is set
      if (rule.style.color === '' && rule.style.backgroundColor === '') {
        j++;
        continue;
      }
      // replace div.sourceCode by a pre.sourceCode rule
      sheets[i].deleteRule(j);
      sheets[i].insertRule('pre.sourceCode{' + style + '}', j);
    }
  }
})();
</script>




<link href="data:text/css;charset=utf-8,body%20%7B%0Abackground%2Dcolor%3A%20%23fff%3B%0Amargin%3A%201em%20auto%3B%0Amax%2Dwidth%3A%20700px%3B%0Aoverflow%3A%20visible%3B%0Apadding%2Dleft%3A%202em%3B%0Apadding%2Dright%3A%202em%3B%0Afont%2Dfamily%3A%20%22Open%20Sans%22%2C%20%22Helvetica%20Neue%22%2C%20Helvetica%2C%20Arial%2C%20sans%2Dserif%3B%0Afont%2Dsize%3A%2014px%3B%0Aline%2Dheight%3A%201%2E35%3B%0A%7D%0A%23TOC%20%7B%0Aclear%3A%20both%3B%0Amargin%3A%200%200%2010px%2010px%3B%0Apadding%3A%204px%3B%0Awidth%3A%20400px%3B%0Aborder%3A%201px%20solid%20%23CCCCCC%3B%0Aborder%2Dradius%3A%205px%3B%0Abackground%2Dcolor%3A%20%23f6f6f6%3B%0Afont%2Dsize%3A%2013px%3B%0Aline%2Dheight%3A%201%2E3%3B%0A%7D%0A%23TOC%20%2Etoctitle%20%7B%0Afont%2Dweight%3A%20bold%3B%0Afont%2Dsize%3A%2015px%3B%0Amargin%2Dleft%3A%205px%3B%0A%7D%0A%23TOC%20ul%20%7B%0Apadding%2Dleft%3A%2040px%3B%0Amargin%2Dleft%3A%20%2D1%2E5em%3B%0Amargin%2Dtop%3A%205px%3B%0Amargin%2Dbottom%3A%205px%3B%0A%7D%0A%23TOC%20ul%20ul%20%7B%0Amargin%2Dleft%3A%20%2D2em%3B%0A%7D%0A%23TOC%20li%20%7B%0Aline%2Dheight%3A%2016px%3B%0A%7D%0Atable%20%7B%0Amargin%3A%201em%20auto%3B%0Aborder%2Dwidth%3A%201px%3B%0Aborder%2Dcolor%3A%20%23DDDDDD%3B%0Aborder%2Dstyle%3A%20outset%3B%0Aborder%2Dcollapse%3A%20collapse%3B%0A%7D%0Atable%20th%20%7B%0Aborder%2Dwidth%3A%202px%3B%0Apadding%3A%205px%3B%0Aborder%2Dstyle%3A%20inset%3B%0A%7D%0Atable%20td%20%7B%0Aborder%2Dwidth%3A%201px%3B%0Aborder%2Dstyle%3A%20inset%3B%0Aline%2Dheight%3A%2018px%3B%0Apadding%3A%205px%205px%3B%0A%7D%0Atable%2C%20table%20th%2C%20table%20td%20%7B%0Aborder%2Dleft%2Dstyle%3A%20none%3B%0Aborder%2Dright%2Dstyle%3A%20none%3B%0A%7D%0Atable%20thead%2C%20table%20tr%2Eeven%20%7B%0Abackground%2Dcolor%3A%20%23f7f7f7%3B%0A%7D%0Ap%20%7B%0Amargin%3A%200%2E5em%200%3B%0A%7D%0Ablockquote%20%7B%0Abackground%2Dcolor%3A%20%23f6f6f6%3B%0Apadding%3A%200%2E25em%200%2E75em%3B%0A%7D%0Ahr%20%7B%0Aborder%2Dstyle%3A%20solid%3B%0Aborder%3A%20none%3B%0Aborder%2Dtop%3A%201px%20solid%20%23777%3B%0Amargin%3A%2028px%200%3B%0A%7D%0Adl%20%7B%0Amargin%2Dleft%3A%200%3B%0A%7D%0Adl%20dd%20%7B%0Amargin%2Dbottom%3A%2013px%3B%0Amargin%2Dleft%3A%2013px%3B%0A%7D%0Adl%20dt%20%7B%0Afont%2Dweight%3A%20bold%3B%0A%7D%0Aul%20%7B%0Amargin%2Dtop%3A%200%3B%0A%7D%0Aul%20li%20%7B%0Alist%2Dstyle%3A%20circle%20outside%3B%0A%7D%0Aul%20ul%20%7B%0Amargin%2Dbottom%3A%200%3B%0A%7D%0Apre%2C%20code%20%7B%0Abackground%2Dcolor%3A%20%23f7f7f7%3B%0Aborder%2Dradius%3A%203px%3B%0Acolor%3A%20%23333%3B%0Awhite%2Dspace%3A%20pre%2Dwrap%3B%20%0A%7D%0Apre%20%7B%0Aborder%2Dradius%3A%203px%3B%0Amargin%3A%205px%200px%2010px%200px%3B%0Apadding%3A%2010px%3B%0A%7D%0Apre%3Anot%28%5Bclass%5D%29%20%7B%0Abackground%2Dcolor%3A%20%23f7f7f7%3B%0A%7D%0Acode%20%7B%0Afont%2Dfamily%3A%20Consolas%2C%20Monaco%2C%20%27Courier%20New%27%2C%20monospace%3B%0Afont%2Dsize%3A%2085%25%3B%0A%7D%0Ap%20%3E%20code%2C%20li%20%3E%20code%20%7B%0Apadding%3A%202px%200px%3B%0A%7D%0Adiv%2Efigure%20%7B%0Atext%2Dalign%3A%20center%3B%0A%7D%0Aimg%20%7B%0Abackground%2Dcolor%3A%20%23FFFFFF%3B%0Apadding%3A%202px%3B%0Aborder%3A%201px%20solid%20%23DDDDDD%3B%0Aborder%2Dradius%3A%203px%3B%0Aborder%3A%201px%20solid%20%23CCCCCC%3B%0Amargin%3A%200%205px%3B%0A%7D%0Ah1%20%7B%0Amargin%2Dtop%3A%200%3B%0Afont%2Dsize%3A%2035px%3B%0Aline%2Dheight%3A%2040px%3B%0A%7D%0Ah2%20%7B%0Aborder%2Dbottom%3A%204px%20solid%20%23f7f7f7%3B%0Apadding%2Dtop%3A%2010px%3B%0Apadding%2Dbottom%3A%202px%3B%0Afont%2Dsize%3A%20145%25%3B%0A%7D%0Ah3%20%7B%0Aborder%2Dbottom%3A%202px%20solid%20%23f7f7f7%3B%0Apadding%2Dtop%3A%2010px%3B%0Afont%2Dsize%3A%20120%25%3B%0A%7D%0Ah4%20%7B%0Aborder%2Dbottom%3A%201px%20solid%20%23f7f7f7%3B%0Amargin%2Dleft%3A%208px%3B%0Afont%2Dsize%3A%20105%25%3B%0A%7D%0Ah5%2C%20h6%20%7B%0Aborder%2Dbottom%3A%201px%20solid%20%23ccc%3B%0Afont%2Dsize%3A%20105%25%3B%0A%7D%0Aa%20%7B%0Acolor%3A%20%230033dd%3B%0Atext%2Ddecoration%3A%20none%3B%0A%7D%0Aa%3Ahover%20%7B%0Acolor%3A%20%236666ff%3B%20%7D%0Aa%3Avisited%20%7B%0Acolor%3A%20%23800080%3B%20%7D%0Aa%3Avisited%3Ahover%20%7B%0Acolor%3A%20%23BB00BB%3B%20%7D%0Aa%5Bhref%5E%3D%22http%3A%22%5D%20%7B%0Atext%2Ddecoration%3A%20underline%3B%20%7D%0Aa%5Bhref%5E%3D%22https%3A%22%5D%20%7B%0Atext%2Ddecoration%3A%20underline%3B%20%7D%0A%0Acode%20%3E%20span%2Ekw%20%7B%20color%3A%20%23555%3B%20font%2Dweight%3A%20bold%3B%20%7D%20%0Acode%20%3E%20span%2Edt%20%7B%20color%3A%20%23902000%3B%20%7D%20%0Acode%20%3E%20span%2Edv%20%7B%20color%3A%20%2340a070%3B%20%7D%20%0Acode%20%3E%20span%2Ebn%20%7B%20color%3A%20%23d14%3B%20%7D%20%0Acode%20%3E%20span%2Efl%20%7B%20color%3A%20%23d14%3B%20%7D%20%0Acode%20%3E%20span%2Ech%20%7B%20color%3A%20%23d14%3B%20%7D%20%0Acode%20%3E%20span%2Est%20%7B%20color%3A%20%23d14%3B%20%7D%20%0Acode%20%3E%20span%2Eco%20%7B%20color%3A%20%23888888%3B%20font%2Dstyle%3A%20italic%3B%20%7D%20%0Acode%20%3E%20span%2Eot%20%7B%20color%3A%20%23007020%3B%20%7D%20%0Acode%20%3E%20span%2Eal%20%7B%20color%3A%20%23ff0000%3B%20font%2Dweight%3A%20bold%3B%20%7D%20%0Acode%20%3E%20span%2Efu%20%7B%20color%3A%20%23900%3B%20font%2Dweight%3A%20bold%3B%20%7D%20%0Acode%20%3E%20span%2Eer%20%7B%20color%3A%20%23a61717%3B%20background%2Dcolor%3A%20%23e3d2d2%3B%20%7D%20%0A" rel="stylesheet" type="text/css" />




</head>

<body>




<h1 class="title toc-ignore">Covariance structures with glmmTMB</h1>
<h4 class="author">Kasper Kristensen and Maeve McGillycuddy</h4>
<h4 class="date">2024-09-26</h4>


<div id="TOC">
<ul>
<li><a href="#the-ar1-covariance-structure">The AR(1) covariance structure</a><ul>
<li><a href="#demonstration-on-simulated-data">Demonstration on simulated data</a></li>
<li><a href="#increasing-the-sample-size">Increasing the sample size</a></li>
</ul></li>
<li><a href="#the-unstructured-covariance">The unstructured covariance</a></li>
<li><a href="#the-toeplitz-structure">The Toeplitz structure</a></li>
<li><a href="#compound-symmetry">Compound symmetry</a></li>
<li><a href="#anova-tables">Anova tables</a></li>
<li><a href="#adding-coordinate-information">Adding coordinate information</a></li>
<li><a href="#ornsteinuhlenbeck">Ornstein–Uhlenbeck</a></li>
<li><a href="#spatial-correlations">Spatial correlations</a><ul>
<li><a href="#matern">Matern</a></li>
<li><a href="#gaussian">Gaussian</a></li>
<li><a href="#exponential">Exponential</a></li>
<li><a href="#a-spatial-covariance-example">A spatial covariance example</a></li>
</ul></li>
<li><a href="#mappings">Mappings</a><ul>
<li><a href="#unstructured">Unstructured</a></li>
</ul></li>
<li><a href="#generalized-latent-variable-model">Generalized latent variable model</a><ul>
<li><a href="#reduced-rank">Reduced-rank</a></li>
</ul></li>
<li><a href="#proptional">Proptional</a></li>
<li><a href="#construction-of-structured-covariance-matrices">Construction of structured covariance matrices</a></li>
<li><a href="#references">References</a></li>
</ul>
</div>

<p>This vignette demonstrates some of the covariance structures available in the <code>glmmTMB</code> package. Currently the available covariance structures are:</p>
<!-- not sure why |x| for abs value isn't working in MathJax/LateX within kable table ... -->
<table style="width:100%;">
<colgroup>
<col width="19%"></col>
<col width="5%"></col>
<col width="7%"></col>
<col width="12%"></col>
<col width="55%"></col>
</colgroup>
<thead>
<tr class="header">
<th align="left">Covariance</th>
<th align="left">Notation</th>
<th align="left">no. parameters</th>
<th align="left">Requirement</th>
<th align="left">Parameters</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="left">Unstructured (general positive definite)</td>
<td align="left"><code>us</code></td>
<td align="left"><span class="math inline">\(n(n+1)/2\)</span></td>
<td align="left"></td>
<td align="left">See <a href="#mappings">Mappings</a></td>
</tr>
<tr class="even">
<td align="left">Heterogeneous Toeplitz</td>
<td align="left"><code>toep</code></td>
<td align="left"><span class="math inline">\(2n-1\)</span></td>
<td align="left"></td>
<td align="left">log-SDs (<span class="math inline">\(\theta_1-\theta_n\)</span>); correlations <span class="math inline">\(\rho_k = \theta_{n+k}/\sqrt{1+\theta_{n+k}^2}\)</span>, <span class="math inline">\(k = \textrm{abs}(i-j+1)\)</span></td>
</tr>
<tr class="odd">
<td align="left">Het. compound symmetry</td>
<td align="left"><code>cs</code></td>
<td align="left"><span class="math inline">\(n+1\)</span></td>
<td align="left"></td>
<td align="left">log-SDs (<span class="math inline">\(\theta_1-\theta_n\)</span>); correlation <span class="math inline">\(\rho = \theta_{n+1}/\sqrt{1+\theta_{n+1}^2}\)</span></td>
</tr>
<tr class="even">
<td align="left">Homogenous diagonal</td>
<td align="left"><code>homdiag</code></td>
<td align="left"><span class="math inline">\(1\)</span></td>
<td align="left"></td>
<td align="left">log-SD</td>
</tr>
<tr class="odd">
<td align="left">Het. diagonal</td>
<td align="left"><code>diag</code></td>
<td align="left"><span class="math inline">\(n\)</span></td>
<td align="left"></td>
<td align="left">log-SDs</td>
</tr>
<tr class="even">
<td align="left">AR(1)</td>
<td align="left"><code>ar1</code></td>
<td align="left"><span class="math inline">\(2\)</span></td>
<td align="left">Unit spaced levels</td>
<td align="left">log-SD; <span class="math inline">\(\rho = \left(\theta_2/\sqrt{1+\theta_2^2}\right)^{d_{ij}}\)</span></td>
</tr>
<tr class="odd">
<td align="left">Ornstein-Uhlenbeck</td>
<td align="left"><code>ou</code></td>
<td align="left"><span class="math inline">\(2\)</span></td>
<td align="left">Coordinates</td>
<td align="left">log-SD; log-OU rate (<span class="math inline">\(\rho = \exp(-\exp(\theta_2) d_{ij})\)</span>)</td>
</tr>
<tr class="even">
<td align="left">Spatial exponential</td>
<td align="left"><code>exp</code></td>
<td align="left"><span class="math inline">\(2\)</span></td>
<td align="left">Coordinates</td>
<td align="left">log-SD; log-scale (<span class="math inline">\(\rho = \exp(-\exp(-\theta_2) d_{ij})\)</span>)</td>
</tr>
<tr class="odd">
<td align="left">Spatial Gaussian</td>
<td align="left"><code>gau</code></td>
<td align="left"><span class="math inline">\(2\)</span></td>
<td align="left">Coordinates</td>
<td align="left">log-SD; log-scale (<span class="math inline">\(\rho = \exp(-\exp(-2\theta_2) d_{ij}^2\)</span>)</td>
</tr>
<tr class="even">
<td align="left">Spatial Matèrn</td>
<td align="left"><code>mat</code></td>
<td align="left"><span class="math inline">\(3\)</span></td>
<td align="left">Coordinates</td>
<td align="left">log-SD, log-range, log-shape (power)</td>
</tr>
<tr class="odd">
<td align="left">Reduced-rank</td>
<td align="left"><code>rr</code></td>
<td align="left"><span class="math inline">\(nd-d(d-1)/2\)</span></td>
<td align="left">rank (d)</td>
<td align="left"></td>
</tr>
<tr class="even">
<td align="left">Proptional</td>
<td align="left"><code>propto</code></td>
<td align="left"><span class="math inline">\(1\)</span></td>
<td align="left">Variance-covariance matrix</td>
<td align="left"></td>
</tr>
</tbody>
</table>
<p>The word 'heterogeneous' refers to the marginal variances of the model.</p>
<p>Homogenous versions of some structures (e.g. Toeplitz, compound symmetric) can be implemented by using the <code>map</code> argument to set all log-SD parameters equal to each other.</p>
<p>Some of the structures require temporal or spatial coordinates. We will show examples in a later section.</p>
<div id="the-ar1-covariance-structure" class="section level2">
<h2>The AR(1) covariance structure</h2>
<div id="demonstration-on-simulated-data" class="section level3">
<h3>Demonstration on simulated data</h3>
<p>First, let's consider a simple time series model. Assume that our measurements <span class="math inline">\(Y(t)\)</span> are given at discrete times <span class="math inline">\(t \in \{1,...,n\}\)</span> by</p>
<p><span class="math display">\[Y(t) = \mu + X(t) + \varepsilon(t)\]</span></p>
<p>where</p>
<ul>
<li><span class="math inline">\(\mu\)</span> is the mean value parameter.</li>
<li><span class="math inline">\(X(t)\)</span> is a stationary AR(1) process, i.e. has covariance <span class="math inline">\(cov(X(s),  X(t)) = \sigma^2\exp(-\theta |t-s|)\)</span>.</li>
<li><span class="math inline">\(\varepsilon(t)\)</span> is iid. <span class="math inline">\(N(0,\sigma_0^2)\)</span> measurement error.</li>
</ul>
<p>A simulation experiment is set up using the parameters</p>
<table>
<thead>
<tr class="header">
<th>Description</th>
<th>Parameter</th>
<th>Value</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>Mean</td>
<td><span class="math inline">\(\mu\)</span></td>
<td>0</td>
</tr>
<tr class="even">
<td>Process variance</td>
<td><span class="math inline">\(\sigma^2\)</span></td>
<td>1</td>
</tr>
<tr class="odd">
<td>Measurement variance</td>
<td><span class="math inline">\(\sigma_0^2\)</span></td>
<td>1</td>
</tr>
<tr class="even">
<td>One-step correlation</td>
<td><span class="math inline">\(\phi\)</span></td>
<td>0.7</td>
</tr>
</tbody>
</table>
<p>The following R-code draws a simulation based on these parameter values. For illustration purposes we consider a very short time series.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">n &lt;-<span class="st"> </span><span class="dv">25</span>                                              ## Number of time points
x &lt;-<span class="st"> </span>MASS<span class="op">::</span><span class="kw">mvrnorm</span>(<span class="dt">mu =</span> <span class="kw">rep</span>(<span class="dv">0</span>,n),
             <span class="dt">Sigma =</span> .<span class="dv">7</span> <span class="op">^</span><span class="st"> </span><span class="kw">as.matrix</span>(<span class="kw">dist</span>(<span class="dv">1</span><span class="op">:</span>n)) )    ## Simulate the process using the MASS package
y &lt;-<span class="st"> </span>x <span class="op">+</span><span class="st"> </span><span class="kw">rnorm</span>(n)                                   ## Add measurement noise</code></pre></div>
<p>In order to fit the model with <code>glmmTMB</code> we must first specify a time variable as a <em>factor</em>. The factor <em>levels</em> correspond to unit spaced time points. It is a common mistake to forget some factor levels due to missing data or to order the levels incorrectly. We therefore recommend to construct factors with explicit levels, using the <code>levels</code> argument to the <code>factor</code> function:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">times &lt;-<span class="st"> </span><span class="kw">factor</span>(<span class="dv">1</span><span class="op">:</span>n, <span class="dt">levels=</span><span class="dv">1</span><span class="op">:</span>n)
<span class="kw">head</span>(<span class="kw">levels</span>(times))</code></pre></div>
<p>We also need a grouping variable. In the current case there is only one time-series so the grouping is:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">group &lt;-<span class="st"> </span><span class="kw">factor</span>(<span class="kw">rep</span>(<span class="dv">1</span>,n))</code></pre></div>
<p>We combine the data into a single data frame (not absolutely required, but good practice):</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">dat0 &lt;-<span class="st"> </span><span class="kw">data.frame</span>(y, times, group)</code></pre></div>
<p>Now fit the model using</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">glmmTMB</span>(y <span class="op">~</span><span class="st"> </span><span class="kw">ar1</span>(times <span class="op">+</span><span class="st"> </span><span class="dv">0</span> <span class="op">|</span><span class="st"> </span>group), <span class="dt">data=</span>dat0)</code></pre></div>
<p>This formula notation follows that of the <code>lme4</code> package.</p>
<ul>
<li>The left hand side of the bar <code>times + 0</code> corresponds to a design matrix <span class="math inline">\(Z\)</span> linking observation vector <span class="math inline">\(y\)</span> (rows) with a random effects vector <span class="math inline">\(u\)</span> (columns) (see <a href="#construction-of-structured-covariance-matrices">Construction of structured covariance matrices</a> for why we need the <code>+ 0</code>)</li>
<li>The distribution of <span class="math inline">\(u\)</span> is <code>ar1</code> (this is the only <code>glmmTMB</code> specific part of the formula).</li>
<li>The right hand side of the bar splits the above specification independently among groups. Each group has its own separate <span class="math inline">\(u\)</span> vector but shares the same parameters for the covariance structure.</li>
</ul>
<p>After running the model, we find the parameter estimates <span class="math inline">\(\mu\)</span> (intercept), <span class="math inline">\(\sigma_0^2\)</span> (dispersion), <span class="math inline">\(\sigma\)</span> (Std. Dev.) and <span class="math inline">\(\phi\)</span> (First off-diagonal of &quot;Corr&quot;) in the output:</p>
<p>For those trying to make sense of the internal parameterization, the internal transformation from the parameter (<span class="math inline">\(\theta_2\)</span>) to the AR1 coefficient (<span class="math inline">\(\phi\)</span>) is <span class="math inline">\(\phi = \theta_2/\sqrt(1+\theta_2^2)\)</span>; the inverse transformation is <span class="math inline">\(\theta_2 = \phi/\sqrt(1-\phi^2)\)</span>. (The first element of the <code>theta</code> vector is the log-standard-deviation.)</p>
</div>
<div id="increasing-the-sample-size" class="section level3">
<h3>Increasing the sample size</h3>
<p>A single time series of 6 time points is not sufficient to identify the parameters. We could either increase the length of the time series or increase the number of groups. We'll try the latter:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">simGroup &lt;-<span class="st"> </span><span class="cf">function</span>(g, <span class="dt">n=</span><span class="dv">6</span>, <span class="dt">phi=</span><span class="fl">0.7</span>) {
    x &lt;-<span class="st"> </span>MASS<span class="op">::</span><span class="kw">mvrnorm</span>(<span class="dt">mu =</span> <span class="kw">rep</span>(<span class="dv">0</span>,n),
             <span class="dt">Sigma =</span> phi <span class="op">^</span><span class="st"> </span><span class="kw">as.matrix</span>(<span class="kw">dist</span>(<span class="dv">1</span><span class="op">:</span>n)) )   ## Simulate the process
    y &lt;-<span class="st"> </span>x <span class="op">+</span><span class="st"> </span><span class="kw">rnorm</span>(n)                               ## Add measurement noise
    times &lt;-<span class="st"> </span><span class="kw">factor</span>(<span class="dv">1</span><span class="op">:</span>n)
    group &lt;-<span class="st"> </span><span class="kw">factor</span>(<span class="kw">rep</span>(g,n))
    <span class="kw">data.frame</span>(y, times, group)
}
<span class="kw">simGroup</span>(<span class="dv">1</span>)</code></pre></div>
<p>Generate a dataset with 1000 groups:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">dat1 &lt;-<span class="st"> </span><span class="kw">do.call</span>(<span class="st">&quot;rbind&quot;</span>, <span class="kw">lapply</span>(<span class="dv">1</span><span class="op">:</span><span class="dv">1000</span>, simGroup) )</code></pre></div>
<p>And fitting the model on this larger dataset gives estimates close to the true values (AR standard deviation=1, residual (measurement) standard deviation=1, autocorrelation=0.7):</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">(fit.ar1 &lt;-<span class="st"> </span><span class="kw">glmmTMB</span>(y <span class="op">~</span><span class="st"> </span><span class="kw">ar1</span>(times <span class="op">+</span><span class="st"> </span><span class="dv">0</span> <span class="op">|</span><span class="st"> </span>group), <span class="dt">data=</span>dat1))</code></pre></div>
</div>
</div>
<div id="the-unstructured-covariance" class="section level2">
<h2>The unstructured covariance</h2>
<p>We can try to fit an unstructured covariance to the previous dataset <code>dat</code>. For this case an unstructured covariance has 300 correlation parameters and 25 variance parameters. Adding <span class="math inline">\(\sigma_0^2 I\)</span> on top would cause a strict overparameterization, as these would be redundant with the diagonal elements in the covariance matrix. Hence, when fitting the model with <code>glmmTMB</code>, we have to disable the <span class="math inline">\(\varepsilon\)</span> term (the dispersion) by setting <code>dispformula=~0</code>:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">fit.us &lt;-<span class="st"> </span><span class="kw">glmmTMB</span>(y <span class="op">~</span><span class="st"> </span><span class="kw">us</span>(times <span class="op">+</span><span class="st"> </span><span class="dv">0</span> <span class="op">|</span><span class="st"> </span>group), <span class="dt">data=</span>dat1, <span class="dt">dispformula=</span><span class="op">~</span><span class="dv">0</span>)
fit.us<span class="op">$</span>sdr<span class="op">$</span>pdHess ## Converged ?</code></pre></div>
<p>The estimated variance and correlation parameters are:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">VarCorr</span>(fit.us)</code></pre></div>
<p>The estimated correlation is approximately constant along diagonals (apparent Toeplitz structure) and we note that the first off-diagonal is now ca. half the true value (0.7) because the dispersion is effectively included in the estimated covariance matrix (i.e. <span class="math inline">\(\rho' = \rho {\sigma^2_{{\text {AR}}}}/({\sigma^2_{{\text {AR}}}} + {\sigma^2_{{\text {meas}}}})\)</span>).</p>
</div>
<div id="the-toeplitz-structure" class="section level2">
<h2>The Toeplitz structure</h2>
<p>The next natural step would be to reduce the number of parameters by collecting correlation parameters within the same off-diagonal. This amounts to 24 correlation parameters and 25 variance parameters.</p>
<p>We use <code>dispformula = ~0</code> to suppress the residual variance (it actually gets set to a small value controlled by the <code>zerodisp_val</code> argument of <code>glmmTMBControl()</code>)<a href="#fn1" class="footnoteRef" id="fnref1"><sup>1</sup></a></p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">fit.toep &lt;-<span class="st"> </span><span class="kw">glmmTMB</span>(y <span class="op">~</span><span class="st"> </span><span class="kw">toep</span>(times <span class="op">+</span><span class="st"> </span><span class="dv">0</span> <span class="op">|</span><span class="st"> </span>group), <span class="dt">data=</span>dat1,
                    <span class="dt">dispformula=</span><span class="op">~</span><span class="dv">0</span>)
fit.toep<span class="op">$</span>sdr<span class="op">$</span>pdHess ## Converged ?</code></pre></div>
<p>The estimated variance and correlation parameters are:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">(vc.toep &lt;-<span class="st"> </span><span class="kw">VarCorr</span>(fit.toep))</code></pre></div>
<p>The diagonal elements are all approximately equal to the true total variance (<span class="math inline">\({\sigma^2_{{\text {AR}}}} + {\sigma^2_{{\text {meas}}}}\)</span>=2), and the off-diagonal elements are approximately equal to the expected value of 0.7/2=0.35.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">vc1 &lt;-<span class="st"> </span>vc.toep<span class="op">$</span>cond[[<span class="dv">1</span>]] ## first term of var-cov for RE of conditional model
<span class="kw">summary</span>(<span class="kw">diag</span>(vc1))
<span class="kw">summary</span>(vc1[<span class="kw">row</span>(vc1)<span class="op">!=</span><span class="kw">col</span>(vc1)])</code></pre></div>
<p>We can get a <em>slightly</em> better estimate of the variance by using REML estimation (however, the estimate of the correlations seems to have gotten slightly worse):</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">fit.toep.reml &lt;-<span class="st"> </span><span class="kw">update</span>(fit.toep, <span class="dt">REML=</span><span class="ot">TRUE</span>)
vc1R &lt;-<span class="st"> </span><span class="kw">VarCorr</span>(fit.toep.reml)<span class="op">$</span>cond[[<span class="dv">1</span>]]
<span class="kw">summary</span>(<span class="kw">diag</span>(vc1R))
<span class="kw">summary</span>(vc1R[<span class="kw">row</span>(vc1R)<span class="op">!=</span><span class="kw">col</span>(vc1R)])</code></pre></div>
</div>
<div id="compound-symmetry" class="section level2">
<h2>Compound symmetry</h2>
<p>The compound symmetry structure collects all off-diagonal elements of the correlation matrix to one common value.</p>
<p>We again use <code>dispformula = ~0</code> to make the model parameters identifiable (see the footnote in <a href="#the-toeplitz-structure">The Toeplitz structure</a>; a similar, although slightly simpler, argument applies here).</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">fit.cs &lt;-<span class="st"> </span><span class="kw">glmmTMB</span>(y <span class="op">~</span><span class="st"> </span><span class="kw">cs</span>(times <span class="op">+</span><span class="st"> </span><span class="dv">0</span> <span class="op">|</span><span class="st"> </span>group), <span class="dt">data=</span>dat1, <span class="dt">dispformula=</span><span class="op">~</span><span class="dv">0</span>)
fit.cs<span class="op">$</span>sdr<span class="op">$</span>pdHess ## Converged ?</code></pre></div>
<p>The estimated variance and correlation parameters are:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">VarCorr</span>(fit.cs)</code></pre></div>
</div>
<div id="anova-tables" class="section level2">
<h2>Anova tables</h2>
<p>The models <code>ar1</code>, <code>toep</code>, and <code>us</code> are nested so we can use:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">anova</span>(fit.ar1, fit.toep, fit.us)</code></pre></div>
<p><code>ar1</code> has the lowest AIC (it's the simplest model, and fits the data adequately); we can't reject the (true in this case!) null model that an AR1 structure is adequate to describe the data.</p>
<p>The model <code>cs</code> is a sub-model of <code>toep</code>:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">anova</span>(fit.cs, fit.toep)</code></pre></div>
<p>Here we <em>can</em> reject the null hypothesis of compound symmetry (i.e., that all the pairwise correlations are the same).</p>
</div>
<div id="adding-coordinate-information" class="section level2">
<h2>Adding coordinate information</h2>
<p>Coordinate information can be added to a variable using the <code>glmmTMB</code> function <code>numFactor</code>. This is necessary in order to use those covariance structures that require coordinates. For example, if we have the numeric coordinates</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">x &lt;-<span class="st"> </span><span class="kw">sample</span>(<span class="dv">1</span><span class="op">:</span><span class="dv">2</span>, <span class="dv">10</span>, <span class="dt">replace=</span><span class="ot">TRUE</span>)
y &lt;-<span class="st"> </span><span class="kw">sample</span>(<span class="dv">1</span><span class="op">:</span><span class="dv">2</span>, <span class="dv">10</span>, <span class="dt">replace=</span><span class="ot">TRUE</span>)</code></pre></div>
<p>we can generate a factor representing <span class="math inline">\((x,y)\)</span> coordinates by</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">(pos &lt;-<span class="st"> </span><span class="kw">numFactor</span>(x,y))</code></pre></div>
<p>Numeric coordinates can be recovered from the factor levels:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">parseNumLevels</span>(<span class="kw">levels</span>(pos))</code></pre></div>
<p>In order to try the remaining structures on our test data we re-interpret the time factor using <code>numFactor</code>:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">dat1<span class="op">$</span>times &lt;-<span class="st"> </span><span class="kw">numFactor</span>(dat1<span class="op">$</span>times)
<span class="kw">levels</span>(dat1<span class="op">$</span>times)</code></pre></div>
</div>
<div id="ornsteinuhlenbeck" class="section level2">
<h2>Ornstein–Uhlenbeck</h2>
<p>Having the numeric times encoded in the factor levels we can now try the Ornstein–Uhlenbeck covariance structure.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">fit.ou &lt;-<span class="st"> </span><span class="kw">glmmTMB</span>(y <span class="op">~</span><span class="st"> </span><span class="kw">ou</span>(times <span class="op">+</span><span class="st"> </span><span class="dv">0</span> <span class="op">|</span><span class="st"> </span>group), <span class="dt">data=</span>dat1)
fit.ou<span class="op">$</span>sdr<span class="op">$</span>pdHess ## Converged ?</code></pre></div>
<p>It should give the exact same results as <code>ar1</code> in this case since the times are equidistant:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">VarCorr</span>(fit.ou)</code></pre></div>
<p>However, note the differences between <code>ou</code> and <code>ar1</code>:</p>
<ul>
<li><code>ou</code> can handle irregular time points.</li>
<li><code>ou</code> only allows positive correlation between neighboring time points.</li>
</ul>
</div>
<div id="spatial-correlations" class="section level2">
<h2>Spatial correlations</h2>
<p>The structures <code>exp</code>, <code>gau</code> and <code>mat</code> are meant to used for spatial data. They all require a Euclidean distance matrix which is calculated internally based on the coordinates. Here, we will try these models on the simulated time series data.</p>
<p>An example with spatial data is presented in a later section.</p>
<div id="matern" class="section level3">
<h3>Matern</h3>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">fit.mat &lt;-<span class="st"> </span><span class="kw">glmmTMB</span>(y <span class="op">~</span><span class="st"> </span><span class="kw">mat</span>(times <span class="op">+</span><span class="st"> </span><span class="dv">0</span> <span class="op">|</span><span class="st"> </span>group), <span class="dt">data=</span>dat1, <span class="dt">dispformula=</span><span class="op">~</span><span class="dv">0</span>)
fit.mat<span class="op">$</span>sdr<span class="op">$</span>pdHess ## Converged ?</code></pre></div>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">VarCorr</span>(fit.mat)</code></pre></div>
</div>
<div id="gaussian" class="section level3">
<h3>Gaussian</h3>
<p>&quot;Gaussian&quot; refers here to a Gaussian decay in correlation with distance, i.e. <span class="math inline">\(\rho = \exp(-d x^2)\)</span>, not to the conditional distribution (&quot;family&quot;).</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">fit.gau &lt;-<span class="st"> </span><span class="kw">glmmTMB</span>(y <span class="op">~</span><span class="st"> </span><span class="kw">gau</span>(times <span class="op">+</span><span class="st"> </span><span class="dv">0</span> <span class="op">|</span><span class="st"> </span>group), <span class="dt">data=</span>dat1, <span class="dt">dispformula=</span><span class="op">~</span><span class="dv">0</span>)
fit.gau<span class="op">$</span>sdr<span class="op">$</span>pdHess ## Converged ?</code></pre></div>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">VarCorr</span>(fit.gau)</code></pre></div>
</div>
<div id="exponential" class="section level3">
<h3>Exponential</h3>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">fit.exp &lt;-<span class="st"> </span><span class="kw">glmmTMB</span>(y <span class="op">~</span><span class="st"> </span><span class="kw">exp</span>(times <span class="op">+</span><span class="st"> </span><span class="dv">0</span> <span class="op">|</span><span class="st"> </span>group), <span class="dt">data=</span>dat1)
fit.exp<span class="op">$</span>sdr<span class="op">$</span>pdHess ## Converged ?</code></pre></div>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">VarCorr</span>(fit.exp)</code></pre></div>
</div>
<div id="a-spatial-covariance-example" class="section level3">
<h3>A spatial covariance example</h3>
<p>Starting out with the built in <code>volcano</code> dataset we reshape it to a <code>data.frame</code> with pixel intensity <code>z</code> and pixel position <code>x</code> and <code>y</code>:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">d &lt;-<span class="st"> </span><span class="kw">data.frame</span>(<span class="dt">z =</span> <span class="kw">as.vector</span>(volcano),
                <span class="dt">x =</span> <span class="kw">as.vector</span>(<span class="kw">row</span>(volcano)),
                <span class="dt">y =</span> <span class="kw">as.vector</span>(<span class="kw">col</span>(volcano)))</code></pre></div>
<p>Next, add random normal noise to the pixel intensities and extract a small subset of 100 pixels. This is our spatial dataset:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">set.seed</span>(<span class="dv">1</span>)
d<span class="op">$</span>z &lt;-<span class="st"> </span>d<span class="op">$</span>z <span class="op">+</span><span class="st"> </span><span class="kw">rnorm</span>(<span class="kw">length</span>(volcano), <span class="dt">sd=</span><span class="dv">15</span>)
d &lt;-<span class="st"> </span>d[<span class="kw">sample</span>(<span class="kw">nrow</span>(d), <span class="dv">100</span>), ]</code></pre></div>
<p>Display sampled noisy volcano data:</p>
<!-- never evaluate -->
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">volcano.data &lt;-<span class="st"> </span><span class="kw">array</span>(<span class="ot">NA</span>, <span class="kw">dim</span>(volcano))
volcano.data[<span class="kw">cbind</span>(d<span class="op">$</span>x, d<span class="op">$</span>y)] &lt;-<span class="st"> </span>d<span class="op">$</span>z
<span class="kw">image</span>(volcano.data, <span class="dt">main=</span><span class="st">&quot;Spatial data&quot;</span>, <span class="dt">useRaster=</span><span class="ot">TRUE</span>)</code></pre></div>
<!-- evaluate if NOT_CRAN -->
<!-- always evaluate -->
<p><img src="data:image/png;base64,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" width="480" /></p>
<p>Based on this data, we'll attempt to re-construct the original image.</p>
<p>As model, it is assumed that the original image <code>image(volcano)</code> is a realization of a random field with correlation decaying exponentially with distance between pixels.</p>
<p>Denoting by <span class="math inline">\(u(x,y)\)</span> this random field the model for the observations is</p>
<p><span class="math display">\[ z_{i} = \mu + u(x_i,y_i) + \varepsilon_i \]</span></p>
<p>To fit the model, a <code>numFactor</code> and a dummy grouping variable must be added to the dataset:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">d<span class="op">$</span>pos &lt;-<span class="st"> </span><span class="kw">numFactor</span>(d<span class="op">$</span>x, d<span class="op">$</span>y)
d<span class="op">$</span>group &lt;-<span class="st"> </span><span class="kw">factor</span>(<span class="kw">rep</span>(<span class="dv">1</span>, <span class="kw">nrow</span>(d)))</code></pre></div>
<p>The model is fit by</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">f &lt;-<span class="st"> </span><span class="kw">glmmTMB</span>(z <span class="op">~</span><span class="st"> </span><span class="dv">1</span> <span class="op">+</span><span class="st"> </span><span class="kw">exp</span>(pos <span class="op">+</span><span class="st"> </span><span class="dv">0</span> <span class="op">|</span><span class="st"> </span>group), <span class="dt">data=</span>d)</code></pre></div>
<p>Recall that a standard deviation <code>sd=15</code> was used to distort the image. A confidence interval for this parameter is</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">confint</span>(f, <span class="st">&quot;sigma&quot;</span>)</code></pre></div>
<p>The glmmTMB <code>predict</code> method can predict unseen levels of the random effects. For instance to predict a 3-by-3 corner of the image one could construct the new data:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">newdata &lt;-<span class="st"> </span><span class="kw">data.frame</span>( <span class="dt">pos=</span><span class="kw">numFactor</span>(<span class="kw">expand.grid</span>(<span class="dt">x=</span><span class="dv">1</span><span class="op">:</span><span class="dv">3</span>,<span class="dt">y=</span><span class="dv">1</span><span class="op">:</span><span class="dv">3</span>)) )
newdata<span class="op">$</span>group &lt;-<span class="st"> </span><span class="kw">factor</span>(<span class="kw">rep</span>(<span class="dv">1</span>, <span class="kw">nrow</span>(newdata)))
newdata</code></pre></div>
<p>and predict using</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">predict</span>(f, newdata, <span class="dt">type=</span><span class="st">&quot;response&quot;</span>, <span class="dt">allow.new.levels=</span><span class="ot">TRUE</span>)</code></pre></div>
<p>A specific image column can thus be predicted using the function</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">predict_col &lt;-<span class="st"> </span><span class="cf">function</span>(i) {
    newdata &lt;-<span class="st"> </span><span class="kw">data.frame</span>( <span class="dt">pos =</span> <span class="kw">numFactor</span>(<span class="kw">expand.grid</span>(<span class="dv">1</span><span class="op">:</span><span class="dv">87</span>,i)))
    newdata<span class="op">$</span>group &lt;-<span class="st"> </span><span class="kw">factor</span>(<span class="kw">rep</span>(<span class="dv">1</span>,<span class="kw">nrow</span>(newdata)))
    <span class="kw">predict</span>(f, <span class="dt">newdata=</span>newdata, <span class="dt">type=</span><span class="st">&quot;response&quot;</span>, <span class="dt">allow.new.levels=</span><span class="ot">TRUE</span>)
}</code></pre></div>
<p>Prediction of the entire image is carried out by (this takes a while...):</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">pred &lt;-<span class="st"> </span><span class="kw">sapply</span>(<span class="dv">1</span><span class="op">:</span><span class="dv">61</span>, predict_col)</code></pre></div>
<p>Finally plot the re-constructed image by</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">image</span>(pred, <span class="dt">main=</span><span class="st">&quot;Reconstruction&quot;</span>)</code></pre></div>
<p><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAeAAAAHgCAIAAADytinCAAAgAElEQVR4nO3de3BV1fn/8XVyDiExCcmBhIsQJUFAgyKIBgj4DSpX/QphkCJCbb3QOqQ6olWZsWWqHanTTsVeNDptmUalzlSxBrwQi3IRuQi/QUDSFKuYgARjYhITjCEJ+/fHmS9uNmZ3s8++PDt5v/5KTpK91skJH5dnPevZIU3TFABAngS/JwAA+G4ENAAIRUADgFAENAAIRUADgFAENAAIRUADgFAENAAIRUADgFAENAAIRUADgFAENAAIRUADgFAENAAIRUADgFAENAAIRUADgFAENAAIRUADgFAENAAIRUADgFAENAAIRUADgFAENFw0fPjwkE5CQkJ2dvYTTzzh97yUUqqxsbG+vr6jo8Ola544cSIUCiUnJzt4ffQ0BDRcl5OTM2bMmMsvv3zQoEFHjx69//77t2zZ4vek1DXXXJOZmblv3z6XrpmQkDBmzJjRo0c7eH30NAQ0XLdq1aq9e/d+8MEHR44cufjii5VSb7/9tt+Tcl1ycvLevXt37drl90QQYAQ0vJOQkDBp0iSlVOx//D/99NOioqKsrKwBAwb88Ic/bGpqin1bY2PjkiVLhg4dmpGRMW3atL1798Yeb21tffDBB0eOHJmWlnbVVVf97W9/iz3++eefh0KhrKysV1999dJLL+3Tp8/s2bNra2tjX92+fXthYWGfPn369+8/Z86cgwcPKqXGjh37wQcfKKWuvPLKtWvXnr7Cjh07Yo8cPHgwFApdcsklsYu89957oVBo4sSJJjM0XNPwFoe9yaOn0wDXXHTRRUqpV199Nfbp559/HltBv/fee1999dXAgQN79eo1d+7cyZMnK6VmzZrV2dl56tSpCRMmKKVGjx49efLkUCiUmZn5+eefa5o2c+ZMpVR2dvYNN9xw3nnnKaVKSko0TTt+/LhSKhKJ9O7de8yYMZFIRCl15513apr2xRdf9OnTJyEhYe7cuddcc41S6vzzz29tbd2wYcOFF16olHrssceOHDkSu0Jqamp2drZS6uWXX/7www+VUhdffHFs5tu2bVNKTZgwQdO0rmZouGZLS4tSKikpKXYFG5MHCGi4KBbQepFI5K9//aumabGtwrvvvjv2nQUFBUqp9evXb9y4USk1fPjwjo4OTdNuueWWSCTyl7/85d13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" width="480" /></p>
</div>
</div>
<div id="mappings" class="section level2">
<h2>Mappings</h2>
<p>For various advanced purposes, such as computing likelihood profiles, it is useful to know the details of the parameterization of the models - the scale on which the parameters are defined (e.g. standard deviation, variance, or log-standard deviation for variance parameters) and their order.</p>
<div id="unstructured" class="section level3">
<h3>Unstructured</h3>
<p>For an unstructured matrix of size <code>n</code>, parameters <code>1:n</code> represent the log-standard deviations while the remaining <code>n(n-1)/2</code> (i.e. <code>(n+1):(n:(n*(n+1)/2))</code>) are the elements of the <em>scaled</em> Cholesky factor of the correlation matrix, filled in row-wise order (see <a href="http://kaskr.github.io/adcomp/classdensity_1_1UNSTRUCTURED__CORR__t.html">TMB documentation</a>). In particular, if <span class="math inline">\(L\)</span> is the lower-triangular matrix with 1 on the diagonal and the correlation parameters in the lower triangle, then the correlation matrix is defined as <span class="math inline">\(\Sigma = D^{-1/2} L L^\top D^{-1/2}\)</span>, where <span class="math inline">\(D = \textrm{diag}(L L^\top)\)</span>. For a single correlation parameter <span class="math inline">\(\theta_0\)</span>, this works out to <span class="math inline">\(\rho = \theta_0/\sqrt{1+\theta_0^2}\)</span> (with inverse <span class="math inline">\(\theta_0 = \rho/\sqrt(1-\rho^2)\)</span>. You can use the utility functions <code>get_cor()</code> (transform a <code>theta</code> vector into the upper triangular [rowwise] elements of a correlation matrix, or the full correlation matrix) and <code>put_cor()</code> (translate a correlation matrix, or the values from the lower triangle, into a <code>theta</code> vector) to perform these transformations.</p>
<p>(See calculations <a href="https://github.com/glmmTMB/glmmTMB/blob/master/misc/glmmTMB_corcalcs.ipynb">here</a>.)</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">vv0 &lt;-<span class="st"> </span><span class="kw">VarCorr</span>(fit.us)
vv1 &lt;-<span class="st"> </span>vv0<span class="op">$</span>cond<span class="op">$</span>group          ## extract 'naked' V-C matrix
n &lt;-<span class="st"> </span><span class="kw">nrow</span>(vv1)
rpars &lt;-<span class="st"> </span><span class="kw">getME</span>(fit.us,<span class="st">&quot;theta&quot;</span>) ## extract V-C parameters
## first n parameters are log-std devs:
<span class="kw">all.equal</span>(<span class="kw">unname</span>(<span class="kw">diag</span>(vv1)),<span class="kw">exp</span>(rpars[<span class="dv">1</span><span class="op">:</span>n])<span class="op">^</span><span class="dv">2</span>)
## now try correlation parameters:
cpars &lt;-<span class="st"> </span>rpars[<span class="op">-</span>(<span class="dv">1</span><span class="op">:</span>n)]
<span class="kw">length</span>(cpars)<span class="op">==</span>n<span class="op">*</span>(n<span class="op">-</span><span class="dv">1</span>)<span class="op">/</span><span class="dv">2</span>      ## the expected number
cc &lt;-<span class="st"> </span><span class="kw">diag</span>(n)
cc[<span class="kw">upper.tri</span>(cc)] &lt;-<span class="st"> </span>cpars
L &lt;-<span class="st"> </span><span class="kw">crossprod</span>(cc)
D &lt;-<span class="st"> </span><span class="kw">diag</span>(<span class="dv">1</span><span class="op">/</span><span class="kw">sqrt</span>(<span class="kw">diag</span>(L)))
<span class="kw">round</span>(D <span class="op">%*%</span><span class="st"> </span>L <span class="op">%*%</span><span class="st"> </span>D,<span class="dv">3</span>)
<span class="kw">round</span>(<span class="kw">unname</span>(<span class="kw">attr</span>(vv1,<span class="st">&quot;correlation&quot;</span>)),<span class="dv">3</span>)</code></pre></div>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">all.equal</span>(<span class="kw">c</span>(<span class="kw">cov2cor</span>(vv1)),<span class="kw">c</span>(fit.us<span class="op">$</span>obj<span class="op">$</span>env<span class="op">$</span><span class="kw">report</span>(fit.us<span class="op">$</span>fit<span class="op">$</span>parfull)<span class="op">$</span>corr[[<span class="dv">1</span>]]))</code></pre></div>
<p>Profiling (experimental/exploratory):</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">## want $par, not $parfull: do NOT include conditional modes/'b' parameters
ppar &lt;-<span class="st"> </span>fit.us<span class="op">$</span>fit<span class="op">$</span>par
<span class="kw">length</span>(ppar)
<span class="kw">range</span>(<span class="kw">which</span>(<span class="kw">names</span>(ppar)<span class="op">==</span><span class="st">&quot;theta&quot;</span>)) ## the last n*(n+1)/2 parameters
## only 1 fixed effect parameter
tt &lt;-<span class="st"> </span><span class="kw">tmbprofile</span>(fit.us<span class="op">$</span>obj,<span class="dv">2</span>,<span class="dt">trace=</span><span class="ot">FALSE</span>)</code></pre></div>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">confint</span>(tt)
<span class="kw">plot</span>(tt)</code></pre></div>
<p><img src="data:image/png;base64,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" width="480" /></p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">ppar &lt;-<span class="st"> </span>fit.cs<span class="op">$</span>fit<span class="op">$</span>par
<span class="kw">length</span>(ppar)
<span class="kw">range</span>(<span class="kw">which</span>(<span class="kw">names</span>(ppar)<span class="op">==</span><span class="st">&quot;theta&quot;</span>)) ## the last n*(n+1)/2 parameters
## only 1 fixed effect parameter, 1 dispersion parameter
tt2 &lt;-<span class="st"> </span><span class="kw">tmbprofile</span>(fit.cs<span class="op">$</span>obj,<span class="dv">3</span>,<span class="dt">trace=</span><span class="ot">FALSE</span>)</code></pre></div>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">plot</span>(tt2)</code></pre></div>
<p><img src="data:image/png;base64,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" width="480" /></p>
</div>
</div>
<div id="generalized-latent-variable-model" class="section level2">
<h2>Generalized latent variable model</h2>
<p>Consider a generalized linear mixed model</p>
<span class="math display">\[\begin{equation}
g(\boldsymbol{\mu}) = \boldsymbol{X\beta} + \boldsymbol{Zb}
\end{equation}\]</span>
<p>where <span class="math inline">\(g(.)\)</span> is the link function; <span class="math inline">\(\boldsymbol{\beta}\)</span> is a p-dimensional vector of regression coefficients related to the covariates; <span class="math inline">\(\boldsymbol{X}\)</span> is an <span class="math inline">\(n \times p\)</span> model matrix; and <span class="math inline">\(\boldsymbol{Z}\)</span> is the <span class="math inline">\(n\times q\)</span> model matrix for the <span class="math inline">\(q\)</span>-dimensional vector-valued random effects variable <span class="math inline">\(\boldsymbol{U}\)</span> which is multivariate normal with mean zero and a parameterized <span class="math inline">\(q \times q\)</span> variance-covariance matrix, <span class="math inline">\(\boldsymbol{\Sigma}\)</span>, i.e., <span class="math inline">\(\boldsymbol{U} \sim N(\boldsymbol{0}, \boldsymbol{\Sigma})\)</span>.</p>
A general latent variable model (GLVM) requires many fewer parameters for the variance-covariance matrix, <span class="math inline">\(\boldsymbol{\Sigma}\)</span>. To a fit a GLVM we add a <em>reduced-rank</em> (rr) covariance structure, so the model becomes <!-- -->
<span class="math display">\[\begin{align}
g(\boldsymbol{\mu}) &amp;= \boldsymbol{X\beta} + \boldsymbol{Z(I_n \otimes \Lambda)b} \\
&amp;= \boldsymbol{X\beta} + \boldsymbol{Zb_{new}}
\end{align}\]</span>
<!-- -->
<p>where <span class="math inline">\(\otimes\)</span> is the Kronecker product and <span class="math inline">\(\boldsymbol{\Lambda} = (\boldsymbol{\lambda_1}, \ldots, \boldsymbol{\lambda_d})'\)</span> is the <span class="math inline">\(q \times d\)</span> matrix of factor loadings (with <span class="math inline">\(d \ll q\)</span>). The upper triangular elements of <span class="math inline">\(\boldsymbol{\Lambda}\)</span> are set to be zero to ensure parameter identifiability. Here we assume that the latent variables follow a multivariate standard normal distribution, <span class="math inline">\(\boldsymbol{b} \sim N(\boldsymbol{0}, \boldsymbol{I})\)</span>.</p>
<p>For GLVMs it is important to select initial starting values for the parameters because the observed likelihood may be multimodal, and maximization algorithms can end up in local maxima. <span class="citation">Niku et al. (2019)</span> describe methods to enable faster and more reliable fits of latent variable models by carefully choosing starting values of the parameters.</p>
<p>A similar method has been implemented in <code>glmmTMB</code>. A generalized linear model is fitted to the data to obtain initial starting values for the fixed parameters in the model. Residuals from the fitted GLM are calculated; Dunn-Smyth residuals are calculated for common families while residuals from the <code>dev.resids()</code> function are used otherwise. Initial starting values for the latent variables and their loadings are obtained by fitting a reduced rank model to the residuals.</p>
<div id="reduced-rank" class="section level3">
<h3>Reduced-rank</h3>
<p>One of our main motivations for adding this variance-covariance structure is to enable the analysis of multivariate abundance data, for example to model the abundance of different taxa across multiple sites. Typically an unstructured random effect is assumed to account for correlation between taxa; however the number of parameters required quickly becomes large with increasing numbers of taxa. A GLVM is a flexible and more parsimonious way to account for correlation so that one can fit a joint model across many taxa.</p>
<p>A GLVM can be fit by specifying a reduced rank (<code>rr</code>) covariance structure. For example, the code for modeling the mean abundance against taxa and to account for the correlation between taxa using two latent variables is as follows</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">## fit rank-reduced models with varying dimension
dvec &lt;-<span class="st"> </span><span class="dv">2</span><span class="op">:</span><span class="dv">10</span>
fit_list &lt;-<span class="st"> </span><span class="kw">lapply</span>(dvec,
                   <span class="cf">function</span>(d) {
                       <span class="kw">glmmTMB</span>(abund <span class="op">~</span><span class="st"> </span>Species <span class="op">+</span><span class="st"> </span><span class="kw">rr</span>(Species <span class="op">+</span><span class="st"> </span><span class="dv">0</span><span class="op">|</span>id, <span class="dt">d =</span> d),
                               <span class="dt">data =</span> spider_long)
                   })
<span class="kw">names</span>(fit_list) &lt;-<span class="st"> </span>dvec
## compare fits via AIC
aic_vec &lt;-<span class="st"> </span><span class="kw">sapply</span>(fit_list, AIC)
delta_aic  &lt;-<span class="st"> </span>aic_vec <span class="op">-</span><span class="st"> </span><span class="kw">min</span>(aic_vec, <span class="dt">na.rm =</span> <span class="ot">TRUE</span>)</code></pre></div>
<p>The left hand side of the bar <code>taxa + 0</code> corresponds to a factor loading matrix that accounts for the correlations among taxa. The right hand side of the bar splits the above specification independently among sites. The <code>d</code> is a non-negative integer (which defaults to 2).</p>
<p>An option in <code>glmmTMBControl()</code> has been included to initialize the starting values for the parameters based on the approach mentioned above with the default set at <code>glmmTMBControl(start_method = list(method = NULL, jitter.sd = 0)</code>:</p>
<ul>
<li><code>method = &quot;res&quot;</code> initializes starting values from the results of fitting a GLM, and fitting a reduced rank model to the residuals to obtain starting values for the fixed coefficients, the latent variables and the factor loadings.</li>
<li><code>jitter.sd</code> adds variation to the starting values of latent variables when <code>method = &quot;res&quot;</code> (default 0).</li>
</ul>
<p>For a reduced rank matrix of rank <code>d</code>, parameters <code>1:d</code> represent the diagonal factor loadings while the remaining <span class="math inline">\(nd-d(d-3)/2\)</span>, (i.e. parameters <code>(d+1):(nd-d(d-1)/2</code>) are the lower diagonal factor loadings filled in column-wise order. The factor loadings from a model can be obtained by <code>fit.rr$obj$env$report(fit.rr$fit$parfull)$fact_load[[1]]</code>. An appropriate rank for the model can be determined by standard model selection approaches such as information criteria (e.g. AIC or BIC) <span class="citation">(F. K. Hui et al. 2015)</span>.</p>
<p>We can extract the random effects (predicted values for each site by species combination) with <code>ranef()</code>; `<code>as.data.frame(ranef())</code> (or <code>broom.mixed::tidy(..., effects = &quot;ran_vals&quot;)</code>) gives the results in a more convenient format. Based on this information, we can plot the predictions for species (ordered by their predicted presence at site 1). (We've arbitrarily chosen <code>d=3</code> here.)</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">spider_rr &lt;-<span class="st"> </span><span class="kw">glmmTMB</span>(abund <span class="op">~</span><span class="st"> </span>Species <span class="op">+</span><span class="st"> </span><span class="kw">rr</span>(Species <span class="op">+</span><span class="st"> </span><span class="dv">0</span><span class="op">|</span>id, <span class="dt">d =</span> <span class="dv">3</span>),
                     <span class="dt">data =</span> spider_long)
re &lt;-<span class="st"> </span><span class="kw">as.data.frame</span>(<span class="kw">ranef</span>(spider_rr))
re &lt;-<span class="st"> </span><span class="kw">within</span>(re, {
    ## sites in numeric order
    grp &lt;-<span class="st"> </span><span class="kw">factor</span>(grp, <span class="dt">levels =</span> <span class="kw">unique</span>(grp))
    ## species in site-1-predicted-abundance order
    term &lt;-<span class="st"> </span><span class="kw">reorder</span>(term, condval, <span class="cf">function</span>(x) x[<span class="dv">1</span>])
    lwr &lt;-<span class="st"> </span>condval <span class="op">-</span><span class="st"> </span><span class="dv">2</span><span class="op">*</span>condsd
    upr &lt;-<span class="st"> </span>condval <span class="op">+</span><span class="st"> </span><span class="dv">2</span><span class="op">*</span>condsd
})
<span class="cf">if</span> (<span class="kw">require</span>(<span class="st">&quot;ggplot2&quot;</span>)) {
    <span class="kw">ggplot</span>(re, <span class="kw">aes</span>(grp, condval)) <span class="op">+</span>
<span class="st">        </span><span class="kw">geom_pointrange</span>(<span class="kw">aes</span>(<span class="dt">ymin=</span>lwr, <span class="dt">ymax =</span> upr)) <span class="op">+</span>
<span class="st">        </span><span class="kw">facet_wrap</span>(<span class="op">~</span>term, <span class="dt">scale =</span> <span class="st">&quot;free&quot;</span>)
}</code></pre></div>
<p>If we instead want to get the factor loadings by Species and <em>latent</em> variables by site, we can use a (so far experimental) function to get a list with components <code>$fl</code> (factor loadings) and <code>$b</code> (latent variables by site)</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">source</span>(<span class="kw">system.file</span>(<span class="st">&quot;misc&quot;</span>, <span class="st">&quot;extract_rr.R&quot;</span>, <span class="dt">package =</span> <span class="st">&quot;glmmTMB&quot;</span>))
rr_info &lt;-<span class="st"> </span><span class="kw">extract_rr</span>(spider_rr)
<span class="kw">lapply</span>(rr_info, dim)</code></pre></div>
<p>We can use this information to create an (ugly) biplot. (Improvements welcome!)</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">par</span>(<span class="dt">las =</span> <span class="dv">1</span>)
afac &lt;-<span class="st"> </span><span class="dv">4</span>
sp_names &lt;-<span class="st"> </span><span class="kw">abbreviate</span>(<span class="kw">gsub</span>(<span class="st">&quot;Species&quot;</span>, <span class="st">&quot;&quot;</span>, <span class="kw">rownames</span>(rr_info<span class="op">$</span>fl)))
<span class="kw">plot</span>(rr_info<span class="op">$</span>fl[,<span class="dv">1</span>], rr_info<span class="op">$</span>fl[,<span class="dv">2</span>], <span class="dt">xlab =</span> <span class="st">&quot;factor 1&quot;</span>, <span class="dt">ylab =</span> <span class="st">&quot;factor 2&quot;</span>, <span class="dt">pch =</span> <span class="dv">16</span>, <span class="dt">cex =</span> <span class="dv">2</span>)
<span class="kw">text</span>(rr_info<span class="op">$</span>b[,<span class="dv">1</span>]<span class="op">*</span>afac<span class="op">*</span><span class="fl">1.05</span>, rr_info<span class="op">$</span>b[,<span class="dv">2</span>]<span class="op">*</span>afac<span class="op">*</span><span class="fl">1.05</span>, <span class="kw">rownames</span>(rr_info<span class="op">$</span>b))
<span class="kw">arrows</span>(<span class="dv">0</span>, <span class="dv">0</span>, rr_info<span class="op">$</span>b[,<span class="dv">1</span>]<span class="op">*</span>afac, rr_info<span class="op">$</span>b[,<span class="dv">2</span>]<span class="op">*</span>afac)
<span class="kw">text</span>(rr_info<span class="op">$</span>fl[,<span class="dv">1</span>], rr_info<span class="op">$</span>fl[,<span class="dv">2</span>], sp_names, <span class="dt">pos =</span> <span class="dv">3</span>, <span class="dt">col =</span> <span class="dv">2</span>)</code></pre></div>
</div>
</div>
<div id="proptional" class="section level2">
<h2>Proptional</h2>
<p>The random effect structure <code>propto</code> fits multivariate random effects proportional to a known variance-covariance matrix. One way the <code>propto</code> structure can be used is in phylogenetic analysis where a random effect proportional to a phylogenetic variance-covariance matrix aims to account for the correlation across species due to their shared ancestry. For example, the <code>carni70</code> data set from the <code>ade4</code> package describes the phylogeny along with the geographic range and body size of 70 carnivora. To account for the dependence among species due to shared ancestral history we can include a phylogenetically structured error term in the model via the <code>propto</code> structure as follows:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">require</span>(ade4)
<span class="kw">require</span>(ape)
<span class="kw">data</span>(carni70)
carnidat &lt;-<span class="st"> </span><span class="kw">data.frame</span>(<span class="dt">species =</span> <span class="kw">rownames</span>(carni70<span class="op">$</span>tab), carni70<span class="op">$</span>tab)
tree &lt;-<span class="st"> </span><span class="kw">read.tree</span>(<span class="dt">text=</span>carni70<span class="op">$</span>tre)
phylo_varcov &lt;-<span class="st"> </span><span class="kw">vcv</span>(tree)<span class="co"># phylogenetic variance-covariance matrix</span>
<span class="co"># row/column names of phylo_varcov must match factor levels in data</span>
<span class="kw">rownames</span>(phylo_varcov) &lt;-<span class="st"> </span><span class="kw">colnames</span>(<span class="kw">rownames</span>(phylo_varcov)) &lt;-<span class="st"> </span><span class="kw">gsub</span>(<span class="st">&quot;.&quot;</span>, <span class="st">&quot;_&quot;</span>, <span class="kw">rownames</span>(phylo_varcov)) 
carnidat<span class="op">$</span>dummy &lt;-<span class="st"> </span><span class="kw">factor</span>(<span class="dv">1</span>) <span class="co"># a dummy grouping variable must be added to the dataset</span>

fit_phylo &lt;-<span class="st"> </span><span class="kw">glmmTMB</span>(<span class="kw">log</span>(range) <span class="op">~</span><span class="st"> </span><span class="kw">log</span>(size) <span class="op">+</span><span class="st"> </span><span class="kw">propto</span>(<span class="dv">0</span> <span class="op">+</span><span class="st"> </span>species <span class="op">|</span><span class="st"> </span>dummy, phylo_varcov),
                     <span class="dt">data =</span> carnidat)</code></pre></div>
<p><code>dummy</code> is a dummy variable equal to one for all observations to specify that all observations belong to the same cluster. The intercept term is excluded from the proportional random effect -- this is to ensure that each random effect corresponds to the effect for its corresponding species. It is important that the row/columns names of the matrix match the terms in the random effect (see <a href="#construction-of-structured-covariance-matrices">Construction of structured covariance matrices</a> for how the terms are constructed).</p>
</div>
<div id="construction-of-structured-covariance-matrices" class="section level2">
<h2>Construction of structured covariance matrices</h2>
<p>This section will explain how covariance matrices are constructed &quot;under the hood&quot;, and in particular why the <code>0+</code> term is generally required in models for temporal and spatial covariances.</p>
<p>Probably the key insight here is that the terms in a random effect (the <code>f</code> formula in a random-effects term <code>(f|g)</code> are expanded using the base-R machinery for regression model formulas. In the case of an intercept-only random effect <code>(1|g)</code>, the model matrix is a column of ones, so we have a <span class="math inline">\(1 \times 1\)</span> covariance matrix - a single variance. For a random-slopes model <code>(x|g)</code> or <code>(1+x|g)</code>, where <code>x</code> is a numeric variable, the model matrix has two columns, a column of ones and column of observed values of <code>x</code>, and the covariance matrix is <span class="math inline">\(2 \times 2\)</span> (intercept variance, slope variance, intercept-slope covariance).</p>
<p>Things start to get weird when we have <code>(f|g)</code> (or <code>(1+f|g)</code>) where <code>f</code> is a factor (representing a categorical variable). R uses <em>treatment contrasts</em> by default; if the observed values of <code>f</code> are <code>c(&quot;c&quot;, &quot;s&quot;, &quot;v&quot;)</code><a href="#fn2" class="footnoteRef" id="fnref2"><sup>2</sup></a> the corresponding factor will have a baseline level of <code>&quot;c&quot;</code> by default, and the model matrix will be:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">model.matrix</span>(<span class="op">~</span>f, <span class="kw">data.frame</span>(<span class="dt">f=</span><span class="kw">factor</span>(<span class="kw">c</span>(<span class="st">&quot;c&quot;</span>, <span class="st">&quot;s&quot;</span>, <span class="st">&quot;v&quot;</span>))))</code></pre></div>
<pre><code>##   (Intercept) fs fv
## 1           1  0  0
## 2           1  1  0
## 3           1  0  1
## attr(,&quot;assign&quot;)
## [1] 0 1 1
## attr(,&quot;contrasts&quot;)
## attr(,&quot;contrasts&quot;)$f
## [1] &quot;contr.treatment&quot;</code></pre>
<p>i.e., an intercept (which corresponds to the predicted mean value for observations in group <code>c</code>) followed by dummy variables that describe contrasts between the predicted mean values for <code>s</code> and <code>c</code> (<code>fs</code>) and between <code>v</code> and <code>c</code> (<code>fv</code>). The covariance matrix is <span class="math inline">\(3 \times 3\)</span> and looks like this:</p>
<p><span class="math display">\[
\newcommand{\ssub}[1]{\sigma^2_{\textrm{#1}}}
\newcommand{\csub}[2]{\sigma^2_{\textrm{#1}, \textrm{#2}}}
\left(
\begin{array}{ccc}
\ssub{c} &amp; \csub{c}{s-c} &amp; \csub{c}{v-c} \\
\csub{c}{s-c} &amp; \ssub{s-c} &amp; \csub{s-c}{v-c} \\
\csub{c}{v-c} &amp; \csub{s-c}{v-c} &amp; \ssub{v-c}
\end{array}
\right)
\]</span></p>
<p>This might be OK for some problems, but the parameters of the model will often be more interpretable if we remove the intercept from the formula:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">model.matrix</span>(<span class="op">~</span><span class="dv">0</span><span class="op">+</span>f, <span class="kw">data.frame</span>(<span class="dt">f=</span><span class="kw">factor</span>(<span class="kw">c</span>(<span class="st">&quot;c&quot;</span>, <span class="st">&quot;s&quot;</span>, <span class="st">&quot;v&quot;</span>))))</code></pre></div>
<pre><code>##   fc fs fv
## 1  1  0  0
## 2  0  1  0
## 3  0  0  1
## attr(,&quot;assign&quot;)
## [1] 1 1 1
## attr(,&quot;contrasts&quot;)
## attr(,&quot;contrasts&quot;)$f
## [1] &quot;contr.treatment&quot;</code></pre>
<p>The corresponding covariance matrix is</p>
<p><span class="math display">\[
\left(
\begin{array}{ccc}
\ssub{c} &amp; \csub{c}{s} &amp; \csub{c}{v} \\
\csub{c}{s} &amp; \ssub{s} &amp; \csub{s}{v} \\
\csub{c}{v} &amp; \csub{s}{v} &amp; \ssub{v}
\end{array}
\right)
\]</span></p>
<p>This is easier to understand (the elements are the variances of the intercepts for each group, and the covariances between intercepts of different groups). If we use an 'unstructured' model (<code>us(f|g)</code>, or just plain <code>(f|g)</code>), then this reparameterization won't make any difference in the overall model fit. However, if we use a structured covariance model, then the choice matters: for example, the two models <code>diag(f|g)</code> and <code>diag(0+f|g)</code> give rise to the covariance matrices</p>
<p><span class="math display">\[
\left(
\begin{array}{ccc}
\ssub{c} &amp; 0 &amp; 0 \\
0 &amp; \ssub{s-c} &amp; 0 \\
0 &amp; 0 &amp; \ssub{v-c}
\end{array}
\right)
\;\; \textrm{vs} \;\;
\left(
\begin{array}{ccc}
\ssub{c} &amp; 0 &amp; 0 \\
0 &amp; \ssub{s} &amp; 0 \\
0 &amp; 0 &amp; \ssub{v}
\end{array}
\right)
\]</span></p>
<p>which <em>cannot</em> be made equivalent by changing parameters.</p>
<p>What does this have to do with temporally/spatially structured covariance matrices? In this case, if two points are separated by a distance <span class="math inline">\(d_{ij}\)</span> (in space or time), we typically want their correlation to be <span class="math inline">\(\sigma^2 \rho(d_{ij})\)</span>, where <span class="math inline">\(\rho()\)</span> is a temporal or spatial autocorrelation function (e.g. in the AR1 model, <span class="math inline">\(\rho(d_{ij}) = \phi^{d_{ij}}\)</span>). So we want to set up a covariance matrix</p>
<p><span class="math display">\[
\sigma^2
\left(
\begin{array}{cccc}
1            &amp; \rho(d_{12}) &amp; \rho(d_{13}) &amp; \ldots \\
\rho(d_{12}) &amp;     1        &amp; \rho(d_{23}) &amp; \ldots \\
\rho(d_{13}) &amp; \rho(d_{23}) &amp; 1            &amp; \ldots \\
\vdots       &amp; \vdots       &amp; \vdots       &amp; \ddots
\end{array}
\right)
\]</span></p>
<p>How <code>glmmTMB</code> actually does this internally is to</p>
<ul>
<li>treat the temporal/spatial locations as a factor to construct the data structure for a <span class="math inline">\(n \times n\)</span> covariance matrix (where <span class="math inline">\(n\)</span> is the number of unique locations)</li>
<li>use the information encoded in the levels by <code>numFactor()</code> to compute the corresponding pairwise distances</li>
<li>use the prefix of the random term (e.g. <code>ar1</code> or <code>ou</code>) and the autocorrelation parameters (drawn from the parameter vector) to specify the autocorrelation function</li>
<li>use the autocorrelation function and the distances to fill in the values in the correlation matrix</li>
<li>multiply the correlation matrix by the variance (also drawn from the parameter vector) to compute the covariance matrix</li>
</ul>
<p>In order for this to work, we need the <span class="math inline">\(i^\textrm{th}\)</span> column of the corresponding model matrix to correspond to an indicator variable for whether an observation is at the <span class="math inline">\(i^\textrm{th}\)</span> location --- <em>not</em> to a contrast between the <span class="math inline">\(i\textrm{th}\)</span> level and the first level! So, we want to use e.g. <code>ar1(0 + time|g)</code>, <em>not</em> <code>ar1(time|g)</code> (which is equivalent to <code>ar1(1+time|g)</code>).</p>
</div>
<div id="references" class="section level2 unnumbered">
<h2>References</h2>
<div id="refs" class="references">
<div id="ref-hui2015model">
<p>Hui, Francis KC, Sara Taskinen, Shirley Pledger, Scott D Foster, and David I Warton. 2015. “Model-Based Approaches to Unconstrained Ordination.” <em>Methods in Ecology and Evolution</em> 6 (4): 399–411. doi:<a href="https://doi.org/10.1111/2041-210X.12236">10.1111/2041-210X.12236</a>.</p>
</div>
<div id="ref-niku2019gllvm">
<p>Niku, Jenni, Francis K. C. Hui, Sara Taskinen, and David I. Warton. 2019. “Gllvm: Fast Analysis of Multivariate Abundance Data with Generalized Linear Latent Variable Models in R.” <em>Methods in Ecology and Evolution</em> 10 (12): 2173–82. doi:<a href="https://doi.org/10.1111/2041-210X.13303">10.1111/2041-210X.13303</a>.</p>
</div>
</div>
</div>
<div class="footnotes">
<hr />
<ol>
<li id="fn1"><p>Why do we do this? Consider the slightly simplified case of a <em>homogeneous</em> Toeplitz structure where all of the variance parameters are identical. The diagonal elements of the covariance matrix are equal to <span class="math inline">\(\sigma_t^2\)</span>, the off-diagonals to <span class="math inline">\(\sigma_t^2 \cdot \rho(|i-j|)\)</span>. If we add a residual variance to the model then the diagonal of the combined covariance matrix becomes <span class="math inline">\(\sigma_t^2 + \sigma_r^2\)</span> and the off-diagonals become <span class="math inline">\((\sigma_t^2 + \sigma_r^2) \rho(|i-j|)\)</span>. However, by reparameterizing the Toeplitz model to <span class="math inline">\(\{{\sigma_t^2}' = \sigma_t^2 + \sigma_r^2, \rho'(|i-j|) = \rho(|i-j|) \cdot \frac{\sigma_t^2}{\sigma_t^2 + \sigma_r^2}\}\)</span> --- that is, by inflating the variance and deflating the correlation parameters --- we can get back to an equivalent Toeplitz model. This implies that the residual variance and the Toeplitz covariance parameters are jointly unidentifiable, which is likely to make problems for the fitting procedure.<a href="#fnref1">↩</a></p></li>
<li id="fn2"><p>chocolate, strawberry, vanilla<a href="#fnref2">↩</a></p></li>
</ol>
</div>



<!-- code folding -->


<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    script.src  = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML";
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>

</body>
</html>
