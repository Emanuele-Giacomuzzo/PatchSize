---
title: "Data manipulation: PatchSizePilot"
author: "Emanuele Giacomuzzo"
date: "2022-08-04"
output: html_document
editor_options: 
  chunk_output_type: console
---

### Patches (`ds_patches`)

-   Every row is a patch at a certain time point.
-   The value of different videos have been already averaged.

```{r}
time_points_ds = NULL
for (time_point in first_time_point:last_time_point) {
  
  load(here("data", "population", paste0(paste0("t",time_point),".RData")))
  
  time_points_ds[[time_point+1]] = pop_output %>%
    left_join(read.csv(here("data", 
                            "population_species_ID_Ble", 
                            paste0("species_ID_t", time_point, ".csv"))) %>%
                select(file,
                       Ble),
              by = "file") %>%
    left_join(read.csv(here("data", 
                            "population_species_ID", 
                            paste0("species_ID_t", time_point, ".csv"))) %>%
                select(file,
                       Cep:Tet),
              by = "file")
  
  if(time_point == 0) {
    
    time_points_ds[[time_point+1]] = time_points_ds[[time_point+1]][rep(row.names(pop_output),
                                                                        nrow(culture_info)), ] %>%
      arrange(file) %>%
      mutate(culture_ID = rep(1 :n_cultures,
                              times = n_videos_taken_t0))
  }
  
  time_points_ds[[time_point+1]] = time_points_ds[[time_point+1]] %>%
    select(file,
           culture_ID,
           bioarea_per_volume,
           indiv_per_volume,
           protist_species[1]:protist_species[n_protist_species]) %>%
    mutate(time_point = time_point,
           day = sampling_days[time_point + 1])
  
}

ds_patches = time_points_ds %>%
  bind_rows() %>%
  left_join(culture_info,
            by = "culture_ID")
```

```{r}
ds_patches = ds_patches %>%
  filter(! culture_ID %in% ecosystems_to_take_off)
```

```{r}

### Average videos & get rid of useless columns
ds_patches = ds_patches %>%
  group_by(
    culture_ID,
    patch_size,
    patch_size_volume,
    disturbance,
    metaecosystem_type,
    time_point,
    day,
    metaecosystem,
    system_nr,
    eco_metaeco_type
  ) %>%
  summarise(
    bioarea_per_volume = mean(bioarea_per_volume),
    indiv_per_volume = mean(indiv_per_volume),
    Ble = mean(Ble),
    Cep = mean(Cep),
    Col = mean(Col),
    Eug = mean(Eug),
    Eup = mean(Eup),
    Lox = mean(Lox),
    Pau = mean(Pau),
    Pca = mean(Pca),
    Spi = mean(Spi),
    Spi_te = mean(Spi_te),
    Tet = mean(Tet)
  ) %>%
  ungroup()
```

```{r}

#Change all the measures to ml
#1. Bioarea_per_volume in the original data is in µm2 / µl -> convert to µm2 / ml
#2. Indiv_per_volume & all protists in the original data are in individuals / µl -> convert to individuals / ml
ds_patches = ds_patches %>%
  mutate(bioarea_per_volume = bioarea_per_volume / 1000,
         indiv_per_volume = indiv_per_volume / 1000,
         Ble = Ble / 1000,
         Cep = Cep / 1000,
         Col = Col / 1000,
         Eug = Eug / 1000,
         Eup = Eup / 1000,
         Lox = Lox / 1000,
         Pau = Pau / 1000,
         Pca = Pca / 1000,
         Spi = Spi / 1000,
         Spi_te = Spi_te / 1000,
         Tet = Tet / 1000)
```

```{r}

#Calculate total response variable for the whole patch
ds_patches = ds_patches %>%
  mutate(bioarea_tot = bioarea_per_volume * patch_size_volume,
         indiv_tot = indiv_per_volume * patch_size_volume,
         Ble_tot = Ble * patch_size_volume,
         Cep_tot = Cep * patch_size_volume,
         Col_tot = Col * patch_size_volume,
         Eug_tot = Eug * patch_size_volume,
         Eup_tot = Eup * patch_size_volume,
         Lox_tot = Lox * patch_size_volume,
         Pau_tot = Pau * patch_size_volume,
         Pca_tot = Pca * patch_size_volume,
         Spi_tot = Spi * patch_size_volume,
         Spi_te_tot = Spi_te * patch_size_volume,
         Tet_tot = Tet * patch_size_volume)
```

```{r}

#Calculate species dominance
ds_patches = ds_patches %>%
  mutate(Ble_dominance = (Ble / indiv_per_volume) * 100,
         Cep_dominance = (Cep / indiv_per_volume) * 100,
         Col_dominance = (Col / indiv_per_volume) * 100,
         Eug_dominance = (Eug / indiv_per_volume) * 100,
         Eup_dominance = (Eup  / indiv_per_volume) * 100,
         Lox_dominance = (Lox / indiv_per_volume) * 100,
         Pau_dominance = (Pau / indiv_per_volume) * 100,
         Pca_dominance = (Pca / indiv_per_volume) * 100,
         Spi_dominance = (Spi / indiv_per_volume) * 100,
         Spi_te_dominance = (Spi_te / indiv_per_volume) * 100,
         Tet_dominance = (Tet / indiv_per_volume) * 100)
```

```{r calculate_alpha_diversity_(ds_patches)}

#Calculate alpha diversity (shannon, simpson, inv simpson, evenness)
ds_patches$species_richness = NA
ds_patches$shannon = NA
ds_patches$simpson = NA
ds_patches$inv_simpson = NA
ds_patches$evenness_pielou = NA


for (row in 1:nrow(ds_patches)) {
  
  species_vector = ds_patches %>%
    slice(row) %>%
    select(protist_species[1]:protist_species[n_protist_species])
  
  ds_patches[row,]$species_richness = species_vector %>%
    mutate_at(vars(protist_species),
              funs(ifelse(. > 0,
                          yes = 1,
                          no = 0))) %>%
    rowSums()
  
  ds_patches[row, ]$simpson = diversity(species_vector,
                                        index = "simpson")
  
  ds_patches[row, ]$shannon = diversity(species_vector,
                                        index = "shannon")
  
  ds_patches[row, ]$inv_simpson = diversity(species_vector,
                                            index = "invsimpson")
  
  ds_patches[row, ]$evenness_pielou = diversity(species_vector) / 
                                      log(specnumber(species_vector))
  
}
```

```{r add_baselines_(ds_patches)}

#Add baselines (from t1).
baselines <- ds_patches %>%
  filter(time_point == 1) %>%
  group_by(culture_ID) %>%
  summarise(across(vars, .names = "baseline_{.col}"))

ds_patches = full_join(ds_patches, baselines)
```

```{r}

#Rename patches
ds_patches$eco_metaeco_type <- recode(
  ds_patches$eco_metaeco_type,
  "S" = "Small isolated",
  "S (S_S)" = "Small connected to small",
  "S (S_L)" = "Small connected to large",
  "M" = "Medium isolated",
  "M (M_M)" = "Medium connected to medium",
  "L" = "Large isolated",
  "L (L_L)" = "Large connected to large",
  "L (S_L)" = "Large connected to small"
)
```

```{r}
#Reorder patches
ds_patches = ds_patches %>%
  mutate(eco_metaeco_type = factor(
    eco_metaeco_type,
    levels = c(
      "Small isolated",
      "Small connected to small",
      "Small connected to large",
      "Medium isolated",
      "Medium connected to medium",
      "Large isolated",
      "Large connected to large",
      "Large connected to small"
    )
  ))
```

```{r save_ds_biomas_abund}
saveRDS(ds_patches, file = here("results", "ds_patches.RData"))
```