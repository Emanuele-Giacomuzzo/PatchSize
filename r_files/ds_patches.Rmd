---
title: "Data manipulation: PatchSizePilot"
author: "Emanuele Giacomuzzo"
date: "2022-08-04"
output: html_document
editor_options: 
  chunk_output_type: console
---

After the dataset has been assembled

-   Every row is a patch at a certain time point.
-   The value of different videos have been already averaged.

```{r}
#Assemble dataset
ds_patches = import.protist.pop.data(culture_info,
                                     first_time_point,
                                     last_time_point,
                                     protist_species)
```

```{r}
#Reorder dataset
ds_patches = ds_patches %>%
  select(time_point,
         day,
         file,
         culture_ID,
         system_nr,
         disturbance,
         eco_metaeco_type,
         patch_size,
         patch_size_volume,
         metaecosystem,
         metaecosystem_type,
         bioarea_per_volume,
         indiv_per_volume,
         all_of(protist_species),
         Ble_main_analysis,
         Cep_main_analysis,
         Spi_main_analysis)
```

```{r}
#Take off problematic videos
ds_patches = ds_patches %>%
  filter(!(time_point %in% videos_to_take_off$time_point & 
           file %in% videos_to_take_off$file))

#Take off problematic cultures 
ds_patches = ds_patches %>%
  filter(! culture_ID %in% patches_to_take_off)
```

```{r}
#Rename columns
  ds_patches = ds_patches %>%
    rename(
      patch_type = eco_metaeco_type,
      indiv_per_μL = indiv_per_volume,
      bioarea_µm2_per_μL = bioarea_per_volume,
      patch_size_ml = patch_size_volume
    ) %>%
    rename_with( ~ paste0(., "_indiv_per_μL"), any_of(
      c(
        protist_species,
        "Ble_low_threshold_analysis",
        "Cep_low_threshold_analysis",
        "Spi_low_threshold_analysis"
      )
    ))

#Rename patches
ds_patches$patch_type <- recode(
  ds_patches$patch_type,
  "S" = "Small isolated",
  "S (S_S)" = "Small connected to small",
  "S (S_L)" = "Small connected to large",
  "M" = "Medium isolated",
  "M (M_M)" = "Medium connected to medium",
  "L" = "Large isolated",
  "L (L_L)" = "Large connected to large",
  "L (S_L)" = "Large connected to small"
)

#Rename patch sizes
ds_patches$patch_size <- recode(
  ds_patches$patch_size,
  "S" = "Small",
  "M" = "Medium",
  "L" = "Large"
)

#Rename the meta-ecosystems
ds_patches$metaecosystem_type <- recode(
  ds_patches$metaecosystem_type,
  "S_S" = "Small-Small meta-ecosystem",
  "M_M" = "Medium-Medium meta-ecosystem",
  "L_L" = "Large-Large meta-ecosystem",
  "S_L" = "Small-Large meta-ecosystem"
)
```

```{r}
#Reorder patches
ds_patches = ds_patches %>%
  mutate(patch_type = factor(
    patch_type,
    levels = c(
      "Small isolated",
      "Small connected to small",
      "Small connected to large",
      "Medium isolated",
      "Medium connected to medium",
      "Large isolated",
      "Large connected to large",
      "Large connected to small"
    )
  ))

#Reorder the meta-ecosystems
ds_patches = ds_patches %>%
  mutate(metaecosystem_type = factor(
    metaecosystem_type,
    levels = c(
      "Small-Small meta-ecosystem",
      "Medium-Medium meta-ecosystem",
      "Medium-Medium isolated",
      "Large-Large meta-ecosystem",
      "Small-Large meta-ecosystem",
      "Small-Large isolated"
    )
  ))
```

```{r}
#Add the column size_of_the_connected_patch
ds_patches$size_of_the_connected_patch = NA
ds_patches$size_of_the_connected_patch[ds_patches$patch_type == "Small connected to small"] = "Small"
ds_patches$size_of_the_connected_patch[ds_patches$patch_type == "Small connected to large"] = "Large"
ds_patches$size_of_the_connected_patch[ds_patches$patch_type == "Medium connected to medium"] = "Medium"
ds_patches$size_of_the_connected_patch[ds_patches$patch_type == "Large connected to large"] = "Large"
ds_patches$size_of_the_connected_patch[ds_patches$patch_type == "Large connected to small"] = "Small"

#Change all the measures to ml
ds_patches = ds_patches %>%
  mutate(bioarea_µm2_per_ml = bioarea_µm2_per_μL * 1000,
         indiv_per_ml = indiv_per_μL * 1000,
         Ble_indiv_per_ml = Ble_indiv_per_μL * 1000,
         Cep_indiv_per_ml = Cep_indiv_per_μL * 1000,
         Col_indiv_per_ml = Col_indiv_per_μL * 1000,
         Eug_indiv_per_ml = Eug_indiv_per_μL * 1000,
         Eup_indiv_per_ml = Eup_indiv_per_μL * 1000,
         Lox_indiv_per_ml = Lox_indiv_per_μL * 1000,
         Pau_indiv_per_ml = Pau_indiv_per_μL * 1000,
         Pca_indiv_per_ml = Pca_indiv_per_μL * 1000,
         Spi_indiv_per_ml = Spi_indiv_per_μL * 1000,
         Spi_te_indiv_per_ml = Spi_te_indiv_per_μL * 1000,
         Tet_indiv_per_ml = Tet_indiv_per_μL * 1000)

#Calculate total response variable for the whole patch
ds_patches = ds_patches %>%
  mutate(bioarea_tot_µm2 = bioarea_µm2_per_ml * patch_size_ml,
         indiv_tot = indiv_per_ml * patch_size_ml,
         Ble_tot_indiv = Ble_indiv_per_ml * patch_size_ml,
         Cep_tot_indiv = Cep_indiv_per_ml * patch_size_ml,
         Col_tot_indiv = Col_indiv_per_ml * patch_size_ml,
         Eug_tot_indiv = Eug_indiv_per_ml * patch_size_ml,
         Eup_tot_indiv = Eup_indiv_per_ml * patch_size_ml,
         Lox_tot_indiv = Lox_indiv_per_ml * patch_size_ml,
         Pau_tot_indiv = Pau_indiv_per_ml * patch_size_ml,
         Pca_tot_indiv = Pca_indiv_per_ml * patch_size_ml,
         Spi_tot_indiv = Spi_indiv_per_ml * patch_size_ml,
         Spi_te_tot_indiv = Spi_te_indiv_per_ml * patch_size_ml,
         Tet_tot_indiv = Tet_indiv_per_ml * patch_size_ml)

#Calculate individuals per ml (based on a combination of the two analyses).
ds_patches = ds_patches %>%
  mutate(indiv_per_ml = !!rlang::parse_expr(paste(paste0(protist_species, "_indiv_per_ml"), collapse = " + ")))

#Calculate species dominance
ds_patches = ds_patches %>%
  mutate(across(all_of(protist_species_indiv_per_ml), 
                list(dominance = ~ (. / indiv_per_ml) * 100), 
                .names = "{col}_dominance"))
```

```{r}
#Rearrange
ds_patches = ds_patches %>%
  select(time_point,
         day,
         file,
         culture_ID,
         system_nr,
         disturbance,
         patch_type,
         patch_size,
         patch_size_ml,
         size_of_the_connected_patch,
         metaecosystem,
         metaecosystem_type,
         bioarea_µm2_per_ml,
         bioarea_tot_µm2,
         indiv_per_ml,
         indiv_tot,
         all_of(protist_species_indiv_per_ml),
         all_of(protist_species_total),
         all_of(protist_species_dominance))
```

```{r}
### Average videos
ds_patches = ds_patches %>%
  group_by(across(all_of(columns_patches))) %>%
  summarise(across(contains("_per_ml"), mean),
            across(contains("_tot"), mean)) %>%
  ungroup()
```

```{r}
#Calculate alpha diversity.
#This includes shannon, simpson, inv simpson, evenness.
ds_patches = calculate.alpha.diversity()

#Calculate divergence from isolated. 
#This is the difference in community composition of each culture from the other isolated cultures (Bray-Curtis). The warning appears because in some cases we are comparing with a communities that has completely crashed and so Bray-Curtis is 1.
ds_patches = calculate.divergence.from.isolated()

#Calculate temporal divergence. 
#This is the difference in community composition of each culture from its previous time point (Bray-Curtis). The warning appears because in some cases we are comparing with a communities that has completely crashed and so Bray-Curtis is 1. 
ds_patches = calculate.temporal.divergence()

#Calculate baselines. 
#To consider the initial values for different cultures when analyzing their temporal trends, we add baselines from time point 1. These baselines are used because at time point 0, we only measured the community of the large bottle that the experiment was assembled from. Additionally, the first perturbation had already occurred by time point 2, which is the starting point for our models.
baselines <- ds_patches %>%
  filter(time_point == 1) %>%
  group_by(culture_ID) %>%
  summarise(across(variables_patches, .names = "baseline_{.col}"))
ds_patches = full_join(ds_patches, baselines)
```

```{r}
#Finalise the dataset by arranging the columns in the order that makes the most sense.
ds_patches = ds_patches %>%
  select(any_of(c(
    columns_patches,
    variables_patches,
    baseline_columns
  )))
```