---
title: "Data Regional Biomass"
output: html_document
date: "2022-11-22"
editor_options: 
  chunk_output_type: console
---

-   Each row is a meta-ecosystem.

-   It contains also "fake" meta-ecosystems which I created from isolated patches (`metaecosystem type = Small-Large isolated` & `metaecosystem type = Medium-Medium isolated`).

- Warning appear after the following code, as:
(i) alpha diversity is computed for a culture that is totally crashed, so it has not meaning.
(ii) beta diversity is computed between a culture that is still alive and one that is totally crashed. Because one of the cultures is totally crashed, the Bray-Curtis index is 1.

```{r}

#Compute meta-ecosystems  for each time point 

ds_metaecosystems = NULL
row_n = 0
for (combination in 1:n_patches_combinations) {
  for (time_point_input in time_points) {
    row_n = row_n + 1
    
    current_day = sampling_days[time_point_input + 1]
    current_system_nr = patch_combinations[combination, ]$system_nr
    current_combination = patch_combinations[combination, ]$patches_combined
    current_disturbance = patch_combinations[combination, ]$disturbance
    current_metaeco_type = patch_combinations[combination, ]$metaecosystem_type
    current_IDs = c(patch_combinations[combination, ]$ID_first_patch,
                    patch_combinations[combination, ]$ID_second_patch)
    
    if (current_system_nr %in% metaecosystems_to_take_off)
      next
    
    if (current_IDs[1] == current_IDs[2])
      next
    
    species_vector_two_patches = ds_patches %>%
      filter(time_point == time_point_input,
             culture_ID %in% current_IDs) %>%
      ungroup() %>%
      select(all_of(protist_species_indiv_per_ml))
    
    absence_presence_two_patches <-
      ifelse(species_vector_two_patches > 0, 1, 0)
    
    #Alpha diversity: Shannon (mean between the two patches)
    shannon_patch_1 = diversity(species_vector_two_patches[1, ], index = "shannon")
    shannon_patch_2 = diversity(species_vector_two_patches[2, ], index = "shannon")
    shannon_value = (shannon_patch_1 + shannon_patch_2) / 2
    
    #Alpha diversity: Species richness (mean between the two patches)
    richness_patch_1 = specnumber(species_vector_two_patches[1, ])
    richness_patch_2 = specnumber(species_vector_two_patches[2, ])
    mean_richness_value = (richness_patch_1 + richness_patch_2) / 2
    
    #Beta diversity: Jaccard
    jaccard_index_value = vegdist(species_vector_two_patches,
                                  method = "jaccard") %>%
      as.numeric()
    
    #Beta diversity: Bray Curtis
    bray_curtis_value = vegdist(species_vector_two_patches,
                                method = "bray") %>%
      as.numeric()
    
    #Beta diversity: partitioning of beta diversity from Sorensen index into turnover (Simpson pair-wise dissimilarity) and nestedness (nestedness-fraction of Sorensen)
    betapart_core_object = betapart.core(absence_presence_two_patches)
    beta_spatial_turnover_value = beta.pair(betapart_core_object)$beta.sim %>% as.double()
    beta_nestedness_value = beta.pair(betapart_core_object)$beta.sne %>% as.double()
    beta_total_value = beta.pair(betapart_core_object)$beta.sor %>% as.double()
    
    #Gamma diversity: Meta-ecosystem richness
    metaecosystem_richness_value = colSums(species_vector_two_patches) %>%
      specnumber()
    
    #Put everything together
    ds_metaecosystems[[row_n]] = ds_patches %>%
      filter(culture_ID %in% current_IDs,
             time_point == time_point_input) %>%
      summarise(
        total_metaecosystem_bioarea_mm2 = sum(bioarea_tot_mm2),
        total_metaecosystem_Ble_indiv = sum(Ble_tot_indiv),
        total_metaecosystem_Cep_indiv = sum(Cep_tot_indiv),
        total_metaecosystem_Col_indiv = sum(Col_tot_indiv),
        total_metaecosystem_Eug_indiv = sum(Eug_tot_indiv),
        total_metaecosystem_Eup_indiv = sum(Eup_tot_indiv),
        total_metaecosystem_Lox_indiv = sum(Lox_tot_indiv),
        total_metaecosystem_Pau_indiv = sum(Pau_tot_indiv),
        total_metaecosystem_Pca_indiv = sum(Pca_tot_indiv),
        total_metaecosystem_Spi_indiv = sum(Spi_tot_indiv),
        total_metaecosystem_Spi_te_indiv = sum(Spi_te_tot_indiv),
        total_metaecosystem_Tet_indiv = sum(Tet_tot_indiv)
      ) %>%
      mutate(
        system_nr = current_system_nr,
        patches_combined = current_combination,
        metaecosystem_type = current_metaeco_type,
        disturbance = current_disturbance,
        time_point = time_point_input,
        day = current_day,
        jaccard_index = jaccard_index_value,
        bray_curtis = bray_curtis_value,
        beta_spatial_turnover = beta_spatial_turnover_value,
        beta_nestedness = beta_nestedness_value,
        beta_total = beta_total_value,
        metaecosystem_richness = metaecosystem_richness_value,
        mean_shannon = shannon_value,
        mean_richness = mean_richness_value
      ) %>%
      ungroup()
    
  }
}

ds_metaecosystems = ds_metaecosystems %>%
  bind_rows() %>%
  as.data.frame() %>%
  select(
    time_point,
    day,
    system_nr,
    patches_combined,
    disturbance,
    metaecosystem_type,
    mean_shannon,
    mean_richness,
    jaccard_index,
    bray_curtis,
    beta_spatial_turnover,
    beta_nestedness,
    beta_total,
    metaecosystem_richness,
    total_metaecosystem_bioarea_mm2,
    paste0("total_metaecosystem_", protist_species, "_indiv")
  )
```

```{r}
expect_equal(nrow(ds_metaecosystems), 
             n_time_points * n_patches_combinations)
```

```{r}
#Add column connection

ds_metaecosystems$connection <-
  ifelse(
    ds_metaecosystems$metaecosystem_type %in% c("Medium-Medium isolated",
                                                "Small-Large isolated"),
    yes = "isolated",
    no = "connected"
  )
```

```{r}
#Add column patch size symmetry

ds_metaecosystems$patch_size_symmetry <-
  ifelse(
    ds_metaecosystems$metaecosystem_type %in% c("Small-Large isolated",
                                                "Small-Large meta-ecosystem"),
    yes = "asymmetric",
    no = "symmetric"
  )

```

```{r}
#Reorder the meta-ecosystems
ds_metaecosystems = ds_metaecosystems %>%
  mutate(metaecosystem_type = factor(metaecosystem_type,
                                     levels = metaecosystem_types_ordered))
```

```{r}
#Join ...
full_join(ds_metaecosystems,
          isolated_combinations_sets)
```

```{r}
ds_metaecosystems <- ds_metaecosystems %>%
  mutate(
    type = case_when(
      metaecosystem_type == "Small-Large isolated" ~ "asymmetric",
      metaecosystem_type == "Small-Large meta-ecosystem" ~ "asymmetric",
      metaecosystem_type == "Medium-Medium isolated" ~ "symmetric",
      metaecosystem_type == "Medium-Medium meta-ecosystem" ~ "symmetric",
      metaecosystem_type == "Small-Small meta-ecosystem" ~ "Small-Small",
      metaecosystem_type == "Medium-Medium meta-ecosystem" ~ "Medium-Medium"
    ))
```

