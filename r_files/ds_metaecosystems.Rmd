---
title: "Data Regional Biomass"
output: html_document
date: "2022-11-22"
editor_options: 
  chunk_output_type: console
---

-   Each row is a meta-ecosystem.

-   It contains also "fake" meta-ecosystems which I created from isolated patches (`metaecosystem type = Small-Large isolated` & `metaecosystem type = Medium-Medium isolated`).

```{r}
### Create a data frame with all the experimental meta-ecosystems and all the possible meta-ecosystems from isolated
culture_ID_isolated_S_low = ds_patches %>%
  filter(patch_type == "Small isolated",
         disturbance == "low") %>%
  pull(culture_ID) %>%
  unique()

culture_ID_isolated_L_low = ds_patches %>%
  filter(patch_type == "Large isolated",
         disturbance == "low") %>%
  pull(culture_ID) %>%
  unique()

culture_ID_isolated_S_high = ds_patches %>%
  filter(patch_type == "Small isolated",
         disturbance == "high") %>%
  pull(culture_ID) %>%
  unique()

culture_ID_isolated_L_high = ds_patches %>%
  filter(patch_type == "Large isolated",
         disturbance == "high") %>%
  pull(culture_ID) %>%
  unique()

culture_ID_isolated_M_low = ds_patches %>%
  filter(patch_type == "Medium isolated",
         disturbance == "low") %>%
  pull(culture_ID) %>%
  unique()

culture_ID_isolated_M_high = ds_patches %>%
  filter(patch_type == "Medium isolated",
         disturbance == "high") %>%
  pull(culture_ID) %>%
  unique()

combinations_S_and_L_low = crossing(culture_ID_isolated_S_low,
                                    culture_ID_isolated_L_low) %>%
                            mutate(disturbance = "low",
                                   metaecosystem_type = "Small-Large isolated") %>%
                            rename(ID_first_patch = culture_ID_isolated_S_low,
                                   ID_second_patch = culture_ID_isolated_L_low) %>%
                            select(disturbance,
                                   metaecosystem_type,
                                   ID_first_patch,
                                   ID_second_patch)

combinations_S_and_L_high = crossing(culture_ID_isolated_S_high,
                                    culture_ID_isolated_L_high) %>%
                            mutate(disturbance = "high",
                                   metaecosystem_type = "Small-Large isolated") %>%
                            rename(ID_first_patch = culture_ID_isolated_S_high,
                                   ID_second_patch = culture_ID_isolated_L_high) %>%
                            select(disturbance,
                                   metaecosystem_type,
                                   ID_first_patch,
                                   ID_second_patch)

combinations_M_and_M_low = combinat::combn(culture_ID_isolated_M_low,
                                   m = 2) %>%
                            t() %>%
                            as.data.frame() %>%
                            rename(ID_first_patch = V1,
                                   ID_second_patch = V2) %>%
                            mutate(disturbance = "low",
                                   metaecosystem_type = "Medium-Medium isolated") %>%
                            select(disturbance,
                                   metaecosystem_type,
                                   ID_first_patch,
                                   ID_second_patch)

combinations_M_and_M_high = combinat::combn(culture_ID_isolated_M_high,
                                   m = 2) %>%
                            t() %>%
                            as.data.frame() %>%
                            rename(ID_first_patch = V1,
                                   ID_second_patch = V2) %>%
                            mutate(disturbance = "high",
                                   metaecosystem_type = "Medium-Medium isolated") %>%
                            select(disturbance,
                                   metaecosystem_type,
                                   ID_first_patch,
                                   ID_second_patch)

expect_equal(nrow(combinations_S_and_L_low),
             length(culture_ID_isolated_S_low) * length(culture_ID_isolated_L_low))

expect_equal(nrow(combinations_S_and_L_high),
             length(culture_ID_isolated_S_high) * length(culture_ID_isolated_L_high))

expect_equal(nrow(combinations_M_and_M_low),
             sum(seq(length(culture_ID_isolated_M_low) - 1)))

expect_equal(nrow(combinations_M_and_M_high),
             sum(seq(length(culture_ID_isolated_M_high) - 1)))

ID_combinations_isolated = rbind(
  combinations_S_and_L_low,
  combinations_S_and_L_high,
  combinations_M_and_M_low,
  combinations_M_and_M_high
) 

ID_combinations_isolated = ID_combinations_isolated %>%
  mutate(system_nr = 1001:(1000 + nrow(ID_combinations_isolated))) %>%
  select(system_nr,
         disturbance,
         metaecosystem_type,
         ID_first_patch,
         ID_second_patch)

ID_combinations_metaecos = ds_patches %>%
  filter(time_point == 0,
         metaecosystem == "yes") %>%
  select(system_nr,
         disturbance,
         metaecosystem_type,
         culture_ID) %>%
  group_by(system_nr,
           disturbance,
           metaecosystem_type) %>%
  summarise(ID_first_patch = (mean(culture_ID) - 0.5),
            ID_second_patch = (mean(culture_ID) + 0.5)) %>%
  as.data.frame()


ID_combinations = rbind(ID_combinations_isolated,
                        ID_combinations_metaecos)

ID_combinations$connection <-
  ifelse(
    ID_combinations$metaecosystem_type %in% c("Medium-Medium isolated",
                                                "Small-Large isolated"),
    yes = "isolated",
    no = "connected"
  )

n_patches_combinations = nrow(ID_combinations)

expect_equal(nrow(ID_combinations), 
             nrow(ID_combinations_isolated) + nrow(ID_combinations_metaecos))
```

Warning appear after the following code, as 
- alpha diversity is computed for a culture that is totally crashed, so it has not meaning.
- beta diversity is computed between a culture that is still alive and one that is totally crashed. Because one of the cultures is totally crashed, the Bray-Curtis index is 1.

```{r}
#Create the ds_metaecosystem dataset
ds_metaecosystems = create.meatecosystem.ds()

expect_equal(nrow(ds_metaecosystems), 
             n_time_points * n_patches_combinations)
```

```{r}
#Add whether systems are connected or not 
ds_metaecosystems$connection <-
  ifelse(
    ds_metaecosystems$metaecosystem_type %in% c("Medium-Medium isolated",
                                                "Small-Large isolated"),
    yes = "isolated",
    no = "connected"
  )

#Add whether patch sizes are symmetric or not
ds_metaecosystems$patch_size_symmetry <-
  ifelse(
    ds_metaecosystems$metaecosystem_type %in% c("Small-Large isolated",
                                                "Small-Large meta-ecosystem"),
    yes = "asymmetric",
    no = "symmetric"
  )
```

```{r}
#Reorder the meta-ecosystems
ds_metaecosystems = ds_metaecosystems %>%
  mutate(metaecosystem_type = factor(
    metaecosystem_type,
    levels = c(
      "Small-Small meta-ecosystem",
      "Medium-Medium meta-ecosystem",
      "Medium-Medium isolated",
      "Large-Large meta-ecosystem",
      "Small-Large meta-ecosystem",
      "Small-Large isolated"
    )
  ))
```

```{r}
#Add baselines (from t1).
baselines <- ds_metaecosystems %>%
  filter(time_point == 1) %>%
  group_by(system_nr) %>%
  summarise(across(all_of(variables_metaecos), .names = "baseline_{.col}"))

n_rows_ds_metaecosystems_before_join = nrow(ds_metaecosystems)

ds_metaecosystems = full_join(ds_metaecosystems, baselines)

expect_equal(nrow(ds_metaecosystems),
             n_rows_ds_metaecosystems_before_join)
```

```{r}
#Create combination sets (for SL isolated) where each sets contains each patch only one time. To find all combinations where all the patches are included, but only one at the time, I keep the small patches on the same order, but then I perform a permutation of the order in which large patches are arranged and coupled to the small patches. 

disturbance_nr = 0
all_sets_SL_isolated <- vector("list", 
                               length(disturbance_levels))

for (disturbance_input in disturbance_levels) {
  
  concat_permutations_large = NULL
  disturbance_nr = disturbance_nr + 1
  
  #Find culture ID of small and large patches
  ID_small_patches = ds_patches %>%
    filter(disturbance == disturbance_input,
           patch_type == "Small isolated") %>%
    pull(culture_ID) %>%
    unique()
  
  ID_large_patches = ds_patches %>%
    filter(disturbance == disturbance_input,
           patch_type == "Large isolated") %>%
    pull(culture_ID) %>%
    unique()
  
  #Force small and large patches vectors to have the same length 
  if(length(ID_large_patches) < length(ID_small_patches)) {
    ID_large_patches = c(ID_large_patches,
                         rep(
                           "Patch taken off",
                           times = length(ID_small_patches) - length(ID_large_patches)
                         ))
  }
  
  if(length(ID_small_patches) < length(ID_large_patches)) {
    ID_small_patches = c(ID_small_patches,
                         rep(
                           "Patch taken off",
                           times = length(ID_large_patches) - length(ID_small_patches)
                         ))
  }
  
  #Permutations of the large patches 
  permutations_large = permn(ID_large_patches)
  
  for(list_element in 1:length(permutations_large)){
    concat_permutations_large = c(concat_permutations_large, 
                                  permutations_large[[list_element]])
  }
  
  #Assign small patches
  all_sets_SL_isolated[[disturbance_nr]]$ID_small_patches = rep(ID_small_patches,
                                                 times = length(permutations_large))
  
  expect_equal(length(all_sets_SL_isolated[[disturbance_nr]]$ID_small_patches),
               length(ID_small_patches) * length(permutations_large))
  
  #Assign large patches 
  all_sets_SL_isolated[[disturbance_nr]]$ID_large_patches = concat_permutations_large
  
  expect_equal(length(all_sets_SL_isolated[[disturbance_nr]]$ID_large_patches),
               length(ID_large_patches) * length(permutations_large))
  
  #Assign set 
  all_sets_SL_isolated[[disturbance_nr]]$combination_set = rep(1:length(permutations_large), 
                                         each = length(ID_small_patches))
  
  expect_equal(length(all_sets_SL_isolated[[disturbance_nr]]$combination_set),
               length(ID_small_patches) * length(permutations_large))
  
  #Finalise
  all_sets_SL_isolated[[disturbance_nr]] = all_sets_SL_isolated[[disturbance_nr]] %>%
    as.data.frame() %>%
    mutate(disturbance = disturbance_input,
           metaecosystem_type = "Small-Large isolated",
           connection = "isolated"
           ) %>%
    rename(ID_first_patch = ID_small_patches,
           ID_second_patch = ID_large_patches) %>%
    select(disturbance,
           metaecosystem_type,
           ID_first_patch,
           ID_second_patch,
           connection,
           combination_set)
  
  expect_equal(nrow(all_sets_SL_isolated[[disturbance_nr]]),
               length(ID_small_patches) * length(permutations_large))
  
  all_sets_SL_isolated[[disturbance_nr]] = all_sets_SL_isolated[[disturbance_nr]] %>%
    filter(!ID_first_patch == "Patch taken off", 
           !ID_second_patch == "Patch taken off") %>%
    mutate(ID_first_patch = as.double(ID_first_patch),
           ID_second_patch = as.double(ID_second_patch))
  
  #Add to the all_sets_SL_isolated the system nr  
  ID_combinations_SL_isolated = ID_combinations %>%
    filter(disturbance == disturbance_input,
           metaecosystem_type == "Small-Large isolated")
  
  all_sets_SL_isolated[[disturbance_nr]] = full_join(all_sets_SL_isolated[[disturbance_nr]], 
                                                     ID_combinations_SL_isolated)
}

all_sets_SL_isolated_binded = all_sets_SL_isolated %>%
  bind_rows()

expect_equal(nrow(all_sets_SL_isolated_binded),
             nrow(all_sets_SL_isolated[[1]]) + nrow(all_sets_SL_isolated[[2]]))

expect_equal(
  length(
    all_sets_SL_isolated_binded %>% 
      pull(system_nr) %>% 
      unique()),
  length(
    ID_combinations %>% 
      filter(metaecosystem_type == "Small-Large isolated") %>% 
      pull(system_nr) %>% 
      unique()
    )
  )

all_sets_SL_isolated = all_sets_SL_isolated_binded
```

```{r}

#Initiate
disturbance_nr = 0
all_sets_MM_isolated <- vector("list", length(disturbance_levels))

#Find all the combination sets 
for (disturbance_input in disturbance_levels) {
  disturbance_nr = disturbance_nr + 1
  
  #Find culture ID of medium patches
  ID_medium_patches = ds_patches %>%
    filter(disturbance == disturbance_input,
           patch_type == "Medium isolated") %>%
    pull(culture_ID) %>%
    unique()
  
  #Find combinations
  ID_combinations_M_isolated = t(combn(ID_medium_patches, 2))
  
  #Initiate
  all_sets_MM_isolated_matrix = matrix(nrow = 1000,
                                       ncol = 4)
  matrix_row = 0
  for (combination_n in 1:nrow(ID_combinations_M_isolated)) {
    
    #Find IDs of the first system 
    first_system = ID_combinations_M_isolated[combination_n,]
    
    for (potential_second_system in 1:nrow(ID_combinations_M_isolated)) {
      
      if (length(intersect(first_system, ID_combinations_M_isolated[potential_second_system,])) == 0) {
        matrix_row = matrix_row + 1

        #Find IDs of the second system 
        second_system = ID_combinations_M_isolated[potential_second_system,]
        
        #Add the first and second system to the 
        all_sets_MM_isolated_matrix[matrix_row, ] = c(first_system,
                                                      second_system)
        
      }
    }
  }
  
  #Tidy the dataset with all the patch combinations 
  all_sets_MM_isolated_matrix = all_sets_MM_isolated_matrix %>% 
    as.data.frame() %>% 
    drop_na()
  
  #Reorder the dataset with all the patch combinations 
  all_sets_MM_isolated_matrix_reordered = data.frame(first_patch = NA,
                         second_patch = NA,
                         set = NA)
  
  for (row in 1:nrow(all_sets_MM_isolated_matrix)) {
    all_sets_MM_isolated_matrix_reordered = all_sets_MM_isolated_matrix_reordered %>%
      add_row(first_patch = all_sets_MM_isolated_matrix[row, 1],
              second_patch = all_sets_MM_isolated_matrix[row, 2],
              set = row) %>%
      add_row(first_patch = all_sets_MM_isolated_matrix[row, 3],
              second_patch = all_sets_MM_isolated_matrix[row, 4],
              set = row)
  }
  
  all_sets_MM_isolated[[disturbance_nr]] = all_sets_MM_isolated_matrix_reordered %>%
    slice(-1) %>% #Take off the NAs you introduced at the beginning
    mutate(disturbance = disturbance_input,
           metaecosystem_type = "Medium-Medium isolated",
           connection = "isolated")
  
  #Add to the all_sets_MM_isolated the system nr 
  ID_combinations_MM_isolated = ID_combinations_M_isolated %>%
    filter(disturbance == disturbance_input,
           metaecosystem_type == "Medium-Medium isolated")
  
  all_sets_MM_isolated[[disturbance_nr]] = full_join(all_sets_MM_isolated[[disturbance_nr]], 
                                                     ID_combinations_MM_isolated)
  
}

#Bind all sets of MM isolated
all_sets_MM_isolated_binded = all_sets_MM_isolated %>%
  bind_rows()

expect_equal(nrow(all_sets_MM_isolated_binded),
             nrow(all_sets_MM_isolated[[1]]) + nrow(all_sets_MM_isolated[[2]]))
 
expect_equal(
  length(
    all_sets_MM_isolated_binded %>%
      pull(system_nr) %>%
      unique()),
  length(
    ID_combinations_M_isolated %>%
      filter(metaecosystem_type == "Small-Large isolated") %>%
      pull(system_nr) %>%
      unique()
    )
  )

all_sets_MM_isolated = all_sets_MM_isolated_binded
```

```{r}
save(ds_metaecosystems, file = here("results", "ds", "ds_metaecosystems.RData"))
```