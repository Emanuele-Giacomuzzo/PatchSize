---
title: "Data Regional Biomass"
output: html_document
date: "2022-11-22"
editor_options: 
  chunk_output_type: console
---

-   Each row is a meta-ecosystem.

-   It contains also "fake" meta-ecosystems which I created from isolated patches (`metaecosystem type = Small-Large isolated` & `metaecosystem type = Medium-Medium isolated`).

```{r}
### Create a data frame with all the experimental meta-ecosystems and all the possible meta-ecosystems from isolated
culture_ID_isolated_S_low = ds_patches %>%
  filter(patch_type == "Small isolated",
         disturbance == "low") %>%
  pull(culture_ID) %>%
  unique()

culture_ID_isolated_L_low = ds_patches %>%
  filter(patch_type == "Large isolated",
         disturbance == "low") %>%
  pull(culture_ID) %>%
  unique()

culture_ID_isolated_S_high = ds_patches %>%
  filter(patch_type == "Small isolated",
         disturbance == "high") %>%
  pull(culture_ID) %>%
  unique()

culture_ID_isolated_L_high = ds_patches %>%
  filter(patch_type == "Large isolated",
         disturbance == "high") %>%
  pull(culture_ID) %>%
  unique()

culture_ID_isolated_M_low = ds_patches %>%
  filter(patch_type == "Medium isolated",
         disturbance == "low") %>%
  pull(culture_ID) %>%
  unique()

culture_ID_isolated_M_high = ds_patches %>%
  filter(patch_type == "Medium isolated",
         disturbance == "high") %>%
  pull(culture_ID) %>%
  unique()

combinations_S_and_L_low = crossing(culture_ID_isolated_S_low,
                                    culture_ID_isolated_L_low) %>%
                            mutate(disturbance = "low",
                                   metaecosystem_type = "Small-Large isolated") %>%
                            rename(ID_first_patch = culture_ID_isolated_S_low,
                                   ID_second_patch = culture_ID_isolated_L_low) %>%
                            select(disturbance,
                                   metaecosystem_type,
                                   ID_first_patch,
                                   ID_second_patch)

combinations_S_and_L_high = crossing(culture_ID_isolated_S_high,
                                    culture_ID_isolated_L_high) %>%
                            mutate(disturbance = "high",
                                   metaecosystem_type = "Small-Large isolated") %>%
                            rename(ID_first_patch = culture_ID_isolated_S_high,
                                   ID_second_patch = culture_ID_isolated_L_high) %>%
                            select(disturbance,
                                   metaecosystem_type,
                                   ID_first_patch,
                                   ID_second_patch)

combinations_M_and_M_low = combn(culture_ID_isolated_M_low,
                                   m = 2) %>%
                            t() %>%
                            as.data.frame() %>%
                            rename(ID_first_patch = V1,
                                   ID_second_patch = V2) %>%
                            mutate(disturbance = "low",
                                   metaecosystem_type = "Medium-Medium isolated") %>%
                            select(disturbance,
                                   metaecosystem_type,
                                   ID_first_patch,
                                   ID_second_patch)

combinations_M_and_M_high = combn(culture_ID_isolated_M_high,
                                   m = 2) %>%
                            t() %>%
                            as.data.frame() %>%
                            rename(ID_first_patch = V1,
                                   ID_second_patch = V2) %>%
                            mutate(disturbance = "high",
                                   metaecosystem_type = "Medium-Medium isolated") %>%
                            select(disturbance,
                                   metaecosystem_type,
                                   ID_first_patch,
                                   ID_second_patch)

expect_equal(nrow(combinations_S_and_L_low),
             length(culture_ID_isolated_S_low) * length(culture_ID_isolated_L_low))

expect_equal(nrow(combinations_S_and_L_high),
             length(culture_ID_isolated_S_high) * length(culture_ID_isolated_L_high))

expect_equal(nrow(combinations_M_and_M_low),
             sum(seq(length(culture_ID_isolated_M_low) - 1)))

expect_equal(nrow(combinations_M_and_M_high),
             sum(seq(length(culture_ID_isolated_M_high) - 1)))

ID_combinations_isolated = rbind(
  combinations_S_and_L_low,
  combinations_S_and_L_high,
  combinations_M_and_M_low,
  combinations_M_and_M_high
) 

ID_combinations_isolated = ID_combinations_isolated %>%
  mutate(system_nr = 1001:(1000 + nrow(ID_combinations_isolated))) %>%
  select(system_nr,
         disturbance,
         metaecosystem_type,
         ID_first_patch,
         ID_second_patch)

ID_combinations_metaecos = ds_patches %>%
  filter(time_point == 0,
         metaecosystem == "yes") %>%
  select(system_nr,
         disturbance,
         metaecosystem_type,
         culture_ID) %>%
  group_by(system_nr,
           disturbance,
           metaecosystem_type) %>%
  summarise(ID_first_patch = (mean(culture_ID) - 0.5),
            ID_second_patch = (mean(culture_ID) + 0.5)) %>%
  as.data.frame()


ID_combinations = rbind(ID_combinations_isolated,
                        ID_combinations_metaecos)

ID_combinations$connection <-
  ifelse(
    ID_combinations$metaecosystem_type %in% c("Medium-Medium isolated",
                                                "Small-Large isolated"),
    yes = "isolated",
    no = "connected"
  )

n_patches_combinations = nrow(ID_combinations)

expect_equal(nrow(ID_combinations), 
             nrow(ID_combinations_isolated) + nrow(ID_combinations_metaecos))
```

Warning appear after the following code, as 
- alpha diversity is computed for a culture that is totally crashed, so it has not meaning.
- beta diversity is computed between a culture that is still alive and one that is totally crashed. Because one of the cultures is totally crashed, the Bray-Curtis index is 1.

```{r}
#Create the ds_metaecosystem dataset
ds_metaecosystems = create.meatecosystem.ds()

expect_equal(nrow(ds_metaecosystems), 
             n_time_points * n_patches_combinations)
```

```{r}
#Add whether systems are connected or not 
ds_metaecosystems$connection <-
  ifelse(
    ds_metaecosystems$metaecosystem_type %in% c("Medium-Medium isolated",
                                                "Small-Large isolated"),
    yes = "isolated",
    no = "connected"
  )

#Add whether patch sizes are symmetric or not
ds_metaecosystems$patch_size_symmetry <-
  ifelse(
    ds_metaecosystems$metaecosystem_type %in% c("Small-Large isolated",
                                                "Small-Large meta-ecosystem"),
    yes = "asymmetric",
    no = "symmetric"
  )
```

```{r}
#Reorder the meta-ecosystems
ds_metaecosystems = ds_metaecosystems %>%
  mutate(metaecosystem_type = factor(
    metaecosystem_type,
    levels = c(
      "Small-Small meta-ecosystem",
      "Medium-Medium meta-ecosystem",
      "Medium-Medium isolated",
      "Large-Large meta-ecosystem",
      "Small-Large meta-ecosystem",
      "Small-Large isolated"
    )
  ))
```

```{r}
#Add baselines (from t1).
baselines <- ds_metaecosystems %>%
  filter(time_point == 1) %>%
  group_by(system_nr) %>%
  summarise(across(all_of(variables_metaecos), .names = "baseline_{.col}"))

n_rows_ds_metaecosystems_before_join = nrow(ds_metaecosystems)

ds_metaecosystems = full_join(ds_metaecosystems, baselines)

expect_equal(nrow(ds_metaecosystems),
             n_rows_ds_metaecosystems_before_join)
```

```{r eval = FALSE}


#Create combination sets (for SL isolated) where each sets contains each patch only one time.

ID_combinations_w_sets = data.frame(
  ID_first_patch = NA,
  ID_second_patch = NA,
  combination_set = NA,
  disturbance = NA,
  metaecosystem_type = NA,
  connection = NA
)

for (disturbance_input in disturbance_levels) {
  #Initalise
  combs = NULL
  concat_permnts_large = NULL
  
  #Find culture ID of small and large patches
  ID_small_patches = ds_patches %>%
    filter(disturbance == disturbance_input,
           patch_type == "Small isolated") %>%
    pull(culture_ID) %>%
    unique()
  
  ID_large_patches = ds_patches %>%
    filter(disturbance == disturbance_input,
           patch_type == "Large isolated") %>%
    pull(culture_ID) %>%
    unique()
  
  #Force small and large patches vectors to have the same length 
  if(length(ID_large_patches) < length(ID_small_patches)) {
    ID_large_patches = c(ID_large_patches,
                         rep(
                           "Patch taken off",
                           times = length(ID_small_patches) - length(ID_large_patches)
                         ))
  }
  
  if(length(ID_small_patches) < length(ID_large_patches)) {
    ID_small_patches = c(ID_small_patches,
                         rep(
                           "Patch taken off",
                           times = length(ID_large_patches) - length(ID_small_patches)
                         ))
  }
  
  #Permutations of the large patches 
  permnts_large = permn(ID_large_patches)
  
  for(list_element in 1:length(permnts_large)){
    concat_permnts_large = c(concat_permnts_large, permnts_large[[list_element]])
  }
  
  #Assign small patches
  combs$ID_small_patches = rep(ID_small_patches,
                               times = length(permnts_large))
  
  expect_equal(length(combs$ID_small_patches),
               length(ID_small_patches) * length(permnts_large))
  
  #Assign large patches 
  combs$ID_large_patches = concat_permnts_large
  
  expect_equal(length(combs$ID_large_patches),
               length(ID_large_patches) * length(permnts_large))
  
  #Assign set 
  combs$comb_set = rep(1:length(permnts_large), 
                  each = length(ID_small_patches))
  
  expect_equal(length(combs$comb_set),
               length(ID_small_patches) * length(permnts_large))
  
  #Finalise
  combs = combs %>%
    as.data.frame() %>%
    mutate(disturbance = disturbance_input,
           metaecosystem_type = "Small-Large isolated",
           connection = "isolated"
           ) %>%
    rename(ID_first_patch = ID_small_patches,
           ID_second_patch = ID_large_patches) %>%
    select(disturbance,
           metaecosystem_type,
           ID_first_patch,
           ID_second_patch,
           connection,
           comb_set)
  
  expect_equal(nrow(combs),
               length(ID_small_patches) * length(permnts_large))
  
  combs = combs %>%
    filter(!ID_first_patch == "Patch taken off", 
           !ID_second_patch == "Patch taken off")
  
  #Join 
  ID_combinations_w_sets = full_join(ID_combinations,
                                     combs)
    
}
```

```{r}
save(ds_metaecosystems, file = here("results", "ds", "ds_metaecosystems.RData"))
```