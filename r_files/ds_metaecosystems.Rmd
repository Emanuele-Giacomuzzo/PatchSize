---
title: "Data Regional Biomass"
output: html_document
date: "2022-11-22"
editor_options: 
  chunk_output_type: console
---

-   Each row is a meta-ecosystem.

-   It contains also "fake" meta-ecosystems which I created from isolated patches (`metaecosystem type = Small-Large isolated` & `metaecosystem type = Medium-Medium isolated`).

- Warning appear after the following code, as:
(i) alpha diversity is computed for a culture that is totally crashed, so it has not meaning.
(ii) beta diversity is computed between a culture that is still alive and one that is totally crashed. Because one of the cultures is totally crashed, the Bray-Curtis index is 1.

```{r}
#Create the ds_metaecosystem dataset
ds_metaecosystems = create.meatecosystem.ds()

expect_equal(nrow(ds_metaecosystems), 
             n_time_points * n_patches_combinations)
```

```{r}
#Add column connection
ds_metaecosystems$connection <-
  ifelse(
    ds_metaecosystems$metaecosystem_type %in% c("Medium-Medium isolated",
                                                "Small-Large isolated"),
    yes = "isolated",
    no = "connected"
  )
```

```{r}
#Add column patch size symmetry
ds_metaecosystems$patch_size_symmetry <-
  ifelse(
    ds_metaecosystems$metaecosystem_type %in% c("Small-Large isolated",
                                                "Small-Large meta-ecosystem"),
    yes = "asymmetric",
    no = "symmetric"
  )

```

```{r}
#Reorder the meta-ecosystems
ds_metaecosystems = ds_metaecosystems %>%
  mutate(metaecosystem_type = factor(
    metaecosystem_type,
    levels = c(
      "Small-Small meta-ecosystem",
      "Medium-Medium meta-ecosystem",
      "Medium-Medium isolated",
      "Large-Large meta-ecosystem",
      "Small-Large meta-ecosystem",
      "Small-Large isolated"
    )
  ))
```

```{r}
#Add baselines. See ds_patches for an explanation. 
baselines <- ds_metaecosystems %>%
  filter(time_point == 1) %>%
  group_by(system_nr) %>%
  summarise(across(all_of(variables_metaecos), .names = "baseline_{.col}"))

n_rows_ds_metaecosystems_before_join = nrow(ds_metaecosystems)

ds_metaecosystems = full_join(ds_metaecosystems, baselines)

expect_equal(nrow(ds_metaecosystems),
             n_rows_ds_metaecosystems_before_join)
```

```{r}
#Join ...
full_join(ds_metaecosystems,
          isolated_combinations_sets)
```

```{r}
#Save dataset
save(ds_metaecosystems, file = here("results", "ds", "ds_metaecosystems.RData"))
```