---
title: "Data Regional Biomass"
output: html_document
date: "2022-11-22"
editor_options: 
  chunk_output_type: console
---

-   Each row is a meta-ecosystem.

-   It contains also "fake" meta-ecosystems which I created from isolated patches (`metaecosystem type = Small-Large isolated` & `metaecosystem type = Medium-Medium isolated`).

```{r}
### Create a data frame with all the experimental meta-ecosystems and all the possible meta-ecosystems from isolated
culture_ID_isolated_S_low = ds_patches %>%
  filter(patch_type == "Small isolated",
         disturbance == "low") %>%
  pull(culture_ID) %>%
  unique()

culture_ID_isolated_L_low = ds_patches %>%
  filter(patch_type == "Large isolated",
         disturbance == "low") %>%
  pull(culture_ID) %>%
  unique()

culture_ID_isolated_S_high = ds_patches %>%
  filter(patch_type == "Small isolated",
         disturbance == "high") %>%
  pull(culture_ID) %>%
  unique()

culture_ID_isolated_L_high = ds_patches %>%
  filter(patch_type == "Large isolated",
         disturbance == "high") %>%
  pull(culture_ID) %>%
  unique()

culture_ID_isolated_M_low = ds_patches %>%
  filter(patch_type == "Medium isolated",
         disturbance == "low") %>%
  pull(culture_ID) %>%
  unique()

culture_ID_isolated_M_high = ds_patches %>%
  filter(patch_type == "Medium isolated",
         disturbance == "high") %>%
  pull(culture_ID) %>%
  unique()

combinations_S_and_L_low = crossing(culture_ID_isolated_S_low,
                                    culture_ID_isolated_L_low) %>%
                            mutate(disturbance = "low",
                                   metaecosystem_type = "Small-Large isolated") %>%
                            rename(ID_first_patch = culture_ID_isolated_S_low,
                                   ID_second_patch = culture_ID_isolated_L_low) %>%
                            select(disturbance,
                                   metaecosystem_type,
                                   ID_first_patch,
                                   ID_second_patch)

combinations_S_and_L_high = crossing(culture_ID_isolated_S_high,
                                    culture_ID_isolated_L_high) %>%
                            mutate(disturbance = "high",
                                   metaecosystem_type = "Small-Large isolated") %>%
                            rename(ID_first_patch = culture_ID_isolated_S_high,
                                   ID_second_patch = culture_ID_isolated_L_high) %>%
                            select(disturbance,
                                   metaecosystem_type,
                                   ID_first_patch,
                                   ID_second_patch)

combinations_M_and_M_low = combn(culture_ID_isolated_M_low,
                                   m = 2) %>%
                            t() %>%
                            as.data.frame() %>%
                            rename(ID_first_patch = V1,
                                   ID_second_patch = V2) %>%
                            mutate(disturbance = "low",
                                   metaecosystem_type = "Medium-Medium isolated") %>%
                            select(disturbance,
                                   metaecosystem_type,
                                   ID_first_patch,
                                   ID_second_patch)

combinations_M_and_M_high = combn(culture_ID_isolated_M_high,
                                   m = 2) %>%
                            t() %>%
                            as.data.frame() %>%
                            rename(ID_first_patch = V1,
                                   ID_second_patch = V2) %>%
                            mutate(disturbance = "high",
                                   metaecosystem_type = "Medium-Medium isolated") %>%
                            select(disturbance,
                                   metaecosystem_type,
                                   ID_first_patch,
                                   ID_second_patch)

test_that("Check nr of combinations is right.",{
  expect_equal(nrow(combinations_S_and_L_low), 
               length(culture_ID_isolated_S_low) * length(culture_ID_isolated_L_low))
  expect_equal(nrow(combinations_S_and_L_high), 
               length(culture_ID_isolated_S_high) * length(culture_ID_isolated_L_high))
  expect_equal(nrow(combinations_M_and_M_low), 
               sum(seq(length(culture_ID_isolated_M_low) -1)))
  expect_equal(nrow(combinations_M_and_M_high), 
               sum(seq(length(culture_ID_isolated_M_high) -1)))
})


ID_combinations_isolated = rbind(
  combinations_S_and_L_low,
  combinations_S_and_L_high,
  combinations_M_and_M_low,
  combinations_M_and_M_high
) 

ID_combinations_isolated = ID_combinations_isolated %>%
  mutate(system_nr = 1001:(1000 + nrow(ID_combinations_isolated))) %>%
  select(system_nr,
         disturbance,
         metaecosystem_type,
         ID_first_patch,
         ID_second_patch)

ID_combinations_metaecos = ds_patches %>%
  filter(time_point == 0,
         metaecosystem == "yes") %>%
  select(system_nr,
         disturbance,
         metaecosystem_type,
         culture_ID) %>%
  group_by(system_nr,
           disturbance,
           metaecosystem_type) %>%
  summarise(ID_first_patch = (mean(culture_ID) - 0.5),
            ID_second_patch = (mean(culture_ID) + 0.5)) %>%
  as.data.frame()


ID_combinations = rbind(ID_combinations_isolated,
                        ID_combinations_metaecos)

n_patches_combinations = nrow(ID_combinations)

test_that("Check nr of combinations is right.",{
  expect_equal(nrow(ID_combinations), 
               nrow(ID_combinations_isolated) + nrow(ID_combinations_metaecos))
})
```

```{r}
#Warnings are normal, as they are about beta diversity = 1
ds_metaecosystems = create.meatecosystem.ds()

test_that("Check nr of meta-ecosystem rows is right.",{
  expect_equal(nrow(ds_metaecosystems), 
               n_time_points * n_patches_combinations)
})
```

```{r}
#Add whether systems are connected or not 
ds_metaecosystems$connection <-
  ifelse(
    ds_metaecosystems$metaecosystem_type %in% c("Medium-Medium isolated",
                                                "Small-Large isolated"),
    yes = "isolated",
    no = "connected"
  )

#Add whether patch sizes are symmetric or not
ds_metaecosystems$patch_size_symmetry <-
  ifelse(
    ds_metaecosystems$metaecosystem_type %in% c("Small-Large isolated",
                                                "Small-Large meta-ecosystem"),
    yes = "asymmetric",
    no = "symmetric"
  )
```

```{r add-baselines-(ds_metaecosystems)}
#Add baselines (from t1).
baselines <- ds_metaecosystems %>%
  filter(time_point == 1) %>%
  group_by(system_nr) %>%
  summarise(across(all_of(variables_metaecos), .names = "baseline_{.col}"))

n_rows_ds_metaecosystems = nrow(ds_metaecosystems)

ds_metaecosystems = full_join(ds_metaecosystems, baselines)

test_that("Check that the number of rows didn't change.",{
  expect_equal(nrow(ds_metaecosystems),
               n_rows_ds_metaecosystems)})
```