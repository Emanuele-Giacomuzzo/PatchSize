---
title: "model_all_points_without_time_fitting"
author: "Emanuele Giacomuzzo"
date: '2022-07-22'
output: html_document
---

## All time points without time fitting 

When modelling the regional biomass, we want to understand if the regional biomass produced by an ecosystem with a small and a large patch (metaecosystem_type = S_L) is lower than the regional biomass produced by an ecosystem with two medium patches (metaecosystem_type = M_M).

### Create regional biomass data set

First of all, let's produce a data set including the regional biomass of all our meta ecosystems. In this data set, not only we want to have the regional biomass of the meta-ecosystems (averaged first across videos and then across patches) but also:

-   We want to include only the meta-ecosystems in which patches had both medium size (metaecosystem_type = M_M) and meta-ecosystems in which patches had one a small size and the other large size (metaecosystem_type = S_L).

-   We want to take off the first time point (day = 0). This is because all the meta-ecosystems had the same regional biomass, which was a construct of our experimental design.

```{r regional-biomass-modified}

ds_regional_shrunk_type_n_day = ds_regional %>%
    filter (metaecosystem_type == "M_M" | metaecosystem_type == "S_L", 
            day != 0)
```

### Model selection

First of all, let's include time as a random variable. Let's start from the largest mixed effect model makes sense to construct. This will include:

-   As fixed effect: disturbance, metaecosystem type, and their interaction
-   As random effect (random intercept and slope): day and the number of the metaecosystem (system_nr).

We are actually going to construct two full models. One with the correlated and one with the uncorrelated random slopes and intercept, the other without.

```{r full-models}

#Uncorrelated intercepts and slopes
full_model = lmer(regional_mean_bioarea ~ 
                    metaecosystem_type  + 
                    disturbance + 
                    metaecosystem_type * disturbance + 
                    (metaecosystem_type || day) + 
                    (disturbance || day) + 
                    (metaecosystem_type*disturbance  || day) + 
                    (metaecosystem_type || system_nr) + 
                    (disturbance || system_nr) + 
                    (metaecosystem_type*disturbance  || system_nr), 
                  data = ds_regional_shrunk_type_n_day, 
                  REML = FALSE)

#Correlated intercepts and slopes
full_model_correlated = lmer(regional_mean_bioarea ~ 
                               metaecosystem_type  + 
                               disturbance + 
                               metaecosystem_type * disturbance + 
                               (metaecosystem_type | day) + 
                               (disturbance | day) + 
                               (metaecosystem_type*disturbance  | day) + 
                               (metaecosystem_type | system_nr) + 
                               (disturbance | system_nr) + 
                               (metaecosystem_type*disturbance  | system_nr), 
                             data = ds_regional_shrunk_type_n_day, REML = FALSE)

anova(full_model, full_model_correlated)
```

Although the AIC for the model with correlated slopes is lower, there is not statistical significance between the two models. Let's then keep as a full model the one with non correlated slopes (full_model).

#### *Meta-ecosystem ID random effect*

Should we keep the random effect of the metaecosystem number?

```{r no_system_nr_model}

no_system_nr_model = lmer(regional_mean_bioarea ~ 
                            metaecosystem_type  + 
                            disturbance + 
                            metaecosystem_type * disturbance + 
                            (metaecosystem_type || day) + 
                            (disturbance || day) + 
                            (metaecosystem_type*disturbance || day), 
                          data = ds_regional_shrunk_type_n_day, 
                          REML = FALSE)

anova(full_model, no_system_nr_model)
```

The difference between the two doesn't seem to be significant. Therefore, let's throw out the system_nr from our model.

#### *Random effects*

Should we keep the random effects?

```{r fixed_effects_model}

fixed_effects_model = lm(regional_mean_bioarea ~ 
                           metaecosystem_type  + 
                           disturbance, 
                         data = ds_regional_shrunk_type_n_day)

anova(no_system_nr_model, fixed_effects_model)
```

The full model is better, as we expected. Time plays such an important part in explaining the way that biomass changes.

#### *Interaction between metaecosystem and disturbance*

Should we keep the interaction between metaecosystem and disturbance?

```{r no_interaction_model, message=FALSE}

no_interaction_model = lmer(regional_mean_bioarea ~ 
                              metaecosystem_type + 
                              disturbance  + 
                              (metaecosystem_type || day) + 
                              (disturbance || day), 
                            data = ds_regional_shrunk_type_n_day, 
                            REML = FALSE)

anova(no_system_nr_model, no_interaction_model)
```

There is no statistical significance between the two models. Therefore, let's drop the interaction between disturbance and meta-ecosystem type.

#### *Random slopes*

Should we keep the random slopes?

```{r no_slopes_model, message=FALSE}

no_slopes_model = lmer(regional_mean_bioarea ~ metaecosystem_type + 
                         disturbance  + 
                         (1 | day), 
                       data = ds_regional_shrunk_type_n_day, 
                       REML = FALSE)

anova(no_interaction_model, no_slopes_model)
```

Yes. We should keep the random slopes. Well, it seems like this is our best model then.

### Best model

#### Without fitting function to time dynamics

##### Effect size & significance

After model selection, we determined that the best model is the following one:

`regional_mean_bioarea ~ metaecosystem_type + disturbance + (metaecosystem_type || day) + (disturbance || day)`

coded as

`lmer(regional_mean_bioarea ~ metaecosystem_type + disturbance  + (metaecosystem_type || day) + (disturbance || day), data = ds_regional_shrunk_type_n_day, REML = FALSE)`

Let's call it then `best_model` to don't get confused.

```{r best-model}

best_model = no_interaction_model
```

###### Effect size & significance of best model

Let's now calculate the statistical significance and effect size of the best model. The marginal and conditional r squared are calculated using the package `MuMIn`. For the coding and interpretation of these r squared check the [documentation for the r.squaredGLMM function](https://rdrr.io/cran/MuMIn/man/r.squaredGLMM.html).

```{r r2-p-best-model}

model.null = lmer(regional_mean_bioarea ~ (1 | day), data = ds_regional_shrunk_type_n_day, REML = FALSE)

r2_best = r.squaredGLMM(best_model)
r2_best = round(r2_best, digits = 3)

anova = anova(best_model, model.null)
p_best = anova$`Pr(>Chisq)`[2]
p_best = round(p_best, digits = 5)

if (p_best < 0.00001) {
  p_best = "< 0.00001"
}


```

###### Effect size & significance of meta-ecosystem type (in the best model)

```{r p-r2-meta-ecosystem-type}
metaecosystem_type_null = lmer(regional_mean_bioarea ~  
                                 disturbance  + 
                                 (disturbance || day),
                               data = ds_regional_shrunk_type_n_day, 
                               REML = FALSE, 
                               control = lmerControl(optimizer ='optimx', 
                                                     optCtrl=list(method='L-BFGS-B')))

r2_no_metaecosystem_type = r.squaredGLMM(metaecosystem_type_null)
r2_no_metaecosystem_type = round(r2_no_metaecosystem_type, digits = 3)

anova = anova(best_model, metaecosystem_type_null)
p_no_metaecosystem_type = anova$`Pr(>Chisq)`[2]
p_no_metaecosystem_type = round(p_no_metaecosystem_type, digits = 5)

if (p_no_metaecosystem_type < 0.00001) {
  p_no_metaecosystem_type = "< 0.00001"
}

```

###### Effect size & significance of disturbance (in the best model)

```{r p-r2-disturbance}

disturbance_null = lmer(regional_mean_bioarea ~ 
                          metaecosystem_type  + 
                          (metaecosystem_type || day), 
                        data = ds_regional_shrunk_type_n_day, 
                        REML = FALSE,
                        control = lmerControl(optimizer ='optimx', 
                                                     optCtrl=list(method='L-BFGS-B')))

r2_no_disturbance = r.squaredGLMM(disturbance_null)
r2_no_disturbance = round(r2_no_disturbance, digits = 3)

anova = anova(best_model, disturbance_null)
p_no_disturbance = anova$`Pr(>Chisq)`[2]
p_no_disturbance = round(p_no_disturbance, digits = 5)

if (p_no_disturbance < 0.00001) {
  p_no_disturbance = "< 0.00001"
}

```

The effect size and significance of our results can be found in the following table.

| Model                                  |           Marginal R2           |   Marginal R2 of the best model explained    |         Conditional R2          |  Conditional R2 of the best model explained  |           P-value           |
|:-----------|:----------:|:----------:|:----------:|:----------:|:----------:|
| Best model                             |         `r r2_best[1]`          |                      /                       |         `r r2_best[2]`          |                      /                       |         `r p_best`          |
| Best model without meta-ecosystem type | `r r2_no_metaecosystem_type[1]` | `r r2_best[1] - r2_no_metaecosystem_type[1]` | `r r2_no_metaecosystem_type[2]` | `r r2_best[2] - r2_no_metaecosystem_type[2]` | `r p_no_metaecosystem_type` |
| Best model without disturbance         |    `r r2_no_disturbance[1]`     |    `r r2_best[1] - r2_no_disturbance[1]`     |    `r r2_no_disturbance[2]`     |    `r r2_best[2] - r2_no_disturbance[2]`     |    `r p_no_disturbance`     |

This means that meta-ecosystem type should explain more than disturbance regional biomass dynamics. However, the effect size isn't that high (`r r2_best[1] - r2_no_metaecosystem_type[1]`). Because of this, we thought we should fit a function to the time dynamics of the regional biomass.