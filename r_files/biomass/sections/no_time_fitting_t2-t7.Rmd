---
title: "model_all_points_without_time_fitting"
author: "Emanuele Giacomuzzo"
date: '2022-07-22'
output: html_document
editor_options: 
  chunk_output_type: console
---

### t2 - t7 with time as random effect

#### Model selection

First of all, let's include time as a random variable. Let's start from the largest mixed effect model makes sense to construct. This will include:

-   As fixed effect: disturbance, metaecosystem type, and their interaction
-   As random effect (random intercept and slope): day and the number of the metaecosystem (system_nr).

We are actually going to construct two full models. One with the correlated and one with the uncorrelated random slopes and intercept, the other without

**Should we get rid of the correlation between intercept and slopes?**

```{r full-models}
full_model_correlated = lmer(regional_mean_bioarea ~ 
                             metaecosystem_type  + 
                             disturbance + 
                             metaecosystem_type * disturbance + 
                             (metaecosystem_type | day) + 
                             (disturbance | day) + 
                             (metaecosystem_type*disturbance  | day) +
                             (1 | system_nr) , 
                             data = ds_regional_shrunk_type_n_day, 
                             REML = FALSE)

full_model_uncorrelated = lmer(regional_mean_bioarea ~ 
                    metaecosystem_type  + 
                    disturbance + 
                    metaecosystem_type * disturbance + 
                    (metaecosystem_type || day) + 
                    (disturbance || day) + 
                    (metaecosystem_type*disturbance  || day) +
                    (1 | system_nr) ,
                  data = ds_regional_shrunk_type_n_day, 
                  REML = FALSE)

BIC(full_model_uncorrelated, full_model_correlated)
```

No.

```{r}
best_model = full_model_correlated
```

**Should we get rid of the interaction between meta-ecosystem and disturbance?**

```{r no_interaction_model, message=FALSE}
no_interaction_model = lmer(regional_mean_bioarea ~ 
                              metaecosystem_type + 
                              disturbance  + 
                              (metaecosystem_type | day) + 
                              (disturbance | day) +
                              (1 | system_nr), 
                            data = ds_regional_shrunk_type_n_day, 
                            REML = FALSE)

BIC(best_model, no_interaction_model)
```

Yes.

```{r}
best_model = no_interaction_model
```

**Should we get rid of the random slopes?**

```{r no_slopes_model, message=FALSE}
no_slopes_model = lmer(regional_mean_bioarea ~ 
                         metaecosystem_type + 
                         disturbance  + 
                         (1 | day) +
                         (1 | system_nr), 
                       data = ds_regional_shrunk_type_n_day, 
                       REML = FALSE)

BIC(best_model, no_slopes_model)
```

Yes.

```{r best-model}
best_model = no_slopes_model
```

**Should we get rid of the random effect of system number?**

```{r}
no_system_nr = lmer(regional_mean_bioarea ~ 
                         metaecosystem_type + 
                         disturbance  + 
                         (1 | day), 
                       data = ds_regional_shrunk_type_n_day, 
                       REML = FALSE)

anova(best_model, no_system_nr)
```

Yes.

```{r}
best_model = no_system_nr
summary(best_model)
```

Therefore, the best model is the following one:

`regional_mean_bioarea ~ metaecosystem_type + disturbance + (1 | day)`

#### Effect size of meta-ecosystem type in the best model

##### Effect size and significance of the whole model

```{r r2-p-best-model}
model.null = lm(regional_mean_bioarea ~ 1 , 
                  data = ds_regional_shrunk_type_n_day)

r2_best = r.squaredGLMM(best_model)
r2_best = round(r2_best, digits = 3)

anova = anova(best_model, model.null)
p_best = anova$`Pr(>Chisq)`[2]
p_best = round(p_best, digits = 5)

if (p_best < 0.00001) {
  p_best = "< 0.00001"
}
```

##### Effect size and significance of meta-ecosystem type

```{r}
metaecosystem_type_null = lmer(regional_mean_bioarea ~  
                                 disturbance  + 
                                 (1 | day),
                               data = ds_regional_shrunk_type_n_day, 
                               REML = FALSE, 
                               control = lmerControl(optimizer ="Nelder_Mead"))

r2_no_metaecosystem_type = r.squaredGLMM(metaecosystem_type_null)
r2_no_metaecosystem_type = round(r2_no_metaecosystem_type, digits = 3)

anova = anova(best_model, metaecosystem_type_null)
p_no_metaecosystem_type = anova$`Pr(>Chisq)`[2]
p_no_metaecosystem_type = round(p_no_metaecosystem_type, digits = 5)

if (p_no_metaecosystem_type < 0.00001) {
  p_no_metaecosystem_type = "< 0.00001"
}
```

##### Effect size and significance of disturbance

```{r p-r2-disturbance}

disturbance_null = lmer(regional_mean_bioarea ~ 
                          metaecosystem_type  + 
                          (1 | day), 
                        data = ds_regional_shrunk_type_n_day, 
                        REML = FALSE,
                        control = lmerControl(optimizer ='optimx', 
                                                     optCtrl=list(method='L-BFGS-B')))

r2_no_disturbance = r.squaredGLMM(disturbance_null)
r2_no_disturbance = round(r2_no_disturbance, digits = 3)

anova = anova(best_model, disturbance_null)
p_no_disturbance = anova$`Pr(>Chisq)`[2]
p_no_disturbance = round(p_no_disturbance, digits = 5)

if (p_no_disturbance < 0.00001) {
  p_no_disturbance = "< 0.00001"
}
```

The effect size and significance of our results can be found in the following table.

| Model                                  |           Marginal R2           |   Marginal R2 of the best model explained    |         Conditional R2          |  Conditional R2 of the best model explained  |           P-value           |
|:-----------|:----------:|:----------:|:----------:|:----------:|:----------:|
| Best model                             |         `r r2_best[1]`          |                      /                       |         `r r2_best[2]`          |                      /                       |         `r p_best`          |
| Best model without meta-ecosystem type | `r r2_no_metaecosystem_type[1]` | `r r2_best[1] - r2_no_metaecosystem_type[1]` | `r r2_no_metaecosystem_type[2]` | `r r2_best[2] - r2_no_metaecosystem_type[2]` | `r p_no_metaecosystem_type` |
| Best model without disturbance         |    `r r2_no_disturbance[1]`     |    `r r2_best[1] - r2_no_disturbance[1]`     |    `r r2_no_disturbance[2]`     |    `r r2_best[2] - r2_no_disturbance[2]`     |    `r p_no_disturbance`     |

This means that meta-ecosystem type should explain more than disturbance regional biomass dynamics. However, the effect size isn't that high (`r r2_best[1] - r2_no_metaecosystem_type[1]`). Because of this, we thought we should fit a function to the time dynamics of the regional biomass.
