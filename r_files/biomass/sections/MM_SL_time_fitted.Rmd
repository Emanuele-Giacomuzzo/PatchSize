---
title: "time_fitting"
author: "Emanuele Giacomuzzo"
date: '2022-07-22'
output: html_document
editor_options: 
  chunk_output_type: console
---

Let's now work using the fitted data that we found in the previous section.

###### Tidy

```{r}
ds_regional_predicted_shrunk_type_n_day = ds_regional_predicted_shrunk_type %>%
  filter(time_point >= 2)
```

###### Model selection

Let's start from the full model.

```{r}
model_slopes_correlated = lmer(regional_mean_bioarea ~ 
                            predicted_from_time + 
                            metaecosystem_type  + 
                            disturbance + 
                            predicted_from_time * metaecosystem_type +
                            predicted_from_time * disturbance +
                            metaecosystem_type * disturbance +
                            predicted_from_time * metaecosystem_type * disturbance +
                            (predicted_from_time | system_nr),
                        data = ds_regional_predicted_shrunk_type_n_day,
                        REML = FALSE)
```

*(1) Should we keep the correlation in (T \| ID)?*

```{r}
model_slopes_uncorrelated = lmer(regional_mean_bioarea ~ 
                            predicted_from_time + 
                            metaecosystem_type  + 
                            disturbance + 
                            predicted_from_time * metaecosystem_type +
                            predicted_from_time * disturbance +
                            metaecosystem_type * disturbance +
                            predicted_from_time * metaecosystem_type * disturbance +
                            (predicted_from_time || system_nr),
                        data = ds_regional_predicted_shrunk_type_n_day,
                        REML = FALSE,
                        control = lmerControl(optimizer = "Nelder_Mead"))

anova(model_slopes_uncorrelated, model_slopes_correlated)
```

No (according to AIC and BIC - however, AIC is only slightly lower).

*(2) Should we keep T \** M?

```{r}
model_no_TM = lmer(regional_mean_bioarea ~ 
                            predicted_from_time + 
                            metaecosystem_type  + 
                            disturbance + 
                            predicted_from_time * disturbance +
                            metaecosystem_type * disturbance +
                            predicted_from_time * metaecosystem_type * disturbance +
                            (predicted_from_time || system_nr),
               data = ds_regional_predicted_shrunk_type_n_day,
               REML = FALSE,
               control = lmerControl (optimizer = "Nelder_Mead")
               )

anova(model_slopes_uncorrelated, model_no_TM)
```

This is really wired. Df = 0. Let's then say no then.

*(3) Should we keep T \** D?

```{r}
model_no_TD = lmer(regional_mean_bioarea ~ 
                            predicted_from_time + 
                            metaecosystem_type  + 
                            disturbance + 
                            metaecosystem_type * disturbance +
                            predicted_from_time * metaecosystem_type * disturbance +
                            (predicted_from_time || system_nr),
               data = ds_regional_predicted_shrunk_type_n_day,
               REML = FALSE,
               control = lmerControl (optimizer = "Nelder_Mead"))

anova(model_no_TM, model_no_TD)
```

This is really wired. Df = 0. Let's then say no then.

*(4) Should we keep M \* D?*

```{r}
model_no_MD = lmer(regional_mean_bioarea ~ 
                            predicted_from_time + 
                            metaecosystem_type  + 
                            disturbance + 
                            predicted_from_time * metaecosystem_type * disturbance +
                            (predicted_from_time || system_nr),
               data = ds_regional_predicted_shrunk_type_n_day,
               REML = FALSE,
               control = lmerControl (optimizer = "Nelder_Mead"))

anova(model_no_TD, model_no_MD)
```

This is really wired. Df = 0. Let's then say no then.

*(5) Should we keep T \* M \* D?*

```{r}
model_no_TMD = lmer(regional_mean_bioarea ~ 
                            predicted_from_time + 
                            metaecosystem_type  + 
                            disturbance + 
                            (predicted_from_time || system_nr),
               data = ds_regional_predicted_shrunk_type_n_day,
               REML = FALSE,
               control = lmerControl (optimizer = "Nelder_Mead"))

anova(model_no_MD, model_no_TMD)
```

Yes according to AIC (but no according to BIC).

*(6) Should we keep (T \|\| ID)?*

```{r}
model_no_random_slope = lmer(regional_mean_bioarea ~ 
                            predicted_from_time + 
                            metaecosystem_type  + 
                            disturbance + 
                            (1 | system_nr),
               data = ds_regional_predicted_shrunk_type_n_day,
               REML = FALSE,
               control = lmerControl (optimizer = "Nelder_Mead"))

anova(model_no_MD, model_no_random_slope)
```

Yes according to AIC (but no according to BIC).

*(7) Should we introduce the correlation (T \| ID) ?*

```{r}
model_no_MD_correlated = lmer(regional_mean_bioarea ~ 
                            predicted_from_time + 
                            metaecosystem_type  + 
                            disturbance + 
                            predicted_from_time * metaecosystem_type * disturbance +
                            (predicted_from_time | system_nr),
               data = ds_regional_predicted_shrunk_type_n_day,
               REML = FALSE,
               control = lmerControl (optimizer = "Nelder_Mead"))

anova(model_no_MD, model_no_MD_correlated)
```

Yes according to AIC (but no according to BIC). This is odd as at the beginning the model told us we shouldn't keep it.

*Should we keep these parameters?*

|        Parameter        |             AIC              | BIC |
|:-----------------------:|:----------------------------:|:---:|
| (T \| ID) (correlation) | No (but only slightly lower) | No  |
|         T \* M          |              ?               |  ?  |
|         T \* D          |              ?               |  ?  |
|         M \* D          |              ?               |  ?  |
|       T \* M \* D       |             Yes              | No  |
|       (T \|\| ID)       |             Yes              | No  |

According to the previous table, then BIC should be the highest for a fixed effect model. Let's see if this is the case.

```{r}
fixed_model = lm(regional_mean_bioarea ~ 
                            predicted_from_time + 
                            metaecosystem_type  + 
                            disturbance,
               data = ds_regional_predicted_shrunk_type_n_day)
```

To make sure everything is okay, let's take a look at all our models.

```{r}
anova(model_slopes_correlated, model_slopes_uncorrelated, model_no_random_slope, fixed_model) #Only with models df > 0 

#anova(model_slopes_correlated, model_slopes_uncorrelated, model_no_TM, model_no_TD, model_no_MD, model_no_TMD, model_no_random_slope, fixed_model) #With all the models
```

The best model according to AIC is T + M + D + (T \|\| ID) (`model_no_MD`), as we found before. However, all other models seem to be of similar goodness. According to BIC, the best is (`fixed_model`)

Therefore, the models I will consider are:

-   T + M + D + T \* M \* D + (T \|\| ID) [best model according to AIC]
-   T + M + D [best model according to BIC]
-   T + M + D + T \* M \* D + (T \| ID) [best model found introducing the correlation at the end]\*

\*DOESN't WORK THOUGH (number of observations (=40) \<= number of random effects (=40) )

```{r echo = FALSE, warning = FALSE}
#Create a table in which time is a fixed effect. 

### --- INITIALISE TABLE --- ###

columns = c("model", "time_point", "AIC", "BIC", "R2", "R2_fixed", "R2_meta_mixed", "R2_meta_fixed") #"R2_mixed"
fitted_time_table = data.frame(matrix(ncol = length(columns),
                                     nrow = 0))
colnames(fitted_time_table) = columns

### --- T + M + D --- ###

for (last_point in 3:7) {
  
  full_model = lm(regional_mean_bioarea ~ 
                    predicted_from_time +
                    metaecosystem_type +
                    disturbance,
                    data = filter(ds_regional_predicted_shrunk_type_n_day, 
                                  time_point <= last_point))
  
  null_model = lm(regional_mean_bioarea ~ 
                    1 , 
                  data = filter(ds_regional_predicted_shrunk_type_n_day, 
                                time_point <= last_point))
  
  metaeco_null_model = lm(regional_mean_bioarea ~  
                            predicted_from_time +
                            disturbance,
                                 data = filter(ds_regional_predicted_shrunk_type_n_day, 
                                               time_point <= last_point))
  
  fitted_time_table = update_all_models_table("T + M + D",
                                             fitted_time_table, 
                                             full_model, 
                                             null_model,
                                             metaeco_null_model,
                                             "fixed")
}

### --- T + M + D + T*M*D + (T||ID) --- ###

for (last_point in 3:7) {
  
  full_model = lmer(regional_mean_bioarea ~ 
                      predicted_from_time +
                      metaecosystem_type +
                      disturbance +
                      predicted_from_time * metaecosystem_type * disturbance + 
                      (predicted_from_time || system_nr),
                    data = filter(ds_regional_predicted_shrunk_type_n_day, 
                                  time_point <= last_point),
                    REML = FALSE,
                    control = lmerControl(optimizer ="Nelder_Mead"))
  
  null_model = lm(regional_mean_bioarea ~ 
                    1 , 
                  data = filter(ds_regional_predicted_shrunk_type_n_day, 
                                time_point <= last_point))
   
  metaeco_null = lmer(regional_mean_bioarea ~  
                        predicted_from_time +
                        disturbance +
                        predicted_from_time * disturbance + 
                        (predicted_from_time || system_nr),
                      data = filter(ds_regional_predicted_shrunk_type_n_day, 
                                               time_point <= last_point),
                      REML = FALSE, 
                      control = lmerControl(optimizer ="Nelder_Mead"))
  
  fitted_time_table = update_all_models_table("T + M + D + T*M*D + (T||ID)",
                                             fitted_time_table, 
                                             full_model, 
                                             null_model,
                                             metaeco_null,
                                             "mixed")
}

# for (last_point in 3:7) {
#   
#   full_model = lmer(regional_mean_bioarea ~ 
#                             predicted_from_time + 
#                             metaecosystem_type  + 
#                             disturbance + 
#                             predicted_from_time * metaecosystem_type * disturbance +
#                             (predicted_from_time | system_nr),
#                data = filter(ds_regional_predicted_shrunk_type_n_day, 
#                                   time_point <= last_point),
#                REML = FALSE,
#                control = lmerControl (optimizer = "Nelder_Mead"))
#   
#   null_model = lm(regional_mean_bioarea ~ 
#                     1 , 
#                   data = filter(ds_regional_predicted_shrunk_type_n_day, 
#                                 time_point <= last_point))
#    
#   metaeco_null = lmer(regional_mean_bioarea ~  
#                         predicted_from_time +
#                         disturbance +
#                         predicted_from_time * disturbance + 
#                         (predicted_from_time | system_nr),
#                       data = filter(ds_regional_predicted_shrunk_type_n_day, 
#                                                time_point <= last_point),
#                       REML = FALSE, 
#                       control = lmerControl(optimizer ="Nelder_Mead"))
#   
#   fitted_time_table = update_all_models_table("T + M + D + T*M*D + (T|ID)",
#                                              fitted_time_table, 
#                                              full_model, 
#                                              null_model,
#                                              metaeco_null,
#                                              "mixed")
# }
```
