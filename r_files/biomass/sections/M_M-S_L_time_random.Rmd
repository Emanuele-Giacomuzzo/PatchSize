---
title: "model_all_points_without_time_fitting"
author: "Emanuele Giacomuzzo"
date: '2022-07-22'
output: html_document
editor_options: 
  chunk_output_type: console
---

##### Model selection

First of all, let's include time as a random variable. Let's start from the largest mixed effect model makes sense to construct. This will include:

-   As fixed effect: disturbance, metaecosystem type, and their interaction
-   As random effect (random intercept and slope): day and the number of the metaecosystem (system_nr).

We are actually going to construct two full models. One with the correlated and one with the uncorrelated random slopes and intercept, the other without

*Should we get rid of the correlation between intercept and slopes?*

```{r full-models}
full_model_correlated = lmer(regional_mean_bioarea ~ 
                             metaecosystem_type  + 
                             disturbance + 
                             metaecosystem_type * disturbance + 
                             (metaecosystem_type | day) + 
                             (disturbance | day) + 
                             (metaecosystem_type*disturbance  | day) +
                             (1 | system_nr) , 
                             data = ds_regional_shrunk_type_n_day, 
                             REML = FALSE)

full_model_uncorrelated = lmer(regional_mean_bioarea ~ 
                    metaecosystem_type  + 
                    disturbance + 
                    metaecosystem_type * disturbance + 
                    (metaecosystem_type || day) + 
                    (disturbance || day) + 
                    (metaecosystem_type*disturbance  || day) +
                    (1 | system_nr) ,
                  data = ds_regional_shrunk_type_n_day, 
                  REML = FALSE)

anova(full_model_uncorrelated, full_model_correlated)
```

No.

```{r}
best_model = full_model_correlated
```

*Should we get rid of the interaction between meta-ecosystem and disturbance?*

```{r no_interaction_model, message=FALSE}
no_interaction_model = lmer(regional_mean_bioarea ~ 
                              metaecosystem_type + 
                              disturbance  + 
                              (metaecosystem_type | day) + 
                              (disturbance | day) +
                              (1 | system_nr), 
                            data = ds_regional_shrunk_type_n_day, 
                            REML = FALSE)

anova(best_model, no_interaction_model)
```

Yes.

```{r}
best_model = no_interaction_model
```

*Should we get rid of the random slopes at different days?*

```{r no_slopes_model, message=FALSE}
no_slopes_model = lmer(regional_mean_bioarea ~ 
                         metaecosystem_type + 
                         disturbance  + 
                         (1 | day) +
                         (1 | system_nr), 
                       data = ds_regional_shrunk_type_n_day, 
                       REML = FALSE)

anova(best_model, no_slopes_model)
```

According to BIC yes (but according to AIC no). I'll still follow the suggestion of BIC.

```{r best-model}
best_model = no_slopes_model
```

*Should we get rid of the random effect of system number?*

```{r}
no_system_nr = lmer(regional_mean_bioarea ~ 
                         metaecosystem_type + 
                         disturbance  + 
                         (1 | day), 
                       data = ds_regional_shrunk_type_n_day, 
                       REML = FALSE)

anova(best_model, no_system_nr)
```

Yes. Although the difference between the two models according to AIC is not that much.

As it seems like the random slopes and intercepts of meta-ecoystem number had a weak effect, but still an effect, let's then keep both models as possible models.

```{r}
best_model_without_system_nr = no_system_nr
best_model_with_system_nr = no_interaction_model
```

##### Model [without]{.underline} system number as random effect

`regional_mean_bioarea ~ metaecosystem_type + disturbance  + (1 | day)`

Let's now look at the effect size of meta-ecosystem type. It will be the effect size of such model minus the effect size of the same model but without meta-ecosystem type.

```{r}

columns = c("model", "AIC", "BIC", "c_r2", "c_r2_metaeco", "m_r2", "m_r2_metaeco")
all_models = data.frame(matrix(ncol = length(columns), nrow = 0))
colnames(all_models) = columns

#### --- M + D + (1 | day) ---- ####

model_name = "M + D + (1 | day)"
R2_range = NULL
m_r2_whole = NULL
c_r2_whole = NULL
for (last_point in 2:7) {
  
  #Models
  full_model = lmer(regional_mean_bioarea ~ 
                      disturbance +
                      metaecosystem_type +
                      (1 | day),
                    data = ds_regional_shrunk_type_n_day %>%
                                    filter(time_point <= last_point),
                    REML = FALSE,
                    control = lmerControl(optimizer ="Nelder_Mead"))
  
  null_model = lm(regional_mean_bioarea ~ 
                    1 , 
                  data = ds_regional_shrunk_type_n_day %>%
                                         filter(time_point <= last_point))
  
  metaecosystem_type_null = lmer(regional_mean_bioarea ~  
                                 disturbance  + 
                                 (1 | day),
                               data = ds_regional_shrunk_type_n_day %>%
                                         filter(time_point <= last_point), 
                               REML = FALSE, 
                               control = lmerControl(optimizer ="Nelder_Mead"))
  
  
  
  #R2
  r2_whole = round(r.squaredGLMM(best_model_without_system_nr), digits = 3)
  r2_metaeco = round(r2_whole - r.squaredGLMM(metaecosystem_type_null), digits = 3)
  
  m_r2_whole = r2_whole[1]
  c_r2_whole = r2_whole[2]
  m_r2_metaeco = r2_metaeco[1]
  c_r2_metaeco = r2_metaeco[2]
  
  #ANOVA
  anova = anova(full_model, null_model)
  
  #P-value
  p_whole = round(anova$`Pr(>Chisq)`[2], digits = 5)
  if (p_whole < 0.00001) {p_whole = "< 0.00001"}
  
  #AIC, BIC
  AIC_whole = anova$AIC[2]
  BIC_whole = anova$BIC[2]
  
  #Assign
  row = nrow(all_models) + 1
  all_models[row] = NA
  
}

#Different time points single points 
R2 = NULL
for (t in 2:7) {
  
  time_point_input = t
  filtered_dataset = ds_regional_shrunk_type_n_day %>%
    filter(time_point == time_point_input)
  model_1 = lm(regional_mean_bioarea ~ 
                            disturbance +
                            metaecosystem_type,
                        data = filtered_dataset)
  model_2 = lm(regional_mean_bioarea ~ 
                            disturbance,
                        data = filtered_dataset)
  R2[[t]] = summary(model_1)$adj.r.squared - summary(model_2)$adj.r.squared
  R2[[t]] = round(R2[[t]], digits = 3)
  
}
```

##### Model [with]{.underline} system number as random effect

Let's now look at the effect size of meta-ecosystem type. It will be the effect size of such model minus the effect size of the same model but without meta-ecosystem type.

```{r}
#Effect size of the whole model 
model.null = lm(regional_mean_bioarea ~ 1 , 
                  data = ds_regional_shrunk_type_n_day)

r_whole = r.squaredGLMM(best_model_with_system_nr)
r_whole = round(r_whole, digits = 3)

anova = anova(best_model_with_system_nr, model.null)
p_whole = anova$`Pr(>Chisq)`[2]
p_whole = round(p_whole, digits = 5)

if (p_whole < 0.00001) {
  p_whole = "< 0.00001"
}

#Effect size of meta-ecosystem type
metaecosystem_type_null = lmer(regional_mean_bioarea ~  
                                 disturbance  + 
                                 (1 | day),
                               data = ds_regional_shrunk_type_n_day, 
                               REML = FALSE, 
                               control = lmerControl(optimizer ="Nelder_Mead"))

r2_no_metaecosystem_type = r.squaredGLMM(metaecosystem_type_null)
r2_no_metaecosystem_type = round(r2_no_metaecosystem_type, digits = 3)

anova = anova(best_model_with_system_nr, metaecosystem_type_null)
p_no_metaecosystem_type = anova$`Pr(>Chisq)`[2]
p_no_metaecosystem_type = round(p_no_metaecosystem_type, digits = 5)

if (p_no_metaecosystem_type < 0.00001) {
  p_no_metaecosystem_type = "< 0.00001"
}

#Effect size of disturbance
disturbance_null = lmer(regional_mean_bioarea ~ 
                          metaecosystem_type  + 
                          (1 | day), 
                        data = ds_regional_shrunk_type_n_day, 
                        REML = FALSE,
                        control = lmerControl(optimizer ='optimx', 
                                                     optCtrl=list(method='L-BFGS-B')))

r2_no_disturbance = r.squaredGLMM(disturbance_null)
r2_no_disturbance = round(r2_no_disturbance, digits = 3)

anova = anova(best_model_with_system_nr, disturbance_null)
p_no_disturbance = anova$`Pr(>Chisq)`[2]
p_no_disturbance = round(p_no_disturbance, digits = 5)

if (p_no_disturbance < 0.00001) {
  p_no_disturbance = "< 0.00001"
}
```

The effect size and significance of our results can be found in the following table.

| Model                                  |           Marginal R2           |   Marginal R2 of the best model explained    |         Conditional R2          |  Conditional R2 of the best model explained  |           P-value           |
|:-----------|:----------:|:----------:|:----------:|:----------:|:----------:|
| Best model                             |         `r r_whole[1]`          |                      /                       |         `r r_whole[2]`          |                      /                       |         `r p_whole`         |
| Best model without meta-ecosystem type | `r r2_no_metaecosystem_type[1]` | `r r_whole[1] - r2_no_metaecosystem_type[1]` | `r r2_no_metaecosystem_type[2]` | `r r_whole[2] - r2_no_metaecosystem_type[2]` | `r p_no_metaecosystem_type` |
| Best model without disturbance         |    `r r2_no_disturbance[1]`     |    `r r_whole[1] - r2_no_disturbance[1]`     |    `r r2_no_disturbance[2]`     |    `r r_whole[2] - r2_no_disturbance[2]`     |    `r p_no_disturbance`     |

This means that meta-ecosystem type should explain more than disturbance regional biomass dynamics. However, the effect size isn't that high (`r r_whole[1] - r2_no_metaecosystem_type[1]`). Let's Let's now try to see how meta-ecosystem effect changes across different time periods.

```{r}

R2 = NULL

for (last_point in 3:7) {
  
  filtered_dataset = ds_regional_shrunk_type_n_day %>%
  filter(time_point <= last_point)
  
  full_model = lm(regional_mean_bioarea ~ 
                            disturbance +
                            metaecosystem_type +
                            (1 | day),
                        data = filtered_dataset)
  
  no_metaeco_type_model = lm(regional_mean_bioarea ~ 
                            disturbance +
                            (1 | day),
                        data = filtered_dataset)
  
  anova(full_model, no_metaeco_type_model)
  
  R2_full = r.squaredGLMM(full_model)[1,1]
  R2_null = r.squaredGLMM(no_metaeco_type_model)[1,1]
  
  R2[[last_point]] =  R2_full - R2_null
  R2[[last_point]] = round(R2[[last_point]], digits = 3)
  
}
```

|     Time points     | R squared of meta-ecosystem type (marginal) |
|:-------------------:|:-------------------------------------------:|
|       t2 - t3       |                 `r R2[[3]]`                 |
|       t2 -t4        |                 `r R2[[4]]`                 |
| t2 - t5 (my choice) |                 `r R2[[5]]`                 |
|       t2 - t6       |                 `r R2[[6]]`                 |
|       t2 - t7       |                 `r R2[[7]]`                 |

: This is a caption.

Let's now see how meta-ecosystem type influenced regional biomass at each time point.

```{r}

R2 = NULL
for (t in 2:7) {
  
  time_point_input = t
  filtered_dataset = ds_regional_shrunk_type_n_day %>%
    filter(time_point == time_point_input)
  model_1 = lm(regional_mean_bioarea ~ 
                            disturbance +
                            metaecosystem_type,
                        data = filtered_dataset)
  model_2 = lm(regional_mean_bioarea ~ 
                            disturbance,
                        data = filtered_dataset)
  R2[[t]] = summary(model_1)$adj.r.squared - summary(model_2)$adj.r.squared
  R2[[t]] = round(R2[[t]], digits = 3)
  
}

```

| Time point |  R squared  |
|:----------:|:-----------:|
|     t2     | `r R2[[2]]` |
|     t3     | `r R2[[3]]` |
|     t4     | `r R2[[4]]` |
|     t5     | `r R2[[5]]` |
|     t6     | `r R2[[6]]` |
|     t7     | `r R2[[7]]` |

##### Results

It seems like the inclusion of the random effect increased the power of the overall model but decreased the effect size of meta-ecosystem type.
