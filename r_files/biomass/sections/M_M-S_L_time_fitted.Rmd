---
title: "time_fitting"
author: "Emanuele Giacomuzzo"
date: '2022-07-22'
output: html_document
editor_options: 
  chunk_output_type: console
---

##### Fitting function to biomass across time (t0 - t7)

Here we want to fit how biomass changes across time to a function. The biomass of our meta-ecosystems looks like this.

```{r regional biomass plot}

ds_regional_shrunk_type = ds_regional %>%
    filter(metaecosystem_type == "M_M" | metaecosystem_type == "S_L")

ds_regional_shrunk_type%>%
  ggplot(aes(x = day,
             y = regional_mean_bioarea,
             group = day)) + 
  geom_boxplot() +
  labs(x = "day", y = "regional bioarea")
```

To fit these data, we need to produce (and parameterise) a function that resemble how the biomass first increases and then decreases.

Hank produced the following function:

$$biomass = a_4 * (day - a_5) * e^{a_1(day - a_5)}$$

If we parameterise the function and then plot, it looks as follows.

```{r time-function}

a1 = -0.1
a4 = 1200
a5 = -1

day = seq(0, 30, 0.01)
biomass = a4*(day-a5) * exp(a1*(day-a5))
plot(biomass ~ day)
```

Now, let's find the best parameters (a1, a4, a5) that fit our data.

```{r parameterise-time-function, results= FALSE}

model = nls(regional_mean_bioarea ~ a4 * (day-a5) * exp(a1 * (day-a5)), 
            start = list(a1 = -0.1, a4 = 1200, a5 = -1),
            trace = T,
            data = ds_regional_shrunk_type)

a1 = as.numeric(model$m$getPars()[1])
a4 = as.numeric(model$m$getPars()[2])
a5 = as.numeric(model$m$getPars()[3])
```

```{r show-fitted-parameters}
model$m$getPars()
```

And now let's plot the function to see how it fits our data.

```{r plot-parameterised-time-function}

day = seq(0,30,1)
predicted = a4*(day-a5)*exp(a1*(day-a5))
data_fitted=data.frame(day=day,regional_mean_bioarea=predicted)

ds_regional_shrunk_type%>%
  ggplot(aes(x = day,
             y = regional_mean_bioarea,
             group = day)) + 
  geom_boxplot() +
  labs(x = "day", y = "regional bioarea") +
  geom_line(data=data_fitted,aes(x = day, y=regional_mean_bioarea),color="red", group = 1)
```

Let's then include our predictions into the data set.

```{r predicted-ds}

ds_regional_predicted_shrunk_type = ds_regional %>%
  mutate(predicted_from_time = a4*(day-a5)*exp(a1*(day-a5))) %>%
  filter(metaecosystem_type == "S_L" | metaecosystem_type == "M_M")
```

##### Tidy

```{r}
ds_regional_predicted_shrunk_type_n_day = ds_regional_predicted_shrunk_type %>%
  filter(time_point >= 2)
```

##### Model selection

*Are slopes and intercept correlated?*

```{r eval = FALSE}
model_slopes_correlated = lmer(regional_mean_bioarea ~ 
                            predicted_from_time + 
                            metaecosystem_type  + 
                            disturbance + 
                            predicted_from_time * metaecosystem_type +
                            predicted_from_time * disturbance +
                            metaecosystem_type * disturbance +
                            predicted_from_time * metaecosystem_type * disturbance +
                            (predicted_from_time | system_nr),
                        data = ds_regional_predicted_shrunk_type_n_day,
                        REML = FALSE)

model_slopes_uncorrelated = lmer(regional_mean_bioarea ~ 
                            predicted_from_time + 
                            metaecosystem_type  + 
                            disturbance + 
                            predicted_from_time * metaecosystem_type +
                            predicted_from_time * disturbance +
                            metaecosystem_type * disturbance +
                            predicted_from_time * metaecosystem_type * disturbance +
                            (predicted_from_time || system_nr),
                        data = ds_regional_predicted_shrunk_type_n_day,
                        REML = FALSE)

anova(model_slopes_uncorrelated, model_slopes_correlated)
```

It doesn't work. Wired. Well, let's just keep the slopes as uncorrelated (`model_slopes_uncorrelated`).

*Should we get rid of the interaction between time and meta-ecosystem type?*

```{r time-fitted-random-effects}
model_1 = lmer(regional_mean_bioarea ~ 
                            predicted_from_time + 
                            metaecosystem_type  + 
                            disturbance + 
                            predicted_from_time * metaecosystem_type +
                            predicted_from_time * disturbance +
                            metaecosystem_type * disturbance +
                            predicted_from_time * metaecosystem_type * disturbance +
                            (predicted_from_time || system_nr),
               data = ds_regional_predicted_shrunk_type_n_day,
               REML = FALSE,
               control = lmerControl (optimizer = "Nelder_Mead")
               )

model_2 = lmer(regional_mean_bioarea ~ 
                            predicted_from_time + 
                            metaecosystem_type  + 
                            disturbance + 
                            predicted_from_time * disturbance +
                            metaecosystem_type * disturbance +
                            predicted_from_time * metaecosystem_type * disturbance +
                            (predicted_from_time || system_nr),
               data = ds_regional_predicted_shrunk_type_n_day,
               REML = FALSE,
               control = lmerControl (optimizer = "Nelder_Mead")
               )

anova(model_1, model_2)
```

Yes.

*Should we get rid of the interaction between time and disturbance?*

```{r}
model_3 = lmer(regional_mean_bioarea ~ 
                            predicted_from_time + 
                            metaecosystem_type  + 
                            disturbance + 
                            metaecosystem_type * disturbance +
                            predicted_from_time * metaecosystem_type * disturbance +
                            (predicted_from_time || system_nr),
               data = ds_regional_predicted_shrunk_type_n_day,
               REML = FALSE,
               control = lmerControl (optimizer = "Nelder_Mead"))

anova(model_2, model_3)
```

Yes.

*Should we get rid of the interaction between meta-ecosystem type and disturbance?*

```{r}
model_4 = lmer(regional_mean_bioarea ~ 
                            predicted_from_time + 
                            metaecosystem_type  + 
                            disturbance + 
                            predicted_from_time * metaecosystem_type * disturbance +
                            (predicted_from_time || system_nr),
               data = ds_regional_predicted_shrunk_type_n_day,
               REML = FALSE,
               control = lmerControl (optimizer = "Nelder_Mead"))

anova(model_3, model_4)
```

Yes.

*Should we get rid of the interaction between meta-ecosystem type, disturbance, and time?*

```{r}
model_5 = lmer(regional_mean_bioarea ~ 
                            predicted_from_time + 
                            metaecosystem_type  + 
                            disturbance + 
                            (predicted_from_time || system_nr),
               data = ds_regional_predicted_shrunk_type_n_day,
               REML = FALSE,
               control = lmerControl (optimizer = "Nelder_Mead"))

anova(model_4, model_5)
```

Yes and no. It depends whether we consider more important AIC or BIC. I would now follow BIC and keep the most parsimonious model.

*Should we get rid of the random effect of system number on the slope of time?*

```{r}

#Take off disturbance slopes
model_8 = lmer(regional_mean_bioarea ~ 
                            predicted_from_time + 
                            metaecosystem_type  + 
                            disturbance + 
                            (1 | system_nr),
               data = ds_regional_predicted_shrunk_type_n_day,
               REML = FALSE,
               control = lmerControl (optimizer = "Nelder_Mead"))

anova(model_5, model_8)
```

Yes.

*Should we get rid of the random effect of system number?*

```{r}

#Take off random effects
model_9 = lm(regional_mean_bioarea ~ 
                            predicted_from_time + 
                            metaecosystem_type  + 
                            disturbance,
                        data = ds_regional_predicted_shrunk_type_n_day)

anova(model_8, model_9)
```

Yes. Let's then keep this last model as our best model and then calculate the effect size of meta-ecosystem type. But actually other two models that are feasible are the one with the interaction between time, disturbance, and meta-ecosystem type (model_4) and the one with system number as a random effect. I think we should test those too.

##### Good model 1

`regional_mean_bioarea ~ predicted_from_time + metaecosystem_type  + disturbance`

```{r}

R2 = NULL

for (last_point in 3:7) {
  
  full_model = lm(regional_mean_bioarea ~ 
                    predicted_from_time +
                    metaecosystem_type +
                    disturbance,
                  data = ds_regional_predicted_shrunk_type %>%
                         filter(time_point <= last_point)
                  )
  
  no_metaeco_type_model = lm(regional_mean_bioarea ~ 
                               predicted_from_time +
                               disturbance,
                             data = ds_regional_predicted_shrunk_type %>%
                               filter(time_point <= last_point)
                             )
  
  anova(full_model, no_metaeco_type_model)
  
  #summary(full_model)
  #summary(no_metaeco_type_model)
  
  R2_full = summary(full_model)$adj.r.squared
  R2_no_metaeco_type = summary(no_metaeco_type_model)$adj.r.squared
  R2[[last_point]] = R2_full - R2_no_metaeco_type
  R2[[last_point]] = round(R2[[last_point]], digits = 3)
  
}
```

|     Time points     |  R squared  |
|:-------------------:|:-----------:|
|       t2 - t3       | `r R2[[3]]` |
|       t2 -t4        | `r R2[[4]]` |
| t2 - t5 (my choice) | `r R2[[5]]` |
|       t2 - t6       | `r R2[[6]]` |
|       t2 - t7       | `r R2[[7]]` |

##### Good model 2

`regional_mean_bioarea ~ predicted_from_time + metaecosystem_type  + disturbance + predicted_from_time * metaecosystem_type * disturbance`

```{r}

R2 = NULL

for (last_point in 3:7) {
  
  full_model = lm(regional_mean_bioarea ~ 
                    predicted_from_time +
                    metaecosystem_type +
                    disturbance +
                    predicted_from_time * metaecosystem_type * disturbance,
                  data = ds_regional_predicted_shrunk_type %>%
                         filter(time_point <= last_point)
                  )
  
  no_metaeco_type_model = lm(regional_mean_bioarea ~ 
                               predicted_from_time +
                               disturbance +
                               predicted_from_time * disturbance,
                             data = ds_regional_predicted_shrunk_type %>%
                               filter(time_point <= last_point)
                             )
  
  anova(full_model, no_metaeco_type_model)
  
  #summary(full_model)
  #summary(no_metaeco_type_model)
  
  R2_full = summary(full_model)$adj.r.squared
  R2_no_metaeco_type = summary(no_metaeco_type_model)$adj.r.squared
  R2[[last_point]] = R2_full - R2_no_metaeco_type
  R2[[last_point]] = round(R2[[last_point]], digits = 3)
  
}
```

|     Time points     |  R squared  |
|:-------------------:|:-----------:|
|       t2 - t3       | `r R2[[3]]` |
|       t2 -t4        | `r R2[[4]]` |
| t2 - t5 (my choice) | `r R2[[5]]` |
|       t2 - t6       | `r R2[[6]]` |
|       t2 - t7       | `r R2[[7]]` |

##### Good model 3

`regional_mean_bioarea ~ predicted_from_time + metaecosystem_type  + disturbance + predicted_from_time * metaecosystem_type * disturbance + (predicted_from_time || system_nr)`

```{r}
R2 = NULL

for (last_point in 3:7) {

  full_model = lmer(regional_mean_bioarea ~ 
                    predicted_from_time +
                    metaecosystem_type +
                    disturbance +
                    predicted_from_time * metaecosystem_type * disturbance + 
                    (predicted_from_time || system_nr),
                  data = ds_regional_predicted_shrunk_type %>%
                         filter(time_point <= last_point), 
                  REML = FALSE,
                  control = lmerControl (optimizer = "Nelder_Mead")
                  )
  
  no_metaeco_type_model = lmer(regional_mean_bioarea ~ 
                               predicted_from_time +
                               disturbance +
                               predicted_from_time * disturbance + 
                               (predicted_from_time || system_nr),
                             data = ds_regional_predicted_shrunk_type %>%
                               filter(time_point <= last_point),
                             REML = FALSE,
                             control = lmerControl (optimizer = "Nelder_Mead")
                             )
  
  anova(full_model, no_metaeco_type_model)
  #summary(full_model)
  #summary(no_metaeco_type_model)
  
  R2_full = r.squaredGLMM(full_model)[1,1]
  R2_null = r.squaredGLMM(no_metaeco_type_model)[1,1]
  
  R2[[last_point]] =  R2_full - R2_null
  R2[[last_point]] = round(R2[[last_point]], digits = 3)
  
}
```

|     Time points     |  R squared  |
|:-------------------:|:-----------:|
|       t2 - t3       | `r R2[[3]]` |
|       t2 -t4        | `r R2[[4]]` |
| t2 - t5 (my choice) | `r R2[[5]]` |
|       t2 - t6       | `r R2[[6]]` |
|       t2 - t7       | `r R2[[7]]` |

##### Good model 4

`regional_mean_bioarea ~ predicted_from_time + metaecosystem_type  + disturbance + (predicted_from_time || system_nr)`

```{r}
R2 = NULL

for (last_point in 3:7) {
  
  full_model = lmer(regional_mean_bioarea ~ 
                    predicted_from_time +
                    metaecosystem_type +
                    disturbance +
                    (predicted_from_time || system_nr),
                  data = ds_regional_predicted_shrunk_type %>%
                         filter(time_point <= last_point),
                  REML = FALSE,
                  control = lmerControl (optimizer = "Nelder_Mead")
                  )
  
  no_metaeco_type_model = lmer(regional_mean_bioarea ~ 
                               predicted_from_time +
                               disturbance +
                               (predicted_from_time || system_nr),
                             data = ds_regional_predicted_shrunk_type %>%
                               filter(time_point <= last_point),
                             REML = FALSE,
                             control = lmerControl (optimizer = "Nelder_Mead")
                             )

  anova(full_model, no_metaeco_type_model)
  #summary(full_model)
  #summary(no_metaeco_type_model)
  
  R2_full = r.squaredGLMM(full_model)[1,1]
  R2_null = r.squaredGLMM(no_metaeco_type_model)[1,1]
  
  R2[[last_point]] =  R2_full - R2_null
  R2[[last_point]] = round(R2[[last_point]], digits = 3)
  
}
```

|     Time points     |  R squared  |
|:-------------------:|:-----------:|
|       t2 - t3       | `r R2[[3]]` |
|       t2 -t4        | `r R2[[4]]` |
| t2 - t5 (my choice) | `r R2[[5]]` |
|       t2 - t6       | `r R2[[6]]` |
|       t2 - t7       | `r R2[[7]]` |
