---
title: "S_patches"
author: "Emanuele Giacomuzzo"
date: "2022-08-02"
output: html_document
editor_options:
  chunk_output_type: console
---

##### Plots

```{r}

### --- SINGLE ECOSYSTEMS --- ###

ds_biomass %>%
  filter(disturbance == "low") %>%
  #filter(eco_metaeco_type == "S (S_S)" | eco_metaeco_type == "S (S_L)") %>%
  filter(patch_size == "S") %>%
  ggplot(aes(x = day,
             y = bioarea_per_volume,
             group = system_nr,
             fill = system_nr,
             color = system_nr,
             linetype = eco_metaeco_type)) +
  geom_line(stat = "summary", fun = "mean") +
  labs(x = "Day",
       y = "Local bioarea (something/μl)",
       title = "Disturbance = low",
       linetype = "") +
  theme_bw() +
  theme(panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        legend.position = c(.95, .95),
        legend.justification = c("right", "top"),
        legend.box.just = "right",
        legend.margin = margin(6, 6, 6, 6)) +
  scale_linetype_discrete(labels = c("small isolated",
                                     "small connected to small",
                                     "small connected to large"))  +
  geom_vline(xintercept = first_perturbation_day,
             linetype="dotdash",
             color = "grey",
             size=0.7) +
  labs(caption = "Vertical grey line: first perturbation")

ds_biomass %>%
  filter(disturbance == "high") %>%
  #filter(eco_metaeco_type == "S (S_S)" | eco_metaeco_type == "S (S_L)") %>%
  filter(patch_size == "S") %>%
  ggplot(aes(x = day,
             y = bioarea_per_volume,
             group = system_nr,
             fill = system_nr,
             color = system_nr,
             linetype = eco_metaeco_type)) +
  geom_line(stat = "summary", fun = "mean") +
  labs(title = "Disturbance = high",
       x = "Day",
       y = "Local bioarea (something/μl)",
       linetype = "") +
  theme_bw() +
  theme(panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        legend.position = c(.95, .95),
        legend.justification = c("right", "top"),
        legend.box.just = "right",
        legend.margin = margin(6, 6, 6, 6)) +
  scale_linetype_discrete(labels = c("small isolated",
                                     "small connected to small",
                                     "small connected to large"))  +
  geom_vline(xintercept = first_perturbation_day,
             linetype="dotdash",
             color = "grey",
             size=0.7) +
  labs(caption = "Vertical grey line: first perturbation")

### --- BOXPLOTS --- ###

local_small_low_plot = ds_biomass %>%
  filter(disturbance == "low") %>%
  filter(patch_size == "S") %>%
  ggplot(aes(x = day,
             y = bioarea_per_volume,
             group = interaction(day,eco_metaeco_type),
             fill = eco_metaeco_type)) +
  geom_boxplot() +
  labs(x = "Day",
       y = "Local bioarea (something/μl)",
       title = "Disturbance = low",
       fill = "") +
  theme_bw() +
  theme(panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        legend.position = c(.95, .95),
        legend.justification = c("right", "top"),
        legend.box.just = "right",
        legend.margin = margin(6, 6, 6, 6)) +
  scale_fill_discrete(labels = c("small isolated",
                                 "small connected to small",
                                 "small connected to large")) +
  geom_vline(xintercept = first_perturbation_day + 0.7,
             linetype="dotdash",
             color = "grey",
             size=0.7) +
  labs(caption = "Vertical grey line: first perturbation")
local_small_low_plot

ds_biomass %>%
  filter(disturbance == "high") %>%
  filter(patch_size == "S") %>%
  ggplot(aes(x = day,
             y = bioarea_per_volume,
             group = interaction(day,eco_metaeco_type),
             fill = eco_metaeco_type)) +
  geom_boxplot() +
  labs(title = "Disturbance = high",
       x = "Day",
       y = "Local bioarea (something/μl)",
       fill = "") +
  theme_bw() +
  theme(panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        legend.position = c(.95, .95),
        legend.justification = c("right", "top"),
        legend.box.just = "right",
        legend.margin = margin(6, 6, 6, 6)) +
  scale_fill_discrete(labels = c("small isolated",
                                 "small connected to small",
                                 "small connected to large")) +
  geom_vline(xintercept = first_perturbation_day + 0.7,
             linetype="dotdash",
             color = "grey",
             size=0.7) +
  labs(caption = "Vertical grey line: first perturbation")
```

##### Time series

Now I'll:

1.  Calculate the average biomass for each time point for all the isolated small patches, one for the low disturbance, and one for the high disturbance.
2.  For the small connected to small and small connected to large patches, calculate their response ratio.

```{r}
average_biomass_S_isolated_low = ds_biomass %>%
  filter(disturbance == "low") %>%
  filter(eco_metaeco_type == "S") %>%
  group_by(culture_ID, time_point, day) %>%
  summarise(bioarea_per_volume_across_videos = mean(bioarea_per_volume)) %>% #Across videos
  group_by(time_point, day) %>%
  summarise(mean_bioarea_per_volume = mean(bioarea_per_volume_across_videos)) #Across cultures

average_biomass_S_isolated_high = ds_biomass %>%
  filter(disturbance == "high") %>%
  filter(eco_metaeco_type == "S") %>%
  group_by(culture_ID, time_point, day) %>%
  summarise(bioarea_per_volume_across_videos = mean(bioarea_per_volume)) %>%
  group_by(time_point, day) %>%
  summarise(mean_bioarea_per_volume = mean(bioarea_per_volume_across_videos))


for (time_point_input in 0:7) {
 
  ds_biomass$isolated_control[ds_biomass$patch_size == "S" & 
                              ds_biomass$disturbance == "low" &
                              ds_biomass$time_point == time_point_input] =
  subset(average_biomass_S_isolated_low,
         time_point == time_point_input)$mean_bioarea_per_volume
  
}

for (time_point_input in 0:7) {
 
  ds_biomass$isolated_control[ds_biomass$patch_size == "S" & 
                              ds_biomass$disturbance == "high" &
                              ds_biomass$time_point == time_point_input] =
  subset(average_biomass_S_isolated_high,
         time_point == time_point_input)$mean_bioarea_per_volume
  
}

ds_biomass = ds_biomass %>%
  mutate(isolated_control = as.numeric(isolated_control)) %>%
  mutate(RR_bioarea_per_volume = bioarea_per_volume / isolated_control)
```

```{r}
### --- REPLOT THE SMALL PATCHES BUT AS RESPONSE RATIO --- ###

ds_biomass %>%
  filter(disturbance == "low") %>%
  filter(patch_size == "S") %>%
  group_by(system_nr, day, eco_metaeco_type) %>%
  summarise(RR_bioarea_per_volume = mean(RR_bioarea_per_volume)) %>% #Across videos
  ggplot(aes(x = day,
             y = RR_bioarea_per_volume,
             group = interaction(day, eco_metaeco_type),
             fill = eco_metaeco_type)) +
  geom_boxplot() +
  labs(title = "Disturbance = low",
       x = "Day",
       y = "Response ratio bioarea (something/μl)",
       fill = "") +
  theme_bw() +
  theme(panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        legend.position = c(.2, .95),
        legend.justification = c("right", "top"),
        legend.box.just = "right",
        legend.margin = margin(6, 6, 6, 6)) +
  scale_fill_discrete(labels = c("small isolated",
                                 "small connected to small",
                                 "small connected to large")) +
  geom_vline(xintercept = first_perturbation_day + 0.7,
             linetype="dotdash",
             color = "grey",
             size=0.7) +
  labs(caption = "Vertical grey line: first perturbation, Response ratio bioarea: Bioarea/Mean bioarea small isolated")

ds_biomass %>%
  filter(disturbance == "high") %>%
  filter(patch_size == "S") %>%
  group_by(system_nr, day, eco_metaeco_type) %>%
  summarise(RR_bioarea_per_volume = mean(RR_bioarea_per_volume)) %>% #Across videos
  ggplot(aes(x = day,
             y = RR_bioarea_per_volume,
             group = interaction(day, eco_metaeco_type),
             fill = eco_metaeco_type)) +
  geom_boxplot() +
  labs(title = "Disturbance = high",
       x = "Day",
       y = "Response ratio bioarea (something/μl)",
       fill = "") +
  theme_bw() +
  theme(panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        legend.position = c(.2, .95),
        legend.justification = c("right", "top"),
        legend.box.just = "right",
        legend.margin = margin(6, 6, 6, 6)) +
  scale_fill_discrete(labels = c("small isolated",
                                 "small connected to small",
                                 "small connected to large")) +
  geom_vline(xintercept = first_perturbation_day + 0.7,
             linetype="dotdash",
             color = "grey",
             size=0.7) +
  labs(caption = "Vertical grey line: first perturbation, Response ratio bioarea: Bioarea/Mean bioarea small isolated")

small_patches_figure = ds_biomass %>%
  filter(disturbance == "low") %>%
  filter(eco_metaeco_type == "S (S_S)" | eco_metaeco_type == "S (S_L)") %>%
  group_by(system_nr, day, eco_metaeco_type) %>%
  summarise(RR_bioarea_per_volume = mean(RR_bioarea_per_volume)) %>% #Across videos
  ggplot(aes(x = day,
             y = RR_bioarea_per_volume,
             group = interaction(day, eco_metaeco_type),
             fill = eco_metaeco_type)) +
  geom_boxplot() +
  labs(x = "Day",
       y = "Response ratio bioarea (something/μl)",
       fill = "") +
  theme_bw() +
  theme(panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        legend.position = c(.2, .95),
        legend.justification = c("right", "top"),
        legend.box.just = "right",
        legend.margin = margin(6, 6, 6, 6)) +
  scale_fill_discrete(labels = c("small connected to small",
                                 "small connected to large")) +
  geom_vline(xintercept = first_perturbation_day + 0.7,
             linetype="dotdash",
             color = "grey",
             size=0.7) +
  labs(caption = "Vertical grey line: first perturbation, Response ratio bioarea: Bioarea/Mean bioarea small isolated")
```

###### Model selection

Let's start from the full model:

$$
RR (bioarea) = t + M + D + t*M + t*D + M*D + t*M+D + (t | system \: nr)
$$

And let's consider all data points from the second to the seventh.

```{r}
first_time_point = 2
last_time_point = 7
```

```{r}
full_model = lmer(RR_bioarea_per_volume ~
                    day * eco_metaeco_type * disturbance +
                    (day | system_nr),
                  data = ds_biomass %>%
                         filter(time_point >= first_time_point) %>%
                         filter(time_point <= last_time_point) %>%
                         filter(eco_metaeco_type== "S (S_S)" | 
                                eco_metaeco_type == "S (S_L)"),
                  REML = FALSE
                  )
```

*Should we keep the interaction between the intercept and slope in (day \| system_nr)?*

```{r}
no_interaction = lmer(RR_bioarea_per_volume ~
                    day * eco_metaeco_type * disturbance +
                    (day || system_nr),
                  data = ds_biomass %>%
                         filter(time_point >= first_time_point) %>%
                         filter(time_point <= last_time_point) %>%
                         filter(eco_metaeco_type== "S (S_S)" | 
                                eco_metaeco_type == "S (S_L)"),
                  REML = FALSE
                  )

anova(full_model, no_interaction)
```

Yes.

*Should we keep the effects on the slope?*

```{r}
no_slope = lmer(RR_bioarea_per_volume ~
                    day * eco_metaeco_type * disturbance +
                    (1 | system_nr),
                  data = ds_biomass %>%
                         filter(time_point >= first_time_point) %>%
                         filter(time_point <= last_time_point) %>%
                         filter(eco_metaeco_type== "S (S_S)" | 
                                eco_metaeco_type == "S (S_L)"),
                  REML = FALSE
                  )

anova(full_model, no_slope)
```

Yes.

*Should we keep t \* M \* D?*

```{r}
no_three_way = lmer(RR_bioarea_per_volume ~
                    day +
                    eco_metaeco_type +
                    disturbance +
                    day : eco_metaeco_type + 
                    day : disturbance + 
                    eco_metaeco_type : disturbance + 
                    (day | system_nr),
                  data = ds_biomass %>%
                         filter(time_point >= first_time_point) %>%
                         filter(time_point <= last_time_point) %>%
                         filter(eco_metaeco_type== "S (S_S)" | 
                                eco_metaeco_type == "S (S_L)"),
                  REML = FALSE
                  )

anova(full_model, no_three_way)
```

No.

*Should we keep t \* M?*

```{r}
no_TM = lmer(RR_bioarea_per_volume ~
                    day +
                    eco_metaeco_type +
                    disturbance +
                    day : disturbance + 
                    eco_metaeco_type : disturbance + 
                    (day | system_nr),
                  data = ds_biomass %>%
                         filter(time_point >= first_time_point) %>%
                         filter(time_point <= last_time_point) %>%
                         filter(eco_metaeco_type== "S (S_S)" | 
                                eco_metaeco_type == "S (S_L)"),
                  REML = FALSE
                  )

anova(no_three_way, no_TM)
```

Yes.

*Should we keep t \* D?*

```{r}
no_TD = lmer(RR_bioarea_per_volume ~
                    day +
                    eco_metaeco_type +
                    disturbance +
                    day : eco_metaeco_type + 
                    eco_metaeco_type : disturbance + 
                    (day | system_nr),
                  data = ds_biomass %>%
                         filter(time_point >= first_time_point) %>%
                         filter(time_point <= last_time_point) %>%
                         filter(eco_metaeco_type== "S (S_S)" | 
                                eco_metaeco_type == "S (S_L)"),
                  REML = FALSE
                  )

anova(no_three_way, no_TD)
```

Yes.

Should we keep M \* D?

```{r}
no_MD = lmer(RR_bioarea_per_volume ~
                    day +
                    eco_metaeco_type +
                    disturbance +
                    day : eco_metaeco_type + 
                    day : disturbance + 
                    (day | system_nr),
                  data = ds_biomass %>%
                         filter(time_point >= first_time_point) %>%
                         filter(time_point <= last_time_point) %>%
                         filter(eco_metaeco_type== "S (S_S)" | 
                                eco_metaeco_type == "S (S_L)"),
                  REML = FALSE
                  )

anova(no_three_way, no_MD)
```

No.

*Should we keep D?*

```{r}
no_D = lmer(RR_bioarea_per_volume ~
                    day +
                    eco_metaeco_type +
                    day : eco_metaeco_type +
                    day : disturbance + 
                    (day | system_nr),
            data = ds_biomass %>%
                         filter(time_point >= first_time_point) %>%
                         filter(time_point <= last_time_point) %>%
                         filter(eco_metaeco_type== "S (S_S)" | 
                                eco_metaeco_type == "S (S_L)"),
            REML = FALSE,
            control = lmerControl (optimizer = "Nelder_Mead")
            )

anova(no_MD, no_D)
```

Wired, AIC tells us that we should not. Let's then compute how more likely is the first model to be true than the second one. I will compute it using a relative likelihood (see @Burnham2011):

$$
e^{0.5 (AIC_{min} - AIC_{max})}
$$

```{r}
AIC_min = 2172.4
AIC_max = 2174.3
exp(0.5 * (AIC_min - AIC_max))
```

The probability that the model without disturbance is better is only 40% more. I will then keep the disturbance.

Then our best model is:

$$
RR (bioarea) = t + M + D + t*D + (t | system \: nr)
$$

Let's then calculate the R squared and stuff.

```{r}
#Create a table in which the regional biomass has been log transformed. 

### --- INITIALISE TABLE --- ###

columns = c("model", "time_point", "AIC", "BIC", "R2_mixed", "R2_fixed", "R2_mixed_M", "R2_fixed_M")
small_patches_matrix = matrix(ncol = length(columns), nrow = 0)
small_patches_table = data.frame(small_patches_matrix)
colnames(small_patches_table) = columns

### --- POPULATE THE TABLE --- ###

for (last_point in 4:7) {
  
  full_model = lmer(RR_bioarea_per_volume ~
                    day +
                    eco_metaeco_type +
                    disturbance +
                    day : disturbance + 
                    day : eco_metaeco_type +
                    (day | system_nr),
                  data = ds_biomass %>%
                              filter(time_point >= 2) %>%
                              filter(time_point <= last_point) %>%
                              filter(eco_metaeco_type== "S (S_S)" | 
                                     eco_metaeco_type == "S (S_L)"),
                  REML = FALSE,
                  control = lmerControl(optimizer = 'optimx', 
                                        optCtrl = list(method = 'L-BFGS-B')))
  
  r.squaredGLMM(full_model)

  
  null_model = lm(RR_bioarea_per_volume ~
                    1,
                  data = ds_biomass %>%
                              filter(time_point >= 2) %>%
                              filter(time_point <= last_point) %>%
                              filter(eco_metaeco_type== "S (S_S)" | 
                                     eco_metaeco_type == "S (S_L)"))
  
  metaeco_null = lmer(RR_bioarea_per_volume ~
                        day +
                        disturbance +
                        day : disturbance +
                        day : eco_metaeco_type + 
                        (day | system_nr),
                      data = ds_biomass %>%
                        filter(time_point >= 2) %>%
                        filter(time_point <= last_point) %>%
                        filter(eco_metaeco_type== "S (S_S)" | 
                               eco_metaeco_type == "S (S_L)"),
                      REML = FALSE,
                      control = lmerControl(optimizer = "Nelder_Mead"))
  r.squaredGLMM(metaeco_null)
  
  small_patches_table = update_all_models_table("t + M + D + t*M + t*D + (t | ID)",
                                             small_patches_table, 
                                             full_model, 
                                             null_model,
                                             metaeco_null,
                                             "mixed")
}

datatable(small_patches_table, 
          rownames = FALSE,
          options = list(pageLength = 100,
                         scrollX = TRUE,
                         autoWidth = TRUE,
                         columnDefs = list(list(targets=c(0),visible=TRUE, width='160'),
                                           list(targets=c(1), visible=TRUE, width='10'),
                                           list(targets=c(2), visible=TRUE, width='10'),
                                           list(targets=c(3), visible=TRUE, width='10'),
                                           list(targets=c(4), visible=TRUE, width='10'),
                                           list(targets=c(5), visible=TRUE, width='10'),
                                           list(targets=c(6), visible=TRUE, width='10'),
                                           list(targets=c(7), visible=TRUE, width='10'),
                                           list(targets='_all', visible=FALSE))),
          caption = "
          M = Meta-ecosystem type, 
          D = disturbance, 
          (1 | t) = random effect of time on the intercept,
          (1 | ID) = random effect of meta-ecosystem ID on the intercept, 
          || = no correlation between intercept and slope,
          | = correlation between intercept and slope,
          R2 = r squared of the whole model,
          R2_fixed = fixed part of the mixed model,
          mixed_R2 = r squared when considering both fixed and random effects (conditional r squared), 
          fixed_R2 = r squared when considering only the fixed effects (marginal r squared)")
```

##### Single time points

I'll show model selection only on time point number 3 (however, I will do it also for the other time points). Let's start from the full model.

```{r}
time_point_input = 4
```

```{r}
full = lmer(RR_bioarea_per_volume ~
              metaecosystem_type +
              disturbance +
              disturbance : metaecosystem_type +
              (1 | system_nr),
            data = ds_biomass %>%
              filter(time_point == time_point_input) %>%
              filter(eco_metaeco_type== "S (S_S)" | 
                     eco_metaeco_type == "S (S_L)"),
          REML = FALSE)
```

*Should we keep the random effect?*

```{r}
no_random = lm(RR_bioarea_per_volume ~
              metaecosystem_type +
              disturbance +
              disturbance : metaecosystem_type,
            data = ds_biomass %>%
              filter(time_point == time_point_input) %>%
              filter(eco_metaeco_type== "S (S_S)" | 
                     eco_metaeco_type == "S (S_L)"))

anova(full, no_random)
```

No. But wired. I'll keep it anyway.

*Should we keep D \* M?*

```{r}
no_MD = lmer(RR_bioarea_per_volume ~
              metaecosystem_type +
              disturbance +
              (1 | system_nr),
            data = ds_biomass %>%
              filter(time_point == time_point_input) %>%
              filter(eco_metaeco_type== "S (S_S)" | 
                     eco_metaeco_type == "S (S_L)"),
          REML = FALSE)

anova(full, no_MD)
```

No.

**Best model**

Therefore, our best model is

$$
Regional \: Bioarea = M + D + (1 | ID)
$$

```{r}

### --- SINGLE TIME POINTS --- ###

columns = c("time_point", 
            "R2_full_marginal", 
            "R2_full_conditional", 
            "R2_patch_type_marginal", 
            "R2_patch_type_conditional")
single_points_matrix = matrix(ncol = length(columns), 
                              nrow = 7)
single_points = as.data.frame(single_points_matrix)
colnames(single_points) = columns

for (t in 2:7) {
  
  modified_ds = ds_biomass %>%
                      filter(time_point == t) %>%
                      filter(eco_metaeco_type== "S (S_S)" | 
                             eco_metaeco_type == "S (S_L)")
  
  full_model = lmer(RR_bioarea_per_volume ~
                      metaecosystem_type +
                      disturbance +
                      metaecosystem_type : disturbance +
                      (1 | system_nr),
                    data = modified_ds,
                    REML = FALSE)
  
  no_M_model = lmer(RR_bioarea_per_volume ~
                      disturbance +
                      (1 | system_nr),
                    data = modified_ds,
                    REML = FALSE)
  
  R2_full_model = r.squaredGLMM(full_model)
  R2_no_M_model = r.squaredGLMM(no_M_model)
  R2_patch_type = R2_full_model - R2_no_M_model
  
  single_points$time_point[t] = t
  single_points$R2_full_marginal[t] = R2_full_model[1]
  single_points$R2_full_conditional[t] = R2_full_model[2]
  single_points$R2_patch_type_marginal[t] = R2_patch_type[1]
  single_points$R2_patch_type_conditional[t] = R2_patch_type[2]
  
}

single_points = round(single_points, digits = 3)
single_points = single_points[2:nrow(single_points),]
datatable(single_points,
          rownames = FALSE,
          colnames = c("Time point", "R2 marginal \n full model", "R2 conditional \n full model", "R2 marginal \n patch type", "R2 conditional \n patch type"))
```

Let's now use the new package called `partR2`. For that, see @stoffel2021.

```{r}
modified_ds = ds_biomass %>%
                      filter(time_point == 3) %>%
                      filter(eco_metaeco_type== "S (S_S)" | 
                             eco_metaeco_type == "S (S_L)")

full_model = lmer(RR_bioarea_per_volume ~
                      metaecosystem_type +
                      disturbance +
                      metaecosystem_type : disturbance +
                      (1 | system_nr),
                    data = modified_ds,
                    REML = FALSE)

marginal_R2 = partR2(full_model,
       partvars = c("metaecosystem_type", "disturbance"),
       R2_type = "marginal", 
       nboot = 1000,
       CI = 0.95)
marginal_R2

conditional_R2 = partR2(full_model,
       partvars = c("metaecosystem_type", "disturbance"),
       R2_type = "conditional", 
       nboot = 1000,
       CI = 0.95)
conditional_R2
```
