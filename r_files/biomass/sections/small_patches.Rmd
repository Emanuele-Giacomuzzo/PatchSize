---
title: "S_patches"
author: "Emanuele Giacomuzzo"
date: "2022-08-02"
output: html_document
editor_options:
  chunk_output_type: console
---

##### Tidy

Now I'll:

1.  Calculate the average biomass for each time point for all the isolated small patches, one for the low disturbance, and one for the high disturbance.
2.  For the small connected to small and small connected to large patches, calculate their response ratio.

```{r tidy-small-patches}
for (disturbance_input in c("low", "high")){
  for (eco_metaeco_input in c("S", "M", "L")){
    for (time_point_input in 0:7){
      
      ds_biomass$isolated_control[ds_biomass$patch_size == eco_metaeco_input & 
                              ds_biomass$disturbance == disturbance_input &
                              ds_biomass$time_point == time_point_input] = 
        
        ds_biomass %>%
        filter(disturbance == disturbance_input) %>%
        filter(eco_metaeco_type == eco_metaeco_input) %>%
        filter(time_point == time_point_input) %>%        
        group_by(culture_ID) %>%
        summarise(bioarea_per_volume_across_videos = mean(bioarea_per_volume)) %>%
        summarise(mean_bioarea_per_volume = mean(bioarea_per_volume_across_videos))
      
    }
  }
}

ds_biomass = ds_biomass %>%
  mutate(isolated_control = as.numeric(isolated_control))
```

##### Plots

```{r small-patches-single-ecosystems-plots}
ds_biomass %>%
  filter(disturbance == "low") %>%
  #filter(eco_metaeco_type == "S (S_S)" | eco_metaeco_type == "S (S_L)") %>%
  filter(patch_size == "S") %>%
  ggplot(aes(x = day,
             y = bioarea_per_volume,
             group = system_nr,
             fill = system_nr,
             color = system_nr,
             linetype = eco_metaeco_type)) +
  geom_line(stat = "summary", fun = "mean") +
  labs(x = "Day",
       y = "Local bioarea (something/μl)",
       title = "Disturbance = low",
       linetype = "") +
  theme_bw() +
  theme(panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        legend.position = c(.95, .95),
        legend.justification = c("right", "top"),
        legend.box.just = "right",
        legend.margin = margin(6, 6, 6, 6)) +
  scale_linetype_discrete(labels = c("small isolated",
                                     "small connected to small",
                                     "small connected to large"))  +
  geom_vline(xintercept = first_perturbation_day,
             linetype="dotdash",
             color = "grey",
             size=0.7) +
  labs(caption = "Vertical grey line: first perturbation")

ds_biomass %>%
  filter(disturbance == "high") %>%
  #filter(eco_metaeco_type == "S (S_S)" | eco_metaeco_type == "S (S_L)") %>%
  filter(patch_size == "S") %>%
  ggplot(aes(x = day,
             y = bioarea_per_volume,
             group = system_nr,
             fill = system_nr,
             color = system_nr,
             linetype = eco_metaeco_type)) +
  geom_line(stat = "summary", fun = "mean") +
  labs(title = "Disturbance = high",
       x = "Day",
       y = "Local bioarea (something/μl)",
       linetype = "") +
  theme_bw() +
  theme(panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        legend.position = c(.95, .95),
        legend.justification = c("right", "top"),
        legend.box.just = "right",
        legend.margin = margin(6, 6, 6, 6)) +
  scale_linetype_discrete(labels = c("small isolated",
                                     "small connected to small",
                                     "small connected to large"))  +
  geom_vline(xintercept = first_perturbation_day,
             linetype="dotdash",
             color = "grey",
             size=0.7) +
  labs(caption = "Vertical grey line: first perturbation")
```

```{r small-patches-boxplots}
local_small_low_plot = ds_biomass %>%
  filter(disturbance == "low") %>%
  filter(patch_size == "S") %>%
  ggplot(aes(x = day,
             y = bioarea_per_volume,
             group = interaction(day,eco_metaeco_type),
             fill = eco_metaeco_type)) +
  geom_boxplot() +
  labs(x = "Day",
       y = "Local bioarea (something/μl)",
       title = "Disturbance = low",
       fill = "") +
  theme_bw() +
  theme(panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        legend.position = c(.95, .95),
        legend.justification = c("right", "top"),
        legend.box.just = "right",
        legend.margin = margin(6, 6, 6, 6)) +
  scale_fill_discrete(labels = c("small isolated",
                                 "small connected to small",
                                 "small connected to large")) +
  geom_vline(xintercept = first_perturbation_day + 0.7,
             linetype="dotdash",
             color = "grey",
             size=0.7) +
  labs(caption = "Vertical grey line: first perturbation")
local_small_low_plot

ds_biomass %>%
  filter(disturbance == "high") %>%
  filter(patch_size == "S") %>%
  ggplot(aes(x = day,
             y = bioarea_per_volume,
             group = interaction(day,eco_metaeco_type),
             fill = eco_metaeco_type)) +
  geom_boxplot() +
  labs(title = "Disturbance = high",
       x = "Day",
       y = "Local bioarea (something/μl)",
       fill = "") +
  theme_bw() +
  theme(panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        legend.position = c(.95, .95),
        legend.justification = c("right", "top"),
        legend.box.just = "right",
        legend.margin = margin(6, 6, 6, 6)) +
  scale_fill_discrete(labels = c("small isolated",
                                 "small connected to small",
                                 "small connected to large")) +
  geom_vline(xintercept = first_perturbation_day + 0.7,
             linetype="dotdash",
             color = "grey",
             size=0.7) +
  labs(caption = "Vertical grey line: first perturbation")
```

```{r small-patches-lnRR-plots}
ds_biomass %>%
  filter(disturbance == "low") %>%
  filter(eco_metaeco_type == "S (S_L)" | eco_metaeco_type == "S (S_S)") %>%
  group_by(culture_ID, day, eco_metaeco_type, isolated_control) %>%
  summarise(bioarea_per_volume_across_videos = mean(bioarea_per_volume)) %>% #Across videos
  mutate(RR_bioarea_per_volume = (bioarea_per_volume_across_videos+1) /isolated_control) %>%
  mutate(lnRR_bioarea_per_volume = ln(RR_bioarea_per_volume)) %>%
  ggplot(aes(x = day,
             y = lnRR_bioarea_per_volume,
             group = interaction(day, eco_metaeco_type),
             fill = eco_metaeco_type)) +
  geom_boxplot() +
  labs(title = "Disturbance = low",
       x = "Day",
       y = "Response ratio bioarea (something/μl)",
       fill = "") +
  theme_bw() +
  theme(panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        legend.position = c(.3, .95),
        legend.justification = c("right", "top"),
        legend.box.just = "right",
        legend.margin = margin(6, 6, 6, 6)) +
  scale_fill_discrete(labels = c("small connected to small",
                                 "small connected to large")) +
  geom_vline(xintercept = first_perturbation_day + 0.7,
             linetype="dotdash",
             color = "grey",
             size=0.7) +
  labs(caption = "Vertical grey line: first perturbation, Response ratio bioarea: Bioarea/Mean bioarea small isolated")

ds_biomass %>%
  filter(disturbance == "high") %>%
  filter(eco_metaeco_type == "S (S_L)" | eco_metaeco_type == "S (S_S)") %>%
  group_by(culture_ID, day, eco_metaeco_type, isolated_control) %>%
  summarise(bioarea_per_volume_across_videos = mean(bioarea_per_volume)) %>% #Across videos
  mutate(RR_bioarea_per_volume = (bioarea_per_volume_across_videos+1) /isolated_control) %>%
  mutate(lnRR_bioarea_per_volume = ln(RR_bioarea_per_volume)) %>%
  ggplot(aes(x = day,
             y = lnRR_bioarea_per_volume,
             group = interaction(day, eco_metaeco_type),
             fill = eco_metaeco_type)) +
  geom_boxplot() +
  labs(title = "Disturbance = high",
       x = "Day",
       y = "Response ratio bioarea (something/μl)",
       fill = "") +
  theme_bw() +
  theme(panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        legend.position = c(.3, .95),
        legend.justification = c("right", "top"),
        legend.box.just = "right",
        legend.margin = margin(6, 6, 6, 6)) +
  scale_fill_discrete(labels = c("small connected to small",
                                 "small connected to large")) +
  geom_vline(xintercept = first_perturbation_day + 0.7,
             linetype="dotdash",
             color = "grey",
             size=0.7) +
  labs(caption = "Vertical grey line: first perturbation, Response ratio bioarea: Bioarea/Mean bioarea small isolated")
```

```{r small-patches-lnRR-plots-fixing}
eco_metaeco_input = "S"
disturbance_input = "high"
time_point_input = 7

ds_biomass$isolated_control[ds_biomass$patch_size == eco_metaeco_input & 
                              ds_biomass$disturbance == disturbance_input &
                              ds_biomass$time_point == time_point_input] = 
        
        ds_biomass %>%
        filter(disturbance == disturbance_input) %>%
        filter(eco_metaeco_type == eco_metaeco_input) %>%
        filter(time_point == time_point_input) %>%        
        group_by(culture_ID) %>%
        summarise(bioarea_per_volume_across_videos = mean(bioarea_per_volume)) %>%
        summarise(mean_bioarea_per_volume = mean(bioarea_per_volume_across_videos))

#Average biomass across small isolated time point 7 = 16.5

ds_biomass %>%
        filter(disturbance == disturbance_input) %>%
        filter(eco_metaeco_type == eco_metaeco_input) %>%
        filter(time_point == time_point_input)

#I need to first average the two biomasses and then get the logarithm of their response ratio 
```

##### Time series

###### Model selection

Let's start from the full model:

$$
RR (bioarea) = t + M + D + t*M + t*D + M*D + t*M+D + (t | system \: nr)
$$

And let's consider all data points from the second to the seventh.

```{r}
first_time_point = 2
last_time_point = 7
```

```{r}
full_model = lmer(RR_bioarea_per_volume ~
                    day * eco_metaeco_type * disturbance +
                    (day | system_nr),
                  data = ds_biomass %>%
                         filter(time_point >= first_time_point) %>%
                         filter(time_point <= last_time_point) %>%
                         filter(eco_metaeco_type== "S (S_S)" | 
                                eco_metaeco_type == "S (S_L)"),
                  REML = FALSE
                  )
```

*Should we keep the interaction between the intercept and slope in (day \| system_nr)?*

```{r}
no_interaction = lmer(RR_bioarea_per_volume ~
                    day * eco_metaeco_type * disturbance +
                    (day || system_nr),
                  data = ds_biomass %>%
                         filter(time_point >= first_time_point) %>%
                         filter(time_point <= last_time_point) %>%
                         filter(eco_metaeco_type== "S (S_S)" | 
                                eco_metaeco_type == "S (S_L)"),
                  REML = FALSE
                  )

anova(full_model, no_interaction)
```

Yes.

*Should we keep the effects on the slope?*

```{r}
no_slope = lmer(RR_bioarea_per_volume ~
                    day * eco_metaeco_type * disturbance +
                    (1 | system_nr),
                  data = ds_biomass %>%
                         filter(time_point >= first_time_point) %>%
                         filter(time_point <= last_time_point) %>%
                         filter(eco_metaeco_type== "S (S_S)" | 
                                eco_metaeco_type == "S (S_L)"),
                  REML = FALSE
                  )

anova(full_model, no_slope)
```

Yes.

*Should we keep t \* M \* D?*

```{r}
no_three_way = lmer(RR_bioarea_per_volume ~
                    day +
                    eco_metaeco_type +
                    disturbance +
                    day : eco_metaeco_type + 
                    day : disturbance + 
                    eco_metaeco_type : disturbance + 
                    (day | system_nr),
                  data = ds_biomass %>%
                         filter(time_point >= first_time_point) %>%
                         filter(time_point <= last_time_point) %>%
                         filter(eco_metaeco_type== "S (S_S)" | 
                                eco_metaeco_type == "S (S_L)"),
                  REML = FALSE
                  )

anova(full_model, no_three_way)
```

No.

*Should we keep t \* M?*

```{r}
no_TM = lmer(RR_bioarea_per_volume ~
                    day +
                    eco_metaeco_type +
                    disturbance +
                    day : disturbance + 
                    eco_metaeco_type : disturbance + 
                    (day | system_nr),
                  data = ds_biomass %>%
                         filter(time_point >= first_time_point) %>%
                         filter(time_point <= last_time_point) %>%
                         filter(eco_metaeco_type== "S (S_S)" | 
                                eco_metaeco_type == "S (S_L)"),
                  REML = FALSE
                  )

anova(no_three_way, no_TM)
```

Yes.

*Should we keep t \* D?*

```{r}
no_TD = lmer(RR_bioarea_per_volume ~
                    day +
                    eco_metaeco_type +
                    disturbance +
                    day : eco_metaeco_type + 
                    eco_metaeco_type : disturbance + 
                    (day | system_nr),
                  data = ds_biomass %>%
                         filter(time_point >= first_time_point) %>%
                         filter(time_point <= last_time_point) %>%
                         filter(eco_metaeco_type== "S (S_S)" | 
                                eco_metaeco_type == "S (S_L)"),
                  REML = FALSE
                  )

anova(no_three_way, no_TD)
```

Yes.

Should we keep M \* D?

```{r}
no_MD = lmer(RR_bioarea_per_volume ~
                    day +
                    eco_metaeco_type +
                    disturbance +
                    day : eco_metaeco_type + 
                    day : disturbance + 
                    (day | system_nr),
                  data = ds_biomass %>%
                         filter(time_point >= first_time_point) %>%
                         filter(time_point <= last_time_point) %>%
                         filter(eco_metaeco_type== "S (S_S)" | 
                                eco_metaeco_type == "S (S_L)"),
                  REML = FALSE
                  )

anova(no_three_way, no_MD)
```

No.

*Should we keep D?*

```{r}
no_D = lmer(RR_bioarea_per_volume ~
                    day +
                    eco_metaeco_type +
                    day : eco_metaeco_type +
                    day : disturbance + 
                    (day | system_nr),
            data = ds_biomass %>%
                         filter(time_point >= first_time_point) %>%
                         filter(time_point <= last_time_point) %>%
                         filter(eco_metaeco_type== "S (S_S)" | 
                                eco_metaeco_type == "S (S_L)"),
            REML = FALSE,
            control = lmerControl (optimizer = "Nelder_Mead")
            )

anova(no_MD, no_D)
```

Wired, AIC tells us that we should not. Let's then compute how more likely is the first model to be true than the second one. I will compute it using a relative likelihood (see @Burnham2011):

$$
e^{0.5 (AIC_{min} - AIC_{max})}
$$

```{r}
AIC_min = 2172.4
AIC_max = 2174.3
exp(0.5 * (AIC_min - AIC_max))
```

The probability that the model without disturbance is better is only 40% more. I will then keep the disturbance.

Then our best model is:

$$
RR (bioarea) = t + M + D + t*D + (t | system \: nr)
$$

Let's then calculate the R squared and stuff.

```{r}
#Create a table in which the regional biomass has been log transformed. 

### --- INITIALISE TABLE --- ###

columns = c("model", "time_point", "AIC", "BIC", "R2_mixed", "R2_fixed", "R2_mixed_M", "R2_fixed_M")
small_patches_matrix = matrix(ncol = length(columns), nrow = 0)
small_patches_table = data.frame(small_patches_matrix)
colnames(small_patches_table) = columns

### --- POPULATE THE TABLE --- ###

for (last_point in 4:7) {
  
  full_model = lmer(RR_bioarea_per_volume ~
                    day +
                    eco_metaeco_type +
                    disturbance +
                    day : disturbance + 
                    day : eco_metaeco_type +
                    (day | system_nr),
                  data = ds_biomass %>%
                              filter(time_point >= 2) %>%
                              filter(time_point <= last_point) %>%
                              filter(eco_metaeco_type== "S (S_S)" | 
                                     eco_metaeco_type == "S (S_L)"),
                  REML = FALSE,
                  control = lmerControl(optimizer = 'optimx', 
                                        optCtrl = list(method = 'L-BFGS-B')))
  
  r.squaredGLMM(full_model)

  
  null_model = lm(RR_bioarea_per_volume ~
                    1,
                  data = ds_biomass %>%
                              filter(time_point >= 2) %>%
                              filter(time_point <= last_point) %>%
                              filter(eco_metaeco_type== "S (S_S)" | 
                                     eco_metaeco_type == "S (S_L)"))
  
  metaeco_null = lmer(RR_bioarea_per_volume ~
                        day +
                        disturbance +
                        day : disturbance +
                        day : eco_metaeco_type + 
                        (day | system_nr),
                      data = ds_biomass %>%
                        filter(time_point >= 2) %>%
                        filter(time_point <= last_point) %>%
                        filter(eco_metaeco_type== "S (S_S)" | 
                               eco_metaeco_type == "S (S_L)"),
                      REML = FALSE,
                      control = lmerControl(optimizer = "Nelder_Mead"))
  r.squaredGLMM(metaeco_null)
  
  small_patches_table = update_all_models_table("t + M + D + t*M + t*D + (t | ID)",
                                             small_patches_table, 
                                             full_model, 
                                             null_model,
                                             metaeco_null,
                                             "mixed")
}

datatable(small_patches_table, 
          rownames = FALSE,
          options = list(pageLength = 100,
                         scrollX = TRUE,
                         autoWidth = TRUE,
                         columnDefs = list(list(targets=c(0),visible=TRUE, width='160'),
                                           list(targets=c(1), visible=TRUE, width='10'),
                                           list(targets=c(2), visible=TRUE, width='10'),
                                           list(targets=c(3), visible=TRUE, width='10'),
                                           list(targets=c(4), visible=TRUE, width='10'),
                                           list(targets=c(5), visible=TRUE, width='10'),
                                           list(targets=c(6), visible=TRUE, width='10'),
                                           list(targets=c(7), visible=TRUE, width='10'),
                                           list(targets='_all', visible=FALSE))),
          caption = "
          M = Meta-ecosystem type, 
          D = disturbance, 
          (1 | t) = random effect of time on the intercept,
          (1 | ID) = random effect of meta-ecosystem ID on the intercept, 
          || = no correlation between intercept and slope,
          | = correlation between intercept and slope,
          R2 = r squared of the whole model,
          R2_fixed = fixed part of the mixed model,
          mixed_R2 = r squared when considering both fixed and random effects (conditional r squared), 
          fixed_R2 = r squared when considering only the fixed effects (marginal r squared)")
```

##### Single time points

I'll show model selection only on time point number 3 (however, I will do it also for the other time points). Let's start from the full model.

```{r}
time_point_input = 4
```

```{r}
full = lmer(RR_bioarea_per_volume ~
              metaecosystem_type +
              disturbance +
              disturbance : metaecosystem_type +
              (1 | system_nr),
            data = ds_biomass %>%
              filter(time_point == time_point_input) %>%
              filter(eco_metaeco_type== "S (S_S)" | 
                     eco_metaeco_type == "S (S_L)"),
          REML = FALSE)
```

*Should we keep the random effect?*

```{r}
no_random = lm(RR_bioarea_per_volume ~
              metaecosystem_type +
              disturbance +
              disturbance : metaecosystem_type,
            data = ds_biomass %>%
              filter(time_point == time_point_input) %>%
              filter(eco_metaeco_type== "S (S_S)" | 
                     eco_metaeco_type == "S (S_L)"))

anova(full, no_random)
```

No. But wired. I'll keep it anyway.

*Should we keep D \* M?*

```{r}
no_MD = lmer(RR_bioarea_per_volume ~
              metaecosystem_type +
              disturbance +
              (1 | system_nr),
            data = ds_biomass %>%
              filter(time_point == time_point_input) %>%
              filter(eco_metaeco_type== "S (S_S)" | 
                     eco_metaeco_type == "S (S_L)"),
          REML = FALSE)

anova(full, no_MD)
```

No.

**Best model**

Therefore, our best model is

$$
Regional \: Bioarea = M + D + (1 | ID)
$$
