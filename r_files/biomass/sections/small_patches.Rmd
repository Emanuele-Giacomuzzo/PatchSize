---
title: "S_patches"
author: "Emanuele Giacomuzzo"
date: "2022-08-02"
output: html_document
editor_options:
  chunk_output_type: console
---

##### Plots

```{r}

### --- SINGLE ECOSYSTEMS --- ###

ds_biomass %>%
  filter(disturbance == "low") %>%
  #filter(eco_metaeco_type == "S (S_S)" | eco_metaeco_type == "S (S_L)") %>%
  filter(patch_size == "S") %>%
  ggplot(aes(x = day,
             y = bioarea_per_volume,
             group = system_nr,
             fill = system_nr,
             color = system_nr,
             linetype = eco_metaeco_type)) +
  geom_line(stat = "summary", fun = "mean") +
  labs(x = "Day",
       y = "Local bioarea (something/μl)",
       title = "Disturbance = low",
       linetype = "") +
  theme_bw() +
  theme(panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        legend.position = c(.95, .95),
        legend.justification = c("right", "top"),
        legend.box.just = "right",
        legend.margin = margin(6, 6, 6, 6)) +
  scale_linetype_discrete(labels = c("small isolated",
                                     "small connected to small",
                                     "small connected to large"))  +
  geom_vline(xintercept = first_perturbation_day,
             linetype="dotdash",
             color = "grey",
             size=0.7) +
  labs(caption = "Vertical grey line: first perturbation")

ds_biomass %>%
  filter(disturbance == "high") %>%
  #filter(eco_metaeco_type == "S (S_S)" | eco_metaeco_type == "S (S_L)") %>%
  filter(patch_size == "S") %>%
  ggplot(aes(x = day,
             y = bioarea_per_volume,
             group = system_nr,
             fill = system_nr,
             color = system_nr,
             linetype = eco_metaeco_type)) +
  geom_line(stat = "summary", fun = "mean") +
  labs(title = "Disturbance = high",
       x = "Day",
       y = "Local bioarea (something/μl)",
       linetype = "") +
  theme_bw() +
  theme(panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        legend.position = c(.95, .95),
        legend.justification = c("right", "top"),
        legend.box.just = "right",
        legend.margin = margin(6, 6, 6, 6)) +
  scale_linetype_discrete(labels = c("small isolated",
                                     "small connected to small",
                                     "small connected to large"))  +
  geom_vline(xintercept = first_perturbation_day,
             linetype="dotdash",
             color = "grey",
             size=0.7) +
  labs(caption = "Vertical grey line: first perturbation")

### --- BOXPLOTS --- ###

local_small_low_plot = ds_biomass %>%
  filter(disturbance == "low") %>%
  filter(patch_size == "S") %>%
  ggplot(aes(x = day,
             y = bioarea_per_volume,
             group = interaction(day,eco_metaeco_type),
             fill = eco_metaeco_type)) +
  geom_boxplot() +
  labs(x = "Day",
       y = "Local bioarea (something/μl)",
       title = "Disturbance = low",
       fill = "") +
  theme_bw() +
  theme(panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        legend.position = c(.95, .95),
        legend.justification = c("right", "top"),
        legend.box.just = "right",
        legend.margin = margin(6, 6, 6, 6)) +
  scale_fill_discrete(labels = c("small isolated",
                                 "small connected to small",
                                 "small connected to large")) +
  geom_vline(xintercept = first_perturbation_day + 0.7,
             linetype="dotdash",
             color = "grey",
             size=0.7) +
  labs(caption = "Vertical grey line: first perturbation")
local_small_low_plot

ds_biomass %>%
  filter(disturbance == "high") %>%
  filter(patch_size == "S") %>%
  ggplot(aes(x = day,
             y = bioarea_per_volume,
             group = interaction(day,eco_metaeco_type),
             fill = eco_metaeco_type)) +
  geom_boxplot() +
  labs(title = "Disturbance = high",
       x = "Day",
       y = "Local bioarea (something/μl)",
       fill = "") +
  theme_bw() +
  theme(panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        legend.position = c(.95, .95),
        legend.justification = c("right", "top"),
        legend.box.just = "right",
        legend.margin = margin(6, 6, 6, 6)) +
  scale_fill_discrete(labels = c("small isolated",
                                 "small connected to small",
                                 "small connected to large")) +
  geom_vline(xintercept = first_perturbation_day + 0.7,
             linetype="dotdash",
             color = "grey",
             size=0.7) +
  labs(caption = "Vertical grey line: first perturbation")
```

##### Model

Now I'll:

1.  Calculate the average biomass for each time point for all the isolated small patches, one for the low disturbance, and one for the high disturbance.
2.  For the small connected to small and small connected to large patches, calculate their response ratio.

```{r}
average_biomass_S_isolated_low = ds_biomass %>%
  filter(disturbance == "low") %>%
  filter(eco_metaeco_type == "S") %>%
  group_by(culture_ID, time_point, day) %>%
  summarise(bioarea_per_volume_across_videos = mean(bioarea_per_volume)) %>% #Across videos
  group_by(time_point, day) %>%
  summarise(mean_bioarea_per_volume = mean(bioarea_per_volume_across_videos)) #Across cultures

average_biomass_S_isolated_high = ds_biomass %>%
  filter(disturbance == "high") %>%
  filter(eco_metaeco_type == "S") %>%
  group_by(culture_ID, time_point, day) %>%
  summarise(bioarea_per_volume_across_videos = mean(bioarea_per_volume)) %>%
  group_by(time_point, day) %>%
  summarise(mean_bioarea_per_volume = mean(bioarea_per_volume_across_videos))


for (time_point_input in 0:7) {
 
  ds_biomass$isolated_control[ds_biomass$patch_size == "S" & 
                              ds_biomass$disturbance == "low" &
                              ds_biomass$time_point == time_point_input] =
  subset(average_biomass_S_isolated_low,
         time_point == time_point_input)$mean_bioarea_per_volume
  
}

for (time_point_input in 0:7) {
 
  ds_biomass$isolated_control[ds_biomass$patch_size == "S" & 
                              ds_biomass$disturbance == "high" &
                              ds_biomass$time_point == time_point_input] =
  subset(average_biomass_S_isolated_high,
         time_point == time_point_input)$mean_bioarea_per_volume
  
}

ds_biomass = ds_biomass %>%
  mutate(isolated_control = as.numeric(isolated_control)) %>%
  mutate(RR_bioarea_per_volume = bioarea_per_volume / isolated_control)

ds_biomass %>%
  filter(disturbance == "low") %>%
  filter(patch_size == "S") %>%
  group_by(system_nr, day, eco_metaeco_type) %>%
  summarise(RR_bioarea_per_volume = mean(RR_bioarea_per_volume)) %>% #Across videos
  ggplot(aes(x = day,
             y = RR_bioarea_per_volume,
             group = interaction(day, eco_metaeco_type),
             fill = eco_metaeco_type)) +
  geom_boxplot() +
  labs(title = "Disturbance = low",
       x = "Day",
       y = "Response ratio bioarea (something/μl)",
       fill = "") +
  theme_bw() +
  theme(panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        legend.position = c(.2, .95),
        legend.justification = c("right", "top"),
        legend.box.just = "right",
        legend.margin = margin(6, 6, 6, 6)) +
  scale_fill_discrete(labels = c("small isolated",
                                 "small connected to small",
                                 "small connected to large")) +
  geom_vline(xintercept = first_perturbation_day + 0.7,
             linetype="dotdash",
             color = "grey",
             size=0.7) +
  labs(caption = "Vertical grey line: first perturbation, Response ratio bioarea: Bioarea/Mean bioarea small isolated")

ds_biomass %>%
  filter(disturbance == "high") %>%
  filter(patch_size == "S") %>%
  group_by(system_nr, day, eco_metaeco_type) %>%
  summarise(RR_bioarea_per_volume = mean(RR_bioarea_per_volume)) %>% #Across videos
  ggplot(aes(x = day,
             y = RR_bioarea_per_volume,
             group = interaction(day, eco_metaeco_type),
             fill = eco_metaeco_type)) +
  geom_boxplot() +
  labs(title = "Disturbance = high",
       x = "Day",
       y = "Response ratio bioarea (something/μl)",
       fill = "") +
  theme_bw() +
  theme(panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        legend.position = c(.2, .95),
        legend.justification = c("right", "top"),
        legend.box.just = "right",
        legend.margin = margin(6, 6, 6, 6)) +
  scale_fill_discrete(labels = c("small isolated",
                                 "small connected to small",
                                 "small connected to large")) +
  geom_vline(xintercept = first_perturbation_day + 0.7,
             linetype="dotdash",
             color = "grey",
             size=0.7) +
  labs(caption = "Vertical grey line: first perturbation, Response ratio bioarea: Bioarea/Mean bioarea small isolated")

small_patches_figure = ds_biomass %>%
  filter(disturbance == "low") %>%
  filter(eco_metaeco_type == "S (S_S)" | eco_metaeco_type == "S (S_L)") %>%
  group_by(system_nr, day, eco_metaeco_type) %>%
  summarise(RR_bioarea_per_volume = mean(RR_bioarea_per_volume)) %>% #Across videos
  ggplot(aes(x = day,
             y = RR_bioarea_per_volume,
             group = interaction(day, eco_metaeco_type),
             fill = eco_metaeco_type)) +
  geom_boxplot() +
  labs(x = "Day",
       y = "Response ratio bioarea (something/μl)",
       fill = "") +
  theme_bw() +
  theme(panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        legend.position = c(.2, .95),
        legend.justification = c("right", "top"),
        legend.box.just = "right",
        legend.margin = margin(6, 6, 6, 6)) +
  scale_fill_discrete(labels = c("small connected to small",
                                 "small connected to large")) +
  geom_vline(xintercept = first_perturbation_day + 0.7,
             linetype="dotdash",
             color = "grey",
             size=0.7) +
  labs(caption = "Vertical grey line: first perturbation, Response ratio bioarea: Bioarea/Mean bioarea small isolated")
```

##### Model selection

Let's start from the full model:

$$
RR (bioarea) = t + M + D + t*M + t*D + M*D + t*M+D + (t | system \: nr)
$$

```{r}
full_model = lmer(RR_bioarea_per_volume ~
                    day * eco_metaeco_type * disturbance +
                    (day | system_nr),
                  data = ds_biomass %>%
                         filter(eco_metaeco_type== "S (S_S)" | eco_metaeco_type == "S (S_L)"),
                  REML = FALSE
                  )
```

*Should we keep the interaction between the intercept and slope in (day \| system_nr)?*

```{r}
no_interaction = lmer(RR_bioarea_per_volume ~
                    day * eco_metaeco_type * disturbance +
                    (day || system_nr),
                  data = ds_biomass %>%
                         filter(eco_metaeco_type== "S (S_S)" | eco_metaeco_type == "S (S_L)"),
                  REML = FALSE
                  )

anova(full_model, no_interaction)
```

No.

*Should we keep the effects on the slope?*

```{r}
no_slope = lmer(RR_bioarea_per_volume ~
                    day * eco_metaeco_type * disturbance +
                    (1 | system_nr),
                  data = ds_biomass %>%
                         filter(eco_metaeco_type== "S (S_S)" | eco_metaeco_type == "S (S_L)"),
                  REML = FALSE
                  )

anova(no_interaction, no_slope)
```

Yes.

*Should we keep t \* M \* D?*

```{r}
no_three_way = lmer(RR_bioarea_per_volume ~
                    day +
                    eco_metaeco_type +
                    disturbance +
                    day : eco_metaeco_type + 
                    day : disturbance + 
                    eco_metaeco_type : disturbance + 
                    (day || system_nr),
                  data = ds_biomass %>%
                         filter(eco_metaeco_type== "S (S_S)" | eco_metaeco_type == "S (S_L)"),
                  REML = FALSE
                  )

anova(no_interaction, no_three_way)
```

No.

*Should we keep t \* M?*

```{r}
no_TM = lmer(RR_bioarea_per_volume ~
                    day +
                    eco_metaeco_type +
                    disturbance +
                    day : disturbance + 
                    eco_metaeco_type : disturbance + 
                    (day || system_nr),
                  data = ds_biomass %>%
                         filter(eco_metaeco_type== "S (S_S)" | eco_metaeco_type == "S (S_L)"),
                  REML = FALSE
                  )

anova(no_three_way, no_TM)
```

No.

*Should we keep t \* D?*

```{r}
no_TD = lmer(RR_bioarea_per_volume ~
                    day +
                    eco_metaeco_type +
                    disturbance +
                    eco_metaeco_type : disturbance + 
                    (day || system_nr),
                  data = ds_biomass %>%
                         filter(eco_metaeco_type== "S (S_S)" | eco_metaeco_type == "S (S_L)"),
                  REML = FALSE
                  )

anova(no_TM, no_TD)
```

Yes.

Should we keep M \* D?

```{r}
no_MD = lmer(RR_bioarea_per_volume ~
                    day +
                    eco_metaeco_type +
                    disturbance +
                    day : disturbance + 
                    (day || system_nr),
                  data = ds_biomass %>%
                         filter(eco_metaeco_type== "S (S_S)" | eco_metaeco_type == "S (S_L)"),
                  REML = FALSE
                  )

anova(no_TM, no_MD)
```

No.

Then our best model is:

$$
RR (bioarea) = t + M + D + t*D + (t || system \: nr)
$$

Let's then calculate the R squared and stuff.
