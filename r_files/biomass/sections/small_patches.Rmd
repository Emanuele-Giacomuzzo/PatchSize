---
title: "S_patches"
author: "Emanuele Giacomuzzo"
date: "2022-08-02"
output: html_document
editor_options:
  chunk_output_type: console
---

##### Plots

```{r small-patches-single-ecosystems-plots}
ds_biomass %>%
  filter(disturbance == "low") %>%
  filter(patch_size == "S") %>%
  ggplot(aes(x = day,
             y = bioarea_per_volume,
             group = culture_ID,
             fill = culture_ID,
             color = culture_ID,
             linetype = eco_metaeco_type)) +
  geom_line(stat = "summary", fun = "mean") +
  labs(x = "Day",
       y = "Local bioarea (something/μl)",
       title = "Disturbance = low",
       linetype = "") +
  theme_bw() +
  theme(panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        legend.position = c(.95, .95),
        legend.justification = c("right", "top"),
        legend.box.just = "right",
        legend.margin = margin(6, 6, 6, 6)) +
  scale_linetype_discrete(labels = c("small isolated",
                                     "small connected to small",
                                     "small connected to large"))  +
  geom_vline(xintercept = first_perturbation_day,
             linetype="dotdash",
             color = "grey",
             size=0.7) +
  labs(caption = "Vertical grey line: first perturbation")

ds_biomass %>%
  filter(disturbance == "high") %>%
  filter(patch_size == "S") %>%
  ggplot(aes(x = day,
             y = bioarea_per_volume,
             group = culture_ID,
             fill = system_nr,
             color = system_nr,
             linetype = eco_metaeco_type)) +
  geom_line(stat = "summary", fun = "mean") +
  labs(title = "Disturbance = high",
       x = "Day",
       y = "Local bioarea (something/μl)",
       linetype = "") +
  theme_bw() +
  theme(panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        legend.position = c(.95, .95),
        legend.justification = c("right", "top"),
        legend.box.just = "right",
        legend.margin = margin(6, 6, 6, 6)) +
  scale_linetype_discrete(labels = c("small isolated",
                                     "small connected to small",
                                     "small connected to large"))  +
  geom_vline(xintercept = first_perturbation_day,
             linetype="dotdash",
             color = "grey",
             size=0.7) +
  labs(caption = "Vertical grey line: first perturbation")
```

```{r small-patches-boxplots}
ds_biomass %>%
  filter(disturbance == "low") %>%
  filter(patch_size == "S") %>%
  ggplot(aes(x = day,
             y = bioarea_per_volume,
             group = interaction(day,eco_metaeco_type),
             fill = eco_metaeco_type)) +
  geom_boxplot() +
  labs(x = "Day",
       y = "Local bioarea (something/μl)",
       title = "Disturbance = low",
       fill = "") +
  theme_bw() +
  theme(panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        legend.position = c(.95, .95),
        legend.justification = c("right", "top"),
        legend.box.just = "right",
        legend.margin = margin(6, 6, 6, 6)) +
  scale_fill_discrete(labels = c("small isolated",
                                 "small connected to small",
                                 "small connected to large")) +
  geom_vline(xintercept = first_perturbation_day + 0.7,
             linetype="dotdash",
             color = "grey",
             size=0.7) +
  labs(caption = "Vertical grey line: first perturbation")

ds_biomass %>%
  filter(disturbance == "high") %>%
  filter(patch_size == "S") %>%
  ggplot(aes(x = day,
             y = bioarea_per_volume,
             group = interaction(day,eco_metaeco_type),
             fill = eco_metaeco_type)) +
  geom_boxplot() +
  labs(title = "Disturbance = high",
       x = "Day",
       y = "Local bioarea (something/μl)",
       fill = "") +
  theme_bw() +
  theme(panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        legend.position = c(.95, .95),
        legend.justification = c("right", "top"),
        legend.box.just = "right",
        legend.margin = margin(6, 6, 6, 6)) +
  scale_fill_discrete(labels = c("small isolated",
                                 "small connected to small",
                                 "small connected to large")) +
  geom_vline(xintercept = first_perturbation_day + 0.7,
             linetype="dotdash",
             color = "grey",
             size=0.7) +
  labs(caption = "Vertical grey line: first perturbation")
```

```{r small-patches-lnRR-plots}
small_patches_publication = ds_biomass_averaged_across_videos %>%
  filter(disturbance == "low") %>%
  filter(eco_metaeco_type == "S (S_L)" | eco_metaeco_type == "S (S_S)") %>%
  ggplot(aes(x = day,
             y = lnRR_bioarea_per_volume,
             group = interaction(day, eco_metaeco_type),
             fill = eco_metaeco_type)) +
  geom_boxplot() +
  labs(title = "Disturbance = low",
       x = "Day",
       y = "LnRR Local Bioarea (something/μl)",
       fill = "") +
  theme_bw() +
  theme(panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        legend.position = c(.3, .95),
        legend.justification = c("right", "top"),
        legend.box.just = "right",
        legend.margin = margin(6, 6, 6, 6)) +
  scale_fill_discrete(labels = c("small connected to small",
                                 "small connected to large")) +
  geom_vline(xintercept = first_perturbation_day + 0.7,
             linetype="dotdash",
             color = "grey",
             size=0.7) +
  labs(caption = "Vertical grey line: first perturbation, LnRR Local Bioarea: Bioarea + 1 / Mean bioarea small isolated")
small_patches_publication

ds_biomass_averaged_across_videos %>%
  filter(disturbance == "high") %>%
  filter(eco_metaeco_type == "S (S_L)" | eco_metaeco_type == "S (S_S)") %>%
  ggplot(aes(x = day,
             y = lnRR_bioarea_per_volume,
             group = interaction(day, eco_metaeco_type),
             fill = eco_metaeco_type)) +
  geom_boxplot() +
  labs(title = "Disturbance = high",
       x = "Day",
       y = "LnRR Local Bioarea (something/μl)",
       fill = "") +
  theme_bw() +
  theme(panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        legend.position = c(.3, .95),
        legend.justification = c("right", "top"),
        legend.box.just = "right",
        legend.margin = margin(6, 6, 6, 6)) +
  scale_fill_discrete(labels = c("small connected to small",
                                 "small connected to large")) +
  geom_vline(xintercept = first_perturbation_day + 0.7,
             linetype="dotdash",
             color = "grey",
             size=0.7) +
  labs(caption = "Vertical grey line: first perturbation, LnRR Local Bioarea: Bioarea/Mean bioarea small isolated")
```

##### Time series

###### Model selection

Let's start from the full model:

$$
ln \: RR (bioarea) = t + M + D + t*M + t*D + M*D + t*M+D + (t | system \: nr)
$$

And let's consider all data points from the second to the seventh.

```{r choose-time-points}
first_time_point = 2
last_time_point = 7
```

```{r small-patches-full-model}
full_model = lmer(lnRR_bioarea_per_volume ~
                    day * eco_metaeco_type * disturbance +
                    (day | culture_ID),
                  data = ds_biomass_averaged_across_videos %>%
                         filter(time_point >= first_time_point) %>%
                         filter(time_point <= last_time_point) %>%
                         filter(eco_metaeco_type== "S (S_S)" | 
                                eco_metaeco_type == "S (S_L)"),
                  REML = FALSE)
```

*Should we keep the interaction between the intercept and slope in (day \| culture_ID)?*

```{r small-patches-no-interaction}
no_interaction = lmer(lnRR_bioarea_per_volume ~
                    day * eco_metaeco_type * disturbance +
                    (day || culture_ID),
                  data = ds_biomass_averaged_across_videos %>%
                         filter(time_point >= first_time_point) %>%
                         filter(time_point <= last_time_point) %>%
                         filter(eco_metaeco_type== "S (S_S)" | 
                                eco_metaeco_type == "S (S_L)"),
                  REML = FALSE)

anova(full_model, no_interaction)
```

Yes.

*Should we keep the effects on the slope?*

```{r small-patches-no-slope}
no_slope = lmer(lnRR_bioarea_per_volume ~
                    day * eco_metaeco_type * disturbance +
                    (1 | culture_ID),
                  data = ds_biomass_averaged_across_videos %>%
                         filter(time_point >= first_time_point) %>%
                         filter(time_point <= last_time_point) %>%
                         filter(eco_metaeco_type== "S (S_S)" | 
                                eco_metaeco_type == "S (S_L)"),
                  REML = FALSE)

anova(full_model, no_slope)
```

Yes.

*Should we keep t \* M \* D?*

```{r small-patches-no-three-way}
no_three_way = lmer(lnRR_bioarea_per_volume ~
                    day +
                    eco_metaeco_type +
                    disturbance +
                    day : eco_metaeco_type + 
                    day : disturbance + 
                    eco_metaeco_type : disturbance + 
                    (day | culture_ID),
                  data = ds_biomass_averaged_across_videos %>%
                         filter(time_point >= first_time_point) %>%
                         filter(time_point <= last_time_point) %>%
                         filter(eco_metaeco_type== "S (S_S)" | 
                                eco_metaeco_type == "S (S_L)"),
                  REML = FALSE)

anova(full_model, no_three_way)
```

No.

*Should we keep t \* M?*

```{r small-patches-no-TM}
no_TM = lmer(lnRR_bioarea_per_volume ~
                    day +
                    eco_metaeco_type +
                    disturbance +
                    day : disturbance + 
                    eco_metaeco_type : disturbance + 
                    (day | culture_ID),
                  data = ds_biomass_averaged_across_videos %>%
                         filter(time_point >= first_time_point) %>%
                         filter(time_point <= last_time_point) %>%
                         filter(eco_metaeco_type== "S (S_S)" | 
                                eco_metaeco_type == "S (S_L)"),
                  REML = FALSE)

anova(no_three_way, no_TM)
```

Yes.

*Should we keep t \* D?*

```{r small-patches-no-TD}
no_TD = lmer(lnRR_bioarea_per_volume ~
                    day +
                    eco_metaeco_type +
                    disturbance +
                    day : eco_metaeco_type + 
                    eco_metaeco_type : disturbance + 
                    (day | culture_ID),
                  data = ds_biomass_averaged_across_videos %>%
                         filter(time_point >= first_time_point) %>%
                         filter(time_point <= last_time_point) %>%
                         filter(eco_metaeco_type== "S (S_S)" | 
                                eco_metaeco_type == "S (S_L)"),
                  REML = FALSE)

anova(no_three_way, no_TD)
```

No.

Should we keep M \* D?

```{r small-patches-no-MD}
no_MD = lmer(lnRR_bioarea_per_volume ~
                    day +
                    eco_metaeco_type +
                    disturbance +
                    day : eco_metaeco_type + 
                    (day | culture_ID),
                  data = ds_biomass_averaged_across_videos %>%
                         filter(time_point >= first_time_point) %>%
                         filter(time_point <= last_time_point) %>%
                         filter(eco_metaeco_type== "S (S_S)" | 
                                eco_metaeco_type == "S (S_L)"),
             REML = FALSE,
             control = lmerControl (optimizer = "Nelder_Mead"))

anova(no_TD, no_MD)
```

No.

*Should we keep D?*

```{r small-patches-no-D}
no_D = lmer(lnRR_bioarea_per_volume ~
                    day +
                    eco_metaeco_type +
                    day : eco_metaeco_type +
                    (day | culture_ID),
            data = ds_biomass_averaged_across_videos %>%
                         filter(time_point >= first_time_point) %>%
                         filter(time_point <= last_time_point) %>%
                         filter(eco_metaeco_type== "S (S_S)" | 
                                eco_metaeco_type == "S (S_L)"),
            REML = FALSE,
            control = lmerControl (optimizer = "Nelder_Mead")
            )

anova(no_MD, no_D)
```

Yes.

###### Best model

Then our best model is:

$$
RR (bioarea) = t + M + D + t*M + (t | ID)
$$

Let's then calculate the R squared and stuff for t2-t7.

```{r small-t2-t7-best-model, eval = FALSE}
best_model = no_MD

#Model diagnostics
plot(best_model)
qqnorm(resid(best_model))

#R2
r.squaredGLMM(no_MD)
```

```{r small-data-table}
#Create a table in which the regional biomass has been log transformed. 

### --- INITIALISE TABLE --- ###

columns = c("model", "time_point", "AIC", "BIC", "R2_mixed", "R2_fixed", "R2_mixed_M", "R2_fixed_M")
small_patches_matrix = matrix(ncol = length(columns), nrow = 0)
small_patches_table = data.frame(small_patches_matrix)
colnames(small_patches_table) = columns

### --- POPULATE THE TABLE --- ###

for (last_point in 4:7) {
  
  full_model = lmer(lnRR_bioarea_per_volume ~
                    day +
                    eco_metaeco_type +
                    disturbance +
                    day : disturbance + 
                    day : eco_metaeco_type +
                    (day | culture_ID),
                  data = ds_biomass_averaged_across_videos %>%
                              filter(time_point >= 2) %>%
                              filter(time_point <= last_point) %>%
                              filter(eco_metaeco_type== "S (S_S)" | 
                                     eco_metaeco_type == "S (S_L)"),
                  REML = FALSE,
                  control = lmerControl(optimizer = 'optimx', 
                                        optCtrl = list(method = 'L-BFGS-B')))
  
  r.squaredGLMM(full_model)

  
  null_model = lm(lnRR_bioarea_per_volume ~
                    1,
                  data = ds_biomass_averaged_across_videos %>%
                    filter(time_point >= 2) %>%
                    filter(time_point <= last_point) %>%
                    filter(eco_metaeco_type== "S (S_S)" | 
                           eco_metaeco_type == "S (S_L)"))
  
  metaeco_null = lmer(lnRR_bioarea_per_volume ~
                        day +
                        disturbance +
                        day : disturbance +
                        day : eco_metaeco_type + 
                        (day | culture_ID),
                      data = ds_biomass_averaged_across_videos %>%
                        filter(time_point >= 2) %>%
                        filter(time_point <= last_point) %>%
                        filter(eco_metaeco_type== "S (S_S)" | 
                               eco_metaeco_type == "S (S_L)"),
                      REML = FALSE,
                      control = lmerControl(optimizer = "Nelder_Mead"))
  r.squaredGLMM(metaeco_null)
  
  small_patches_table = update_all_models_table("t + M + D + t*M + t*D + (t | ID)",
                                             small_patches_table, 
                                             full_model, 
                                             null_model,
                                             metaeco_null,
                                             "mixed")
}

datatable(small_patches_table, 
          rownames = FALSE,
          options = list(pageLength = 100,
                         scrollX = TRUE,
                         autoWidth = TRUE,
                         columnDefs = list(list(targets=c(0),visible=TRUE, width='160'),
                                           list(targets=c(1), visible=TRUE, width='10'),
                                           list(targets=c(2), visible=TRUE, width='10'),
                                           list(targets=c(3), visible=TRUE, width='10'),
                                           list(targets=c(4), visible=TRUE, width='10'),
                                           list(targets=c(5), visible=TRUE, width='10'),
                                           list(targets=c(6), visible=TRUE, width='10'),
                                           list(targets=c(7), visible=TRUE, width='10'),
                                           list(targets='_all', visible=FALSE))),
          caption = "
          M = Meta-ecosystem type, 
          D = disturbance, 
          (1 | t) = random effect of time on the intercept,
          (1 | ID) = random effect of meta-ecosystem ID on the intercept, 
          || = no correlation between intercept and slope,
          | = correlation between intercept and slope,
          R2 = r squared of the whole model,
          R2_fixed = fixed part of the mixed model,
          mixed_R2 = r squared when considering both fixed and random effects (conditional r squared), 
          fixed_R2 = r squared when considering only the fixed effects (marginal r squared)")
```

##### Single time points

###### Model selection

I'll show model selection only on time point number 3 (however, I will do it also for the other time points). Let's start from the full model.

```{r small-time-point-input}
time_point_input = 4
```

```{r small-full-model-single-point, eval = FALSE}
full = lmer(lnRR_bioarea_per_volume ~
              eco_metaeco_type +
              disturbance +
              disturbance : eco_metaeco_type +
              (1 | culture_ID),
            data = ds_biomass_averaged_across_videos %>%
              filter(time_point == time_point_input) %>%
              filter(eco_metaeco_type== "S (S_S)" | 
                     eco_metaeco_type == "S (S_L)"),
          REML = FALSE)
```

*Should we keep the random effect?*

```{r small-no-random-effects-single-point, eval = FALSE}
no_random = lm(lnRR_bioarea_per_volume ~
              eco_metaeco_type +
              disturbance +
              disturbance : eco_metaeco_type,
            data = ds_biomass_averaged_across_videos %>%
              filter(time_point == time_point_input) %>%
              filter(eco_metaeco_type== "S (S_S)" | 
                     eco_metaeco_type == "S (S_L)"))

anova(full, no_random)
```

No. But wired. I'll keep it anyway.

*Should we keep D \* M?*

```{r small-no-DM-single-point, eval = FALSE}
no_MD = lmer(lnRR_bioarea_per_volume ~
              eco_metaeco_type +
              disturbance +
              (1 | culture_ID),
            data = ds_biomass_averaged_across_videos %>%
              filter(time_point == time_point_input) %>%
              filter(eco_metaeco_type== "S (S_S)" | 
                     eco_metaeco_type == "S (S_L)"),
          REML = FALSE)

anova(full, no_MD)
```

No.

**Best model**

Therefore, our best model is

$$
Regional \: Bioarea = M + D + (1 | ID)
$$
