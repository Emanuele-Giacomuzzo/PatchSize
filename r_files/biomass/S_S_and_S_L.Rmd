---
title: "S_S_and_S_L"
author: "Emanuele Giacomuzzo"
date: '2022-07-26'
output: html_document
---

## Local biomass modelling - S_S and S_L

### Tidy

```{r}
ds_local_S_t2_t7 = ds %>%
  filter (eco_metaeco_type == "S (S_S)" | 
          eco_metaeco_type == "S (S_L)") %>%
  filter(time_point >= 2) #Let's take off the first two time points which are before the first disturbance event.
```

### Plot

```{r}
ds_local_S_t2_t7 %>%
    ggplot(aes(x = day,
               y = bioarea_per_volume,
               fill = eco_metaeco_type,
               color = eco_metaeco_type)) +
    geom_point(stat = "summary", fun = "mean") +
    geom_line(stat = "summary", fun = "mean") +
    labs(x = "Day", 
         y = "Local biomass (bioarea/Âµl)", 
         color = '', 
         fill = '') +
    scale_fill_discrete(labels = c("Patch connected to patch of the same size", 
                                   "Patch connected to larger patch")) +
    scale_color_discrete(labels = c("Patch connected to patch of the same size", 
                                    "Patch connected to larger patch")) +
    theme_bw() +
    theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank())
```

### Model selection

Let's start from building the full model.

```{r}
full_model = lmer(bioarea_per_volume ~ 
                    metaecosystem_type  + 
                    disturbance + 
                    metaecosystem_type * disturbance + 
                    (metaecosystem_type || day) + 
                    (disturbance || day) + 
                    (metaecosystem_type*disturbance  || day),
                  data = ds_local_S_t2_t7, 
                  REML = FALSE)
```

**Does time have a random effect?**

```{r}
fixed_effects_model = lm(bioarea_per_volume ~ 
                           metaecosystem_type  + 
                           disturbance +
                           metaecosystem_type * disturbance, 
                         data = ds_local_S_t2_t7)

anova(full_model, fixed_effects_model)
```

Yes. Let's then keep the random effect of time.

```{r}
best_model = full_model
```

**Do meta-ecosystem type and disturbance interact?**

```{r}
no_interaction_model = lmer(bioarea_per_volume ~ 
                              metaecosystem_type + 
                              disturbance  + 
                              (metaecosystem_type || day) + 
                              (disturbance || day), 
                            data = ds_local_S_t2_t7, 
                            REML = FALSE)

anova(best_model, no_interaction_model)
```

Yes. Let's keep the model without the interaction between meta-ecosystem type and disturbance, as it has lower BIC.

```{r}
best_model = no_interaction_model
```

**Does time have an effect on the slope of metaecosystem_type?**

```{r}
no_metaeco_slopes_model = lmer(bioarea_per_volume ~ 
                         metaecosystem_type + 
                         disturbance  + 
                         (disturbance || day), 
                       data = ds_local_S_t2_t7, 
                       REML = FALSE,
                       control = lmerControl (optimizer = "Nelder_Mead")
                       )

anova(best_model, no_metaeco_slopes_model)
```

No. Let's then keep the model without the random effect of time on meta-ecosystem type slopes.

**Does time have an effect on the slope of disturbance?**

```{r}
no_disturbance_slopes_model = lmer(bioarea_per_volume ~ 
                         metaecosystem_type + 
                         disturbance  + 
                         (1 | day), 
                       data = ds_local_S_t2_t7, 
                       REML = FALSE,
                       control = lmerControl (optimizer = "Nelder_Mead")
                       )

anova(best_model, no_disturbance_slopes_model)
```

Yes. Let's keep the model without slopes from disturbance, as it has lower BIC.

```{r}
best_model = no_disturbance_slopes_model
summary(best_model)
```

## Analysis of the best model

#### Effect size and significance of full model

```{r}
model.null = lm(bioarea_per_volume ~ 
                  1, 
                  data = ds_local_S_t2_t7)

r2_best = r.squaredGLMM(best_model)
r2_best = round(r2_best, digits = 3)

anova = anova(best_model, model.null)
p_best = anova$`Pr(>Chisq)`[2]
p_best = round(p_best, digits = 5)

if (p_best < 0.00001) {
  p_best = "< 0.00001"
}
```

#### Effect size and significance of meta-ecosystem type

```{r}
metaecosystem_type_null = lmer(bioarea_per_volume ~  
                                 disturbance  + 
                                 (1 | day),
                               data = ds_local_S_t2_t7, 
                               REML = FALSE, 
                               control = lmerControl(optimizer ="Nelder_Mead"))

r2_no_metaecosystem_type = r.squaredGLMM(metaecosystem_type_null)
r2_no_metaecosystem_type = round(r2_no_metaecosystem_type, digits = 3)

anova = anova(best_model, metaecosystem_type_null)
p_no_metaecosystem_type = anova$`Pr(>Chisq)`[2]
p_no_metaecosystem_type = round(p_no_metaecosystem_type, digits = 5)

if (p_no_metaecosystem_type < 0.00001) {
  p_no_metaecosystem_type = "< 0.00001"
}
```

#### Effect size and significance of disturbance

```{r}
disturbance_null = lmer(bioarea_per_volume ~ 
                          metaecosystem_type  + 
                          (1 | day), 
                        data = ds_local_S_t2_t7, 
                        REML = FALSE,
                        control = lmerControl(optimizer ='optimx', 
                                                     optCtrl=list(method='L-BFGS-B')))

r2_no_disturbance = r.squaredGLMM(disturbance_null)
r2_no_disturbance = round(r2_no_disturbance, digits = 3)

anova = anova(best_model, disturbance_null)
p_no_disturbance = anova$`Pr(>Chisq)`[2]
p_no_disturbance = round(p_no_disturbance, digits = 5)

if (p_no_disturbance < 0.00001) {
  p_no_disturbance = "< 0.00001"
}
```

The effect size and significance of our results can be found in the following table.

| Model                                  |           Marginal R2           |   Marginal R2 of the best model explained    |         Conditional R2          |  Conditional R2 of the best model explained  |           P-value           |
|:-----------|:----------:|:----------:|:----------:|:----------:|:----------:|
| Best model                             |         `r r2_best[1]`          |                      /                       |         `r r2_best[2]`          |                      /                       |         `r p_best`          |
| Best model without meta-ecosystem type | `r r2_no_metaecosystem_type[1]` | `r r2_best[1] - r2_no_metaecosystem_type[1]` | `r r2_no_metaecosystem_type[2]` | `r r2_best[2] - r2_no_metaecosystem_type[2]` | `r p_no_metaecosystem_type` |
| Best model without disturbance         |    `r r2_no_disturbance[1]`     |    `r r2_best[1] - r2_no_disturbance[1]`     |    `r r2_no_disturbance[2]`     |    `r r2_best[2] - r2_no_disturbance[2]`     |    `r p_no_disturbance`     |

## t2-3, t2-t4, t2-t5, t2-t6, t2-t7

Let's now try to see how meta-ecosystem effect changes across different time periods.

```{r}
R2 = NULL
for (last_point in 3:7) {
  
  filtered_dataset = ds_local_S_t2_t7 %>%
  filter(time_point <= last_point)
  
  full_model = lmer(bioarea_per_volume ~ 
                      disturbance +
                      metaecosystem_type + 
                      (1 | day),
                    data = filtered_dataset,
                    REML = FALSE)
  
  no_metaeco_type_model = lmer(bioarea_per_volume ~ 
                               disturbance +
                               (1 | day),
                             data = filtered_dataset,
                             REML = FALSE)
  
  anova(full_model, no_metaeco_type_model)
  
  R2_full = r.squaredGLMM(full_model)[1,1]
  R2_null = r.squaredGLMM(no_metaeco_type_model)[1,1]
  
  R2[[last_point]] =  R2_full - R2_null
  R2[[last_point]] = round(R2[[last_point]], digits = 3)
  
}
```

| Time points | Marginal R squared of meta-ecosystem type |
|:-----------:|:-----------------------------------------:|
|   t2 - t3   |                `r R2[[3]]`                |
|   t2 -t4    |                `r R2[[4]]`                |
|   t2 - t5   |                `r R2[[5]]`                |
|   t2 - t6   |                `r R2[[6]]`                |
|   t2 - t7   |                `r R2[[7]]`                |
