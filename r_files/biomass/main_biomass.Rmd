---
title: "Biomass analysis (PatchSizePilot)"
author: "Emanuele Giacomuzzo"
date: '2022-07-07'
output:
  html_document:
    toc: true
    theme: united
editor_options: 
  chunk_output_type: console
bibliography: /Applications/Mendeley/library.bib
---

Here I study how **biomass density** changes across treatments in the PatchSizePilot. In particular, I'm studying how biomass density changes across:

-   ecosystems of different size (this is the case in nature, but we need to make sure that it's the case also in our experiment)\
-   ecosystems that are connected (through the flow of nutrients) to an ecosystem of the same size or to an ecosystem that is larger\
-   meta-ecosystems in which patch size is the same or in which one patch has most of the area (we keep the total area of the meta-ecosystem constant)

```{r set-up-environment, echo = FALSE, results = FALSE, message = FALSE}
start_time = Sys.time()

rm( list = ls(  ) )
cat( "\014" )
library("tidyverse")
library("grid")
library("gridExtra") 
library("lme4")
library("here")
library("MuMIn")
library("equatiomatic")
library("knitr")
library("optimx")
library("GenSA")

knitr::opts_chunk$set(message = FALSE)

source(here("r_files", "biomass", "functions", "biomass_plots.R"))

p = NULL #To run the plotting function
```

# Import

```{r import, message = FALSE, echo = TRUE}
culture_info = read.csv(here("data", "PatchSizePilot_culture_info.csv"), header = TRUE)
load(here("data", "population", "t0.RData")); t0 = pop_output
load(here("data", "population", "t1.RData")); t1 = pop_output
load(here("data", "population", "t2.RData")); t2 = pop_output
load(here("data", "population", "t3.RData")); t3 = pop_output
load(here("data", "population", "t4.RData")); t4 = pop_output
load(here("data", "population", "t5.RData")); t5 = pop_output
load(here("data", "population", "t6.RData")); t6 = pop_output
load(here("data", "population", "t7.RData")); t7 = pop_output
rm(pop_output)
```

# Tidy

```{r tidy-up}
t0$time = NA
t1$time = NA

t0$replicate_video = 1:12 #In t1 I took 12 videos of a single 
t1$replicate_video = 1 #In t1 I took only 1 video/culture
t2$replicate_video = 1 #In t2 I took only 1 video/culture
t3$replicate_video = 1 #In t3 I took only 1 video/culture
t4$replicate_video = 1 #In t4 I took only 1 video/culture
t5$replicate_video = 1 #In t5 I took only 1 video/culture

t6 = t6 %>%
  rename(replicate_video = replicate)
t7 = t7 %>%
  rename(replicate_video = replicate)

#Create an elongated version of t0 so that each of the 110 cultures can have 12 video replicates at t0.
elongating_t0 = NULL
for (video in 1:nrow(t0)){
  for (ID in 1:nrow(culture_info)) {
    elongating_t0 = rbind(elongating_t0, t0[video,])
  }
}

ID_vector = rep(1:nrow(culture_info), 
                times = nrow(t0))

elongating_t0$culture_ID = ID_vector

t0 = merge(culture_info,elongating_t0, by="culture_ID")
t1 = merge(culture_info,t1, by = "culture_ID")
t2 = merge(culture_info,t2, by = "culture_ID")
t3 = merge(culture_info,t3, by = "culture_ID")
t4 = merge(culture_info,t4, by = "culture_ID")
t5 = merge(culture_info,t5, by = "culture_ID")
t6 = merge(culture_info,t6, by = "culture_ID")
t7 = merge(culture_info,t7, by = "culture_ID")
ds = rbind(t0, t1, t2, t3, t4, t5, t6, t7)
rm(elongating_t0, t0, t1, t2, t3, t4, t5, t6, t7)

ds$time_point[ds$time_point=="t0"] = 0
ds$time_point[ds$time_point=="t1"] = 1
ds$time_point[ds$time_point=="t2"] = 2
ds$time_point[ds$time_point=="t3"] = 3
ds$time_point[ds$time_point=="t4"] = 4
ds$time_point[ds$time_point=="t5"] = 5
ds$time_point[ds$time_point=="t6"] = 6
ds$time_point[ds$time_point=="t7"] = 7
ds$time_point = as.character(ds$time_point)

ds$day = NA
ds$day[ds$time_point== 0] = 0
ds$day[ds$time_point== 1] = 4
ds$day[ds$time_point== 2] = 8
ds$day[ds$time_point== 3] = 12
ds$day[ds$time_point== 4] = 16
ds$day[ds$time_point== 5] = 20
ds$day[ds$time_point== 6] = 24
ds$day[ds$time_point== 7] = 28

ds = ds %>% 
  select(culture_ID, 
         patch_size, 
         disturbance, 
         metaecosystem_type, 
         bioarea_per_volume, 
         replicate_video, 
         time_point,
         day,
         metaecosystem, 
         system_nr, 
         eco_metaeco_type)

ds = ds[, c("culture_ID", 
            "system_nr", 
            "disturbance", 
            "time_point",
            "day", 
            "patch_size", 
            "metaecosystem", 
            "metaecosystem_type", 
            "eco_metaeco_type", 
            "replicate_video",
            "bioarea_per_volume")]

ds$eco_metaeco_type = factor(ds$eco_metaeco_type, 
                             levels = c('S', 
                                      'S (S_S)', 
                                      'S (S_L)', 
                                      'M', 
                                      'M (M_M)', 
                                      'L', 
                                      'L (L_L)', 
                                      'L (S_L)'))

 ds$patch_size = factor(ds$patch_size,
                        levels = c ('S', 'M', 'L'))

#ds$metaecosystem_type = factor(ds$metaecosystem_type,
#                       levels = c ('S_S', 'M_M', 'L_L'))

ecosystems_to_take_off = 60 #Culture number 60 because it was spilled
ds = ds %>%
  filter(! culture_ID %in% ecosystems_to_take_off)
```

# Create regional data set

```{r regional-biomass}
ds_regional = ds %>%
  filter(metaecosystem == "yes") %>%
  group_by(culture_ID, system_nr, disturbance, day, time_point, patch_size, metaecosystem_type) %>%
  summarise(patch_mean_bioarea_across_videos = mean(bioarea_per_volume)) %>%
  group_by(system_nr, disturbance, day, time_point, metaecosystem_type) %>%
  summarise(regional_mean_bioarea = mean(patch_mean_bioarea_across_videos))

metaecosystems_to_take_off = 40 #System 40 was the system of culture 60 that I spilled
ds_regional = ds_regional %>%
  filter(! system_nr %in% metaecosystems_to_take_off)
```

```{r child = "plots.Rmd", eval = FALSE}
```

# Modelling considerations

Before start modelling, just a few considerations on mixed effect models and model selection.

## Mixed effects models

-   To build the mixed effect models we will use the R package lme4. See page 6 of [this PDF](https://cran.r-project.org/web/packages/lme4/vignettes/lmer.pdf) to know more about the syntaxis of this package.

-   To do model diagnostics of mixed effect models, I'm going to look at the following two plots (as suggested by @Zuur2009, page 487):

    -   Quantile-quantile plots

    -   Partial residual plots

-   The effect size of the explaining variables is calculated in the mixed effect models as marginal and conditional r squared. The marginal r squared is how much variance is explained by the fixed effects. The conditional r squared is how much variance is explained by the fixed and the random effects. The marginal and conditional r squared are calculated using the package `MuMIn`. The computation is based on the methods of @Nakagawa2017. For the coding and interpretation of these r squared check the [documentation for the r.squaredGLMM function](https://rdrr.io/cran/MuMIn/man/r.squaredGLMM.html)

## Model selection

-   I am starting from the largest model and then simplifying because ... (see statistical modelling course at ETH).

-   I am going to select the best model according to BIC instead of AIC. This is because BIC is better for understanding and AIC for predicting.

# Regional biomass modelling

When modelling the regional biomass, we want to understand if the regional biomass produced by an ecosystem with a small and a large patch (metaecosystem_type = S_L) is lower than the regional biomass produced by an ecosystem with two medium patches (metaecosystem_type = M_M).

## Tidy

First of all, let's modify the data set including the regional biomass of our meta-ecosystems. In this data set, we want to have the regional biomass of the meta-ecosystems (averaged first across videos and then across patches) in which we:

-   Include only the meta-ecosystems in which patches had both medium size (metaecosystem_type = M_M) and meta-ecosystems in which patches had one a small size and the other large size (metaecosystem_type = S_L).

-   Take off the first two point (day 0 and day = 4). This is because the first perturbation happened only at day 5.

```{r}
ds_regional_shrunk_type_n_day = ds_regional %>%
    filter (metaecosystem_type == "M_M" | metaecosystem_type == "S_L", 
            time_point >= 2)
```

## Plot

Notice: I'm only going to plot the low disturbance.

```{r}

#calculate the standard deviation
ds_regional %>%
  group_by(metaecosystem_type, disturbance, day) %>%
  summarise(mean_bioarea = mean(regional_mean_bioarea), 
            sd_bioarea = sd(regional_mean_bioarea)) %>%
  filter(disturbance == "low") %>%
  filter (metaecosystem_type == "S_L" | metaecosystem_type == "M_M") %>%
  ggplot (aes(x = day,
                y = mean_bioarea,
                fill = metaecosystem_type,
                color = metaecosystem_type)) +
  #geom_point(stat = "summary", fun = "mean") +
  geom_line (stat = "summary", 
             fun = "mean", 
             position=position_dodge(width=0.5)) +
  geom_pointrange(
    aes(ymin = mean_bioarea - sd_bioarea, 
        ymax = mean_bioarea + sd_bioarea),
    position=position_dodge(width=0.5)) +
  labs(x = "Day", 
       y = "Regional biomass (average bioarea between 2 patches/Âµl)", 
       color='', 
       fill='') +
  scale_fill_discrete(labels = c("Meta-ecosystem with patches of same size", "Meta-ecosystem with patches of different size")) +
  scale_color_discrete(labels = c("Meta-ecosystem with patches of same size", "Meta-ecosystem with patches of different size")) +
  theme_bw() +
  theme(panel.grid.major = element_blank(), 
        panel.grid.minor = element_blank())
```

*Figure 2. Regional biomass production in meta-ecosystems of the same total area, but whose two patches are either identical (red, medium-medium meta-ecosystem) or one is five times larger (blue, small-large meta-ecosystem).*

```{r child = "no_time_fitting_t2-t7.Rmd", echo = TRUE, eval = TRUE}
```

```{r child = "no_time_fitted_different_time_periods.Rmd", echo = TRUE, eval = TRUE}
```

```{r child = "time_fitting.Rmd", echo = TRUE, eval = TRUE}
```

```{r child = "time_fitted_t2-t7.Rmd", echo = TRUE, eval = TRUE}
```

```{r child = "time_fitted_each_time_point.Rmd", echo = TRUE, eval = TRUE}
```

```{r child = "time_fitted_different_time_periods.Rmd", echo = TRUE, eval = TRUE}
```

# Local biomass modelling 

## Plot

```{r}

ds %>%
    filter (  eco_metaeco_type == "S" | 
              eco_metaeco_type == "S (S_S)" |
              eco_metaeco_type == "S (S_L)") %>%
    ggplot(aes(x = day,
               y = bioarea_per_volume,
               fill = eco_metaeco_type,
               color = eco_metaeco_type)) +
    geom_point(stat = "summary", fun = "mean") +
    geom_line(stat = "summary", fun = "mean") +
    labs(x = "Day", 
         y = "Local biomass (bioarea/Âµl)", 
         color = '', 
         fill = '') +
    scale_fill_discrete(labels = c("Isolated patch", 
                                   "Patch connected to patch of the same size", 
                                   "Patch connected to larger patch")) +
    scale_color_discrete(labels = c("Isolated patch", 
                                    "Patch connected to patch of the same size", 
                                    "Patch connected to larger patch")) +
    theme_bw() +
    theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank())
```

*Figure 3. Local biomass production in patches that are either isolated (red, small isolated patches), connected to patches of the same size (green, patches of small-small meta-ecosystems), or connected to patches five times larger (blue, small patches of small-large meta-ecosystems).*

## Local biomass modelling - S_S and S_L

### Tidy

```{r}
ds_local_S_t2_t7 = ds %>%
  filter (eco_metaeco_type == "S (S_S)" | 
          eco_metaeco_type == "S (S_L)") %>%
  filter(time_point >= 2) #Let's take off the first two time points which are before the first disturbance event.
```

### Plot

```{r}
ds_local_S_t2_t7 %>%
    ggplot(aes(x = day,
               y = bioarea_per_volume,
               fill = eco_metaeco_type,
               color = eco_metaeco_type)) +
    geom_point(stat = "summary", fun = "mean") +
    geom_line(stat = "summary", fun = "mean") +
    labs(x = "Day", 
         y = "Local biomass (bioarea/Âµl)", 
         color = '', 
         fill = '') +
    scale_fill_discrete(labels = c("Patch connected to patch of the same size", 
                                   "Patch connected to larger patch")) +
    scale_color_discrete(labels = c("Patch connected to patch of the same size", 
                                    "Patch connected to larger patch")) +
    theme_bw() +
    theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank())
```

### Model selection

Let's start from building the full model.

```{r}
full_model = lmer(bioarea_per_volume ~ 
                    metaecosystem_type  + 
                    disturbance + 
                    metaecosystem_type * disturbance + 
                    (metaecosystem_type || day) + 
                    (disturbance || day) + 
                    (metaecosystem_type*disturbance  || day),
                  data = ds_local_S_t2_t7, 
                  REML = FALSE)
```

**Does time have a random effect?**

```{r}
fixed_effects_model = lm(bioarea_per_volume ~ 
                           metaecosystem_type  + 
                           disturbance +
                           metaecosystem_type * disturbance, 
                         data = ds_local_S_t2_t7)

anova(full_model, fixed_effects_model)
```

Yes. Let's then keep the random effect of time.

```{r}
best_model = full_model
```

**Do meta-ecosystem type and disturbance interact?**

```{r}
no_interaction_model = lmer(bioarea_per_volume ~ 
                              metaecosystem_type + 
                              disturbance  + 
                              (metaecosystem_type || day) + 
                              (disturbance || day), 
                            data = ds_local_S_t2_t7, 
                            REML = FALSE)

anova(best_model, no_interaction_model)
```

Yes. Let's keep the model without the interaction between meta-ecosystem type and disturbance, as it has lower BIC.

```{r}
best_model = no_interaction_model
```

**Does time have an effect on the slope of metaecosystem_type?**

```{r}
no_metaeco_slopes_model = lmer(bioarea_per_volume ~ 
                         metaecosystem_type + 
                         disturbance  + 
                         (disturbance || day), 
                       data = ds_local_S_t2_t7, 
                       REML = FALSE,
                       control = lmerControl (optimizer = "Nelder_Mead")
                       )

anova(best_model, no_metaeco_slopes_model)
```

No. Let's then keep the model without the random effect of time on meta-ecosystem type slopes.

**Does time have an effect on the slope of disturbance?**

```{r}
no_disturbance_slopes_model = lmer(bioarea_per_volume ~ 
                         metaecosystem_type + 
                         disturbance  + 
                         (1 | day), 
                       data = ds_local_S_t2_t7, 
                       REML = FALSE,
                       control = lmerControl (optimizer = "Nelder_Mead")
                       )

anova(best_model, no_disturbance_slopes_model)
```

Yes. Let's keep the model without slopes from disturbance, as it has lower BIC.

```{r}
best_model = no_disturbance_slopes_model
summary(best_model)
```

## Analysis of the best model

#### Effect size and significance of full model 

```{r}
model.null = lm(bioarea_per_volume ~ 
                  1, 
                  data = ds_local_S_t2_t7)

r2_best = r.squaredGLMM(best_model)
r2_best = round(r2_best, digits = 3)

anova = anova(best_model, model.null)
p_best = anova$`Pr(>Chisq)`[2]
p_best = round(p_best, digits = 5)

if (p_best < 0.00001) {
  p_best = "< 0.00001"
}
```

#### Effect size and significance of meta-ecosystem type

```{r}
metaecosystem_type_null = lmer(bioarea_per_volume ~  
                                 disturbance  + 
                                 (1 | day),
                               data = ds_local_S_t2_t7, 
                               REML = FALSE, 
                               control = lmerControl(optimizer ="Nelder_Mead"))

r2_no_metaecosystem_type = r.squaredGLMM(metaecosystem_type_null)
r2_no_metaecosystem_type = round(r2_no_metaecosystem_type, digits = 3)

anova = anova(best_model, metaecosystem_type_null)
p_no_metaecosystem_type = anova$`Pr(>Chisq)`[2]
p_no_metaecosystem_type = round(p_no_metaecosystem_type, digits = 5)

if (p_no_metaecosystem_type < 0.00001) {
  p_no_metaecosystem_type = "< 0.00001"
}
```

#### Effect size and significance of disturbance

```{r}
disturbance_null = lmer(bioarea_per_volume ~ 
                          metaecosystem_type  + 
                          (1 | day), 
                        data = ds_local_S_t2_t7, 
                        REML = FALSE,
                        control = lmerControl(optimizer ='optimx', 
                                                     optCtrl=list(method='L-BFGS-B')))

r2_no_disturbance = r.squaredGLMM(disturbance_null)
r2_no_disturbance = round(r2_no_disturbance, digits = 3)

anova = anova(best_model, disturbance_null)
p_no_disturbance = anova$`Pr(>Chisq)`[2]
p_no_disturbance = round(p_no_disturbance, digits = 5)

if (p_no_disturbance < 0.00001) {
  p_no_disturbance = "< 0.00001"
}
```

The effect size and significance of our results can be found in the following table.

| Model                                  |           Marginal R2           |   Marginal R2 of the best model explained    |         Conditional R2          |  Conditional R2 of the best model explained  |           P-value           |
|:-----------|:----------:|:----------:|:----------:|:----------:|:----------:|
| Best model                             |         `r r2_best[1]`          |                      /                       |         `r r2_best[2]`          |                      /                       |         `r p_best`          |
| Best model without meta-ecosystem type | `r r2_no_metaecosystem_type[1]` | `r r2_best[1] - r2_no_metaecosystem_type[1]` | `r r2_no_metaecosystem_type[2]` | `r r2_best[2] - r2_no_metaecosystem_type[2]` | `r p_no_metaecosystem_type` |
| Best model without disturbance         |    `r r2_no_disturbance[1]`     |    `r r2_best[1] - r2_no_disturbance[1]`     |    `r r2_no_disturbance[2]`     |    `r r2_best[2] - r2_no_disturbance[2]`     |    `r p_no_disturbance`     |

## t2-3, t2-t4, t2-t5, t2-t6, t2-t7 

Let's now try to see how meta-ecosystem effect changes across different time periods.

```{r}
R2 = NULL
for (last_point in 3:7) {
  
  filtered_dataset = ds_local_S_t2_t7 %>%
  filter(time_point <= last_point)
  
  full_model = lmer(bioarea_per_volume ~ 
                      disturbance +
                      metaecosystem_type + 
                      (1 | day),
                    data = filtered_dataset,
                    REML = FALSE)
  
  no_metaeco_type_model = lmer(bioarea_per_volume ~ 
                               disturbance +
                               (1 | day),
                             data = filtered_dataset,
                             REML = FALSE)
  
  anova(full_model, no_metaeco_type_model)
  
  R2_full = r.squaredGLMM(full_model)[1,1]
  R2_null = r.squaredGLMM(no_metaeco_type_model)[1,1]
  
  R2[[last_point]] =  R2_full - R2_null
  R2[[last_point]] = round(R2[[last_point]], digits = 3)
  
}
```

| Time points | Marginal R squared of meta-ecosystem type |
|:-----------:|:-----------------------------------------:|
|   t2 - t3   |                `r R2[[3]]`                |
|   t2 -t4    |                `r R2[[4]]`                |
|   t2 - t5   |                `r R2[[5]]`                |
|   t2 - t6   |                `r R2[[6]]`                |
|   t2 - t7   |                `r R2[[7]]`                |

## Local biomass modelling - S and S_L

### Tidy

```{r}
ds_local_S_t2_t7 = ds %>%
  filter (eco_metaeco_type == "S" | 
          eco_metaeco_type == "S (S_L)") %>%
  filter(time_point >= 2) #Let's take off the first two time points which are before the first disturbance event.
```

### Plot

```{r}
ds_local_S_t2_t7 %>%
    ggplot(aes(x = day,
               y = bioarea_per_volume,
               fill = eco_metaeco_type,
               color = eco_metaeco_type)) +
    geom_point(stat = "summary", fun = "mean") +
    geom_line(stat = "summary", fun = "mean") +
    labs(x = "Day", 
         y = "Local biomass (bioarea/Âµl)", 
         color = '', 
         fill = '') +
    scale_fill_discrete(labels = c("Isolated patch", 
                                   "Patch connected to larger patch")) +
    scale_color_discrete(labels = c("Isolated patch", 
                                    "Patch connected to larger patch")) +
    theme_bw() +
    theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank())
```

### Model selection

Let's start from building the full model.

```{r}
full_model = lmer(bioarea_per_volume ~ 
                    metaecosystem_type  + 
                    disturbance + 
                    metaecosystem_type * disturbance + 
                    (metaecosystem_type || day) + 
                    (disturbance || day) + 
                    (metaecosystem_type*disturbance  || day),
                  data = ds_local_S_t2_t7, 
                  REML = FALSE)
```

**Does time have a random effect?**

```{r}
fixed_effects_model = lm(bioarea_per_volume ~ 
                           metaecosystem_type  + 
                           disturbance +
                           metaecosystem_type * disturbance, 
                         data = ds_local_S_t2_t7)

anova(full_model, fixed_effects_model)
```

Yes. Let's then keep the random effect of time.

```{r}
best_model = full_model
```

**Do meta-ecosystem type and disturbance interact?**

```{r}
no_interaction_model = lmer(bioarea_per_volume ~ 
                              metaecosystem_type + 
                              disturbance  + 
                              (metaecosystem_type || day) + 
                              (disturbance || day), 
                            data = ds_local_S_t2_t7, 
                            REML = FALSE)

anova(best_model, no_interaction_model)
```

No. Let's keep the model without the interaction between meta-ecosystem type and disturbance.

```{r}
best_model = no_interaction_model
```

**Does time have an effect on the slope of metaecosystem_type?**

```{r}
no_metaeco_slopes_model = lmer(bioarea_per_volume ~ 
                         metaecosystem_type + 
                         disturbance  + 
                         (disturbance || day), 
                       data = ds_local_S_t2_t7, 
                       REML = FALSE,
                       control = lmerControl (optimizer = "Nelder_Mead")
                       )

anova(best_model, no_metaeco_slopes_model)
```

No. Let's then keep the model without the random effect of time on meta-ecosystem type slopes.

**Does time have an effect on the slope of disturbance?**

```{r}
no_disturbance_slopes_model = lmer(bioarea_per_volume ~ 
                         metaecosystem_type + 
                         disturbance  + 
                         (1 | day), 
                       data = ds_local_S_t2_t7, 
                       REML = FALSE,
                       control = lmerControl (optimizer = "Nelder_Mead")
                       )

anova(best_model, no_disturbance_slopes_model)
```

No. Let's keep the model without slopes from disturbance.

```{r}
best_model = no_disturbance_slopes_model
summary(best_model)
```

## Analysis of the best model

#### Effect size and significance of full model 

```{r}
model.null = lm(bioarea_per_volume ~ 
                  1, 
                  data = ds_local_S_t2_t7)

r2_best = r.squaredGLMM(best_model)
r2_best = round(r2_best, digits = 3)

anova = anova(best_model, model.null)
p_best = anova$`Pr(>Chisq)`[2]
p_best = round(p_best, digits = 5)

if (p_best < 0.00001) {
  p_best = "< 0.00001"
}
```

#### Effect size and significance of meta-ecosystem type

```{r}
metaecosystem_type_null = lmer(bioarea_per_volume ~  
                                 disturbance  + 
                                 (1 | day),
                               data = ds_local_S_t2_t7, 
                               REML = FALSE, 
                               control = lmerControl(optimizer ="Nelder_Mead"))

r2_no_metaecosystem_type = r.squaredGLMM(metaecosystem_type_null)
r2_no_metaecosystem_type = round(r2_no_metaecosystem_type, digits = 3)

anova = anova(best_model, metaecosystem_type_null)
p_no_metaecosystem_type = anova$`Pr(>Chisq)`[2]
p_no_metaecosystem_type = round(p_no_metaecosystem_type, digits = 5)

if (p_no_metaecosystem_type < 0.00001) {
  p_no_metaecosystem_type = "< 0.00001"
}
```

#### Effect size and significance of disturbance

```{r}
disturbance_null = lmer(bioarea_per_volume ~ 
                          metaecosystem_type  + 
                          (1 | day), 
                        data = ds_local_S_t2_t7, 
                        REML = FALSE,
                        control = lmerControl(optimizer ='optimx', 
                                                     optCtrl=list(method='L-BFGS-B')))

r2_no_disturbance = r.squaredGLMM(disturbance_null)
r2_no_disturbance = round(r2_no_disturbance, digits = 3)

anova = anova(best_model, disturbance_null)
p_no_disturbance = anova$`Pr(>Chisq)`[2]
p_no_disturbance = round(p_no_disturbance, digits = 5)

if (p_no_disturbance < 0.00001) {
  p_no_disturbance = "< 0.00001"
}
```

The effect size and significance of our results can be found in the following table.

| Model                                  |           Marginal R2           |   Marginal R2 of the best model explained    |         Conditional R2          |  Conditional R2 of the best model explained  |           P-value           |
|:-----------|:----------:|:----------:|:----------:|:----------:|:----------:|
| Best model                             |         `r r2_best[1]`          |                      /                       |         `r r2_best[2]`          |                      /                       |         `r p_best`          |
| Best model without meta-ecosystem type | `r r2_no_metaecosystem_type[1]` | `r r2_best[1] - r2_no_metaecosystem_type[1]` | `r r2_no_metaecosystem_type[2]` | `r r2_best[2] - r2_no_metaecosystem_type[2]` | `r p_no_metaecosystem_type` |
| Best model without disturbance         |    `r r2_no_disturbance[1]`     |    `r r2_best[1] - r2_no_disturbance[1]`     |    `r r2_no_disturbance[2]`     |    `r r2_best[2] - r2_no_disturbance[2]`     |    `r p_no_disturbance`     |

## t2-3, t2-t4, t2-t5, t2-t6, t2-t7 

Let's now try to see how meta-ecosystem effect changes across different time periods.

```{r}
R2 = NULL
for (last_point in 3:7) {
  
  filtered_dataset = ds_local_S_t2_t7 %>%
  filter(time_point <= last_point)
  
  full_model = lmer(bioarea_per_volume ~ 
                      disturbance +
                      metaecosystem_type + 
                      (1 | day),
                    data = filtered_dataset,
                    REML = FALSE)
  
  no_metaeco_type_model = lmer(bioarea_per_volume ~ 
                               disturbance +
                               (1 | day),
                             data = filtered_dataset,
                             REML = FALSE)
  
  anova(full_model, no_metaeco_type_model)
  
  R2_full = r.squaredGLMM(full_model)[1,1]
  R2_null = r.squaredGLMM(no_metaeco_type_model)[1,1]
  
  R2[[last_point]] =  R2_full - R2_null
  R2[[last_point]] = round(R2[[last_point]], digits = 3)
  
}
```

| Time points | Marginal R squared of meta-ecosystem type |
|:-----------:|:-----------------------------------------:|
|   t2 - t3   |                `r R2[[3]]`                |
|   t2 -t4    |                `r R2[[4]]`                |
|   t2 - t5   |                `r R2[[5]]`                |
|   t2 - t6   |                `r R2[[6]]`                |
|   t2 - t7   |                `r R2[[7]]`                |

## Local biomass modelling - S and S (S_S)

### Tidy

```{r}
ds_local_S_t2_t7 = ds %>%
  filter (eco_metaeco_type == "S" | 
          eco_metaeco_type == "S (S_S)") %>%
  filter(time_point >= 2) #Let's take off the first two time points which are before the first disturbance event.
```

### Plot

```{r}
ds_local_S_t2_t7 %>%
    ggplot(aes(x = day,
               y = bioarea_per_volume,
               fill = eco_metaeco_type,
               color = eco_metaeco_type)) +
    geom_point(stat = "summary", fun = "mean") +
    geom_line(stat = "summary", fun = "mean") +
    labs(x = "Day", 
         y = "Local biomass (bioarea/Âµl)", 
         color = '', 
         fill = '') +
    scale_fill_discrete(labels = c("Isolated patch", 
                                   "Patch connected to patch of the same size")) +
    scale_color_discrete(labels = c("Isolated patch", 
                                    "Patch connected to patch of the same size")) +
    theme_bw() +
    theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank())
```

### Model selection

Let's start from building the full model.

```{r}
full_model = lmer(bioarea_per_volume ~ 
                    metaecosystem_type  + 
                    disturbance + 
                    metaecosystem_type * disturbance + 
                    (metaecosystem_type || day) + 
                    (disturbance || day) + 
                    (metaecosystem_type*disturbance  || day),
                  data = ds_local_S_t2_t7, 
                  REML = FALSE)
```

**Does meta-ecosystem type have an effect?**

```{r}

no_metaeco_type_model = lmer(bioarea_per_volume ~ 
                    disturbance + 
                    (disturbance || day),
                  data = ds_local_S_t2_t7, 
                  REML = FALSE)

anova(full_model, no_metaeco_type_model)
```

**No. Meta-ecosystem type has no effect.**

## Local biomass modelling - L and L (L_L)

### Tidy

```{r}
ds_local_S_t2_t7 = ds %>%
  filter (eco_metaeco_type == "L" | 
          eco_metaeco_type == "L (L_L)") %>%
  filter(time_point >= 2) #Let's take off the first two time points which are before the first disturbance event.
```

### Plot

```{r}
ds_local_S_t2_t7 %>%
    ggplot(aes(x = day,
               y = bioarea_per_volume,
               group= interaction(day, eco_metaeco_type),
               fill = eco_metaeco_type,
               color = eco_metaeco_type)) +
  geom_boxplot() + 
  labs(x = "Day", 
       y = "Local biomass (bioarea/Âµl)", 
       color = '', 
       fill = '') +
  scale_fill_discrete(labels = c("Isolated patch (large)", 
                                 "Patch connected to patch of the same size (large)")) +
  scale_color_discrete(labels = c("Isolated patch (large)", 
                                  "Patch connected to patch of the same size (large)")) +
  theme_bw() +
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank())
```

### Model selection

Let's start from building the full model.

```{r}
full_model = lmer(bioarea_per_volume ~ 
                    metaecosystem_type  + 
                    disturbance + 
                    metaecosystem_type * disturbance + 
                    (metaecosystem_type || day) + 
                    (disturbance || day) + 
                    (metaecosystem_type*disturbance  || day),
                  data = ds_local_S_t2_t7, 
                  REML = FALSE)
```

**Does meta-ecosystem type have an effect?**

```{r}
no_metaeco_type_model = lmer(bioarea_per_volume ~ 
                    disturbance + 
                    (disturbance || day),
                  data = ds_local_S_t2_t7, 
                  REML = FALSE)

anova(full_model, no_metaeco_type_model)
```

**No. Meta-ecosystem type has no effect.**

## Local biomass modelling - L and L (S_L)

### Tidy

```{r}
ds_local_S_t2_t7 = ds %>%
  filter (eco_metaeco_type == "L" | 
          eco_metaeco_type == "L (S_L)") %>%
  filter(time_point >= 2) #Let's take off the first two time points which are before the first disturbance event.
```

### Plot

```{r}
ds_local_S_t2_t7 %>%
    ggplot(aes(x = day,
               y = bioarea_per_volume,
               group= interaction(day, eco_metaeco_type),
               fill = eco_metaeco_type,
               color = eco_metaeco_type)) +
  geom_boxplot() + 
  labs(x = "Day", 
       y = "Local biomass (bioarea/Âµl)", 
       color = '', 
       fill = '') +
  scale_fill_discrete(labels = c("Isolated patch", 
                                 "Patch connected to smaller patch")) +
  scale_color_discrete(labels = c("Isolated patch", 
                                  "Patch connected to smaller patch")) +
  theme_bw() +
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank())
```

### Model selection

Let's start from building the full model.

```{r}
full_model = lmer(bioarea_per_volume ~ 
                    metaecosystem_type  + 
                    disturbance + 
                    metaecosystem_type * disturbance + 
                    (metaecosystem_type || day) + 
                    (disturbance || day) + 
                    (metaecosystem_type*disturbance  || day),
                  data = ds_local_S_t2_t7, 
                  REML = FALSE)
```

**Does meta-ecosystem type have an effect?**

```{r}
no_metaeco_type_model = lmer(bioarea_per_volume ~ 
                    disturbance + 
                    (disturbance || day),
                  data = ds_local_S_t2_t7, 
                  REML = FALSE)

anova(full_model, no_metaeco_type_model)
```

**No. Meta-ecosystem type has no effect.**

# Running time

```{r running-time, echo = FALSE, eval = FALSE}
end_time = Sys.time()
print(end_time - start_time) #For some reason it doesn't work 
```

# Bibliography
