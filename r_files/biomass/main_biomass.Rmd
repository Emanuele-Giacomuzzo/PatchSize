---
title: "Biomass analysis (PatchSizePilot)"
author: "Emanuele Giacomuzzo"
date: '2022-07-07'
output:
  html_document:
    toc: true
    theme: united
editor_options: 
  chunk_output_type: console
bibliography: /Applications/Mendeley/library.bib
---

Here I study how **biomass density** changes across treatments in the PatchSizePilot. In particular, I'm studying how biomass density changes across:

-   ecosystems of different size (this is the case in nature, but we need to make sure that it's the case also in our experiment)\
-   ecosystems that are connected (through the flow of nutrients) to an ecosystem of the same size or to an ecosystem that is larger\
-   meta-ecosystems in which patch size is the same or in which one patch has most of the area (we keep the total area of the meta-ecosystem constant)

```{r set-up-environment, echo = FALSE, results = FALSE, message = FALSE}
start_time = Sys.time()

rm( list = ls(  ) )
cat( "\014" )
library("tidyverse")
library("grid")
library("gridExtra") 
library("lme4")
library("here")
library("MuMIn")
library("equatiomatic")
library("knitr")
library("optimx")
library("GenSA")
library("purrr")

knitr::opts_chunk$set(message = FALSE)

source(here("r_files", "biomass", "functions", "biomass_plots.R"))

p = NULL #To run the plotting function
```

```{r extract-sections, include = FALSE}

sections.path = here("r_files", "biomass")
r.files = list.files(sections.path)
rmd.files = r.files[grepl(".Rmd", r.files)]
extracted.path = here("r_files", "biomass", "extracted_sections")

purrr::map(rmd.files, function(file.i) {
  
  file.name = gsub(".Rmd", "", file.i)
  extracted.file <- paste0(file.name, ".R")
  knitr::purl(
    file.path(sections.path, file.i),
    file.path(extracted.path, extracted.file)
    )
  
})
```

# Import

```{r import, message = FALSE, echo = TRUE}
culture_info = read.csv(here("data", "PatchSizePilot_culture_info.csv"), header = TRUE)
load(here("data", "population", "t0.RData")); t0 = pop_output
load(here("data", "population", "t1.RData")); t1 = pop_output
load(here("data", "population", "t2.RData")); t2 = pop_output
load(here("data", "population", "t3.RData")); t3 = pop_output
load(here("data", "population", "t4.RData")); t4 = pop_output
load(here("data", "population", "t5.RData")); t5 = pop_output
load(here("data", "population", "t6.RData")); t6 = pop_output
load(here("data", "population", "t7.RData")); t7 = pop_output
rm(pop_output)
```

# Tidy

```{r child = "tidy.Rmd"}
#source(here("r_files", "biomass", "extracted_sections", "tidy.R"))
```

# Create regional data set

```{r regional-biomass}
ds_regional = ds %>%
  filter(metaecosystem == "yes") %>%
  group_by(culture_ID, system_nr, disturbance, day, time_point, patch_size, metaecosystem_type) %>%
  summarise(patch_mean_bioarea_across_videos = mean(bioarea_per_volume)) %>%
  group_by(system_nr, disturbance, day, time_point, metaecosystem_type) %>%
  summarise(regional_mean_bioarea = mean(patch_mean_bioarea_across_videos))

metaecosystems_to_take_off = 40 #System 40 was the system of culture 60 that I spilled
ds_regional = ds_regional %>%
  filter(! system_nr %in% metaecosystems_to_take_off)
```

```{r child = "plots.Rmd", eval = FALSE}
#source(here("r_files", "biomass", "extracted_sections", "plots.R"))
```

# Modelling considerations

Before start modelling, just a few considerations on mixed effect models and model selection.

## Mixed effects models

-   To build the mixed effect models we will use the R package lme4. See page 6 of [this PDF](https://cran.r-project.org/web/packages/lme4/vignettes/lmer.pdf) to know more about the syntaxis of this package.

-   To do model diagnostics of mixed effect models, I'm going to look at the following two plots (as suggested by @Zuur2009, page 487):

    -   Quantile-quantile plots

    -   Partial residual plots

-   The effect size of the explaining variables is calculated in the mixed effect models as marginal and conditional r squared. The marginal r squared is how much variance is explained by the fixed effects. The conditional r squared is how much variance is explained by the fixed and the random effects. The marginal and conditional r squared are calculated using the package `MuMIn`. The computation is based on the methods of @Nakagawa2017. For the coding and interpretation of these r squared check the [documentation for the r.squaredGLMM function](https://rdrr.io/cran/MuMIn/man/r.squaredGLMM.html)

## Model selection

-   I am starting from the largest model and then simplifying because ... (see statistical modelling course at ETH).

-   I am going to select the best model according to BIC instead of AIC. This is because BIC is better for understanding and AIC for predicting.

# Regional biomass modelling

When modelling the regional biomass, we want to understand if the regional biomass produced by an ecosystem with a small and a large patch (metaecosystem_type = S_L) is lower than the regional biomass produced by an ecosystem with two medium patches (metaecosystem_type = M_M).

## Tidy

First of all, let's modify the data set including the regional biomass of our meta-ecosystems. In this data set, we want to have the regional biomass of the meta-ecosystems (averaged first across videos and then across patches) in which we:

-   Include only the meta-ecosystems in which patches had both medium size (metaecosystem_type = M_M) and meta-ecosystems in which patches had one a small size and the other large size (metaecosystem_type = S_L).

-   Take off the first two point (day 0 and day = 4). This is because the first perturbation happened only at day 5.

```{r}
ds_regional_shrunk_type_n_day = ds_regional %>%
    filter (metaecosystem_type == "M_M" | metaecosystem_type == "S_L", 
            time_point >= 2)
```

## Plot

Notice: I'm only going to plot the low disturbance.

```{r}

#calculate the standard deviation
ds_regional %>%
  group_by(metaecosystem_type, disturbance, day) %>%
  summarise(mean_bioarea = mean(regional_mean_bioarea), 
            sd_bioarea = sd(regional_mean_bioarea)) %>%
  filter(disturbance == "low") %>%
  filter (metaecosystem_type == "S_L" | metaecosystem_type == "M_M") %>%
  ggplot (aes(x = day,
                y = mean_bioarea,
                fill = metaecosystem_type,
                color = metaecosystem_type)) +
  #geom_point(stat = "summary", fun = "mean") +
  geom_line (stat = "summary", 
             fun = "mean", 
             position=position_dodge(width=0.5)) +
  geom_pointrange(
    aes(ymin = mean_bioarea - sd_bioarea, 
        ymax = mean_bioarea + sd_bioarea),
    position=position_dodge(width=0.5)) +
  labs(x = "Day", 
       y = "Regional biomass (average bioarea between 2 patches/µl)", 
       color='', 
       fill='') +
  scale_fill_discrete(labels = c("Meta-ecosystem with patches of same size", 
                                 "Meta-ecosystem with patches of different size")) +
  scale_color_discrete(labels = c("Meta-ecosystem with patches of same size", 
                                  "Meta-ecosystem with patches of different size")) +
  theme_bw() +
  theme(panel.grid.major = element_blank(), 
        panel.grid.minor = element_blank())
```

*Figure 2. Regional biomass production in meta-ecosystems of the same total area, but whose two patches are either identical (red, medium-medium meta-ecosystem) or one is five times larger (blue, small-large meta-ecosystem).*

#source(here("r_files", "biomass", "extracted_sections", "no_time_fitting_t2-t7.R"))

```{r child = "no_time_fitting_t2-t7.Rmd", echo = TRUE, eval = TRUE}
```

#source(here("r_files", "biomass", "extracted_sections", "no_time_fitted_different_time_periods.R"))

```{r child = "no_time_fitted_different_time_periods.Rmd", echo = TRUE, eval = TRUE}
```

#source(here("r_files", "biomass", "extracted_sections", "time_fitting.R"))

```{r child = "time_fitting.Rmd", echo = TRUE, eval = TRUE}
```

#source(here("r_files", "biomass", "extracted_sections", "time_fitted_t2-t7.R"))

```{r child = "time_fitted_t2-t7.Rmd", echo = TRUE, eval = TRUE}
```

#source(here("r_files", "biomass", "extracted_sections", "time_fitted_each_time_point.R"))

```{r child = "time_fitted_each_time_point.Rmd", echo = TRUE, eval = TRUE}
```

#source(here("r_files", "biomass", "extracted_sections", "time_fitted_different_time_periods.R"))

```{r child = "time_fitted_different_time_periods.Rmd", echo = TRUE, eval = TRUE}
```

# Local biomass modelling

## Plot

```{r}
ds %>%
    filter (  eco_metaeco_type == "S" | 
              eco_metaeco_type == "S (S_S)" |
              eco_metaeco_type == "S (S_L)") %>%
    ggplot(aes(x = day,
               y = bioarea_per_volume,
               fill = eco_metaeco_type,
               color = eco_metaeco_type)) +
    geom_point(stat = "summary", fun = "mean") +
    geom_line(stat = "summary", fun = "mean") +
    labs(x = "Day", 
         y = "Local biomass (bioarea/µl)", 
         color = '', 
         fill = '') +
    scale_fill_discrete(labels = c("Isolated patch", 
                                   "Patch connected to patch of the same size", 
                                   "Patch connected to larger patch")) +
    scale_color_discrete(labels = c("Isolated patch", 
                                    "Patch connected to patch of the same size", 
                                    "Patch connected to larger patch")) +
    theme_bw() +
    theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank())
```

*Figure 3. Local biomass production in patches that are either isolated (red, small isolated patches), connected to patches of the same size (green, patches of small-small meta-ecosystems), or connected to patches five times larger (blue, small patches of small-large meta-ecosystems).*

#source(here("r_files", "biomass", "extracted_sections", "S_S\_and_S\_L.R"))

```{r child = "S_S_and_S_L.Rmd"}
```

#source(here("r_files", "biomass", "extracted_sections", "S_and_S-S_L.R"))

```{r child = "S_and_S-S_L.Rmd"}
```

#source(here("r_files", "biomass", "extracted_sections", "S_and_S-S_S.R"))

#Problem of rescaling variables

```{r child = "S_and_S-S_S.Rmd"}
```

#source(here("r_files", "biomass", "extracted_sections", "L_and_L-L_L.R"))

```{r child = "L_and_L-L_L.Rmd"}
```

#source(here("r_files", "biomass", "extracted_sections", "L_and_L-S_L.R"))

```{r child = "L_and_L-S_L.Rmd"}
```

# Running time

```{r running-time, echo = FALSE, eval = FALSE}
end_time = Sys.time()
print(end_time - start_time) #For some reason it doesn't work 
```

# Bibliography
