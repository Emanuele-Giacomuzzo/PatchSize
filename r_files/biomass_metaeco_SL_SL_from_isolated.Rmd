---
title: "small_large_from_isolated"
author: "Emanuele Giacomuzzo"
date: "2022-08-06"
output: html_document
editor_options: 
  chunk_output_type: console
---

### Small-Large vs Small-Large from isolated {.tabset .tabset-pills}

Do a meta-ecosystem with patches of the same size and a meta-ecosystems with patches of different size have different metaecosystem biomass density because of their resource flow? Or would we see this also with small and large ecosystems that are not connected? *(Do the small-large meta-ecosystems have different biomass density from two isolated small and large patches?)*

##### Plots

```{r S_L_from_isolated-single-systems-plots, message=FALSE}
for (disturbance_input in c("low", "high")){
  
  print(ds_metaecosystems %>%
          filter ( disturbance == disturbance_input) %>%
          filter (metaecosystem_type == "S_L" | 
                  metaecosystem_type == "S_L_from_isolated") %>%
          ggplot (aes(x = day,
                      y = total_metaecosystem_bioarea,
                      group = system_nr,
                      fill = system_nr,
                      color = system_nr,
                      linetype = metaecosystem_type)) +
          geom_line () +
          labs(title = paste("Disturbance =", disturbance_input),
               x = "Day", 
               y = "Regional bioarea (µm²)",
               fill = "System nr",
               color = "System nr",
               linetype = "") +
          scale_linetype_discrete(labels = c("small-large",
                                             "small-large \n from isolated")) + 
          theme_bw() +
          theme(panel.grid.major = element_blank(), 
                panel.grid.minor = element_blank(),
                legend.position = c(.95, .95),
                legend.justification = c("right", "top"),
                legend.box.just = "right",
                legend.margin = margin(6, 6, 6, 6)) +
          geom_vline(xintercept = first_perturbation_day, 
                     linetype = "dotdash", 
                     color = "grey", 
                     size = 0.7) +
          labs(caption = "Vertical grey line: first perturbation"))}
```

```{r S_L_from_isolated-single-boxplots}
for (disturbance_input in c("low", "high")){

  print(ds_metaecosystems %>%
          filter(disturbance == disturbance_input) %>%
          filter(metaecosystem_type == "S_L" | 
                 metaecosystem_type == "S_L_from_isolated") %>%
          ggplot(aes(x = day,
                     y = total_metaecosystem_bioarea,
                     group = interaction(day, metaecosystem_type),
                     fill = metaecosystem_type)) +
          geom_boxplot() +
          labs(title = "Disturbance = low",
               x = "Day",
               y = "Regional bioarea (µm²)",
               fill = "") +
          scale_fill_discrete(labels = c("small-large", "isolated small & \n isolated large")) + 
          theme_bw() +
          theme(panel.grid.major = element_blank(), 
                panel.grid.minor = element_blank(),
                legend.position = c(.95, .95),
                legend.justification = c("right", "top"),
                legend.box.just = "right",
                legend.margin = margin(6, 6, 6, 6)) +
          geom_vline(xintercept = first_perturbation_day + 0.7, 
                     linetype = "dotdash", 
                     color = "grey", 
                     size = 0.7) +
          labs(caption = "Vertical grey line: first perturbation"))}
```


##### Modelling

```{r}
#Compute possible combinations for the isolated meta-ecosystems. 

Ma_Mh_from_isolated_system_nrs = ds_equally_dominated %>%
  filter(metaecosystem_type == "Ma_Mh_from_isolated") %>%
  pull(system_nr) %>%
  unique()

Ma_Mh_system_nrs = ds_equally_dominated %>%
  filter(metaecosystem_type == "Ma_Mh") %>%
  pull(system_nr) %>%
  unique()

possible_isolated_combinations = combn(x = Ma_Mh_from_isolated_system_nrs, 
                                       m = length(Ma_Mh_system_nrs))

#Bootstrap from all combinations the p value and delta AIC

total_nr_of_combinations = ncol(possible_isolated_combinations)

for (combination_nr in 1:total_nr_of_combinations){
  
  start = Sys.time()

  combination = possible_isolated_combinations[, combination_nr]
  
  ds_equally_dominated_with_combination = ds_equally_dominated %>%
    filter(metaecosystem_type == "Ma_Mh" | system_nr %in% combination)
  
  full_model = lmer(
    total_metaecosystem_bioarea ~
      day +
      metaecosystem_type +
      day:metaecosystem_type +
      (day | system_nr),
    data = ds_equally_dominated_with_combination,
    REML = FALSE
  )
  
  no_metaecosystem_type = lmer(total_metaecosystem_bioarea ~
                                 day +
                                 (day | system_nr),
                               data = ds_equally_dominated_with_combination,
                               REML = FALSE)
  
  anova = anova(full_model, no_metaecosystem_type)
  
  p_value = anova$`Pr(>Chisq)`[2]
  
  AIC_full_model = tidy(anova) %>%
    filter(term == "full_model") %>%
    pull(AIC)
  
  AIC_null_model = tidy(anova) %>%
    filter(term == "no_metaecosystem_type") %>%
    pull(AIC)
  
  end = Sys.time()
  
  end - start
}
```

