---
title: "Patch biomass: small patches"
author: "Emanuele Giacomuzzo"
date: "2022-08-02"
output: html_document
editor_options:
  chunk_output_type: console
---

### Small patches {.tabset .tabset-pills}

*Research question: how does biomass density change according to the size to which the patch is connected? (Does a small patch connected to a small patch have the same biomass density than a small patch connected to a large patch?)*

#### Plots

```{r small-patches-single-ecosystems-plots}
for (disturbance_input in c("low", "high")) {
  print(
    ds_biomass_abund %>%
      filter(disturbance == disturbance_input) %>%
      filter(patch_size == "S") %>%
      ggplot(
        aes(
          x = day,
          y = bioarea_per_volume,
          group = culture_ID,
          fill = culture_ID,
          color = culture_ID,
          linetype = eco_metaeco_type
        )
      ) +
      geom_line(stat = "summary", fun = "mean") +
      labs(
        title = paste("Disturbance =", disturbance_input),
        x = "Day",
        y = "Local bioarea (µm²/μl)",
        linetype = ""
      ) +
      theme_bw() +
      theme(
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        legend.position = c(.95, .95),
        legend.justification = c("right", "top"),
        legend.box.just = "right",
        legend.margin = margin(6, 6, 6, 6)
      ) +
      scale_linetype_discrete(
        labels = c(
          "Small isolated",
          "Small connected to small",
          "Small connected to large"
        )
      )  +
      geom_vline(
        xintercept = first_perturbation_day,
        linetype = "dotdash",
        color = "grey",
        size = 0.7
      ) +
      labs(caption = "Vertical grey line: first perturbation")
  )
}
```

```{r small-patches-boxplots}
for (disturbance_input in c("low", "high")) {
  print(
    ds_biomass_abund %>%
      filter(disturbance == disturbance_input) %>%
      filter(patch_size == "S") %>%
      ggplot(
        aes(
          x = day,
          y = bioarea_per_volume,
          group = interaction(day, eco_metaeco_type),
          fill = eco_metaeco_type
        )
      ) +
      geom_boxplot() +
      labs(
        title = paste("Disturbance =", disturbance_input),
        x = "Day",
        y = "Local bioarea (µm²/μl)",
        fill = ""
      ) +
      theme_bw() +
      theme(
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        legend.position = c(.95, .95),
        legend.justification = c("right", "top"),
        legend.box.just = "right",
        legend.margin = margin(6, 6, 6, 6)
      ) +
      scale_fill_manual(
        values = c(colour_isolated, colour_different_size, colour_same_size),
        labels = c(
          "Small isolated",
          "Small connected to large",
          "Small connected to small"
        )
      ) +
      geom_vline(
        xintercept = first_perturbation_day + 0.7,
        linetype = "dotdash",
        color = "grey",
        size = 0.7
      ) +
      labs(caption = "Vertical grey line: first perturbation")
  )
}
```

```{r small-patches-lnRR-plots}
for (disturbance_input in c("low", "high")) {
  print(
    ds_patches_averaged %>%
      filter(!time_point == 0) %>% #At time point 0 all cultures were the same
      filter(disturbance == disturbance_input) %>%
      filter(eco_metaeco_type == "S (S_S)" |
               eco_metaeco_type == "S (S_L)") %>%
      ggplot(aes(
        x = day,
        y = bioarea_per_volume_d,
        color = eco_metaeco_type
      )) +
      geom_point(position = position_dodge(0.5)) +
      geom_line(position = position_dodge(0.5)) +
      labs(
        title = paste("Disturbance =", disturbance_input),
        x = "Day",
        y = "LnRR bioarea density",
        color = ""
      ) +
      scale_color_discrete(
        labels = c("small connected to large",
                   "small connnected to small")
      ) +
      theme_bw() +
      theme(
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        legend.position = c(.40, .95),
        legend.justification = c("right", "top"),
        legend.box.just = "right",
        legend.margin = margin(6, 6, 6, 6)
      ) +
      #geom_vline(xintercept = first_perturbation_day + 0.7,
      #           linetype="dotdash",
      #           color = "grey",
      #           size=0.7) +
      geom_hline(
        yintercept = 0,
        linetype = "dotted",
        color = "black",
        size = 0.7
      )
  )
}
```

#### Model Time Series

Let's test our hypothesis that small patches connected to large had more bioarea density. To do so, we will use a linear model. As we are using an effect size (control = isolated small), we have pulled all the replicates together and we cannot include random effects. We will exclude time point 0 because there all the cultures were the same (we did not measure each culture at day 0, but we measured the large bottle from which we created all cultures). We excluded the data points of time point = 1 because disturbance and ecosystem type couldn't have had an effect, but we included them as baselines. We are now including both baselines and their interaction with time, as baselines should have less of an effect as time goes by.

$$
Bioarea \: density \: (Hedge's \: d) = B + t + P + D + t*P + t*D + P*D + t*B
$$

B = baseline (bioarea at t1, before the first resource flow)

t = time

P = patch type (connected to small vs connected to large)

D = disturbance

```{r choose-time-points}
first_time_point = 2
last_time_point = 7

data_S = ds_patches_averaged %>%
                         filter(time_point >= first_time_point) %>%
                         filter(time_point <= last_time_point) %>%
                         filter(eco_metaeco_type== "S (S_S)" | eco_metaeco_type == "S (S_L)")
```

```{r small-patches-full-model}
full_model = lm(bioarea_per_volume_d ~                  
                  day + 
                  eco_metaeco_type + 
                  disturbance +
                  day : eco_metaeco_type +
                  day : disturbance + 
                  eco_metaeco_type : disturbance +
                  baseline + 
                  day : baseline,
                  data = data_S)
```

*Should we keep P?*

```{r small-patches-no_P}
no_P = lm(bioarea_per_volume_d ~               
                  day + 
                  disturbance +
                  day : eco_metaeco_type +
                  day : disturbance + 
                  eco_metaeco_type : disturbance,
                  data = ds_patches_averaged %>%
                         filter(time_point >= first_time_point) %>%
                         filter(time_point <= last_time_point) %>%
                         filter(eco_metaeco_type== "S (S_S)" | eco_metaeco_type == "S (S_L)"))

AIC(full_model, no_P)
```

Yes.

*Should we keep D?*

```{r}
no_D = lm(bioarea_per_volume_d ~                  
                  day + 
                  eco_metaeco_type + 
                  day : eco_metaeco_type +
                  day : disturbance + 
                  eco_metaeco_type : disturbance,
                  data = ds_patches_averaged %>%
                         filter(time_point >= first_time_point) %>%
                         filter(time_point <= last_time_point) %>%
                         filter(eco_metaeco_type== "S (S_S)" | eco_metaeco_type == "S (S_L)"))

AIC(full_model, no_D)
```

Yes.

*Should we keep t \* P?*

```{r small-patches-no-TM}
no_TP = lm(bioarea_per_volume_d ~
                  day + 
                  eco_metaeco_type + 
                  disturbance +
                  day : disturbance + 
                  eco_metaeco_type : disturbance,
                  data = ds_patches_averaged %>%
                         filter(time_point >= first_time_point) %>%
                         filter(time_point <= last_time_point) %>%
                         filter(eco_metaeco_type== "S (S_S)" | eco_metaeco_type == "S (S_L)"))

AIC(full_model, no_TP)
```

Yes.

*Should we keep t \* D?*

```{r small-patches-no-TD}
no_TD = lm(bioarea_per_volume_d ~
                  day + 
                  eco_metaeco_type + 
                  disturbance +
                  day : eco_metaeco_type +
                  eco_metaeco_type : disturbance,
                  data = ds_patches_averaged %>%
                         filter(time_point >= first_time_point) %>%
                         filter(time_point <= last_time_point) %>%
                         filter(eco_metaeco_type== "S (S_S)" | eco_metaeco_type == "S (S_L)"))

AIC(full_model, no_TD)
```

No.

Should we keep P \* D?

```{r small-patches-no-MD}
no_PD = lm(bioarea_per_volume_d ~
                  day + 
                  eco_metaeco_type + 
                  disturbance +
                  day : eco_metaeco_type,
                  data = ds_patches_averaged %>%
                         filter(time_point >= first_time_point) %>%
                         filter(time_point <= last_time_point) %>%
                         filter(eco_metaeco_type== "S (S_S)" | eco_metaeco_type == "S (S_L)"))

AIC(no_TD, no_PD)
```

No.

##### Best model

Then our best model is:

$$
lnRR (bioarea \: density) = t + P + D + t*P
$$

Let's then do some model diagnostics.

```{r small-t2-t7-best-model}
best_model = no_PD
par(mfrow = c(2,3))
plot(best_model, which = 1:5)
```

```{r}
R2_full = glance(best_model)$r.squared
no_patch_type = lm(bioarea_per_volume_d ~
                  day + 
                  disturbance,
                  data = ds_patches_averaged %>%
                         filter(time_point >= first_time_point) %>%
                         filter(time_point <= last_time_point) %>%
                         filter(eco_metaeco_type== "S (S_S)" | eco_metaeco_type == "S (S_L)"))

R2_no_P = glance(no_patch_type)$r.squared
R2_P = R2_full - R2_no_P

R2_full = round(R2_full, digits = 2)
R2_P = round(R2_P, digits = 2)
```

\
The adjusted R squared of the model is `r R2_full` and the adjusted R squared of patch type is `r R2_P` (which includes also its interaction with disturbance).

Single time points: see modelling choices.
