---
title: "large_patches"
author: "Emanuele Giacomuzzo"
date: "2022-10-17"
output: html_document
editor_options: 
  chunk_output_type: console
---

#### Large patches {.tabset .tabset-pills}

```{r small-patches-single-ecosystems-plots}
for (disturbance_input in c("low", "high")) {
  print(
    ds_biomass_abund %>%
      filter(disturbance == disturbance_input) %>%
      filter(patch_size == "L") %>%
      ggplot(
        aes(
          x = day,
          y = shannon,
          group = culture_ID,
          fill = culture_ID,
          color = culture_ID,
          linetype = eco_metaeco_type
        )
      ) +
      geom_line(stat = "summary", fun = "mean") +
      labs(
        title = paste("Disturbance =", disturbance_input),
        x = "Day",
        y = "Shannon Index",
        linetype = ""
      ) +
      theme_bw() +
      theme(
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        legend.position = "bottom"
      ) +
        scale_linetype_discrete(
          labels = c(
            "Large isolated",
            "Large connected to large",
            "Large connected to small"
          )
        )  +
      scale_x_continuous(breaks = unique(ds_biomass_abund$day)) +
      geom_vline(
        xintercept = perturbation_days[1] + 0.7,
        linetype = "dotdash",
        color = "grey",
        size = 0.7
      ) +
      geom_vline(
        xintercept = perturbation_days[2] + 0.7,
        linetype = "dotdash",
        color = "grey",
        size = 0.7
      ) +
      geom_vline(
        xintercept = perturbation_days[3] + 0.7,
        linetype = "dotdash",
        color = "grey",
        size = 0.7
      ) +
      geom_vline(
        xintercept = perturbation_days[4] + 0.7,
        linetype = "dotdash",
        color = "grey",
        size = 0.7
      ) +
      geom_vline(
        xintercept = perturbation_days[5] + 0.7,
        linetype = "dotdash",
        color = "grey",
        size = 0.7
      ) +
      geom_vline(
        xintercept = perturbation_days[6] + 0.7,
        linetype = "dotdash",
        color = "grey",
        size = 0.7
      ) +
      labs(caption = "Vertical grey line: resource flow")
  )
}
```

```{r}
for (disturbance_input in c("low", "high")) {
  print(
    ds_biomass_abund %>%
      filter(disturbance == disturbance_input) %>%
      filter(patch_size == "L") %>%
      group_by(culture_ID, time_point) %>%
      mutate(shannon_video_averaged = mean(shannon)) %>%
      ungroup() %>%
      ggplot(
        aes(
          x = day,
          y = shannon_video_averaged,
          group = interaction(day, eco_metaeco_type),
          fill = eco_metaeco_type
        )
      ) +
      geom_boxplot() +
      labs(
        title = paste("Disturbance =", disturbance_input),
        x = "Day",
        y = "Shannon Index",
        fill = ""
      ) +
      theme_bw() +
      theme(
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        legend.position = "bottom"
      ) +
       scale_fill_manual(
         values = c(colour_isolated, colour_same_size, colour_different_size),
         labels = c(
           "Small isolated",
           "Large connected to large",
           "Large connected to small"
         )
       ) +
      scale_x_continuous(breaks = unique(ds_biomass_abund$day)) +
      geom_vline(
        xintercept = perturbation_days[1] + 0.7,
        linetype = "dotdash",
        color = "grey",
        size = 0.7
      ) +
      geom_vline(
        xintercept = perturbation_days[2] + 0.7,
        linetype = "dotdash",
        color = "grey",
        size = 0.7
      ) +
      geom_vline(
        xintercept = perturbation_days[3] + 0.7,
        linetype = "dotdash",
        color = "grey",
        size = 0.7
      ) +
      geom_vline(
        xintercept = perturbation_days[4] + 0.7,
        linetype = "dotdash",
        color = "grey",
        size = 0.7
      ) +
      geom_vline(
        xintercept = perturbation_days[5] + 0.7,
        linetype = "dotdash",
        color = "grey",
        size = 0.7
      ) +
      geom_vline(
        xintercept = perturbation_days[6] + 0.7,
        linetype = "dotdash",
        color = "grey",
        size = 0.7
      ) +
      labs(caption = "Vertical grey line: resource flow")
  )
  
}
```

```{r}
for (disturbance_input in c("low", "high")) {
  print(
    ds_patches_averaged %>%
      filter(!time_point == 0) %>% #At time point 0 all cultures were the same
      filter(disturbance == disturbance_input) %>%
      filter(eco_metaeco_type == "L (L_L)" |
               eco_metaeco_type == "L (S_L)") %>%
      ggplot(aes(
        x = day,
        y = shannon_d,
        color = eco_metaeco_type
      )) +
      geom_point(position = position_dodge(0.5)) +
      geom_line(position = position_dodge(0.5)) +
      geom_errorbar(
        aes(ymin = shannon_d_lower,
            ymax = shannon_d_upper),
        width = .2,
        position = position_dodge(0.5)
      ) +
      labs(
        title = paste("Disturbance =", disturbance_input),
        x = "Day",
        y = "Shannon Index Effect Size (Hedge's d)",
        color = ""
      ) +
       scale_color_discrete(
         labels = c("Large connected to large",
                    "Large connected to small")
       ) +
      theme_bw() +
      theme(
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        legend.position = "bottom"
      ) +
      geom_vline(
        xintercept = perturbation_days[1] + 0.7,
        linetype = "dotdash",
        color = "grey",
        size = 0.7
      ) +
      geom_vline(
        xintercept = perturbation_days[2] + 0.7,
        linetype = "dotdash",
        color = "grey",
        size = 0.7
      ) +
      geom_vline(
        xintercept = perturbation_days[3] + 0.7,
        linetype = "dotdash",
        color = "grey",
        size = 0.7
      ) +
      geom_vline(
        xintercept = perturbation_days[4] + 0.7,
        linetype = "dotdash",
        color = "grey",
        size = 0.7
      ) +
      geom_vline(
        xintercept = perturbation_days[5] + 0.7,
        linetype = "dotdash",
        color = "grey",
        size = 0.7
      ) +
      geom_vline(
        xintercept = perturbation_days[6] + 0.7,
        linetype = "dotdash",
        color = "grey",
        size = 0.7
      ) +
      geom_hline(
        yintercept = 0,
        linetype = "dotted",
        color = "black",
        size = 0.7
      ) +
    scale_x_continuous(breaks = unique(ds_patches_averaged$day))
  )
}
```

Let's test our hypothesis that small patches connected to large had more species richness. To do so, we will use a linear model. As we are using an effect size (control = isolated small), we have pulled all the replicates together and we cannot include random effects. We will exclude time point 0 because there all the cultures were the same (we did not measure each culture at day 0, but we measured the large bottle from which we created all cultures). We excluded the data points of time point = 1 because disturbance and ecosystem type couldn't have had an effect, but we included them as baselines. We are now including both baselines and their interaction with time, as baselines should have less of an effect as time goes by.

$$
Species \: Richness \: (Hedge's \: d) = B + t + P + D + t*P + t*D + P*D + t*B
$$

B = baseline_shannon (bioarea at t1, before the first resource flow)

t = time

P = patch type (connected to small vs connected to large)

D = disturbance

```{r choose-time-points-small-alpha}
first_time_point = 2
last_time_point = 7

data_L = ds_patches_averaged %>%
                         filter(time_point >= first_time_point) %>%
                         filter(time_point <= last_time_point) %>%
                         filter(eco_metaeco_type== "S (S_S)" | eco_metaeco_type == "S (S_L)")
```

```{r small-patches-full-model-small-alpha}
full_model = lm(shannon_d ~                  
                  day + 
                  eco_metaeco_type + 
                  disturbance +
                  day : eco_metaeco_type +
                  day : disturbance + 
                  eco_metaeco_type : disturbance +
                  baseline_shannon + 
                  day : baseline_shannon,
                  data = data_L)

null_model = lm(shannon_d ~                  
                  day + 
                  disturbance +
                  day : disturbance + 
                  baseline_shannon + 
                  day : baseline_shannon,
                  data = data_L)

anova(full_model, null_model)
AIC(full_model, null_model)
```

Let's then do some model diagnostics.

```{r small-t2-t7-best-model-small-alpha}
par(mfrow = c(2,3))
plot(full_model, which = 1:5)
```

```{r}
R2_full = glance(full_model)$r.squared
R2_null = glance(null_model)$r.squared
R2_P = R2_full - R2_null

R2_full = round(R2_full, digits = 2)
R2_P = round(R2_P, digits = 2)
```

The adjusted R squared of the model is `r R2_full` and the adjusted R squared of patch type is `r R2_P` (which includes also its interaction with disturbance). I don't think it's necessary to look at effect sizes at different time points.