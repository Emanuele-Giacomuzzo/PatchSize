---
title: "All MM and SL"
output: html_document
date: "2022-12-13"
editor_options: 
  chunk_output_type: console
---

```{r}
response_variable = "total_metaecosystem_bioarea"
```

```{r}
plot.metaecos.boxplots(metaecosystem_type_input,
                       response_variable)

p_MM_SL_metaecos_biomass = plot.metaecos.points(metaecosystem_type_input,
                                                response_variable)
p_MM_SL_metaecos_biomass
```

**Analysis**

1.  Filter the data. Filter between time point 2 and time point 7 (last time point). We exclude time point 0 and time point 1, as these happened before the first disturbance took place (the first disturbance took place right after time point 1).

```{r}
filtered_data = ds_metaecosystems %>%
                         filter(time_point >= first_time_point_model,
                                time_point <= last_time_point_model,
                                disturbance == disturbance_input,
                                metaecosystem_type %in% metaecosystem_type_input)
```

2.  Construct a full model that captures all our hypotheses.\
    \
    The first hypothesis proposes that the total bioarea of medium-medium and the small-large meta-ecosystems is different. As such, the total bioarea will depend on the meta-ecosystem type (`total_metaecosystem_bioarea ~ metaecosystem_type`).\
    \
    The second hypothesis proposes that the total bioarea of isolated depends on the connection between patches\
    (`total_metaecosystem_bioarea ~ connection`).\
    \
    The third hypothesis proposes that the flow of non-living material has different effects whether the meta-ecosystem is medium-medium or small-large\
    (`total_metaecosystem_bioarea ~ metaecosystem_type * connection`)\

```{r}
full_model = lmer(
  total_metaecosystem_bioarea ~
    day +
    metaecosystem_type +
    metaecosystem_type : day +
    connection +
    connection : day + 
    metaecosystem_type : connection +
    metaecosystem_type : connection : day + 
    (day | system_nr),
  data = filtered_data,
  REML = FALSE,
  control = lmerControl(optimizer = "Nelder_Mead")
)
```

Check the output of the model.

```{r}
summary(full_model)
```

Check that the residuals of the model are okay (model diagnostics)

```{r}
plot(full_model)
qqnorm(resid(full_model))
```

3.  Test the full model.

    Construct the null model for all hypotheses.

```{r}
null_model = lmer(
  total_metaecosystem_bioarea ~
    day +
    (day | system_nr),
  data = filtered_data,
  REML = FALSE,
  control = lmerControl(optimizer = "Nelder_Mead")
)
```

Get the p value and the delta AIC of the full model compared to the null model.

```{r}

AIC = AIC(full_model, null_model) %>% 
  rownames_to_column("model")

AIC_full = AIC %>%
           filter(model == "full_model") %>%
           pull(AIC)

AIC_null = AIC %>%
           filter(model == "null_model") %>%
           pull(AIC)

deltaAIC = AIC_full - AIC_null
deltaAIC = round(deltaAIC, digits = 2)

anova = anova(full_model, null_model)
anova
p_value = anova$`Pr(>Chisq)`[2]
if (p_value < 0.001){
  p_value = "< 0.001"
} else {
  p_value = round(p_value, digits = 3)
}
```

```{r}
print(paste0("P value = ", p_value, ", ΔAIC = ", deltaAIC))
```

4.  Test hypothesis 1

    Construct the null model.

```{r}
null_model = lmer(
  total_metaecosystem_bioarea ~
    day +
    connection +
    connection : day + 
    metaecosystem_type : connection +
    metaecosystem_type : connection : day + 
    (day | system_nr),
  data = filtered_data,
  REML = FALSE,
  control = lmerControl(optimizer = "Nelder_Mead")
)
```

Get the p value and the delta AIC of the full model compared to the null model.

```{r}

AIC = AIC(full_model, null_model) %>% 
  rownames_to_column("model")

AIC_full = AIC %>%
           filter(model == "full_model") %>%
           pull(AIC)

AIC_null = AIC %>%
           filter(model == "null_model") %>%
           pull(AIC)

deltaAIC = AIC_full - AIC_null
deltaAIC = round(deltaAIC, digits = 2)

anova = anova(full_model, null_model)
anova
# p_value = anova$`Pr(>Chisq)`[2]
# if (p_value < 0.001){
#   p_value = "< 0.001"
# } else {
#   p_value = round(p_value, digits = 3)
# }
```

```{r}
# print(paste0("P value = ", p_value, ", ΔAIC = ", deltaAIC))
```

The full model and the null model result to be the same. So, it seems like taking off `metaecosystem_type` and `metaecosystem_type : day` doesn't have an effect, I'm not sure why this is the case.
