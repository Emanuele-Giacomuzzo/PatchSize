---
title: "Water evaporation (PatchSizePilot)"
author: "Emanuele Giacomuzzo"
date: '2022-07-13'
output: html_document
editor_options: 
  chunk_output_type: console
---

```{r environment set-up, message=FALSE, echo=FALSE}

rm( list = ls(  ) )
cat( "\014" )
library("tidyverse")
library("gridExtra")
library("lme4")
library("here")

```

Things to do:

- Exclude number 60 (?)
- Exclude the 5 tubes that were added water at some point because they were microwaved with empty tubes (106-110)

# Import

```{r import}

ds = read.csv(here("data", "PatchSizePilot_culture_info.csv"), header = TRUE)

head(ds)

```

# Tidy 

```{r tidy}

ds = gather(ds, exchange, evaporation, water_add_after_t2:water_add_after_t6)
ds[ds == "water_add_after_t2"] = "2"
ds[ds == "water_add_after_t3"] = "3"
ds[ds == "water_add_after_t4"] = "4"
ds[ds == "water_add_after_t5"] = "5"
ds[ds == "water_add_after_t6"] = "6"


#Divide by two the evaporation after the second resource exchange, as we retopped the water that evaporated also from exchange number 1. 
ds$evaporation[ds$exchange == 2] = ds$evaporation[ds$exchange == 2] / 2

#Add how many tubes were in each rack
ds$nr_of_tubes_in_rack[ds$exchange == 1] = 15
ds$nr_of_tubes_in_rack[ds$exchange == 2] = 15
ds$nr_of_tubes_in_rack[ds$exchange == 3] = 15
ds$nr_of_tubes_in_rack[ds$exchange == 4] = 4
ds$nr_of_tubes_in_rack[ds$exchange == 5] = 4
ds$nr_of_tubes_in_rack[ds$exchange == 6] = 4

#We need to add 2 ml to the evaporation that happened at the exchange events 1 and 2. This is because we already added 1 ml of water at exchange 1 and 1 ml of water at exchange 2. 
ds$evaporation[ds$exchange == 2] = ds$evaporation[ds$exchange == 2] + 2

#We need to take off tubes 106-110 at the second excahnge. This is because we boiled them more and then refilled them with 3.15 ml.

```

# Evaporation ~ time + disturbance + patch type

We want to know if there was a systematic bias in the evaporation of different treatments (disturbance, patch size) and whether evaporation changed across time. My expectation would be that we would see a difference among the exchanges 2,3 and the exchanges 4,5,6. This is because in exchange 2,3 cultures were microwaved in 15 tubes for 3 minutes and in exchange 4,5,6 cultures were microwaved in 4 tubes for only 1 minute. 

### Plot


```{r plot}

ds %>%
  ggplot(aes(x = exchange,
             y = evaporation)) +
  geom_boxplot() + 
  labs(x = "Exchange number", y = "Evaporation (ml)")

ds %>%
  ggplot(aes(x = as.character(nr_of_tubes_in_rack),
             y = evaporation)) + 
  geom_boxplot() +
  labs(x = "nr of tubes microwaved in a rack", y = "evaporation (ml)")

ds %>%
  ggplot(aes(x = exchange,
             y = evaporation,
             fill = patch_size,
             color = patch_size)) +
  geom_boxplot() + 
  labs(x = "Exchange number", y = "Evaporation (ml)", fill = "Patch size", color = "Patch size")

ds %>%
  ggplot(aes(x = exchange,
             y = evaporation,
             fill = disturbance,
             color = disturbance)) +
  geom_boxplot() +
  labs(x = "Exchange number", y = "Evaporation (ml)", fill = "Disturbance", color = "Disturbance")

ds %>%
  ggplot(aes(x = patch_size,
             y = evaporation,
             fill = disturbance,
             color = disturbance)) +
  geom_boxplot() +
  labs(x = "Patch size", y = "Evaporation (ml)", fill = "Disturbance", color = "Disturbance")

```

It seems like there is no real difference across time, disturbance, or patch type. However, we could also run a mixed effect model to show that they do not.  

### Mixed effect model

```{r mixed model, eval = FALSE}

mixed.model = lmer(evaporation  ~ exchange + patch_size + disturbance  + exchange*patch_size + exchange*disturbance + patch_size*disturbance + exchange*patch_size*disturbance + 
                     (exchange||id) + (patch_size||id) + (disturbance||id) + (exchange*patch_size||id) + (exchange*disturbance||id) + (patch_size*disturbance||id) + 
                     (exchange*patch_size*disturbance||id), data=ds)

```

# Evaporation ~ number of tubes in rack

We want to know if microwaving 15 tubes for 3 minutes or microwaving 4 tubes for 1 minute (800 W) made cultures evaporate to different degree throughout the experiment.

```{r difference between rack treatments}

evaporation_exchange_1_2 = ds %>%
  filter(!is.na(evaporation), exchange == 2) %>%
  summarise(mean_evaporation = mean(evaporation), sd_evaporation = sd(evaporation))
mean_evaporation_exchange_1_2 = round(evaporation_exchange_1_2$mean_evaporation, digits = 2)
sd_evaporation_exchange_1_2 = round(evaporation_exchange_1_2$sd_evaporation, digits = 2)





mean_evaporation = ds %>%
  filter(!is.na(evaporation)) %>%
  group_by(nr_of_tubes_in_rack) %>%
  summarise(mean_evaporation = mean(evaporation), sd_evaporation = sd(evaporation))

mean_evaporation_15 = round(mean_evaporation$mean_evaporation[mean_evaporation$nr_of_tubes_in_rack == 15], digits = 2)
mean_evaporation_4 = round(mean_evaporation$mean_evaporation[mean_evaporation$nr_of_tubes_in_rack == 4], digits = 2)
sd_evaporation_15 = round(mean_evaporation$sd_evaporation[mean_evaporation$nr_of_tubes_in_rack == 15], digits = 2)
sd_evaporation_4 = round(mean_evaporation$sd_evaporation[mean_evaporation$nr_of_tubes_in_rack == 4], digits = 2)


```

When we realized that there was too much evaporation happening, the amount of evaporation was `r mean_evaporation_exchange_1_2` ml (SD = `r sd_evaporation_exchange_1_2`). 

The mean evaporation with 15 tubes for 3 minutes was `r mean_evaporation_15` ml (SD = `r sd_evaporation_15`). The mean evaporation with 4 tubes for 1 minute was `r mean_evaporation_4` ml (SD = `r sd_evaporation_4`).