---
title: "Untitled"
output:
  html_document:
    code_folding: hide
    profiling: yes
date: "2023-04-14"
editor_options: 
  chunk_output_type: console
---

```{r}
filtered_data = ds_patches_effect_size %>%
  filter(
    time_point >= first_time_point_model,
    time_point <= last_time_point_model,
    patch_type %in% patch_type_input_model
  )
```

```{r}
plot.patches.points.ES(filtered_data,
                       patch_type_input_model,
                       response_variable)
```

<center>[**Null model**]{.underline}</center>

```{r}
null_model = lm(get(response_variable) ~
                  1,
                data = filtered_data)

#Robust regression
#null_model_robust = lmrob(get(response_variable) ~ 
#                            1, 
#                          data = filtered_data, 
#                          method = "MM")
```

<center>[**Full model**]{.underline} [**(with `size_connected_patch` and `size_connected_patch : day`)**]{.underline}</center>

```{r}
full_model = lm(get(response_variable) ~
                  size_connected_patch +
                  size_connected_patch:day,
                data = filtered_data)
```

<details>
  <summary>Click for model output</summary>
```{r}
print(summary(full_model), digits = 1)
```
</details> 

```{r eval = eval_cook_distances}
# Create the cook's distance plot
cook_distances <- influence.measures(full_model)[["infmat"]] %>% 
  as.data.frame() %>%
  select(cook.d) %>%
  pull() %>%
  as.double()
filtered_data_to_plot = filtered_data
filtered_data_to_plot$cook = cook_distances
filtered_data_to_plot$observation = 1:nrow(filtered_data_to_plot)
cook_distances_plot = filtered_data_to_plot %>%
    plot_ly(x = ~observation,
            y = ~cook,
            type = "scatter",
            mode = "markers",
            marker = list(size = 5, 
                          color = "#4C78A8"),
            text = paste("Patch type: ", filtered_data_to_plot$patch_type, "<br>",
                         "Day: ", filtered_data_to_plot$day, "<br>"),
            hoverinfo = "text") %>%
    plotly::layout(
        title = "Cook's distances",
        xaxis = list(title = "Observation index"),
        yaxis = list(title = "Cook's distance")
    )

#Create the residuals vs leverages plot
my_residuals <- resid(full_model)
my_leverages <- hatvalues(full_model)
filtered_data_to_plot$residuals = my_residuals
filtered_data_to_plot$leverages = my_leverages
leverage_plot = filtered_data_to_plot %>%
  plot_ly(x = ~leverages, 
        y = ~residuals, 
        type = "scatter", 
        mode = "markers", 
        marker = list(size = 5, 
                          color = "#4C78A8"),
        text = paste("Patch type: ", filtered_data_to_plot$patch_type, "<br>",
                         "Day: ", filtered_data_to_plot$day, "<br>"),
        hoverinfo = "text") %>%
  plotly::layout(
        title = "Residuals vs Leverages",
        xaxis = list(title = "Leverage"),
        yaxis = list(title = "Residual")
    )

#Calculate leverage points threshold (taken from rule of the statistical modelling course)
treshold_leverage_points = 2 * length(coef(full_model)) / nrow(filtered_data) 
treshold_leverage_points = round(treshold_leverage_points, digits = 2)

#Robust regression
#full_model_robust = lmrob(get(response_variable) ~ 
#                            size_connected_patch +
#                            size_connected_patch:day,
#                          data = filtered_data, 
#                          method = "MM")
#print(summary(full_model_robust), digits = 1)
#par(mfrow = c(2, 3))
#plot(full_model_robust, which = 1:5)
```

<details>
  <summary>Click for residual plots</summary>
```{r}
par(mfrow = c(2, 3))
plot(full_model, which = 1:5)
```

```{r, echo=FALSE, eval = eval_cook_distances}
cook_distances_plot
```

```{r}
leverage_plot
print(paste("Leverage points over", treshold_leverage_points, "could change the results of your model."))
```
</details> 

```{r}
model_stats_full = compute.model.stats(full_model,
                                       null_model,
                                       "linear_model")

model_stats_full %>%
  mutate(deltaAIC = round(deltaAIC, digits = 1),
         p_value = round(p_value, digits = 3),
         R2 = round(R2, digits = 2),
         evidence = "",
         evidence = ifelse(p_value > 0.1, 
                           "none",
                           evidence),
         evidence = ifelse(p_value < 0.1, 
                           "* weak",
                           evidence),
         evidence = ifelse(p_value < 0.05, 
                           "** moderate",
                           evidence),
         evidence = ifelse(p_value < 0.01, 
                           "*** strong",
                           evidence),
         evidence = ifelse(p_value < 0.001, 
                           "**** very strong",
                           evidence)) %>%
  print()
```

&nbsp;<br>
&nbsp;<br>
&nbsp;<br>

<center>[**Fixed model**]{.underline} [**(with `size_connected_patch`)**]{.underline}</center>

```{r}
fixed_model = lm(get(response_variable) ~
                  size_connected_patch,
                data = filtered_data)
```

<details>
  <summary>Click for model output</summary>
```{r}
print(summary(fixed_model), digits = 1)
```
</details> 

```{r eval = eval_cook_distances}
# Create the cook's distance plot
cook_distances <- influence.measures(fixed_model)[["infmat"]] %>% 
  as.data.frame() %>%
  select(cook.d) %>%
  pull() %>%
  as.double()
filtered_data_to_plot = filtered_data
filtered_data_to_plot$cook = cook_distances
filtered_data_to_plot$observation = 1:nrow(filtered_data_to_plot)
cook_distances_plot = filtered_data_to_plot %>%
    plot_ly(x = ~observation,
            y = ~cook,
            type = "scatter",
            mode = "markers",
            marker = list(size = 5, 
                          color = "#4C78A8"),
            text = paste("Patch type: ", filtered_data_to_plot$patch_type, "<br>",
                         "Day: ", filtered_data_to_plot$day, "<br>"),
            hoverinfo = "text") %>%
    plotly::layout(
        title = "Cook's distances",
        xaxis = list(title = "Observation index"),
        yaxis = list(title = "Cook's distance")
    )

#Create the residuals vs leverages plot
my_residuals <- resid(fixed_model)
my_leverages <- hatvalues(fixed_model)
filtered_data_to_plot$residuals = my_residuals
filtered_data_to_plot$leverages = my_leverages
leverage_plot = filtered_data_to_plot %>%
  plot_ly(x = ~leverages, 
        y = ~residuals, 
        type = "scatter", 
        mode = "markers", 
        marker = list(size = 5, 
                          color = "#4C78A8"),
        text = paste("Patch type: ", filtered_data_to_plot$patch_type, "<br>",
                         "Day: ", filtered_data_to_plot$day, "<br>"),
        hoverinfo = "text") %>%
  plotly::layout(
        title = "Residuals vs Leverages",
        xaxis = list(title = "Leverage"),
        yaxis = list(title = "Residual")
    )

#Calculate leverage points threshold (taken from rule of the statistical modelling course)
treshold_leverage_points = 2 * length(coef(fixed_model)) / nrow(filtered_data) 
treshold_leverage_points = round(treshold_leverage_points, digits = 2)

#Robust regression
#fixed_model_robust = lmrob(get(response_variable) ~ 
#                            size_connected_patch +
#                            size_connected_patch:day,
#                          data = filtered_data, 
#                          method = "MM")
#print(summary(fixed_model_robust), digits = 1)
#par(mfrow = c(2, 3))
#plot(fixed_model_robust, which = 1:5)
```

<details>
  <summary>Click for residual plots</summary>
```{r}
par(mfrow = c(2, 3))
plot(fixed_model, which = 1:5)
```

```{r, echo=FALSE, eval = eval_cook_distances}
cook_distances_plot
```

```{r}
leverage_plot
print(paste("Leverage points over", treshold_leverage_points, "could change the results of your model."))
```
</details> 

```{r}
model_stats_fixed = compute.model.stats(fixed_model,
                                       null_model,
                                       "linear_model")

model_stats_fixed %>%
  mutate(deltaAIC = round(deltaAIC, digits = 1),
         p_value = round(p_value, digits = 3),
         R2 = round(R2, digits = 2),
         evidence = "",
         evidence = ifelse(p_value > 0.1, 
                           "none",
                           evidence),
         evidence = ifelse(p_value < 0.1, 
                           "* weak",
                           evidence),
         evidence = ifelse(p_value < 0.05, 
                           "** moderate",
                           evidence),
         evidence = ifelse(p_value < 0.01, 
                           "*** strong",
                           evidence),
         evidence = ifelse(p_value < 0.001, 
                           "**** very strong",
                           evidence)) %>%
  print()
```

```{r}
results_table = fill.results.table(results_table,
                                   response_variable,
                                   patch_type_input_model,
                                   model_stats_full,
                                   model_stats_fixed)
```

&nbsp;<br>
&nbsp;<br>
&nbsp;<br>