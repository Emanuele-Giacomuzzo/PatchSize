---
title: "Data Patches Averaged"
output: html_document
date: "2022-11-22"
editor_options: 
  chunk_output_type: console
---

### Patch effect sizes (`ds_patches_averaged`)

```{r ds_patches_averaged}
ds_patches_averaged = ds_biomass_abund %>%
  group_by(
    culture_ID,
    system_nr,
    disturbance,
    time_point,
    day,
    patch_size,
    eco_metaeco_type
  ) %>%
  summarise(
    baseline_across_videos = mean(baseline),
    bioarea_per_volume_across_videos = mean(bioarea_per_volume),
    indiv_per_volume_across_videos = mean(indiv_per_volume),
    species_richness_across_videos = max(species_richness),
    Ble_across_videos = mean(Ble),
    Cep_across_videos = mean(Cep),
    Col_across_videos = mean(Col),
    Eug_across_videos = mean(Eug),
    Eup_across_videos = mean(Eup),
    Lox_across_videos = mean(Lox),
    Pau_across_videos = mean(Pau),
    Pca_across_videos = mean(Pca),
    Spi_across_videos = mean(Spi),
    Spi_te_across_videos = mean(Spi_te),
    Tet_across_videos = mean(Tet)
  ) %>%
  group_by(disturbance, 
           eco_metaeco_type, 
           time_point, 
           day) %>%
  summarise(
    sample_size = n(),
    baseline = mean(baseline_across_videos),
    bioarea_per_volume_mean = mean(bioarea_per_volume_across_videos),
    bioarea_per_volume_sd = sd(bioarea_per_volume_across_videos),
    indiv_per_volume_mean = mean(indiv_per_volume_across_videos),
    indiv_per_volume_sd = sd(indiv_per_volume_across_videos),
    species_richness_mean = mean(species_richness_across_videos),
    species_richness_sd = sd(species_richness_across_videos),
    Ble_mean = mean(Ble_across_videos),
    Ble_sd = sd(Ble_across_videos),
    Cep_mean = mean(Cep_across_videos),
    Cep_sd = sd(Cep_across_videos),
    Col_mean = mean(Col_across_videos),
    Col_sd = sd(Col_across_videos),
    Eug_mean = mean(Eug_across_videos),
    Eug_sd = sd(Eug_across_videos),
    Eup_mean = mean(Eup_across_videos),
    Eup_sd = sd(Eup_across_videos),
    Lox_mean = mean(Lox_across_videos),
    Lox_sd = sd(Lox_across_videos),
    Pau_mean = mean(Pau_across_videos),
    Pau_sd = sd(Pau_across_videos),
    Pca_mean = mean(Pca_across_videos),
    Pca_sd = sd(Pca_across_videos),
    Spi_mean = mean(Spi_across_videos),
    Spi_sd = sd(Spi_across_videos),
    Spi_te_mean = mean(Spi_te_across_videos),
    Spi_te_sd = sd(Spi_te_across_videos),
    Tet_mean = mean(Tet_across_videos),
    Tet_sd = sd(Tet_across_videos)
  ) %>% #Initialise columns
  mutate(bioarea_per_volume_d = NA,
         bioarea_per_volume_d_upper = NA,
         bioarea_per_volume_d_lower = NA,
         bioarea_per_volume_lnRR = NA,
         indiv_per_volume_d = NA,
         indiv_per_volume_d_upper = NA,
         indiv_per_volume_d_lower = NA,
         indiv_per_volume_lnRR = NA,
         species_richness_d = NA,
         species_richness_d_upper = NA,
         species_richness_d_lower = NA,
         species_richness_lnRR = NA,
         Ble_d = NA,
         Ble_d_upper = NA,
         Ble_d_lower = NA,
         Ble_lnRR = NA,
         Cep_d = NA,
         Cep_d_upper = NA,
         Cep_d_lower = NA,
         Cep_lnRR = NA,
         Col_d = NA,
         Col_d_upper = NA,
         Col_d_lower = NA,
         Col_lnRR = NA,
         Eug_d = NA,
         Eug_d_upper = NA,
         Eug_d_lower = NA,
         Eug_lnRR = NA,
         Eup_d = NA,
         Eup_d_upper = NA,
         Eup_d_lower = NA,
         Eup_lnRR = NA,
         Lox_d = NA,
         Lox_d_upper = NA,
         Lox_d_lower = NA,
         Lox_lnRR = NA,
         Pau_d = NA,
         Pau_d_upper = NA,
         Pau_d_lower = NA,
         Pau_lnRR = NA,
         Pca_d = NA,
         Pca_d_upper = NA,
         Pca_d_lower = NA,
         Pca_lnRR = NA,
         Spi_d = NA,
         Spi_d_upper = NA,
         Spi_d_lower = NA,
         Spi_lnRR = NA,
         Spi_te_d = NA,
         Spi_te_d_upper = NA,
         Spi_te_d_lower = NA,
         Spi_te_lnRR = NA,
         Tet_d = NA,
         Tet_d_upper = NA,
         Tet_d_lower = NA,
         Tet_lnRR = NA)
```

```{r}
treatments_and_controls = data.frame(
  treatment = c("S (S_S)", "S (S_L)", "L (L_L)", "L (S_L)"),
  control = c("S", "S", "L", "L")
)

n_of_treatments = nrow(treatments_and_controls)

row_n = 0
for (disturbance_input in c("low", "high")) {
  for (treatment_n in 1:n_of_treatments) {
    for (time_point_input in 0:7) {
      row_n = row_n + 1
      
      eco_metaeco_treatment = treatments_and_controls$treatment[treatment_n]
      treatment = ds_patches_averaged %>%
        filter(
          disturbance == disturbance_input,
          eco_metaeco_type == eco_metaeco_treatment,
          time_point == time_point_input
        )
      
      eco_metaeco_control = treatments_and_controls$control[treatment_n]
      control = ds_patches_averaged %>%
        filter(
          disturbance == disturbance_input,
          eco_metaeco_type == eco_metaeco_control,
          time_point == time_point_input
        )
      
      ds_patches_averaged$bioarea_per_volume_d[ds_patches_averaged$disturbance == disturbance_input &
                                                 ds_patches_averaged$eco_metaeco_type == eco_metaeco_treatment &
                                                 ds_patches_averaged$time_point == time_point_input] = calculate.hedges_d(
                                                   treatment$bioarea_per_volume_mean,
                                                   treatment$bioarea_per_volume_sd,
                                                   treatment$sample_size,
                                                   control$bioarea_per_volume_mean,
                                                   control$bioarea_per_volume_sd,
                                                   control$sample_size
                                                 )
      
      ds_patches_averaged$bioarea_per_volume_lnRR[ds_patches_averaged$disturbance == disturbance_input &
                                                    ds_patches_averaged$eco_metaeco_type == eco_metaeco_treatment &
                                                    ds_patches_averaged$time_point == time_point_input] = ln(treatment$bioarea_per_volume_mean / control$bioarea_per_volume_mean)
      
      ds_patches_averaged$indiv_per_volume_d[ds_patches_averaged$disturbance == disturbance_input &
                                               ds_patches_averaged$eco_metaeco_type == eco_metaeco_treatment &
                                               ds_patches_averaged$time_point == time_point_input] = calculate.hedges_d(
                                                 treatment$indiv_per_volume_mean,
                                                 treatment$indiv_per_volume_sd,
                                                 treatment$sample_size,
                                                 control$indiv_per_volume_mean,
                                                 control$indiv_per_volume_sd,
                                                 control$sample_size
                                               )
      
      ds_patches_averaged$indiv_per_volume_lnRR[ds_patches_averaged$disturbance == disturbance_input &
                                                    ds_patches_averaged$eco_metaeco_type == eco_metaeco_treatment &
                                                    ds_patches_averaged$time_point == time_point_input] = ln(treatment$indiv_per_volume_mean / control$indiv_per_volume_mean)
      
      ds_patches_averaged$species_richness_d[ds_patches_averaged$disturbance == disturbance_input &
                                               ds_patches_averaged$eco_metaeco_type == eco_metaeco_treatment &
                                               ds_patches_averaged$time_point == time_point_input] = calculate.hedges_d(
                                                 treatment$species_richness_mean,
                                                 treatment$species_richness_sd,
                                                 treatment$sample_size,
                                                 control$species_richness_mean,
                                                 control$species_richness_sd,
                                                 control$sample_size
                                               )
      
      ds_patches_averaged$species_richness_lnRR[ds_patches_averaged$disturbance == disturbance_input &
                                                  ds_patches_averaged$eco_metaeco_type == eco_metaeco_treatment &
                                                  ds_patches_averaged$time_point == time_point_input] = ln(treatment$species_richness_mean / control$species_richness_mean)
      
      ds_patches_averaged$Ble_d[ds_patches_averaged$disturbance == disturbance_input &
                                  ds_patches_averaged$eco_metaeco_type == eco_metaeco_treatment &
                                  ds_patches_averaged$time_point == time_point_input] = calculate.hedges_d(
                                    treatment$Ble_mean,
                                    treatment$Ble_sd,
                                    treatment$sample_size,
                                    control$Ble_mean,
                                    control$Ble_sd,
                                    control$sample_size
                                  )
      
      ds_patches_averaged$Ble_lnRR[ds_patches_averaged$disturbance == disturbance_input &
                                                    ds_patches_averaged$eco_metaeco_type == eco_metaeco_treatment &
                                                    ds_patches_averaged$time_point == time_point_input] = ln(treatment$Ble_mean / control$Ble_mean)
      
      ds_patches_averaged$Cep_d[ds_patches_averaged$disturbance == disturbance_input &
                                  ds_patches_averaged$eco_metaeco_type == eco_metaeco_treatment &
                                  ds_patches_averaged$time_point == time_point_input] = calculate.hedges_d(
                                    treatment$Cep_mean,
                                    treatment$Cep_sd,
                                    treatment$sample_size,
                                    control$Cep_mean,
                                    control$Cep_sd,
                                    control$sample_size
                                  )
      
      ds_patches_averaged$Cep_lnRR[ds_patches_averaged$disturbance == disturbance_input &
                                                    ds_patches_averaged$eco_metaeco_type == eco_metaeco_treatment &
                                                    ds_patches_averaged$time_point == time_point_input] = ln(treatment$Cep_mean / control$Cep_mean)
      
      ds_patches_averaged$Col_d[ds_patches_averaged$disturbance == disturbance_input &
                                  ds_patches_averaged$eco_metaeco_type == eco_metaeco_treatment &
                                  ds_patches_averaged$time_point == time_point_input] = calculate.hedges_d(
                                    treatment$Col_mean,
                                    treatment$Col_sd,
                                    treatment$sample_size,
                                    control$Col_mean,
                                    control$Col_sd,
                                    control$sample_size
                                  )
      
      ds_patches_averaged$Col_lnRR[ds_patches_averaged$disturbance == disturbance_input &
                                                    ds_patches_averaged$eco_metaeco_type == eco_metaeco_treatment &
                                                    ds_patches_averaged$time_point == time_point_input] = ln(treatment$Col_mean / control$Col_mean)
      
      ds_patches_averaged$Eug_d[ds_patches_averaged$disturbance == disturbance_input &
                                  ds_patches_averaged$eco_metaeco_type == eco_metaeco_treatment &
                                  ds_patches_averaged$time_point == time_point_input] = calculate.hedges_d(
                                    treatment$Eug_mean,
                                    treatment$Eug_sd,
                                    treatment$sample_size,
                                    control$Eug_mean,
                                    control$Eug_sd,
                                    control$sample_size
                                  )
      
      ds_patches_averaged$Eug_lnRR[ds_patches_averaged$disturbance == disturbance_input &
                                                    ds_patches_averaged$eco_metaeco_type == eco_metaeco_treatment &
                                                    ds_patches_averaged$time_point == time_point_input] = ln(treatment$Eug_mean / control$Eug_mean)
      
      ds_patches_averaged$Eup_d[ds_patches_averaged$disturbance == disturbance_input &
                                  ds_patches_averaged$eco_metaeco_type == eco_metaeco_treatment &
                                  ds_patches_averaged$time_point == time_point_input] = calculate.hedges_d(
                                    treatment$Eup_mean,
                                    treatment$Eup_sd,
                                    treatment$sample_size,
                                    control$Eup_mean,
                                    control$Eup_sd,
                                    control$sample_size
                                  )
      
      ds_patches_averaged$Eup_lnRR[ds_patches_averaged$disturbance == disturbance_input &
                                                    ds_patches_averaged$eco_metaeco_type == eco_metaeco_treatment &
                                                    ds_patches_averaged$time_point == time_point_input] = ln(treatment$Eup_mean / control$Eup_mean)
      
      ds_patches_averaged$Lox_d[ds_patches_averaged$disturbance == disturbance_input &
                                  ds_patches_averaged$eco_metaeco_type == eco_metaeco_treatment &
                                  ds_patches_averaged$time_point == time_point_input] = calculate.hedges_d(
                                    treatment$Lox_mean,
                                    treatment$Lox_sd,
                                    treatment$sample_size,
                                    control$Lox_mean,
                                    control$Lox_sd,
                                    control$sample_size
                                  )
      
      ds_patches_averaged$Lox_lnRR[ds_patches_averaged$disturbance == disturbance_input &
                                                    ds_patches_averaged$eco_metaeco_type == eco_metaeco_treatment &
                                                    ds_patches_averaged$time_point == time_point_input] = ln(treatment$Lox_mean / control$Lox_mean)
      
      ds_patches_averaged$Pau_d[ds_patches_averaged$disturbance == disturbance_input &
                                  ds_patches_averaged$eco_metaeco_type == eco_metaeco_treatment &
                                  ds_patches_averaged$time_point == time_point_input] = calculate.hedges_d(
                                    treatment$Pau_mean,
                                    treatment$Pau_sd,
                                    treatment$sample_size,
                                    control$Pau_mean,
                                    control$Pau_sd,
                                    control$sample_size
                                  )
      
      ds_patches_averaged$Pau_lnRR[ds_patches_averaged$disturbance == disturbance_input &
                                                    ds_patches_averaged$eco_metaeco_type == eco_metaeco_treatment &
                                                    ds_patches_averaged$time_point == time_point_input] = ln(treatment$Pau_mean / control$Pau_mean)
      
      ds_patches_averaged$Pca_d[ds_patches_averaged$disturbance == disturbance_input &
                                  ds_patches_averaged$eco_metaeco_type == eco_metaeco_treatment &
                                  ds_patches_averaged$time_point == time_point_input] = calculate.hedges_d(
                                    treatment$Pca_mean,
                                    treatment$Pca_sd,
                                    treatment$sample_size,
                                    control$Pca_mean,
                                    control$Pca_sd,
                                    control$sample_size
                                  )
      
      ds_patches_averaged$Pca_lnRR[ds_patches_averaged$disturbance == disturbance_input &
                                                    ds_patches_averaged$eco_metaeco_type == eco_metaeco_treatment &
                                                    ds_patches_averaged$time_point == time_point_input] = ln(treatment$Pca_mean / control$Pca_mean)
      
      ds_patches_averaged$Spi_d[ds_patches_averaged$disturbance == disturbance_input &
                                  ds_patches_averaged$eco_metaeco_type == eco_metaeco_treatment &
                                  ds_patches_averaged$time_point == time_point_input] = calculate.hedges_d(
                                    treatment$Spi_mean,
                                    treatment$Spi_sd,
                                    treatment$sample_size,
                                    control$Spi_mean,
                                    control$Spi_sd,
                                    control$sample_size
                                  )
      
      ds_patches_averaged$Spi_lnRR[ds_patches_averaged$disturbance == disturbance_input &
                                                    ds_patches_averaged$eco_metaeco_type == eco_metaeco_treatment &
                                                    ds_patches_averaged$time_point == time_point_input] = ln(treatment$Spi_mean / control$Spi_mean)
      
      ds_patches_averaged$Spi_te_d[ds_patches_averaged$disturbance == disturbance_input &
                                     ds_patches_averaged$eco_metaeco_type == eco_metaeco_treatment &
                                     ds_patches_averaged$time_point == time_point_input] = calculate.hedges_d(
                                       treatment$Spi_te_mean,
                                       treatment$Spi_te_sd,
                                       treatment$sample_size,
                                       control$Spi_te_mean,
                                       control$Spi_te_sd,
                                       control$sample_size
                                     )
      
      ds_patches_averaged$Spi_te_lnRR[ds_patches_averaged$disturbance == disturbance_input &
                                                    ds_patches_averaged$eco_metaeco_type == eco_metaeco_treatment &
                                                    ds_patches_averaged$time_point == time_point_input] = ln(treatment$Spi_te_mean / control$Spi_te_mean)
      
      ds_patches_averaged$Tet_d[ds_patches_averaged$disturbance == disturbance_input &
                                  ds_patches_averaged$eco_metaeco_type == eco_metaeco_treatment &
                                  ds_patches_averaged$time_point == time_point_input] = calculate.hedges_d(
                                    treatment$Tet_mean,
                                    treatment$Tet_sd,
                                    treatment$sample_size,
                                    control$Tet_mean,
                                    control$Tet_sd,
                                    control$sample_size
                                  )
      
      ds_patches_averaged$Tet_lnRR[ds_patches_averaged$disturbance == disturbance_input &
                                                    ds_patches_averaged$eco_metaeco_type == eco_metaeco_treatment &
                                                    ds_patches_averaged$time_point == time_point_input] = ln(treatment$Tet_mean / control$Tet_mean)
    }
  }
}
```

```{r}
saveRDS(ds_patches_averaged, file = here("results", "ds_patches_averaged.RData"))
```

```{r ds_patches_averaged-datatable}
datatable(ds_patches_averaged,
          rownames = FALSE,
          options = list(scrollX = TRUE),
          filter = list(position = 'top', 
                        clear = FALSE))
```