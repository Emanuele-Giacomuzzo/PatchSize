---
title: "PatchSizePilot"
author: "Emanuele Giacomuzzo"
date: "2022-08-03"
output: 
  html_document:
     code_folding: hide
bibliography: /Applications/Mendeley/library.bib
html_document:
    toc: true
    toc_float: true
    code_folding: hide
    number_sections: true
    includes:
      after_body: tabset-dropdown.html
editor_options: 
  chunk_output_type: console
---

```{r extract-sections, echo = FALSE, eval = FALSE}
library(here)
library(knitr)
library(purrr)
for (main_section in c("biomass", "body_size")){
  
 sections.path = here("r_files", main_section, "sections")
 extracted.path = here("r_files", main_section, "extracted_sections")
 
 r.files = list.files(sections.path)
 rmd.files = r.files[grepl(".Rmd", r.files)]
 
 
 map(rmd.files, function(file.i) {
   
   file.name = gsub(".Rmd", "", file.i)
   extracted.file = paste0(file.name, ".R")
   purl(file.path(sections.path, file.i),
        file.path(extracted.path, extracted.file))}) 
}
```

```{r set-up-environment, echo = FALSE, results = FALSE, message = FALSE}
#renv::snapshot() #Run this to save all the current packages used in this project
rm( list = ls(  ) )
cat( "\014" )

start_time = Sys.time()

library("conflicted")
library("tidyverse")
library("grid")
library("gridExtra") 
library("lme4")
library("here")
library("MuMIn")
library("equatiomatic")
library("knitr")
library("optimx")
library("GenSA")
library("purrr")
library("kableExtra")
library("DT")
library("renv")
library("broom")
library("patchwork")
library("gganimate") 
library("gapminder")
library("gifski")
library("av")
#library("transformr") #Can't call it because sf package is not installed and when I try installing sf I get the error: configure: error: libproj or sqlite3 not found in standard or given locations. I'm for now not reinstalling it. I'll need it once that I update the body size gganimate plots. 
library("gifski")
library("GGally")
library("strengejacke")
library("sjPlot")
library("sjstats")
library("partR2")
library("SciViews")
library("effsize")

conflict_prefer("load", "base")
conflict_prefer("filter", "dplyr")

knitr::opts_chunk$set(message = FALSE)

source(here("r_files", "biomass", "functions", "biomass_plots.R"))
source(here("r_files", "biomass", "functions", "update_all_models_table.R"))
source(here("r_files", "body_size", "functions", "plot_data_mean.R"))
source(here("r_files", "body_size", "functions", "plot_data_raw.R"))

gif_figures = TRUE

p = NULL #To run the plotting function

#Publication settings
publication_width = 12
publication_height = 12
publication_unit = "cm"

first_perturbation_day = 5
ecosystems_to_take_off = 60 #Culture number 60 because it was spilled (isolated large patch, high disturbance, system nr = 40)
metaecosystems_to_take_off = 40 #System 40 was the system of culture 60 that I spilled
```

# PatchSizePilot {.tabset}

## Overview

```{r child = here("r_files", "overview.Rmd")}
```

![](images/Chapter%201.png)

## Biomass {.tabset .tabset-pills}

```{r child = here("r_files", "biomass", "main_biomass.Rmd")}
```

## Body size {.tabset .tabset-pills}

```{r child = here("r_files", "body_size", "main_body_size.Rmd")}
```

## Figures

```{r, echo = FALSE, fig.align='center', fig.cap = "Regional biomass under low disturbance in meta-ecosystems of the same total area, but exhibiting two local patches of the same size (red, medium-medium meta-ecosystem) or different size (blue, small-large meta-ecosystem). Points represent the mean, error bars represent the standard deviation. See the Appendix for equivalent figure of the high disturbance treatment."}
regional_publication + labs(title = "")

ggsave(here("results", "biomass", "regional_publication.jpg"), 
       regional_publication + labs(title = ""), 
       units = publication_unit,
       width = publication_width, 
       height = publication_height)
```

```{r, echo = FALSE, fig.align = 'center', fig.cap = "Local biomass under low disturbance in patches connected to a patch of the same size (red, small patches of small-small meta-ecosystems) or to a patch of larger size (blue, small patches of small-large meta-ecosystems). The local biomass has been transformed as the natural logarithm of the reponse ratio as follows: ln(RR) = ln((bioarea + 1) / mean bioarea small isolated patches under low disturbance).", eval = FALSE}
small_patches_publication + labs(title = "")

ggsave(here("results", "biomass", "small_patches_publication.jpg"), 
       small_patches_publication + labs(title = ""), 
       units = publication_unit,
       width = publication_width, 
       height = publication_height)
```

```{r, echo = FALSE, fig.align = 'center', fig.cap = "Local biomass under low disturbance in patches connected to a patch of the same size (red, large patches of large-large meta-ecosystems) or to a patch of larger size (blue, large patches of small-large meta-ecosystems). The local biomass has been transformed as the natural logarithm of the reponse ratio as follows: ln(RR) = ln((bioarea + 1) / mean bioarea large isolated patches under low disturbance).", eval = FALSE}
large_patches_publication + labs(title = "")

ggsave(here("results", "biomass", "large_patches_publication.jpg"), 
       large_patches_publication + labs(title = ""), 
       units = publication_unit,
       width = publication_width, 
       height = publication_height)
```

## Tests

```{r child = here("r_files", "tests", "evaporation_tests.Rmd")}
```

## Running time

```{r running-time, echo = FALSE, eval = TRUE}
end_time = Sys.time()
end_time - start_time
```

## Other

### Mixed effects models

-   To build the mixed effect models we will use the R package lme4. See page 6 of [this PDF](https://cran.r-project.org/web/packages/lme4/vignettes/lmer.pdf) to know more about the syntaxis of this package and [this link](https://mspeekenbrink.github.io/sdam-r-companion/linear-mixed-effects-models.html) for the interaction syntaxis.

-   To do model diagnostics of mixed effect models, I'm going to look at the following two plots (as suggested by @Zuur2009, page 487):

    -   Quantile-quantile plots (`plot(mixed_model)`)

    -   Partial residual plots (`qqnorm(resid(mixed_model))`)

-   The effect size of the explaining variables is calculated in the mixed effect models as marginal and conditional r squared. The marginal r squared is how much variance is explained by the fixed effects. The conditional r squared is how much variance is explained by the fixed and the random effects. The marginal and conditional r squared are calculated using the package `MuMIn`. The computation is based on the methods of @Nakagawa2017. For the coding and interpretation of these r squared check the [documentation for the r.squaredGLMM function](https://rdrr.io/cran/MuMIn/man/r.squaredGLMM.html)

-   Time can be included as a fixed or random effect. Time can be included as a random effect if the different data points are non independent from each other (e.g., seasons). However, because the biomass in our experiment was following a temporal trend, the different time points show autocorrelation. In other words, t2 is more similar to t3 than t4 and so on. This is why we decided to include time as a fixed effect. For an excellent discussion on this topic see [this blog post](https://dynamicecology.wordpress.com/2015/11/04/is-it-a-fixed-or-random-effect/).

### Modeling choices

-   I am going to select the best model according to AIC. @Halsey2019 suggests this approach instead of p values. P-values are not a reliable way of choosing a model because:

    -   My sample size is small, producing larger p-values

    -   P-values are really variable, creating many false positives and negatives (e.g., if p=0.05 there is a 1 in 3 chance that it's a false positive)

-   To study the local biomass how it changes across treatments, we could have made three different models between the three combinations of small patches. However, that might be confusing to interpret the results. We decided instead to use an effect size where we control is the isolated small patch. At the beginning we thought to use the natural logarithm of the response ratio (lnRR). The problem, however, is that some bioarea values were 0. We were thinking to add 1 to all null values, but according to @Rosenberg2013, such practice inflates effect sizes. Because of this, I looked into other types of effect size. I found that the most common and preferred metric in use today is known as Hedge's d (a.k.a. Hedge's g) (@Hedges1985 ). It is calculated as the difference in mean between treatment and control divided by the standard deviation of the pooled data. Another measure would be Cohen's d, but it underperforms with sample sizes that are lower than 20 ([StatisticsHowTo)](https://www.statisticshowto.com/hedges-g/). I can easily calculate the Hedge's d using the r package `effsize`. \
    Same thing for the large patches.

## Bibliography
