---
title: "PatchSizePilot"
author: "Emanuele Giacomuzzo"
date: "2022-08-03"
output: 
  html_document:
     code_folding: hide
bibliography: /Applications/Mendeley/library.bib
html_document:
    toc: true
    toc_float: true
    code_folding: hide
    number_sections: true
    includes:
      after_body: tabset-dropdown.html
editor_options: 
  chunk_output_type: console
---

```{r set-up-environment, echo = FALSE, results = FALSE, message = FALSE}
rm( list = ls(  ) )
cat( "\014" )

start_time = Sys.time()

library("conflicted")
library("tidyverse")
library("grid")
library("gridExtra") 
library("lme4")
library("here")
library("MuMIn")
library("equatiomatic")
library("knitr")
library("optimx")
library("GenSA")
library("purrr")
library("kableExtra")
library("DT")

conflict_prefer("filter", "dplyr")

knitr::opts_chunk$set(message = FALSE)

source(here("r_files", "biomass", "functions", "biomass_plots.R"))
source(here("r_files", "biomass", "functions", "update_all_models_table.R"))
source(here("r_files", "body_size", "functions", "plot_data_mean.R"))
source(here("r_files", "body_size", "functions", "plot_data_raw.R"))


p = NULL #To run the plotting function

#Publication settings
publication_width = 12
publication_height = 12
publication_unit = "cm"
```

```{r extract-sections, echo = FALSE, eval = FALSE}
#You can just run this to run all the sections so then you can work on them. 

for (main_section in c("biomass", "body_size")){
  
 sections.path = here("r_files", main_section, "sections")
 r.files = list.files(sections.path)
 rmd.files = r.files[grepl(".Rmd", r.files)]
 extracted.path = here("r_files", main_section, "extracted_sections")
 
 purrr::map(rmd.files, function(file.i) {
   file.name = gsub(".Rmd", "", file.i)
   extracted.file <- paste0(file.name, ".R")
   knitr::purl(
     file.path(sections.path, file.i),
     file.path(extracted.path, extracted.file))}) 
  
}
```

# PatchSizePilot {.tabset}

## Biomass {.tabset .tabset-pills}

```{r child = here("r_files", "biomass", "main_biomass.Rmd")}
```

## Body size {.tabset .tabset-pills}

```{r child = here("r_files", "body_size", "main_body_size.Rmd")}
```

## Figures

```{r, echo = FALSE, fig.align='center', fig.cap = "Regional bioarea density (mean bioarea density between two patches) in meta-ecosystems of the same total area, but whose two patches have either the same size (red, medium-medium meta-ecosystem) or that have a smaller and larger patch (blue, small-large meta-ecosystem). Points represent the mean, error bars represent the standard deviation. For clarity, only the low disturbance treatment is shown here. See the Appendix for equivalent the figure of the high disturbance treatment."}
p_regional_low_mean + labs(title = "")

ggsave(here("results", "biomass", "publication_regional_low_mean.jpg"), 
       p_regional_low_mean + labs(title = ""), 
       units = publication_unit,
       width = publication_width, 
       height = publication_height)
```

```{r, echo = FALSE, fig.align = 'center', fig.cap = "Local biomass production in patches that are either connnected to a patch of the same size (green, small patches of small-small meta-ecosystemes) or to a patch of larger size (orange, small patches of small-large meta-ecosystems). Points represent the mean, error bars represent the standard deviation. For clarity, only the low disturbance treatment is shown here. See the Appendix for equivalent the figure of the high disturbance treatment. Problem: the small patches in green actually have different sample size than the one in orange. Does it still make sense to include the standard deviation?"}
local_small_low_plot + labs(title = "")

ggsave(here("results", "biomass", "publication_local_small_low_plot.jpg"), 
       local_small_low_plot + labs(title = ""), 
       units = publication_unit,
       width = publication_width, 
       height = publication_height)
```

## Tests

```{r child = here("r_files", "tests", "evaporation_tests.Rmd")}
```

## Running time

```{r running-time, echo = FALSE, eval = TRUE}
end_time = Sys.time()
end_time - start_time
```

## Other

### Mixed effects models

-   To build the mixed effect models we will use the R package lme4. See page 6 of [this PDF](https://cran.r-project.org/web/packages/lme4/vignettes/lmer.pdf) to know more about the syntaxis of this package.

-   To do model diagnostics of mixed effect models, I'm going to look at the following two plots (as suggested by @Zuur2009, page 487):

    -   Quantile-quantile plots

    -   Partial residual plots

-   The effect size of the explaining variables is calculated in the mixed effect models as marginal and conditional r squared. The marginal r squared is how much variance is explained by the fixed effects. The conditional r squared is how much variance is explained by the fixed and the random effects. The marginal and conditional r squared are calculated using the package `MuMIn`. The computation is based on the methods of @Nakagawa2017. For the coding and interpretation of these r squared check the [documentation for the r.squaredGLMM function](https://rdrr.io/cran/MuMIn/man/r.squaredGLMM.html)

-   See for the interaction syntaxis [this link.](https://mspeekenbrink.github.io/sdam-r-companion/linear-mixed-effects-models.html)

### Model selection

-   I am starting from the largest model and then simplifying because ... (see statistical modelling course at ETH).

-   I am going to select the best model according to AIC. BIC is better for understanding and AIC for predicting. @Halsey2019 also suggests this approach instead of p values. I'm going to use AIC because I'm interested in knowing how much meta-ecosystem type contributed to the overall regional biomass.

## Bibliography
