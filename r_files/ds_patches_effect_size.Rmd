---
title: "Data Patches Averaged"
output: html_document
date: "2022-11-22"
editor_options: 
  chunk_output_type: console
---

```{r}
vars_to_group_by = columns_patches[columns_patches != "culture_ID" & columns_patches != "system_nr"]

ds_patches_effect_size = calculate.effect.sizes(ds_patches,
                                                vars_to_group_by,
                                                variables_patches) %>%
  filter(time_point >= 1)

expect_equal(nrow(ds_patches_effect_size), 
             (n_treatments + n_controls) * (n_time_points - 1) * n_disturbance_levels)
```

```{r}
#Add baselines (from t1).
baselines <- ds_patches_effect_size %>%
  filter(time_point == 1) %>%
  group_by(patch_type, disturbance) %>%
  summarise(across(paste0(variables_patches, "_d"), 
                   .names = "baseline_{.col}")) %>%
  select(patch_type,
         disturbance,
         paste0("baseline_", variables_patches, "_d"))


expect_equal(nrow(baselines), 
             (n_treatments + n_controls) * n_disturbance_levels)

n_rows_ds_patches_ES_before_joining_baselines = nrow(ds_patches_effect_size)

ds_patches_effect_size = full_join(ds_patches_effect_size, baselines)

expect_equal(n_rows_ds_patches_ES_before_joining_baselines, 
               nrow(ds_patches_effect_size))
```

```{r}
save(ds_patches_effect_size, file = here("results", "ds", "ds_patches_effect_size.RData"))
```