---
title: "Data Regional Biomass"
output: html_document
date: "2022-11-22"
editor_options: 
  chunk_output_type: console
---

### Meta-ecosystem biomass (`ds_metaecosystems`)

-   Each row is a meta-ecosystem.

-   It contains also "fake" meta-ecosystems which I created from isolated patches (`metecosystem type = S_L_from_isolated`).

```{r ds_metaecosystems-create-dataset}

#Create ds_metaecosystems

ds_metaecosystems = ds_patches %>%
  filter(metaecosystem == "yes",
         !system_nr %in% metaecosystems_to_take_off) %>%
  mutate(total_patch_bioarea = bioarea_per_volume * patch_size_volume) %>%
  group_by(system_nr, 
           time_point,
           disturbance,
           metaecosystem_type,
           day) %>%
  summarise(total_metaecosystem_bioarea = sum(total_patch_bioarea))
```

```{r ds_metaecosystems-create-SL_SL_from_isolated, message=FALSE, results='hide'}

#Add Small-Large Meta-ecosystems from isolated

isolated_S_low = ds_patches %>%
  filter(eco_metaeco_type == "S",
         disturbance == "low")

isolated_L_low = ds_patches %>%
  filter(eco_metaeco_type == "L",
         disturbance == "low")

isolated_S_high = ds_patches %>%
  filter(eco_metaeco_type == "S",
         disturbance == "high")

isolated_L_high = ds_patches %>%
  filter(eco_metaeco_type == "L",
         disturbance == "high")

S_low_system_nrs = unique(isolated_S_low$system_nr)
S_high_system_nrs = unique(isolated_S_high$system_nr)
L_low_system_nrs = unique(isolated_L_low$system_nr)
L_high_system_nrs = unique(isolated_L_high$system_nr)

low_system_nrs_combination = expand.grid(S_low_system_nrs, L_low_system_nrs) %>%
  mutate(disturbance = "low")
high_system_nrs_combination = expand.grid(S_high_system_nrs, L_high_system_nrs) %>%
  mutate(disturbance = "high")
system_nr_combinations = rbind(low_system_nrs_combination, high_system_nrs_combination) %>%
  rename(S_system_nr = Var1,
         L_system_nr = Var2)

number_of_combinations = nrow(system_nr_combinations)

SL_from_isolated_all_combinations = NULL
for (pair in 1:number_of_combinations){
  
  SL_from_isolated_all_combinations[[pair]] = ds_patches %>%
    filter(system_nr %in% system_nr_combinations[pair,]) %>%
    group_by(disturbance, day, time_point) %>%
    summarise(total_metaecosystem_bioarea = sum(bioarea_tot)) %>%
    mutate(system_nr = 1000 + pair,
           metaecosystem_type = "S_L_from_isolated")
  
}

SL_from_isolated_all_combinations = SL_from_isolated_all_combinations %>%
  bind_rows()

ds_metaecosystems = rbind(ds_metaecosystems, SL_from_isolated_all_combinations)
```

```{r ds_metaecosystems-calculate-beta-diversity}

#Calculate beta diversity & gamma diversity

ds_metaecosystems = ds_metaecosystems %>%
  mutate(jaccard_index = NA,
         bray_curtis = NA,
         metaecosystem_richness = NA)

for (system_nr_input in system_nr_metaecosystems) {
  for (time_point_input in first_time_point:last_time_point) {
    
    if (system_nr_input %in% metaecosystems_to_take_off)
      next
    
    #Vectors
    
    species_vector_of_the_two_patches = ds_patches %>%
      filter(system_nr == system_nr_input,
             time_point == time_point_input) %>%
      ungroup() %>%
      select(Ble:Tet)
    
    species_vector_mean_across_patches = species_vector_of_the_two_patches %>%
      summarise(across(everything(), 
                       list(mean)))
    
    presence_absence_two_patches = ifelse(test = species_vector_of_the_two_patches > 0,
                                          yes = 1,
                                          no = 0)
    
    summed_columns = colSums(presence_absence_two_patches)
    
    presence_absence_metaecosystem = ifelse(test = summed_columns > 0,
                              yes = 1,
                              no = 0)
    
    #Beta diversity
  
    all_jaccard_indices = beta.pair(presence_absence_two_patches, 
                                     index.family = "jaccard")
    
    jaccard_index = all_jaccard_indices$beta.jac
    
    bray_curtis = vegdist(presence_absence_two_patches, method = "bray")
    
    #Gamma diversity
    
    metaecosystem_richness = sum(presence_absence_metaecosystem)
    
    gamma_shannon = diversity(species_vector_mean_across_patches, index = "shannon")
    
    #Add to dataset
    
    ds_metaecosystems$jaccard_index[ds_metaecosystems$system_nr == system_nr_input &
                                         ds_metaecosystems$time_point == time_point_input] = jaccard_index
    
    ds_metaecosystems$bray_curtis[ds_metaecosystems$system_nr == system_nr_input &
                                         ds_metaecosystems$time_point == time_point_input] = bray_curtis
    
    ds_metaecosystems$metaecosystem_richness[ds_metaecosystems$system_nr == system_nr_input &
                                          ds_metaecosystems$time_point == time_point_input] = metaecosystem_richness
    
    ds_metaecosystems$gamma_shannon[ds_metaecosystems$system_nr == system_nr_input &
                                          ds_metaecosystems$time_point == time_point_input] = gamma_shannon
    
    
  }
}
```

```{r}

#Add baselines (from t1)

baselines = ds_metaecosystems %>%
  ungroup() %>%
  filter(time_point == 1) %>%
  select(system_nr, 
         total_metaecosystem_bioarea, 
         jaccard_index,
         bray_curtis,
         metaecosystem_richness,
         gamma_shannon) %>%
  rename(baseline_bioarea = total_metaecosystem_bioarea,
         baseline_jaccard_index = jaccard_index,
         baseline_bray_curtis = bray_curtis,
         baseline_metaecosystem_richness = metaecosystem_richness,
         baseline_gamma_shannon = gamma_shannon)

ds_metaecosystems = full_join(ds_metaecosystems, baselines)
```

```{r}
saveRDS(ds_metaecosystems, file = here("results", "ds_metaecosystems.RData"))
```

```{r ds_metaecosystems-datatable}
datatable(ds_metaecosystems,
          rownames = FALSE,
          options = list(scrollX = TRUE),
          filter = list(position = 'top', 
                        clear = FALSE))
```
