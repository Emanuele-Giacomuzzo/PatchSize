---
title: "Biomass analysis (PatchSizePilot)"
author: "Emanuele Giacomuzzo"
date: '2022-07-07'
output: html_document
editor_options: 
  chunk_output_type: console
---

Here I study how **biomass density** changes across treatments in the PatchSizePilot. In particular, I'm studying how:

-   Biomass density changes across ecosystems of different size (this is the case in nature, but we need to make sure that it's the case also in our experiment)\
-   Biomass density changes across ecosystems that are connected (throug the flow of nutrients) to an ecosystem of the same size or to an ecosystem that is larger\
-   Biomass density changes across meta-ecosystems in which patch size is the same or in which one patch has most of the area (we keep the total area of the meta-ecosystem constant)

```{r set up environment, message = FALSE, echo = FALSE}

rm( list = ls(  ) )
cat( "\014" )
library("tidyverse")
library("grid")
library("gridExtra") 
library("lme4")
library("here")
library("MuMIn")

source(here("r_files", "scripts", "biomass_plots.R"))

p = NULL #To run the plotting function

```

# Import

```{r data import, message = FALSE, echo = TRUE}

culture_info = read.csv(here("data", "PatchSizePilot_culture_info.csv"), header = TRUE)
load(here("data", "population", "t0.RData")); t0 = pop_output
load(here("data", "population", "t1.RData")); t1 = pop_output
load(here("data", "population", "t2.RData")); t2 = pop_output
load(here("data", "population", "t3.RData")); t3 = pop_output
load(here("data", "population", "t4.RData")); t4 = pop_output
load(here("data", "population", "t5.RData")); t5 = pop_output
load(here("data", "population", "t6.RData")); t6 = pop_output
load(here("data", "population", "t7.RData")); t7 = pop_output
rm(pop_output)

```

# Tidy

```{r tidy up, echo = TRUE}

t0$time = NA
t1$time = NA

t0$replicate_video = 1:12 #In t1 I took 12 videos of a single 
t1$replicate_video = 1 #In t1 I took only 1 video/culture
t2$replicate_video = 1 #In t2 I took only 1 video/culture
t3$replicate_video = 1 #In t3 I took only 1 video/culture
t4$replicate_video = 1 #In t4 I took only 1 video/culture
t5$replicate_video = 1 #In t5 I took only 1 video/culture
t6$replicate_video = t6$replicate; t6$replicate = NULL
t7$replicate_video = t7$replicate; t7$replicate = NULL

#Create an elongated version of t0 so that each of the 110 cultures can have 12 video replicates at t0.
elongating_t0 = NULL
for (video in 1:nrow(t0)){
  for (ID in 1:nrow(culture_info)) {
    elongating_t0 = rbind(elongating_t0, t0[video,])
  }
}

ID_vector = rep(1:nrow(culture_info), times = nrow(t0))
elongating_t0$culture_ID = ID_vector

t0 = merge(culture_info,elongating_t0, by="culture_ID")
t1 = merge(culture_info,t1,by="culture_ID")
t2 = merge(culture_info,t2,by="culture_ID")
t3 = merge(culture_info,t3,by="culture_ID")
t4 = merge(culture_info,t4,by="culture_ID")
t5 = merge(culture_info,t5,by="culture_ID")
t6 = merge(culture_info,t6,by="culture_ID")
t7 = merge(culture_info,t7,by="culture_ID")
ds = rbind(t0, t1, t2, t3, t4, t5, t6, t7); rm(elongating_t0, t0, t1, t2, t3, t4, t5, t6, t7)

# Switch from data point to day
ds$day = ds$time_point; ds$time_point = NULL
ds$day[ds$day=="t0"] = "0"
ds$day[ds$day=="t1"] = "4"
ds$day[ds$day=="t2"] = "8"
ds$day[ds$day=="t3"] = "12"
ds$day[ds$day=="t4"] = "16"
ds$day[ds$day=="t5"] = "20"
ds$day[ds$day=="t6"] = "24"
ds$day[ds$day=="t7"] = "28"
ds$day = as.numeric(ds$day)

ds = ds %>% 
  select(culture_ID, patch_size, disturbance, metaecosystem_type, bioarea_per_volume, replicate_video, day, metaecosystem, system_nr, eco_metaeco_type)
ds = ds[, c("culture_ID", "system_nr", "disturbance", "day", "patch_size", "metaecosystem", "metaecosystem_type", "eco_metaeco_type", "replicate_video","bioarea_per_volume")]

ds$eco_metaeco_type = factor(ds$eco_metaeco_type, levels=c('S', 'S (S_S)', 'S (S_L)', 'M', 'M (M_M)', 'L', 'L (L_L)', 'L (S_L)'))

```

# Plot

## Biomass \@ low disturbance

```{r low disturbance single plots, eval = TRUE, echo = FALSE, message = FALSE}

biomass_plots("low")
p[[1]]
p[[2]]
p[[3]]
p[[4]]
p[[5]]
p[[6]]

```

Let's now save all the plots together in a single image. As the single image is too large for R markdown, it cannot be displayed here.

```{r low disturbance grid, eval = FALSE}

grid = grid.arrange(p[[1]],p[[3]],p[[5]],p[[2]],p[[4]],p[[6]],
                    ncol=3, nrow=2,
                    top = textGrob("Low disturbance",gp=gpar(fontsize=20,font=3)))
ggsave(here("results", "biomass", "Clean_biomass_low.jpg"), grid, width = 22, height = 13)

```

## Biomass \@ high disturbance

```{r high disturbance single plots, eval = TRUE, echo = FALSE, message = FALSE}

biomass_plots("high")
p[[1]]
p[[2]]
p[[3]]
p[[4]]
p[[5]]
p[[6]]

```

Let's save also here for high disturbance.

```{r high disturbance grid, eval = FALSE}

biomass_plots("high")
grid = grid.arrange(p[[1]],p[[3]],p[[5]],p[[2]],p[[4]],p[[6]],
             ncol=3, nrow=2,
             top = textGrob("High disturbance",gp=gpar(fontsize=20,font=3)))
ggsave(here("results", "biomass", "Clean_biomass_high.jpg"), grid, width = 22, height = 13)

```

# Mixed effect models

## Regional biomass

We want to understand if the regional biomass produced by an ecosystem with a small and a large patch (metaecosystem_type = S_L) is lower than the regional biomass produced by an ecosystem with two medium patches (metaecosystem_type = M_M). To model the regional biomass, let's start from the largest mixed effect model makes sense to construct. This will include:

- As fixed effect: disturbance, metaecosystem type, and the interaction betweeen disturbance and metaecosystem type. 
- As random effect: day. The metaecosystem ID will not be considered as a random effect because it already includes the fixed effects (disturbance and metaecosystem type). 

In equation form, therefore, the full mixed effect model will take the following form:

$$biomass = (β_0 * + λ1_t) +  (β_1 * λ2_t)* metaecosystem \: type +(β_2 * λ3_t)* disturbance +  (β_3*λ4_t)*metaecosystem \: type * disturbance + ε $$
After having produced the full model, we will modify the model and see if we can improve it. To build the mixed effect models we will use the R package lme4. See page 6 of [this PDF](https://cran.r-project.org/web/packages/lme4/vignettes/lmer.pdf) to know more about the syntaxis of this package. 

```{r mixed effect model, message=FALSE}

ds_regional = ds %>%
    filter (metaecosystem_type == "M_M" | metaecosystem_type == "S_L", day != 0) %>%
    group_by(culture_ID, system_nr, disturbance, day, patch_size, metaecosystem_type) %>%
    summarise(patch_mean_bioarea_across_videos = mean(bioarea_per_volume)) %>%
    group_by(system_nr, disturbance, day,metaecosystem_type) %>%
    summarise(regional_mean_bioarea = mean(patch_mean_bioarea_across_videos)) %>%
    filter()

#Uncorrelated intercepts and slopes
full_model = lmer(regional_mean_bioarea ~ metaecosystem_type  + disturbance + metaecosystem_type * disturbance + (metaecosystem_type || day) + (disturbance || day) + (metaecosystem_type*disturbance  || day), data = ds_regional, REML = FALSE)

#Correlated intercepts and slopes
full_model_correlated = lmer(regional_mean_bioarea ~ metaecosystem_type  + disturbance + metaecosystem_type * disturbance + (metaecosystem_type | day) + (disturbance | day) + (metaecosystem_type*disturbance  | day), data = ds_regional, REML = FALSE)

#No random effects
fixed_effects_model = lm(regional_mean_bioarea ~ metaecosystem_type  + disturbance, data = ds_regional)

#No interaction between metaecosystem and disturbance
no_interaction_model = lmer(regional_mean_bioarea ~ metaecosystem_type + disturbance  + (metaecosystem_type || day) + (disturbance || day), data = ds_regional, REML = FALSE)

#No interaction between metaecosystem and disturbance, no random slopes
no_interaction_no_slopes_model = lmer(regional_mean_bioarea ~ metaecosystem_type + disturbance  + (1 | day), data = ds_regional, REML = FALSE)

#No random slopes
no_slopes_model = lmer(regional_mean_bioarea ~ metaecosystem_type  + disturbance + metaecosystem_type * disturbance + (1| day),data = ds_regional, REML = FALSE)

anova(full_model, full_model_correlated, no_interaction_model, no_interaction_no_slopes_model, no_slopes_model)

```

First of all, it seems like there is no correlation between intercepts and slopes. Which is exactly what we would expect. In other words, there is no reason why we would expect that if the biomass production by the M_M meta-ecosystem is higher (higher intercept), then the difference between the production of M_M and S_L  is higher/lower (higher/lower slope). 

Second, the best model (no_interaction_no_slopes_model) seems to be the one where there is 

- no interaction between disturbance and meta-ecosystem type on regional biomass production
- no random slopes (at different days, it seems like the difference between the production of different meta-ecosystem types stays the same across time)

In equation form is as follows:

$$biomass = (β_0 + intercept_{t}) + β_1 metaecosystem \: type * β_2 disturbance + ε $$

Before accepting this model, however, we need to do some model diagnostics. To assess how well the model fits the data, I'm going to look at the following two plotso (as suggested by Zuur2009, page 487):

- Quantile-quantile plots
- Partial residual plots

```{r model diagnostics best model}

plot(no_interaction_no_slopes_model, col = 1)
qqnorm(resid(no_interaction_no_slopes_model))

```

That's our lucky day. The two plots look fabulous.

Will this model be stastically significant? Let's take a look. 

```{r}

model.null = lmer(regional_mean_bioarea ~ (1 | day), data = ds_regional, REML = FALSE)

anova = anova(no_interaction_no_slopes_model, model.null)
p = anova$`Pr(>Chisq)`[2]
p

r2 = r.squaredGLMM(no_interaction_no_slopes_model)
r2

```

This difference is significant as it has a p-value of `r p`. Great!

The marginal R squared (variance explained by the fixed effects) is `r round(r2 [1], digits = 1)` and the conditional R squared (variance explained by the entire model) is `r round(r2 [2], digits = 1)`. Fopr the coding and interpretation of these r squared check the [documentation for the r.squaredGLMM function](https://rdrr.io/cran/MuMIn/man/r.squaredGLMM.html). This is great!

Let's now take a look at what happens if we take off the metaecosystem type.

```{r coefficient of determination}

no_interaction_no_slopes_model_null = lmer(regional_mean_bioarea ~  disturbance  + (1 | day), data = ds_regional, REML = FALSE)
anova = anova(no_interaction_no_slopes_model, no_interaction_no_slopes_model_null)
p = anova$`Pr(>Chisq)`[2]

```

It's significant (p-value = `r p`), which means that including metaecosystem_effect increases the goodness of the model.

Let's make sure, however, that this null model is legit. 

```{r model diagnostics null model}

plot(no_interaction_no_slopes_model_null, col = 1)
qqnorm(resid(no_interaction_no_slopes_model_null))

```

Okay that's good. At this point we want to know the r squared for the 

```{r}

metaecosystem_type_model = lmer(regional_mean_bioarea ~  metaecosystem_type  + (1 | day), data = ds_regional, REML = FALSE)
r.squaredGLMM(metaecosystem_type_model)

disturbance_type_model = lmer(regional_mean_bioarea ~  disturbance  + (1 | day), data = ds_regional, REML = FALSE)
r.squaredGLMM(disturbance_type_model)

```

```{r fitting also a function}

a1 = 0.02
a2 = 1
a3 = 2
a4 = 5
a5 = 50
x = seq(0, 500, 0.01)
y = a4*(x-a5)^a3*exp(a1*(x-a5)^a2)

model = nls(regional_mean_bioarea ~ y, start = list(a=2000,b=5,c=200),trace = T)

```





# Bibliography

Zuur, A. F., Ieno, E. N., Walker, N. J., Saveliev, A. A., & Smith, G. M. (2009). Mixed effects models and extensions in ecology with R (Vol. 574). New York: Springer.