---
title: "fitting_Hank_function"
author: "Emanuele Giacomuzzo"
date: '2022-07-18'
output: html_document
editor_options: 
  chunk_output_type: console
---

#### Hank function

Here we want to fit how biomass changes across time to a function. The biomass of our meta-ecosystems looks like this.

```{r regional biomass plot}

ds_regional%>%
  ggplot(aes(x = day,
             y = regional_mean_bioarea,
             group = day)) + 
  geom_boxplot() +
  labs(x = "day", y = "regional bioarea")

```

To fit these data, we need to produce (and parameterise) a function that resemble how the biomass first increases and then decreases.

Hank produced the following function:

$$y = a_4 * (x-a_5)^{a_3} * e^{a_1(x-a_5)^{a_2}}$$

If we parameterise the function and then plot, it looks as follows.

```{r time function Hank}

a1 = -0.02
a2 = 1
a3 = 2
a4 = 5
a5 = -25

x = seq(0, 500, 0.01)

y = a4*(x-a5)^a3*exp(a1*(x-a5)^a2) #Latex form: y = a4*(x-a5)^{a3} * e^{a1*(x-a5)^{a2}}

plot(y ~ x)
```

##### nls

Now, let's see if this curve with these parameters fits our data. The easiest way of fitting the function is using the `nls` function from the basic r package.

```{r, eval=FALSE}

model = nls(regional_mean_bioarea ~ a4*(day-a5)^a3*exp(a1*(day-a5)^a2), 
            start = list(a1 = -0.02, a2 = 1, a3 = 2, a4 = 5, a5 = -25),
            trace = T,
            data = ds_regional)

```

However, it seems like the nls function (which fits non-linear functions to data) is not powerful enough. The error is as follows:

-   [***Error in nlsModel(formula, mf, start, wts, scaleOffset = scOff, nDcentral = nDcntr) : singular gradient matrix at initial parameter estimates)***]{.underline}

It seems also like the manual parameterisation of the starting parameters doesn't work. Also, the x axis is not a problem because if we try to transform the days so that they go from 0 to 500, we get the same error. (Both not shown here).

##### Generalised simulated annealing

Therefore, I assume that the nls function has not enough power to optimise the cost function that finds the parameters of Hank's function. Instead of using the `nls` function, I'll then use generalised simulated annealing to optimise the cost function of the root-mean-square-deviation of the observed data points. I'll be using the `GenSa` function from the [GenSA package](https://cran.r-project.org/web/packages/GenSA/GenSA.pdf) to run generalised simulated annealing.

A lovely tutorial from whose code I adapted is the following one: [Parameter estimation in R: a simple stomatal conductance model example](https://khufkens.com/2016/10/02/paramater-estimation-in-r-a-simple-stomatal-conductance-model-example/).

Let's then try to find the parameters of Hank's function using the GenSA function.

```{r adapted from Hufkens}

ds_regional = ds_regional %>%
  filter(day >0)

par = c(951.82665,-41.45987,-2.43646,960.10914,26.77695)

biomass_model = function(par = par, ds_regional = ds_regional) {

 regional_mean_bioarea = ds_regional$regional_mean_bioarea
 day = ds_regional$day
 a1 = par[1]
 a2 = par[2]
 a3 = par[3]
 a4 = par[4]
 a5 = par[5]

 biomass = a4 * (day-a5)^a3 * exp(a1*(day-a5)^a2)

 return(biomass)
 
}

cost.function <- function(ds_regional, par) {

   obs = as.vector(ds_regional$regional_mean_bioarea)
   pred = as.vector(biomass_model(par = par, ds_regional = ds_regional))
   s = (obs - pred)^2
   RMSE = sqrt(mean(s, na.rm = TRUE))
   
   return(RMSE)

   }


# limits to the parameter space
lower <- c(-1000,-1000,-1000,-1000,-1000)
upper <- c(1000,1000,1000,1000,1000)

# optimize the model parameters
optim.par = GenSA(
  
  par = par,
  fn = cost.function,
  ds_regional = ds_regional,
  lower = lower,
  upper = upper,
  control = list(temperature = 5000)

  )

par = optim.par$par

a1 = par[1]
a2 = par[2]
a3 = par[3]
a4 = par[4]
a5 = par[5]

x = seq(0, 550, 0.01)
y = a4*(x-a5)^a3*exp(a1*(x-a5)^a2) #Latex form: y = a4*(x-a5)^{a3} * e^{a1*(x-a5)^{a2}}
plot(y ~ x)
```

It doesn't seem to work. GenSA might not find the right parameters because:

-   There are too many parameters

-   We need to give it better initial parameters

-   We need to give it better upper and lower limits

-   We need to fit a single meta--ecosystem

**Fit a single meta-ecosystem**

```{r adapted from Hufkens single ecosystem}

ds_regional_24 = ds_regional %>%
  filter(system_nr == 24) 

ds_regional_24%>%
  ggplot(aes(x = day,
             y = regional_mean_bioarea,
             group = day)) + 
  geom_boxplot()

par = c(-0.07,1.01,2,5,-20)

biomass_model = function(par = par, ds_regional_24 = ds_regional_24) {

 regional_mean_bioarea = ds_regional_24$regional_mean_bioarea
 day = ds_regional_24$day
 a1 = par[1]
 a2 = par[2]
 a3 = par[3]
 a4 = par[4]
 a5 = par[5]

 biomass = a4 * (x-a5)^a3 * exp(a1*(x-a5)^a2)

 return(biomass)
 
}

cost.function <- function(ds_regional_24, par) {

   obs = as.vector(ds_regional_24$regional_mean_bioarea)
   pred = as.vector(biomass_model(par = par, ds_regional_24 = ds_regional_24))
   s = (obs - pred)^2
   RMSE = sqrt(mean(s, na.rm = TRUE))
   
   return(RMSE)

   }


# limits to the parameter space
lower <- c(-10,-10,-10,-10,-10)
upper <- c(100,100,100,100,100)

# optimize the model parameters
optim.par = GenSA(
  
  par = par,
  fn = cost.function,
  ds_regional_24 = ds_regional_24,
  lower = lower,
  upper = upper,
  control = list(temperature = 4000)

  )

par = optim.par$par

a1 = par[1]
a2 = par[2]
a3 = par[3]
a4 = par[4]
a5 = par[5]

x = seq(0, 30, 0.01)
y = a4*(x-a5)^a3*exp(a1*(x-a5)^a2) #Latex form: y = a4*(x-a5)^{a3} * e^{a1*(x-a5)^{a2}}
plot(y ~ x)
```

**New function (by Tianna)**

```{r Tianna 2}

a= 35
b = 10
x = seq(0, 50, 0.1)
 
y = a*x^2*exp(-(x/b)^2)
plot(y ~ x)

model = nls(regional_mean_bioarea ~ a*day^2*exp(-(day/b)^2), 
            start = list(a = 35, b = 10),
            trace = T,
            data = ds_regional) #Doesn't work

par = c(35,10)

biomass_model = function(par = par, ds_regional = ds_regional) {

 regional_mean_bioarea = ds_regional$regional_mean_bioarea
 day = ds_regional$day
 a = par[1]
 b = par[2]
 
 biomass = a*day^2*exp(-(day/b)^2)

 return(biomass)
 
}

cost.function <- function(ds_regional, par) {

   obs = as.vector(ds_regional$regional_mean_bioarea)
   pred = as.vector(biomass_model(par = par, ds_regional = ds_regional))
   s = (obs - pred)^2
   RMSE = sqrt(mean(s, na.rm = TRUE))
   
   return(RMSE)

   }


# limits to the parameter space
lower <- c(-100,-100)
upper <- c(100,100)

# optimize the model parameters
optim.par = GenSA(
  
  par = par,
  fn = cost.function,
  ds_regional = ds_regional,
  lower = lower,
  upper = upper,
  control = list(temperature = 4000)

  )

par = optim.par$par

a = par[1]
b = par[2]

x = seq(0, 35, 0.01)
y = a*x^2*exp(-(x/b)^2)
plot(y ~ x)


```

Quadratic equation is good! But it's still not similar to the biomass dynamics.

Maybe the problem is the nls and the GenSA functions. I should look into them.

Possible other functions to fit (by Alice):

-   Kernel density estimation
-   Weibull distribution
