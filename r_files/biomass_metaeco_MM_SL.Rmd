---
title: "MM_SL_plots"
author: "Emanuele Giacomuzzo"
date: "2022-08-04"
output: html_document
editor_options: 
  chunk_output_type: console
---

### Medium-Medium vs Small-Large {.tabset .tabset-pills}

#### Plots

```{r}
ds_metaecosystems %>%
      filter (disturbance == disturbance_input,
              metaecosystem_type %in% c("S_L", "M_M")) %>%
      ggplot (
        aes(
          x = day,
          y = total_metaecosystem_bioarea,
          group = system_nr,
          fill = system_nr,
          color = system_nr,
          linetype = metaecosystem_type
        )
      ) +
      geom_line () +
      labs(
        x = "Day",
        y = "Meta-ecosystem Total Bioarea (µm²)",
        fill = "System nr",
        color = "System nr",
        linetype = ""
      ) +
      scale_linetype_discrete(labels = c("Medium-Medium",
                                         "Small-Large")) +
      theme_bw() +
      theme(
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        legend.position = "bottom"
      ) +
      scale_x_continuous(breaks = unique(ds_metaecosystems$day)) +
      geom_vline(
        xintercept = resource_flow_days[1] + 0.7,
        linetype = "dotdash",
        color = "grey",
        size = 0.7
      ) +
      geom_vline(
        xintercept = resource_flow_days[2] + 0.7,
        linetype = "dotdash",
        color = "grey",
        size = 0.7
      ) +
      geom_vline(
        xintercept = resource_flow_days[3] + 0.7,
        linetype = "dotdash",
        color = "grey",
        size = 0.7
      ) +
      geom_vline(
        xintercept = resource_flow_days[4] + 0.7,
        linetype = "dotdash",
        color = "grey",
        size = 0.7
      ) +
      geom_vline(
        xintercept = resource_flow_days[5] + 0.7,
        linetype = "dotdash",
        color = "grey",
        size = 0.7
      ) +
      geom_vline(
        xintercept = resource_flow_days[6] + 0.7,
        linetype = "dotdash",
        color = "grey",
        size = 0.7
      ) +
      labs(caption = "Vertical grey line: resource flow")
```

```{r}
ds_metaecosystems %>%
      filter(disturbance == disturbance_input,
             metaecosystem_type %in% c("S_L", "M_M")) %>%
      ggplot (
        aes(
          x = day,
          y = total_metaecosystem_bioarea,
          group = interaction(day, metaecosystem_type),
          fill = metaecosystem_type
        )
      ) +
      geom_boxplot() +
      labs(
        x = "Day",
        y = "Meta-ecosystem Total Bioarea (µm²)",
        color = '',
        fill = ''
      ) +
      scale_fill_manual(
        values = c(colour_MM, colour_SL),
        labels = c("Medium-Medium",
                   "Small-Large")
      ) +
      theme_bw() +
      theme(
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        legend.position = "bottom"
      )  +
      scale_x_continuous(breaks = unique(ds_metaecosystems$day)) +
      geom_vline(
        xintercept = resource_flow_days[1] + 0.7,
        linetype = "dotdash",
        color = "grey",
        size = 0.7
      ) +
      geom_vline(
        xintercept = resource_flow_days[2] + 0.7,
        linetype = "dotdash",
        color = "grey",
        size = 0.7
      ) +
      geom_vline(
        xintercept = resource_flow_days[3] + 0.7,
        linetype = "dotdash",
        color = "grey",
        size = 0.7
      ) +
      geom_vline(
        xintercept = resource_flow_days[4] + 0.7,
        linetype = "dotdash",
        color = "grey",
        size = 0.7
      ) +
      geom_vline(
        xintercept = resource_flow_days[5] + 0.7,
        linetype = "dotdash",
        color = "grey",
        size = 0.7
      ) +
      geom_vline(
        xintercept = resource_flow_days[6] + 0.7,
        linetype = "dotdash",
        color = "grey",
        size = 0.7
      ) +
      labs(caption = "Vertical grey line: resource flow")
```

#### Model Time Series {.tabset .tabset-pills}

Let's test our hypothesis that Small-Large and Medium-Medium meta-ecosystems have a different total bioarea. To do so, we will use a mixed effect model. We will exclude time point 0 because there all the cultures were the same (we did not measure each culture at day 0, but we measured the large bottle from which we created all cultures). We excluded the data points of time point = 1 because disturbance and ecosystem type couldn't have had an effect, but we included them as baselines. We are now including both baselines and their interaction with time, as baselines should have less of an effect as time goes by.

The model we are going to test is then:

$$
Metaecosystem \: Total \: Bioarea = t + M + D + tM + tD + MD + B + t*B + (t | system \: nr)
$$

t Day M Meta-ecosystem type D Disturbance B Baseline system nr Meta-ecosystem nr

```{r}
filtered_data = ds_metaecosystems %>%
    filter(metaecosystem_type %in% c("M_M", "S_L"),
           disturbance == disturbance_input,
           time_point >= first_time_point_model,
           time_point <= last_time_point_model)
```

```{r}
full_model = lmer(
  total_metaecosystem_bioarea ~
    day +
    metaecosystem_type +
    metaecosystem_type : day +
    (day | system_nr),
  data = filtered_data,
  REML = FALSE,
  control = lmerControl(optimizer = "Nelder_Mead")
)

null_model = lmer(
  total_metaecosystem_bioarea ~
    day +
    (day | system_nr),
  data = filtered_data,
  REML = FALSE,
  control = lmerControl(optimizer = "Nelder_Mead")
)

anova(full_model, null_model)
```

Let's do some model diagnostics:

```{r}
plot(full_model)
qqnorm(resid(full_model))
```

The R squared of this model are:

```{r warning=FALSE}
R2_marginal = r.squaredGLMM(full_model)[1]
R2_marginal = round(R2_marginal, digits = 2)
R2_conditional = r.squaredGLMM(full_model)[2]
R2_conditional = round(R2_conditional, digits = 2)
```

-   Marginal R2 = `r R2_marginal`

-   Conditional R2 = `r R2_conditional`

The R2 of meta-ecosystem type couldn't be calculated because the package `partR2` (@Stoffel2021) can't compute it when we have random slopes.

#### Model Time Points {.tabset}

Let's now look at the full model and see if we should keep the interaction between meta-ecosystem type and disturbance. We are not using mixed effects because a certain system nr can't be at different perturbations or at different meta-ecosystem types.

$$
Total \: Regional \: Bioarea = M + D + MD
$$

##### Time point 1

Let's start by looking at whether meta-ecosystem type and disturbance had an effect at time point = 1. At this time point, no disturbance event had yet occurred. Therefore, we would not expect an effect of disturbance. In regards to meta-ecosystem type, there might be an effect if it comes from just the sizes of the two ecosystems.

```{r}
chosen_time_point = 1

filtered_data = ds_metaecosystems %>%
                            filter(disturbance == disturbance_input,
                                   metaecosystem_type %in% c("M_M", "S_L"),
                                   time_point == chosen_time_point)
```

```{r}
filtered_data %>%
      ggplot (aes(x = metaecosystem_type,
                  y = total_metaecosystem_bioarea)) +
      geom_boxplot() +
      labs(
        title = paste0(
          "Time point = ",
          chosen_time_point
        ),
        x = "",
        y = "Meta-ecosystem Total Bioarea (µm²)",
        color = '',
        fill = ''
      ) +
      scale_fill_manual(
        values = c(colour_MM, colour_SL),
        labels = c("Medium-Medium",
                   "Small-Large")
      ) +
      theme_bw() +
      theme(
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank()
      )
```

```{r}
full_model = lm(total_metaecosystem_bioarea ~
            metaecosystem_type,
          data = filtered_data)

null_model = lm(total_metaecosystem_bioarea ~
            1,
          data = filtered_data)

AIC(full_model, null_model)
```

I'm not using the baseline in the model because the baseline is computed on this exact time point.

##### Time point 2

Here there should be an effect of meta-ecosystem type.

```{r}
chosen_time_point = 2

filtered_data = ds_metaecosystems %>%
                            filter(disturbance == disturbance_input,
                                   metaecosystem_type %in% c("M_M", "S_L"),
                                   time_point == chosen_time_point)
```

```{r}
filtered_data %>%
      ggplot (aes(x = metaecosystem_type,
                  y = total_metaecosystem_bioarea)) +
      geom_boxplot() +
      labs(
        title = paste0(
          "Time point = ",
          chosen_time_point
        ),
        x = "",
        y = "Meta-ecosystem Total Bioarea (µm²)",
        color = '',
        fill = ''
      ) +
      scale_fill_manual(
        values = c(colour_MM, colour_SL),
        labels = c("Medium-Medium",
                   "Small-Large")
      ) +
      theme_bw() +
      theme(
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank()
      )
```

```{r}
full_model = lm(total_metaecosystem_bioarea ~
            metaecosystem_type +
            baseline_bioarea,
          data = filtered_data)

null_model = lm(total_metaecosystem_bioarea ~
            baseline_bioarea,
          data = filtered_data)

anova(full_model, null_model)
AIC(full_model, null_model)
```

```{r}
par(mfrow=c(2,3))
plot(full_model, which = 1:5)

R2_full = glance(full_model)$r.squared
R2_null = glance(null_model)$r.squared
R2_M = R2_full - R2_null

R2_full = round(R2_full, digits = 2)
R2_M = round(R2_M, digits = 2)
```

The adjusted R squared of the model is `r R2_full` and the adjusted R squared of patch type is `r R2_M`.

##### Time point 3

Here there should be an effect of meta-ecosystem type.

```{r}
chosen_time_point = 3

filtered_data = ds_metaecosystems %>%
                            filter(disturbance == disturbance_input,
                                   metaecosystem_type %in% c("M_M", "S_L"),
                                   time_point == chosen_time_point)
```

```{r}
filtered_data %>%
      ggplot (aes(x = metaecosystem_type,
                  y = total_metaecosystem_bioarea)) +
      geom_boxplot() +
      labs(
        title = paste0(
          "Time point = ",
          chosen_time_point
        ),
        x = "",
        y = "Meta-ecosystem Total Bioarea (µm²)",
        color = '',
        fill = ''
      ) +
      scale_fill_manual(
        values = c(colour_MM, colour_SL),
        labels = c("Medium-Medium",
                   "Small-Large")
      ) +
      theme_bw() +
      theme(
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank()
      )
```

```{r}

#With baseline

full_model = lm(total_metaecosystem_bioarea ~
            metaecosystem_type +
            baseline_bioarea,
          data = filtered_data)

null_model = lm(total_metaecosystem_bioarea ~
            baseline_bioarea,
          data = filtered_data)

anova(full_model, null_model)
AIC(full_model, null_model) 

par(mfrow=c(2,3))
plot(full_model, which = 1:5)

R2_full = glance(full_model)$r.squared
R2_null = glance(null_model)$r.squared
R2_M = R2_full - R2_null

R2_full = round(R2_full, digits = 2)
R2_M = round(R2_M, digits = 2)
```

```{r}

#Without baseline

full_model = lm(total_metaecosystem_bioarea ~
            metaecosystem_type,
          data = filtered_data)

null_model = lm(total_metaecosystem_bioarea ~
                  1,
          data = filtered_data)

anova(full_model, null_model)
AIC(full_model, null_model) 

par(mfrow=c(2,3))
plot(full_model, which = 1:5)

R2_full = glance(full_model)$r.squared
R2_null = glance(null_model)$r.squared
R2_M = R2_full - R2_null

R2_full = round(R2_full, digits = 2)
R2_M = round(R2_M, digits = 2)
```

The adjusted R squared of the model is `r R2_full` and the adjusted R squared of patch type is `r R2_M`.

##### Time point 4

Here there should be an effect of meta-ecosystem type.

```{r}
chosen_time_point = 4

filtered_data = ds_metaecosystems %>%
                            filter(disturbance == disturbance_input,
                                   metaecosystem_type %in% c("M_M", "S_L"),
                                   time_point == chosen_time_point)
```

```{r}
filtered_data %>%
      ggplot (aes(x = metaecosystem_type,
                  y = total_metaecosystem_bioarea)) +
      geom_boxplot() +
      labs(
        title = paste0(
          "Time point = ",
          chosen_time_point
        ),
        x = "",
        y = "Meta-ecosystem Total Bioarea (µm²)",
        color = '',
        fill = ''
      ) +
      scale_fill_manual(
        values = c(colour_MM, colour_SL),
        labels = c("Medium-Medium",
                   "Small-Large")
      ) +
      theme_bw() +
      theme(
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank()
      )
```

```{r}

#With baseline

full_model = lm(
  total_metaecosystem_bioarea ~
    metaecosystem_type +
    baseline_bioarea,
  data = filtered_data
  )

null_model = lm(total_metaecosystem_bioarea ~
                  baseline_bioarea,
                data = filtered_data)

anova(full_model, null_model)
AIC(full_model, null_model)

par(mfrow=c(2,3))
plot(full_model, which = 1:5)
```

```{r}

#Without baseline

full_model = lm(
  total_metaecosystem_bioarea ~
    metaecosystem_type,
  data = filtered_data
  )

null_model = lm(total_metaecosystem_bioarea ~
                  1,
                data = filtered_data)

anova(full_model, null_model)
AIC(full_model, null_model)

par(mfrow=c(2,3))
plot(full_model, which = 1:5)
```

##### Time point 5

Here there should be an effect of meta-ecosystem type.

```{r}
chosen_time_point = 5

filtered_data = ds_metaecosystems %>%
                            filter(disturbance == disturbance_input,
                                   metaecosystem_type %in% c("M_M", "S_L"),
                                   time_point == chosen_time_point)
```

```{r}
filtered_data %>%
      ggplot (aes(x = metaecosystem_type,
                  y = total_metaecosystem_bioarea)) +
      geom_boxplot() +
      labs(
        title = paste0(
          "Time point = ",
          chosen_time_point
        ),
        x = "",
        y = "Meta-ecosystem Total Bioarea (µm²)",
        color = '',
        fill = ''
      ) +
      scale_fill_manual(
        values = c(colour_MM, colour_SL),
        labels = c("Medium-Medium",
                   "Small-Large")
      ) +
      theme_bw() +
      theme(
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank()
      )
```

```{r}

#With baseline

full_model = lm(total_metaecosystem_bioarea ~
            metaecosystem_type +
            baseline_bioarea,
          data = filtered_data)

null_model = lm(total_metaecosystem_bioarea ~
            baseline_bioarea,
          data = filtered_data)

AIC(full_model, null_model)

par(mfrow=c(2,3))
plot(full_model, which = 1:5)
```

```{r}

#Without baseline

full_model = lm(total_metaecosystem_bioarea ~
            metaecosystem_type,
          data = filtered_data)

null_model = lm(total_metaecosystem_bioarea ~
            1,
          data = filtered_data)

AIC(full_model, null_model)

par(mfrow=c(2,3))
plot(full_model, which = 1:5)
```

##### Time point 6

Here there should be an effect of meta-ecosystem type.

```{r}
chosen_time_point = 6

filtered_data = ds_metaecosystems %>%
                            filter(disturbance == disturbance_input,
                                   metaecosystem_type %in% c("M_M", "S_L"),
                                   time_point == chosen_time_point)
```

```{r}
filtered_data %>%
      ggplot (aes(x = metaecosystem_type,
                  y = total_metaecosystem_bioarea)) +
      geom_boxplot() +
      labs(
        title = paste0(
          "Time point = ",
          chosen_time_point
        ),
        x = "",
        y = "Meta-ecosystem Total Bioarea (µm²)",
        color = '',
        fill = ''
      ) +
      scale_fill_manual(
        values = c(colour_MM, colour_SL),
        labels = c("Medium-Medium",
                   "Small-Large")
      ) +
      theme_bw() +
      theme(
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank()
      )
```

```{r}

#With baseline

full_model = lm(total_metaecosystem_bioarea ~
            metaecosystem_type +
            baseline_bioarea,
          data = filtered_data)

null_model = lm(total_metaecosystem_bioarea ~
            baseline_bioarea,
          data = filtered_data)

AIC(full_model, null_model)

par(mfrow=c(2,3))
plot(full_model, which = 1:5)
```

```{r}

#Without baseline

full_model = lm(total_metaecosystem_bioarea ~
            metaecosystem_type,
          data = filtered_data)

null_model = lm(total_metaecosystem_bioarea ~
            1,
          data = filtered_data)

AIC(full_model, null_model)

par(mfrow=c(2,3))
plot(full_model, which = 1:5)
```

##### Time point 7

Here there should be an effect of meta-ecosystem type.

```{r}
chosen_time_point = 7

filtered_data = ds_metaecosystems %>%
                            filter(disturbance == disturbance_input,
                                   metaecosystem_type %in% c("M_M", "S_L"),
                                   time_point == chosen_time_point)
```

```{r}
filtered_data %>%
      ggplot (aes(x = metaecosystem_type,
                  y = total_metaecosystem_bioarea)) +
      geom_boxplot() +
      labs(
        title = paste0(
          "Time point = ",
          chosen_time_point
        ),
        x = "",
        y = "Meta-ecosystem Total Bioarea (µm²)",
        color = '',
        fill = ''
      ) +
      scale_fill_manual(
        values = c(colour_MM, colour_SL),
        labels = c("Medium-Medium",
                   "Small-Large")
      ) +
      theme_bw() +
      theme(
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank()
      )
```

```{r}

#With baseline

full_model = lm(total_metaecosystem_bioarea ~
            metaecosystem_type +
            baseline_bioarea,
          data = filtered_data)

null_model = lm(total_metaecosystem_bioarea ~
            baseline_bioarea,
          data = filtered_data)

AIC(full_model, null_model)

par(mfrow=c(2,3))
plot(full_model, which = 1:5)
```

```{r}

#Without baseline

full_model = lm(total_metaecosystem_bioarea ~
            metaecosystem_type,
          data = filtered_data)

null_model = lm(total_metaecosystem_bioarea ~
            1,
          data = filtered_data)

AIC(full_model, null_model)

par(mfrow=c(2,3))
plot(full_model, which = 1:5)
```
