---
title: "small_large_from_isolated"
author: "Emanuele Giacomuzzo"
date: "2022-08-06"
output: html_document
editor_options: 
  chunk_output_type: console
---

### Biomass

Do a meta-ecosystem with patches of the same size and a meta-ecosystems with patches of different size have different metaecosystem biomass density because of their resource flow? Or would we see this also with small and large ecosystems that are not connected? *(Do the small-large meta-ecosystems have different biomass density from two isolated small and large patches?)*

##### Plots

```{r S_L_from_isolated-single-systems-plots, message=FALSE}
ds_metaecosystems %>%
      filter (disturbance == disturbance_input,
              metaecosystem_type %in% c("S_L", "S_L_from_isolated")) %>%
      ggplot (
        aes(
          x = day,
          y = total_metaecosystem_bioarea,
          group = system_nr,
          fill = system_nr,
          color = system_nr,
          linetype = metaecosystem_type
        )
      ) +
      geom_line () +
      labs(
        x = "Day",
        y = "Meta-ecosystem Total Bioarea (µm²)",
        fill = "System nr",
        color = "System nr",
        linetype = ""
      ) +
       scale_linetype_discrete(labels = c("Small-Large",
                                          "Small-Large from isolated")) +
      theme_bw() +
      theme(
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        legend.position = "bottom"
      ) +
      scale_x_continuous(breaks = unique(ds_metaecosystems$day)) +
      geom_vline(
        xintercept = resource_flow_days[1] + 0.7,
        linetype = "dotdash",
        color = "grey",
        size = 0.7
      ) +
      geom_vline(
        xintercept = resource_flow_days[2] + 0.7,
        linetype = "dotdash",
        color = "grey",
        size = 0.7
      ) +
      geom_vline(
        xintercept = resource_flow_days[3] + 0.7,
        linetype = "dotdash",
        color = "grey",
        size = 0.7
      ) +
      geom_vline(
        xintercept = resource_flow_days[4] + 0.7,
        linetype = "dotdash",
        color = "grey",
        size = 0.7
      ) +
      geom_vline(
        xintercept = resource_flow_days[5] + 0.7,
        linetype = "dotdash",
        color = "grey",
        size = 0.7
      ) +
      geom_vline(
        xintercept = resource_flow_days[6] + 0.7,
        linetype = "dotdash",
        color = "grey",
        size = 0.7
      ) +
      labs(caption = "Vertical grey line: resource flow")
```

```{r S_L_from_isolated-single-boxplots}
ds_metaecosystems %>%
  filter(
    disturbance == disturbance_input,
    metaecosystem_type %in% c("S_L", "S_L_from_isolated")
  ) %>%
  ggplot(
    aes(
      x = day,
      y = total_metaecosystem_bioarea,
      group = interaction(day, metaecosystem_type),
      fill = metaecosystem_type
    )
  ) +
  geom_boxplot() +
  labs(title = "Disturbance = low",
       x = "Day",
       y = "Regional bioarea (µm²)",
       fill = "",
       caption = "Vertical grey line: first perturbation") +
  scale_fill_discrete(labels = c("Small-Large", "Small-Large from isolated")) +
  theme_bw() +
  theme(
    panel.grid.major = element_blank(),
    panel.grid.minor = element_blank(),
    legend.position = "bottom"
  ) +
  geom_vline(
    xintercept = first_perturbation_day + 0.7,
    linetype = "dotdash",
    color = "grey",
    size = 0.7
  )
```

```{r}

##Bootstrap from all combinations the p value and delta AIC

system_nr_SL_from_isolated = ds_metaecosystems %>%
  filter(disturbance == disturbance_input,
         metaecosystem_type == "S_L_from_isolated") %>%
  pull(system_nr) %>%
  unique()

n_of_SL_metaecos = ds_metaecosystems %>%
  filter(disturbance == disturbance_input,
         metaecosystem_type == "S_L") %>%
  pull(system_nr) %>%
  unique() %>%
  length()

possible_combinations = combn(x = system_nr_SL_from_isolated,
                              m = n_of_SL_metaecos)

n_combinations = ncol(possible_combinations)

n_iterations = 200

statistics = NULL
for (combination_nr in 1:n_iterations){

  combination = possible_combinations[, combination_nr]
  
  filtered_ds = ds_metaecosystems %>%
    filter(metaecosystem_type == "SL" | system_nr %in% combination)
  
  full_model = lmer(
    total_metaecosystem_bioarea ~
      day +
      metaecosystem_type +
      day:metaecosystem_type +
      (day | system_nr),
    data = filtered_ds,
    REML = FALSE,
    control = lmerControl(optimizer = 'optimx', 
                          optCtrl = list(method = 'L-BFGS-B'))
  )
  
  null_model = lmer(
    total_metaecosystem_bioarea ~
      day +
      (day | system_nr),
    data = filtered_ds,
    REML = FALSE,
    control = lmerControl(optimizer = 'optimx', 
                          optCtrl = list(method = 'L-BFGS-B'))
  )
  
  anova = anova(full_model, null_model)
  
  p_value = anova$`Pr(>Chisq)`[2]
  
  AIC_full_model = tidy(anova) %>%
    filter(term == "full_model") %>%
    pull(AIC)
  
  AIC_null_model = tidy(anova) %>%
    filter(term == "null_model") %>%
    pull(AIC)
  
  delta_AIC = AIC_full_model - AIC_null_model
  
  statistics[[combination_nr]] = data.frame(p_value = p_value,
                                            delta_AIC = delta_AIC)
  
}

statistics = statistics %>%
  bind_rows()

confidence_interval = 95

percentage_iterations_to_take_off = 100 - confidence_interval
ratio_iterations_to_take_off = percentage_iterations_to_take_off / 100
n_iterations_to_take_off = n_iterations * ratio_iterations_to_take_off

upper_bound = n_iterations - (n_iterations_to_take_off / 2)
lower_bound = (n_iterations_to_take_off / 2)

p_values = statistics$p_value %>%
  sort(decreasing = TRUE)
p_values_for_CI = p_values[lower_bound:upper_bound]



```