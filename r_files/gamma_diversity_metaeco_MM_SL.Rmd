---
title: "gamma_shannon"
author: "Emanuele Giacomuzzo"
date: "2022-10-18"
output: html_document
editor_options: 
  chunk_output_type: console
---

#### Differently sized patches

```{r}
for (disturbance_input in c("low", "high")) {
  print(
    ds_regional_biomass %>%
      filter (disturbance == disturbance_input) %>%
      filter (metaecosystem_type == "S_L" |
                metaecosystem_type == "M_M") %>%
      
      ggplot (
        aes(
          x = day,
          y = gamma_shannon,
          group = system_nr,
          fill = system_nr,
          color = system_nr,
          linetype = metaecosystem_type
        )
      ) +
      geom_line () +
      labs(
        title = paste("Disturbance =", disturbance_input),
        x = "Day",
        y = "Gamma Diversity (Shannon)",
        fill = "System nr",
        color = "System nr",
        linetype = ""
      ) +
      scale_linetype_discrete(labels = c("Medium-Medium",
                                         "Small-Large")) +
      theme_bw() +
      theme(
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        legend.position = "bottom"
      ) +
      scale_x_continuous(breaks = unique(ds_regional_biomass$day)) +
      geom_vline(
        xintercept = perturbation_days[1] + 0.7,
        linetype = "dotdash",
        color = "grey",
        size = 0.7
      ) +
      geom_vline(
        xintercept = perturbation_days[2] + 0.7,
        linetype = "dotdash",
        color = "grey",
        size = 0.7
      ) +
      geom_vline(
        xintercept = perturbation_days[3] + 0.7,
        linetype = "dotdash",
        color = "grey",
        size = 0.7
      ) +
      geom_vline(
        xintercept = perturbation_days[4] + 0.7,
        linetype = "dotdash",
        color = "grey",
        size = 0.7
      ) +
      geom_vline(
        xintercept = perturbation_days[5] + 0.7,
        linetype = "dotdash",
        color = "grey",
        size = 0.7
      ) +
      geom_vline(
        xintercept = perturbation_days[6] + 0.7,
        linetype = "dotdash",
        color = "grey",
        size = 0.7
      ) +
      labs(caption = "Vertical grey line: resource flow")
  )
}
```

```{r}
for (disturbance_input in c("low", "high")) {
  print(
    ds_regional_biomass %>%
      filter(disturbance == disturbance_input) %>%
      filter (metaecosystem_type == "S_L" |
                metaecosystem_type == "M_M") %>%
      ggplot (
        aes(
          x = day,
          y = gamma_shannon,
          group = interaction(day, metaecosystem_type),
          fill = metaecosystem_type
        )
      ) +
      geom_boxplot() +
      labs(
        title = paste("Disturbance =", disturbance_input),
        x = "Day",
        y = "Gamma diversity (Shannon Index)",
        color = '',
        fill = ''
      ) +
      scale_fill_manual(
        values = c(colour_MM, colour_SL),
        labels = c("Medium-Medium",
                   "Small-Large")
      ) +
      theme_bw() +
      theme(
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        legend.position = "bottom"
      )  +
      scale_x_continuous(breaks = unique(ds_regional_biomass$day)) +
      geom_vline(
        xintercept = perturbation_days[1] + 0.7,
        linetype = "dotdash",
        color = "grey",
        size = 0.7
      ) +
      geom_vline(
        xintercept = perturbation_days[2] + 0.7,
        linetype = "dotdash",
        color = "grey",
        size = 0.7
      ) +
      geom_vline(
        xintercept = perturbation_days[3] + 0.7,
        linetype = "dotdash",
        color = "grey",
        size = 0.7
      ) +
      geom_vline(
        xintercept = perturbation_days[4] + 0.7,
        linetype = "dotdash",
        color = "grey",
        size = 0.7
      ) +
      geom_vline(
        xintercept = perturbation_days[5] + 0.7,
        linetype = "dotdash",
        color = "grey",
        size = 0.7
      ) +
      geom_vline(
        xintercept = perturbation_days[6] + 0.7,
        linetype = "dotdash",
        color = "grey",
        size = 0.7
      ) +
      labs(caption = "Vertical grey line: resource flow")
  )
}
```

##### Model Time Series

Let's test our hypothesis that Small-Large and Medium-Medium meta-ecosystems have a different gamma diversity. To do so, we will use a mixed effect model. We will exclude time point 0 because there all the cultures were the same (we did not measure each culture at day 0, but we measured the large bottle from which we created all cultures). We excluded the data points of time point = 1 because disturbance and ecosystem type couldn't have had an effect, but we included them as baselines. We are now including both baselines and their interaction with time, as baselines should have less of an effect as time goes by.

The model we are going to test is then:

$$
Metaecosystem \: Gamma \: Diversity = t + M + D + tM + tD + MD + B + t*B + (t | system \: nr)
$$

t Day 
M Meta-ecosystem type 
D Disturbance 
B Baseline 
system nr Meta-ecosystem nr

```{r}
data = ds_regional_biomass %>%
    filter(time_point >= 2) %>%
    filter(metaecosystem_type == "M_M" |
             metaecosystem_type == "S_L")
```

```{r}

full_model = lmer(
  gamma_shannon ~
    day +
    metaecosystem_type +
    disturbance +
    baseline_gamma_shannon + 
    day * metaecosystem_type +
    day * disturbance +
    day * baseline_gamma_shannon +
    metaecosystem_type * disturbance + 
    (day | system_nr),
  data = data,
  REML = FALSE,
  control = lmerControl(optimizer = "Nelder_Mead")
)

null_model = lmer(
  gamma_shannon ~
    day +
    disturbance +
    baseline_gamma_shannon + 
    day * disturbance +
    day * baseline_gamma_shannon +
    (day | system_nr),
  data = data,
  REML = FALSE,
  control = lmerControl(optimizer = "Nelder_Mead")
)

anova(full_model, null_model)
```

Let's do some model diagnostics:

```{r}
plot(full_model)
qqnorm(resid(full_model))
```

The R squared of this model are:

```{r warning=FALSE}
R2_marginal = r.squaredGLMM(full_model)[1]
R2_marginal = round(R2_marginal, digits = 2)
R2_conditional = r.squaredGLMM(full_model)[2]
R2_conditional = round(R2_conditional, digits = 2)
```

-   Marginal R2 = `r R2_marginal`

-   Conditional R2 = `r R2_conditional`

#### Model Time Points {.tabset}

Let's now look at the full model and see if we should keep the interaction between meta-ecosystem type and disturbance. We are not using mixed effects because a certain system nr can't be at different perturbations or at different meta-ecosystem types.

$$
Total \: Regional \: Bioarea = M + D + MD
$$

##### Time point 1

Let's start by looking at whether meta-ecosystem type and disturbance had an effect at time point = 1. At this time point, no disturbance event had yet occurred. Therefore, we would not expect an effect of disturbance. In regards to meta-ecosystem type, there might be an effect if it comes from just the sizes of the two ecosystems.

```{r}
chosen_time_point = 1

data = ds_regional_biomass %>%
                            filter(time_point == chosen_time_point) %>%
                            filter(metaecosystem_type == "M_M" | metaecosystem_type == "S_L")
```

```{r}
for(disturbance_input in c("low", "high")) {
  print(
    data %>%
      filter(disturbance == disturbance_input) %>%
      ggplot (aes(x = metaecosystem_type,
                  y = gamma_shannon)) +
      geom_boxplot() +
      labs(
        title = paste0(
          "Time point = ",
          chosen_time_point,
          ", Disturbance = ",
          disturbance_input
        ),
        x = "",
        y = "Meta-ecosystem Total Bioarea (µm²)",
        color = '',
        fill = ''
      ) +
      scale_fill_manual(
        values = c(colour_MM, colour_SL),
        labels = c("Medium-Medium",
                   "Small-Large")
      ) +
      theme_bw() +
      theme(
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank()
      )
  )
}
```

```{r}
full_model = lm(gamma_shannon ~
            metaecosystem_type +
            disturbance +
            baseline_gamma_shannon +
            metaecosystem_type * disturbance,
          data = data)

null_model = lm(gamma_shannon ~
            disturbance +
            baseline_gamma_shannon,
          data = data)

AIC(full_model, null_model)
```

##### Time point 2

Here there should be an effect of meta-ecosystem type.

```{r}
chosen_time_point = 2

data = ds_regional_biomass %>%
                            filter(time_point == chosen_time_point) %>%
                            filter(metaecosystem_type == "M_M" | metaecosystem_type == "S_L")
```

```{r}
for(disturbance_input in c("low", "high")) {
  print(
    data %>%
      filter(disturbance == disturbance_input) %>%
      ggplot (aes(x = metaecosystem_type,
                  y = gamma_shannon)) +
      geom_boxplot() +
      labs(
        title = paste0(
          "Time point = ",
          chosen_time_point,
          ", Disturbance = ",
          disturbance_input
        ),
        x = "",
        y = "Meta-ecosystem Total Bioarea (µm²)",
        color = '',
        fill = ''
      ) +
      scale_fill_manual(
        values = c(colour_MM, colour_SL),
        labels = c("Medium-Medium",
                   "Small-Large")
      ) +
      theme_bw() +
      theme(
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank()
      )
  )
}
```

```{r}
full_model = lm(gamma_shannon ~
            metaecosystem_type +
            disturbance +
            baseline_gamma_shannon +
            metaecosystem_type * disturbance,
          data = data)

null_model = lm(gamma_shannon ~
            disturbance +
            baseline_gamma_shannon,
          data = data)

AIC(full_model, null_model)
```

```{r}
par(mfrow=c(2,3))
plot(full_model, which = 1:5)

R2_full = glance(full_model)$r.squared
R2_null = glance(null_model)$r.squared
R2_M = R2_full - R2_null

R2_full = round(R2_full, digits = 2)
R2_M = round(R2_M, digits = 2)
```

The adjusted R squared of the model is `r R2_full` and the adjusted R squared of patch type is `r R2_M`.

##### Time point 3

Here there should be an effect of meta-ecosystem type.

```{r}
chosen_time_point = 3

data = ds_regional_biomass %>%
                            filter(time_point == chosen_time_point) %>%
                            filter(metaecosystem_type == "M_M" | metaecosystem_type == "S_L")
```

```{r}
for(disturbance_input in c("low", "high")) {
  print(
    data %>%
      filter(disturbance == disturbance_input) %>%
      ggplot (aes(x = metaecosystem_type,
                  y = gamma_shannon)) +
      geom_boxplot() +
      labs(
        title = paste0(
          "Time point = ",
          chosen_time_point,
          ", Disturbance = ",
          disturbance_input
        ),
        x = "",
        y = "Meta-ecosystem Total Bioarea (µm²)",
        color = '',
        fill = ''
      ) +
      scale_fill_manual(
        values = c(colour_MM, colour_SL),
        labels = c("Medium-Medium",
                   "Small-Large")
      ) +
      theme_bw() +
      theme(
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank()
      )
  )
}
```

```{r}
full_model = lm(gamma_shannon ~
            metaecosystem_type +
            disturbance +
            baseline_gamma_shannon +
            metaecosystem_type * disturbance,
          data = data)

null_model = lm(gamma_shannon ~
            disturbance +
            baseline_gamma_shannon,
          data = data)

AIC(full_model, null_model)
```

```{r}
par(mfrow=c(2,3))
plot(full_model, which = 1:5)

R2_full = glance(full_model)$r.squared
R2_null = glance(null_model)$r.squared
R2_M = R2_full - R2_null

R2_full = round(R2_full, digits = 2)
R2_M = round(R2_M, digits = 2)
```

The adjusted R squared of the model is `r R2_full` and the adjusted R squared of patch type is `r R2_M`.

##### Time point 4

Here there should be an effect of meta-ecosystem type.

```{r}
chosen_time_point = 4

data = ds_regional_biomass %>%
                            filter(time_point == chosen_time_point) %>%
                            filter(metaecosystem_type == "M_M" | metaecosystem_type == "S_L")
```

```{r}
for(disturbance_input in c("low", "high")) {
  print(
    data %>%
      filter(disturbance == disturbance_input) %>%
      ggplot (aes(x = metaecosystem_type,
                  y = gamma_shannon)) +
      geom_boxplot() +
      labs(
        title = paste0(
          "Time point = ",
          chosen_time_point,
          ", Disturbance = ",
          disturbance_input
        ),
        x = "",
        y = "Meta-ecosystem Total Bioarea (µm²)",
        color = '',
        fill = ''
      ) +
      scale_fill_manual(
        values = c(colour_MM, colour_SL),
        labels = c("Medium-Medium",
                   "Small-Large")
      ) +
      theme_bw() +
      theme(
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank()
      )
  )
}
```

```{r}
full_model = lm(gamma_shannon ~
            metaecosystem_type +
            disturbance +
            baseline_gamma_shannon +
            metaecosystem_type * disturbance,
          data = data)

null_model = lm(gamma_shannon ~
            disturbance +
            baseline_gamma_shannon,
          data = data)

AIC(full_model, null_model)
```

```{r}
par(mfrow=c(2,3))
plot(full_model, which = 1:5)

R2_full = glance(full_model)$r.squared
R2_null = glance(null_model)$r.squared
R2_M = R2_full - R2_null

R2_full = round(R2_full, digits = 2)
R2_M = round(R2_M, digits = 2)
```

The adjusted R squared of the model is `r R2_full` and the adjusted R squared of patch type is `r R2_M`.

##### Time point 5

Here there should be an effect of meta-ecosystem type.

```{r}
chosen_time_point = 5

data = ds_regional_biomass %>%
                            filter(time_point == chosen_time_point) %>%
                            filter(metaecosystem_type == "M_M" | metaecosystem_type == "S_L")
```

```{r}
for(disturbance_input in c("low", "high")) {
  print(
    data %>%
      filter(disturbance == disturbance_input) %>%
      ggplot (aes(x = metaecosystem_type,
                  y = gamma_shannon)) +
      geom_boxplot() +
      labs(
        title = paste0(
          "Time point = ",
          chosen_time_point,
          ", Disturbance = ",
          disturbance_input
        ),
        x = "",
        y = "Meta-ecosystem Total Bioarea (µm²)",
        color = '',
        fill = ''
      ) +
      scale_fill_manual(
        values = c(colour_MM, colour_SL),
        labels = c("Medium-Medium",
                   "Small-Large")
      ) +
      theme_bw() +
      theme(
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank()
      )
  )
}
```

```{r}
full_model = lm(gamma_shannon ~
            metaecosystem_type +
            disturbance +
            baseline_gamma_shannon +
            metaecosystem_type * disturbance,
          data = data)

null_model = lm(gamma_shannon ~
            disturbance +
            baseline_gamma_shannon,
          data = data)

AIC(full_model, null_model)
```

```{r}
par(mfrow=c(2,3))
plot(full_model, which = 1:5)

R2_full = glance(full_model)$r.squared
R2_null = glance(null_model)$r.squared
R2_M = R2_full - R2_null

R2_full = round(R2_full, digits = 2)
R2_M = round(R2_M, digits = 2)
```

The adjusted R squared of the model is `r R2_full` and the adjusted R squared of patch type is `r R2_M`.

##### Time point 6

Here there should be an effect of meta-ecosystem type.

```{r}
chosen_time_point = 6

data = ds_regional_biomass %>%
                            filter(time_point == chosen_time_point) %>%
                            filter(metaecosystem_type == "M_M" | metaecosystem_type == "S_L")
```

```{r}
for(disturbance_input in c("low", "high")) {
  print(
    data %>%
      filter(disturbance == disturbance_input) %>%
      ggplot (aes(x = metaecosystem_type,
                  y = gamma_shannon)) +
      geom_boxplot() +
      labs(
        title = paste0(
          "Time point = ",
          chosen_time_point,
          ", Disturbance = ",
          disturbance_input
        ),
        x = "",
        y = "Meta-ecosystem Total Bioarea (µm²)",
        color = '',
        fill = ''
      ) +
      scale_fill_manual(
        values = c(colour_MM, colour_SL),
        labels = c("Medium-Medium",
                   "Small-Large")
      ) +
      theme_bw() +
      theme(
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank()
      )
  )
}
```

```{r}
full_model = lm(gamma_shannon ~
            metaecosystem_type +
            disturbance +
            baseline_gamma_shannon +
            metaecosystem_type * disturbance,
          data = data)

null_model = lm(gamma_shannon ~
            disturbance +
            baseline_gamma_shannon,
          data = data)

AIC(full_model, null_model)
```

```{r}
par(mfrow=c(2,3))
plot(full_model, which = 1:5)

R2_full = glance(full_model)$r.squared
R2_null = glance(null_model)$r.squared
R2_M = R2_full - R2_null

R2_full = round(R2_full, digits = 2)
R2_M = round(R2_M, digits = 2)
```

The adjusted R squared of the model is `r R2_full` and the adjusted R squared of patch type is `r R2_M`.

##### Time point 7

Here there should be an effect of meta-ecosystem type.

```{r}
chosen_time_point = 7

data = ds_regional_biomass %>%
                            filter(time_point == chosen_time_point) %>%
                            filter(metaecosystem_type == "M_M" | metaecosystem_type == "S_L")
```

```{r}
for(disturbance_input in c("low", "high")) {
  print(
    data %>%
      filter(disturbance == disturbance_input) %>%
      ggplot (aes(x = metaecosystem_type,
                  y = gamma_shannon)) +
      geom_boxplot() +
      labs(
        title = paste0(
          "Time point = ",
          chosen_time_point,
          ", Disturbance = ",
          disturbance_input
        ),
        x = "",
        y = "Meta-ecosystem Total Bioarea (µm²)",
        color = '',
        fill = ''
      ) +
      scale_fill_manual(
        values = c(colour_MM, colour_SL),
        labels = c("Medium-Medium",
                   "Small-Large")
      ) +
      theme_bw() +
      theme(
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank()
      )
  )
}
```

```{r}
full_model = lm(gamma_shannon ~
            metaecosystem_type +
            disturbance +
            baseline_gamma_shannon +
            metaecosystem_type * disturbance,
          data = data)

null_model = lm(gamma_shannon ~
            disturbance +
            baseline_gamma_shannon,
          data = data)

AIC(full_model, null_model)
```

```{r}
par(mfrow=c(2,3))
plot(full_model, which = 1:5)

R2_full = glance(full_model)$r.squared
R2_null = glance(null_model)$r.squared
R2_M = R2_full - R2_null

R2_full = round(R2_full, digits = 2)
R2_M = round(R2_M, digits = 2)
```

The adjusted R squared of the model is `r R2_full` and the adjusted R squared of patch type is `r R2_M`.
