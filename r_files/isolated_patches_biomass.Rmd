---
title: "isolated_patches"
author: "Emanuele Giacomuzzo"
date: "2022-08-05"
output: html_document
editor_options: 
  chunk_output_type: console
---

##### Time - Biomass

```{r}
response_variable = "bioarea_per_ml"
```

```{r}
plot.patches.boxplots(eco_metaeco_type_input,
                       response_variable)

p_isolated_biomass = plot.patches.points(eco_metaeco_type_input,
                       response_variable)

p_isolated_biomass
```

*Analysis*

1.  Filter the data. Filter between time point 2 and time point 7 (last time point). We exclude time point 0 and time point 1, as these happened before the first disturbance took place (the first disturbance took place right after time point 1).

```{r}
filtered_data = ds_patches %>%
  filter(
    disturbance == disturbance_input,
    metaecosystem == "no",
    time_point >= first_time_point_model,
    time_point <= last_time_point_model
  )
```

2.  Construct a full model that captures all our hypotheses.\
    \
    The first hypothesis proposes that the bioarea density of isolated patches depends on their patch size (`patch_size_ml`). \
    \
    The second hypothesis proposes that the bioarea density of isolated patches goes down faster in smaller patches (`patch_size_ml : day`).

```{r}
full_model = lmer(
  bioarea_per_ml ~
    day +
    patch_size_ml +
    patch_size_ml : day +
    baseline_bioarea_per_ml + 
    baseline_bioarea_per_ml : day +
    (day | culture_ID),
  data = filtered_data,
  REML = FALSE,
  control = lmerControl(optimizer = "Nelder_Mead")
)
```

Check the output of the model.

```{r}
summary(full_model)
```

Check that the residuals of the model are okay (model diagnostics).

```{r}
plot(full_model)
qqnorm(resid(full_model))
```

3.  Test the full model.

Construct the null model for all hypotheses.
    
```{r}
null_model = lmer(
  bioarea_per_ml ~
    day +
    baseline_bioarea_per_ml + 
    baseline_bioarea_per_ml : day +
    (day | culture_ID),
  data = filtered_data,
  REML = FALSE,
  control = lmerControl(optimizer = "Nelder_Mead")
)
```
    
Get the p value and the delta AIC of the full model compared to the null model.

```{r}

AIC = AIC(full_model, null_model) %>% 
  rownames_to_column("model")

AIC_full = AIC %>%
           filter(model == "full_model") %>%
           pull(AIC)

AIC_null = AIC %>%
           filter(model == "null_model") %>%
           pull(AIC)

deltaAIC = AIC_full - AIC_null
deltaAIC = round(deltaAIC, digits = 2)

anova = anova(full_model, null_model)
anova
p_value = anova$`Pr(>Chisq)`[2]
if(p_value < 0.001){
  p_value = "< 0.001"
} else {
  p_value = round(p_value, digits = 3)
}
```

```{r}
print(paste0("P value = ", p_value, ", ΔAIC = ", deltaAIC))
```

4.  Test hypothesis 1

Construct the null model.

```{r}
null_model = lmer(
  bioarea_per_ml ~
    day +
    patch_size_ml : day +
    baseline_bioarea_per_ml + 
    baseline_bioarea_per_ml : day +
    (day | culture_ID),
  data = filtered_data,
  REML = FALSE,
  control = lmerControl(optimizer = "Nelder_Mead")
)
```

Get the p value and the delta AIC of the full model compared to the null model.

```{r}

AIC = AIC(full_model, null_model) %>% 
  rownames_to_column("model")

AIC_full = AIC %>%
           filter(model == "full_model") %>%
           pull(AIC)

AIC_null = AIC %>%
           filter(model == "null_model") %>%
           pull(AIC)

deltaAIC = AIC_full - AIC_null
deltaAIC = round(deltaAIC, digits = 2)

anova = anova(full_model, null_model)
anova
p_value = anova$`Pr(>Chisq)`[2]
if (p_value < 0.001){
   p_value = "< 0.001"
 } else {
   p_value = round(p_value, digits = 3)
 }
```

```{r}
print(paste0("P value = ", p_value, ", ΔAIC = ", deltaAIC))
```


5.  Test hypothesis 2

Construct the null model.

```{r}
null_model = lmer(
  bioarea_per_ml ~
    day +
    patch_size_ml +
    baseline_bioarea_per_ml + 
    baseline_bioarea_per_ml : day +
    (day | culture_ID),
  data = filtered_data,
  REML = FALSE,
  control = lmerControl(optimizer = "Nelder_Mead")
)
```

Get the p value and the delta AIC of the full model compared to the null model.

```{r}

AIC = AIC(full_model, null_model) %>% 
  rownames_to_column("model")

AIC_full = AIC %>%
           filter(model == "full_model") %>%
           pull(AIC)

AIC_null = AIC %>%
           filter(model == "null_model") %>%
           pull(AIC)

deltaAIC = AIC_full - AIC_null
deltaAIC = round(deltaAIC, digits = 2)

anova = anova(full_model, null_model)
anova
p_value = anova$`Pr(>Chisq)`[2]
if (p_value < 0.001){
   p_value = "< 0.001"
 } else {
   p_value = round(p_value, digits = 3)
 }
```

```{r}
print(paste0("P value = ", p_value, ", ΔAIC = ", deltaAIC))
```

##### Patch size - Biomass {.tabset .tabset-pills}

###### Isolated

```{r}
plot.patches.size.response.boxplots(metaecosystem_input = "no",
                                  trophic_type_input = "NA",
                                  flow_input = "NA",
                                  response_variable = response_variable)
```

###### Connected

```{r}
plot.patches.size.response.boxplots(metaecosystem_input = "yes",
                                  trophic_type_input = "NA",
                                  flow_input = "NA",
                                  response_variable = response_variable)
```