---
title: "Data manipulation: PatchSizePilot"
author: "Emanuele Giacomuzzo"
date: "2022-08-04"
output: html_document
editor_options: 
  chunk_output_type: console
---

### Biomass & abundance

#### Patch biomass & community density (`ds_biomass_abund`)

This dataset is the master dataset containing all the information about the biomass of the experiment.

```{r ds_biomass_abund-import-pop_data, message = FALSE, echo = TRUE}
load(here("data", "population", "t0.RData")); t0 = pop_output
load(here("data", "population", "t1.RData")); t1 = pop_output
load(here("data", "population", "t2.RData")); t2 = pop_output
load(here("data", "population", "t3.RData")); t3 = pop_output
load(here("data", "population", "t4.RData")); t4 = pop_output
load(here("data", "population", "t5.RData")); t5 = pop_output
load(here("data", "population", "t6.RData")); t6 = pop_output
load(here("data", "population", "t7.RData")); t7 = pop_output
rm(pop_output)
```

```{r ds_biomass_abund-import-species-data}
species_ID_t0 = read.csv(here("data", "population_species_ID", "species_ID_t0.csv")) %>%
  select(file, Ble:Tet)
species_ID_t1 = read.csv(here("data", "population_species_ID", "species_ID_t1.csv")) %>%
  select(file, Ble:Tet)
species_ID_t2 = read.csv(here("data", "population_species_ID", "species_ID_t2.csv")) %>%
  select(file, Ble:Tet)
species_ID_t3 = read.csv(here("data", "population_species_ID", "species_ID_t3.csv")) %>%
  select(file, Ble:Tet)
species_ID_t4 = read.csv(here("data", "population_species_ID", "species_ID_t4.csv")) %>%
  select(file, Ble:Tet)
species_ID_t5 = read.csv(here("data", "population_species_ID", "species_ID_t5.csv")) %>%
  select(file, Ble:Tet)
species_ID_t6 = read.csv(here("data", "population_species_ID", "species_ID_t6.csv")) %>%
  select(file, Ble:Tet)
species_ID_t7 = read.csv(here("data", "population_species_ID", "species_ID_t7.csv")) %>%
  select(file, Ble:Tet)
```

```{r ds_biomass_abund-join-time-points-with-info}
t0 = merge(t0, species_ID_t0, by = "file")
t1 = merge(t1, species_ID_t1, by = "file")
t2 = merge(t2, species_ID_t2, by = "file")
t3 = merge(t3, species_ID_t3, by = "file")
t4 = merge(t4, species_ID_t4, by = "file")
t5 = merge(t5, species_ID_t5, by = "file")
t6 = merge(t6, species_ID_t6, by = "file")
t7 = merge(t7, species_ID_t7, by = "file")
rm(species_ID_t0, species_ID_t1, species_ID_t2, species_ID_t3, species_ID_t4, species_ID_t5, species_ID_t6, species_ID_t7)
```


```{r ds_biomass_abund-tidy-time-points, message = FALSE, echo = TRUE}
t2$time = NULL
t3$time = NULL
t4$time = NULL
t5$time = NULL
t6$time = NULL
t7$time = NULL

t0$replicate_video = 1:12 #In t1 I took 12 videos of a single 
t1$replicate_video = 1 #In t1 I took only 1 video/culture
t2$replicate_video = 1 #In t2 I took only 1 video/culture
t3$replicate_video = 1 #In t3 I took only 1 video/culture
t4$replicate_video = 1 #In t4 I took only 1 video/culture
t5$replicate_video = 1 #In t5 I took only 1 video/culture
t6$replicate_video = t6$replicate; t6$replicate = NULL
t7$replicate_video = t7$replicate; t7$replicate = NULL
```

```{r elongate-t0-to-merge-with-culture-info}
number_of_columns_t0 = ncol(t0)
nr_of_cultures = nrow(culture_info)
nr_of_videos = nrow(t0)

t0 = t0[rep(row.names(t0), nr_of_cultures),] %>%
   arrange(file) %>%
   mutate(culture_ID = rep(1:nr_of_cultures, times = nr_of_videos))
```

```{r ds_biomass_abund-join-time-points, message = FALSE, echo = TRUE}
t0 = merge(culture_info,t0, by="culture_ID")
t1 = merge(culture_info,t1, by = "culture_ID")
t2 = merge(culture_info,t2, by = "culture_ID")
t3 = merge(culture_info,t3, by = "culture_ID")
t4 = merge(culture_info,t4, by = "culture_ID")
t5 = merge(culture_info,t5, by = "culture_ID")
t6 = merge(culture_info,t6, by = "culture_ID")
t7 = merge(culture_info,t7, by = "culture_ID")
ds_biomass_abund = rbind(t0, t1, t2, t3, t4, t5, t6, t7)
rm(t0, t1, t2, t3, t4, t5, t6, t7)
```

```{r ds_biomass_abund-tidy-dataset-columns, message = FALSE, echo = TRUE}
ds_biomass_abund = ds_biomass_abund %>%
  filter(! culture_ID %in% ecosystems_to_take_off)

ds_biomass_abund$time_point[ds_biomass_abund$time_point=="t0"] = 0
ds_biomass_abund$time_point[ds_biomass_abund$time_point=="t1"] = 1
ds_biomass_abund$time_point[ds_biomass_abund$time_point=="t2"] = 2
ds_biomass_abund$time_point[ds_biomass_abund$time_point=="t3"] = 3
ds_biomass_abund$time_point[ds_biomass_abund$time_point=="t4"] = 4
ds_biomass_abund$time_point[ds_biomass_abund$time_point=="t5"] = 5
ds_biomass_abund$time_point[ds_biomass_abund$time_point=="t6"] = 6
ds_biomass_abund$time_point[ds_biomass_abund$time_point=="t7"] = 7
ds_biomass_abund$time_point = as.character(ds_biomass_abund$time_point)

ds_biomass_abund$day = NA
ds_biomass_abund$day[ds_biomass_abund$time_point== 0] = 0
ds_biomass_abund$day[ds_biomass_abund$time_point== 1] = 4
ds_biomass_abund$day[ds_biomass_abund$time_point== 2] = 8
ds_biomass_abund$day[ds_biomass_abund$time_point== 3] = 12
ds_biomass_abund$day[ds_biomass_abund$time_point== 4] = 16
ds_biomass_abund$day[ds_biomass_abund$time_point== 5] = 20
ds_biomass_abund$day[ds_biomass_abund$time_point== 6] = 24
ds_biomass_abund$day[ds_biomass_abund$time_point== 7] = 28

ds_biomass_abund = ds_biomass_abund %>%
  mutate(bioarea_tot = bioarea_per_volume * (patch_size_volume * 1000)) %>% #bioarea_per_volume in Âµm2, patch_size_vol in ml 
  mutate(indiv_tot = indiv_per_volume * (patch_size_volume * 1000))

ds_for_evaporation = ds_biomass_abund #Keep this dataset for the evaporation effects

ds_biomass_abund = ds_biomass_abund %>% 
  select(culture_ID, 
         patch_size,
         patch_size_volume,
         disturbance, 
         metaecosystem_type, 
         indiv_per_volume, 
         replicate_video, 
         time_point,
         day,
         metaecosystem, 
         system_nr, 
         eco_metaeco_type,
         bioarea_per_volume,
         bioarea_tot,
         indiv_per_volume,
         indiv_tot,
         Ble,
         Cep,
         Col,
         Eug,
         Eup,
         Lox,
         Pau,
         Pca,
         Spi,
         Spi_te,
         Tet)
```

```{r ds_biomass_abund-calculate-alpha-diversity}
ds_biomass_abund = ds_biomass_abund %>%
  mutate(Ble_presence = case_when(Ble > 0 ~ 1,
                                  TRUE ~ 0)) %>%
  mutate(Cep_presence = case_when(Cep > 0 ~ 1,
                                  TRUE ~ 0)) %>%
  mutate(Col_presence = case_when(Col > 0 ~ 1,
                                  TRUE ~ 0)) %>%
  mutate(Eug_presence = case_when(Eup > 0 ~ 1,
                                  TRUE ~ 0)) %>%
  mutate(Eup_presence = case_when(Eug > 0 ~ 1,
                                  TRUE ~ 0)) %>%
  mutate(Lox_presence = case_when(Lox > 0 ~ 1,
                                  TRUE ~ 0)) %>%
  mutate(Pau_presence = case_when(Pau > 0 ~ 1,
                                  TRUE ~ 0)) %>%
  mutate(Pca_presence = case_when(Pca > 0 ~ 1,
                                  TRUE ~ 0)) %>%
  mutate(Spi_presence = case_when(Spi > 0 ~ 1,
                                  TRUE ~ 0)) %>%
  mutate(Spi_te_presence = case_when(Spi_te > 0 ~ 1,
                                  TRUE ~ 0)) %>%
  mutate(Tet_presence = case_when(Tet > 0 ~ 1,
                                  TRUE ~ 0)) %>%
  mutate(species_richness = Ble_presence +
                            Cep_presence +
                            Col_presence +
                            Eug_presence +
                            Eup_presence +
                            Lox_presence +
                            Pau_presence +
                            Pca_presence +
                            Spi_presence +
                            Spi_te_presence +
                            Tet_presence)

ds_biomass_abund_averaged = ds_biomass_abund %>%
  group_by(system_nr,
           time_point) %>%
  mutate(bioarea_per_volume = mean(bioarea_per_volume)) %>%
  ungroup() %>%
  mutate(Ble_presence = case_when(Ble > 0 ~ 1,
                                  TRUE ~ 0)) %>%
  mutate(Cep_presence = case_when(Cep > 0 ~ 1,
                                  TRUE ~ 0)) %>%
  mutate(Col_presence = case_when(Col > 0 ~ 1,
                                  TRUE ~ 0)) %>%
  mutate(Eug_presence = case_when(Eup > 0 ~ 1,
                                  TRUE ~ 0)) %>%
  mutate(Eup_presence = case_when(Eug > 0 ~ 1,
                                  TRUE ~ 0)) %>%
  mutate(Lox_presence = case_when(Lox > 0 ~ 1,
                                  TRUE ~ 0)) %>%
  mutate(Pau_presence = case_when(Pau > 0 ~ 1,
                                  TRUE ~ 0)) %>%
  mutate(Pca_presence = case_when(Pca > 0 ~ 1,
                                  TRUE ~ 0)) %>%
  mutate(Spi_presence = case_when(Spi > 0 ~ 1,
                                  TRUE ~ 0)) %>%
  mutate(Spi_te_presence = case_when(Spi_te > 0 ~ 1,
                                  TRUE ~ 0)) %>%
  mutate(Tet_presence = case_when(Tet > 0 ~ 1,
                                  TRUE ~ 0)) %>%
  mutate(species_richness = Ble_presence +
                            Cep_presence +
                            Col_presence +
                            Eug_presence +
                            Eup_presence +
                            Lox_presence +
                            Pau_presence +
                            Pca_presence +
                            Spi_presence +
                            Spi_te_presence +
                            Tet_presence)
```

```{r ds_biomass_abund-datatable}
saveRDS(ds_biomass_abund, file = here("results", "ds_biomass_abund.RData"))

datatable(ds_biomass_abund,
          rownames = FALSE,
          options = list(scrollX = TRUE),
          filter = list(position = 'top', 
                        clear = FALSE))
```

##### Effect sizes

```{r ds_patches_averaged}
ds_patches_averaged = ds_biomass_abund %>%
  group_by(
    culture_ID,
    system_nr,
    disturbance,
    time_point,
    day,
    patch_size,
    eco_metaeco_type
  ) %>%
  summarise(
    bioarea_per_volume_across_videos = mean(bioarea_per_volume),
    indiv_per_volume_across_videos = mean(indiv_per_volume),
    species_richness_across_videos = max(species_richness),
    Ble_across_videos = mean(Ble),
    Cep_across_videos = mean(Cep),
    Col_across_videos = mean(Col),
    Eug_across_videos = mean(Eug),
    Eup_across_videos = mean(Eup),
    Lox_across_videos = mean(Lox),
    Pau_across_videos = mean(Pau),
    Pca_across_videos = mean(Pca),
    Spi_across_videos = mean(Spi),
    Spi_te_across_videos = mean(Spi_te),
    Tet_across_videos = mean(Tet)
  ) %>%
  group_by(disturbance, eco_metaeco_type, time_point, day) %>%
  summarise(
    sample_size = n(),
    bioarea_per_volume_mean = mean(bioarea_per_volume_across_videos),
    bioarea_per_volume_sd = sd(bioarea_per_volume_across_videos),
    indiv_per_volume_mean = mean(indiv_per_volume_across_videos),
    indiv_per_volume_sd = sd(indiv_per_volume_across_videos),
    species_richness_mean = mean(species_richness_across_videos),
    species_richness_sd = sd(species_richness_across_videos),
    Ble_mean = mean(Ble_across_videos),
    Ble_sd = sd(Ble_across_videos),
    Cep_mean = mean(Cep_across_videos),
    Cep_sd = sd(Cep_across_videos),
    Col_mean = mean(Col_across_videos),
    Col_sd = sd(Col_across_videos),
    Eug_mean = mean(Eug_across_videos),
    Eug_sd = sd(Eug_across_videos),
    Eup_mean = mean(Eup_across_videos),
    Eup_sd = sd(Eup_across_videos),
    Lox_mean = mean(Lox_across_videos),
    Lox_sd = sd(Lox_across_videos),
    Pau_mean = mean(Pau_across_videos),
    Pau_sd = sd(Pau_across_videos),
    Pca_mean = mean(Pca_across_videos),
    Pca_sd = sd(Pca_across_videos),
    Spi_mean = mean(Spi_across_videos),
    Spi_sd = sd(Spi_across_videos),
    Spi_te_mean = mean(Spi_te_across_videos),
    Spi_te_sd = sd(Spi_te_across_videos),
    Tet_mean = mean(Tet_across_videos),
    Tet_sd = sd(Tet_across_videos)
  )

treatments_and_controls = data.frame(
  treatment = c("S (S_S)", "S (S_L)", "L (L_L)", "L (S_L)"),
  control = c("S", "S", "L", "L")
)

n_of_treatments = nrow(treatments_and_controls)

#Initialise the new columns
ds_patches_averaged %>%
  mutate(bioarea_per_volume_d = NA,
         indiv_per_volume_d = NA,
         species_richness_d = NA,
         Ble_d = NA,
         Cep_d = NA,
         Col_d = NA,
         Eug_d = NA,
         Eup_d = NA,
         Lox_d = NA,
         Pau_d = NA,
         Pca_d = NA,
         Spi_d = NA,
         Spi_te_d = NA,
         Tet_d = NA,
         bioarea_per_volume_lnRR = NA,
         indiv_per_volume_lnRR = NA,
         species_richness_lnRR = NA,
         Ble_lnRR = NA,
         Cep_lnRR = NA,
         Col_lnRR = NA,
         Eug_lnRR = NA,
         Eup_lnRR = NA,
         Lox_lnRR = NA,
         Pau_lnRR = NA,
         Pca_lnRR = NA,
         Spi_lnRR = NA,
         Spi_te_lnRR = NA,
         Tet_lnRR = NA)

row_n = 0
for (disturbance_input in c("low", "high")) {
  for (treatment_n in 1:n_of_treatments) {
    for (time_point_input in 0:7) {
      row_n = row_n + 1
      
      eco_metaeco_treatment = treatments_and_controls$treatment[treatment_n]
      treatment = ds_patches_averaged %>%
        filter(
          disturbance == disturbance_input,
          eco_metaeco_type == eco_metaeco_treatment,
          time_point == time_point_input
        )
      
      eco_metaeco_control = treatments_and_controls$control[treatment_n]
      control = ds_patches_averaged %>%
        filter(
          disturbance == disturbance_input,
          eco_metaeco_type == eco_metaeco_control,
          time_point == time_point_input
        )
      
      ds_patches_averaged$bioarea_per_volume_d[ds_patches_averaged$disturbance == disturbance_input &
                                                 ds_patches_averaged$eco_metaeco_type == eco_metaeco_treatment &
                                                 ds_patches_averaged$time_point == time_point_input] = calculate.hedges_d(
                                                   treatment$bioarea_per_volume_mean,
                                                   treatment$bioarea_per_volume_sd,
                                                   treatment$sample_size,
                                                   control$bioarea_per_volume_mean,
                                                   control$bioarea_per_volume_sd,
                                                   control$sample_size
                                                 )
      
      ds_patches_averaged$bioarea_per_volume_lnRR[ds_patches_averaged$disturbance == disturbance_input &
                                                    ds_patches_averaged$eco_metaeco_type == eco_metaeco_treatment &
                                                    ds_patches_averaged$time_point == time_point_input] = ln(treatment$bioarea_per_volume_mean / control$bioarea_per_volume_mean)
      
      ds_patches_averaged$indiv_per_volume_d[ds_patches_averaged$disturbance == disturbance_input &
                                               ds_patches_averaged$eco_metaeco_type == eco_metaeco_treatment &
                                               ds_patches_averaged$time_point == time_point_input] = calculate.hedges_d(
                                                 treatment$indiv_per_volume_mean,
                                                 treatment$indiv_per_volume_sd,
                                                 treatment$sample_size,
                                                 control$indiv_per_volume_mean,
                                                 control$indiv_per_volume_sd,
                                                 control$sample_size
                                               )
      
      ds_patches_averaged$indiv_per_volume_lnRR[ds_patches_averaged$disturbance == disturbance_input &
                                                    ds_patches_averaged$eco_metaeco_type == eco_metaeco_treatment &
                                                    ds_patches_averaged$time_point == time_point_input] = ln(treatment$indiv_per_volume_mean / control$indiv_per_volume_mean)
      
      ds_patches_averaged$species_richness_d[ds_patches_averaged$disturbance == disturbance_input &
                                               ds_patches_averaged$eco_metaeco_type == eco_metaeco_treatment &
                                               ds_patches_averaged$time_point == time_point_input] = calculate.hedges_d(
                                                 treatment$species_richness_mean,
                                                 treatment$species_richness_sd,
                                                 treatment$sample_size,
                                                 control$species_richness_mean,
                                                 control$species_richness_sd,
                                                 control$sample_size
                                               )
      
      ds_patches_averaged$species_richness_lnRR[ds_patches_averaged$disturbance == disturbance_input &
                                                  ds_patches_averaged$eco_metaeco_type == eco_metaeco_treatment &
                                                  ds_patches_averaged$time_point == time_point_input] = ln(treatment$species_richness_mean / control$species_richness_mean)
      
      ds_patches_averaged$Ble_d[ds_patches_averaged$disturbance == disturbance_input &
                                  ds_patches_averaged$eco_metaeco_type == eco_metaeco_treatment &
                                  ds_patches_averaged$time_point == time_point_input] = calculate.hedges_d(
                                    treatment$Ble_mean,
                                    treatment$Ble_sd,
                                    treatment$sample_size,
                                    control$Ble_mean,
                                    control$Ble_sd,
                                    control$sample_size
                                  )
      
      ds_patches_averaged$Ble_lnRR[ds_patches_averaged$disturbance == disturbance_input &
                                                    ds_patches_averaged$eco_metaeco_type == eco_metaeco_treatment &
                                                    ds_patches_averaged$time_point == time_point_input] = ln(treatment$Ble_mean / control$Ble_mean)
      
      ds_patches_averaged$Cep_d[ds_patches_averaged$disturbance == disturbance_input &
                                  ds_patches_averaged$eco_metaeco_type == eco_metaeco_treatment &
                                  ds_patches_averaged$time_point == time_point_input] = calculate.hedges_d(
                                    treatment$Cep_mean,
                                    treatment$Cep_sd,
                                    treatment$sample_size,
                                    control$Cep_mean,
                                    control$Cep_sd,
                                    control$sample_size
                                  )
      
      ds_patches_averaged$Cep_lnRR[ds_patches_averaged$disturbance == disturbance_input &
                                                    ds_patches_averaged$eco_metaeco_type == eco_metaeco_treatment &
                                                    ds_patches_averaged$time_point == time_point_input] = ln(treatment$Cep_mean / control$Cep_mean)
      
      ds_patches_averaged$Col_d[ds_patches_averaged$disturbance == disturbance_input &
                                  ds_patches_averaged$eco_metaeco_type == eco_metaeco_treatment &
                                  ds_patches_averaged$time_point == time_point_input] = calculate.hedges_d(
                                    treatment$Col_mean,
                                    treatment$Col_sd,
                                    treatment$sample_size,
                                    control$Col_mean,
                                    control$Col_sd,
                                    control$sample_size
                                  )
      
      ds_patches_averaged$Col_lnRR[ds_patches_averaged$disturbance == disturbance_input &
                                                    ds_patches_averaged$eco_metaeco_type == eco_metaeco_treatment &
                                                    ds_patches_averaged$time_point == time_point_input] = ln(treatment$Col_mean / control$Col_mean)
      
      ds_patches_averaged$Eug_d[ds_patches_averaged$disturbance == disturbance_input &
                                  ds_patches_averaged$eco_metaeco_type == eco_metaeco_treatment &
                                  ds_patches_averaged$time_point == time_point_input] = calculate.hedges_d(
                                    treatment$Eug_mean,
                                    treatment$Eug_sd,
                                    treatment$sample_size,
                                    control$Eug_mean,
                                    control$Eug_sd,
                                    control$sample_size
                                  )
      
      ds_patches_averaged$Eug_lnRR[ds_patches_averaged$disturbance == disturbance_input &
                                                    ds_patches_averaged$eco_metaeco_type == eco_metaeco_treatment &
                                                    ds_patches_averaged$time_point == time_point_input] = ln(treatment$Eug_mean / control$Eug_mean)
      
      ds_patches_averaged$Eup_d[ds_patches_averaged$disturbance == disturbance_input &
                                  ds_patches_averaged$eco_metaeco_type == eco_metaeco_treatment &
                                  ds_patches_averaged$time_point == time_point_input] = calculate.hedges_d(
                                    treatment$Eup_mean,
                                    treatment$Eup_sd,
                                    treatment$sample_size,
                                    control$Eup_mean,
                                    control$Eup_sd,
                                    control$sample_size
                                  )
      
      ds_patches_averaged$Eup_lnRR[ds_patches_averaged$disturbance == disturbance_input &
                                                    ds_patches_averaged$eco_metaeco_type == eco_metaeco_treatment &
                                                    ds_patches_averaged$time_point == time_point_input] = ln(treatment$Eup_mean / control$Eup_mean)
      
      ds_patches_averaged$Lox_d[ds_patches_averaged$disturbance == disturbance_input &
                                  ds_patches_averaged$eco_metaeco_type == eco_metaeco_treatment &
                                  ds_patches_averaged$time_point == time_point_input] = calculate.hedges_d(
                                    treatment$Lox_mean,
                                    treatment$Lox_sd,
                                    treatment$sample_size,
                                    control$Lox_mean,
                                    control$Lox_sd,
                                    control$sample_size
                                  )
      
      ds_patches_averaged$Lox_lnRR[ds_patches_averaged$disturbance == disturbance_input &
                                                    ds_patches_averaged$eco_metaeco_type == eco_metaeco_treatment &
                                                    ds_patches_averaged$time_point == time_point_input] = ln(treatment$Lox_mean / control$Lox_mean)
      
      ds_patches_averaged$Pau_d[ds_patches_averaged$disturbance == disturbance_input &
                                  ds_patches_averaged$eco_metaeco_type == eco_metaeco_treatment &
                                  ds_patches_averaged$time_point == time_point_input] = calculate.hedges_d(
                                    treatment$Pau_mean,
                                    treatment$Pau_sd,
                                    treatment$sample_size,
                                    control$Pau_mean,
                                    control$Pau_sd,
                                    control$sample_size
                                  )
      
      ds_patches_averaged$Pau_lnRR[ds_patches_averaged$disturbance == disturbance_input &
                                                    ds_patches_averaged$eco_metaeco_type == eco_metaeco_treatment &
                                                    ds_patches_averaged$time_point == time_point_input] = ln(treatment$Pau_mean / control$Pau_mean)
      
      ds_patches_averaged$Pca_d[ds_patches_averaged$disturbance == disturbance_input &
                                  ds_patches_averaged$eco_metaeco_type == eco_metaeco_treatment &
                                  ds_patches_averaged$time_point == time_point_input] = calculate.hedges_d(
                                    treatment$Pca_mean,
                                    treatment$Pca_sd,
                                    treatment$sample_size,
                                    control$Pca_mean,
                                    control$Pca_sd,
                                    control$sample_size
                                  )
      
      ds_patches_averaged$Pca_lnRR[ds_patches_averaged$disturbance == disturbance_input &
                                                    ds_patches_averaged$eco_metaeco_type == eco_metaeco_treatment &
                                                    ds_patches_averaged$time_point == time_point_input] = ln(treatment$Pca_mean / control$Pca_mean)
      
      ds_patches_averaged$Spi_d[ds_patches_averaged$disturbance == disturbance_input &
                                  ds_patches_averaged$eco_metaeco_type == eco_metaeco_treatment &
                                  ds_patches_averaged$time_point == time_point_input] = calculate.hedges_d(
                                    treatment$Spi_mean,
                                    treatment$Spi_sd,
                                    treatment$sample_size,
                                    control$Spi_mean,
                                    control$Spi_sd,
                                    control$sample_size
                                  )
      
      ds_patches_averaged$Spi_lnRR[ds_patches_averaged$disturbance == disturbance_input &
                                                    ds_patches_averaged$eco_metaeco_type == eco_metaeco_treatment &
                                                    ds_patches_averaged$time_point == time_point_input] = ln(treatment$Spi_mean / control$Spi_mean)
      
      ds_patches_averaged$Spi_te_d[ds_patches_averaged$disturbance == disturbance_input &
                                     ds_patches_averaged$eco_metaeco_type == eco_metaeco_treatment &
                                     ds_patches_averaged$time_point == time_point_input] = calculate.hedges_d(
                                       treatment$Spi_te_mean,
                                       treatment$Spi_te_sd,
                                       treatment$sample_size,
                                       control$Spi_te_mean,
                                       control$Spi_te_sd,
                                       control$sample_size
                                     )
      
      ds_patches_averaged$Spi_te_lnRR[ds_patches_averaged$disturbance == disturbance_input &
                                                    ds_patches_averaged$eco_metaeco_type == eco_metaeco_treatment &
                                                    ds_patches_averaged$time_point == time_point_input] = ln(treatment$Spi_te_mean / control$Spi_te_mean)
      
      ds_patches_averaged$Tet_d[ds_patches_averaged$disturbance == disturbance_input &
                                  ds_patches_averaged$eco_metaeco_type == eco_metaeco_treatment &
                                  ds_patches_averaged$time_point == time_point_input] = calculate.hedges_d(
                                    treatment$Tet_mean,
                                    treatment$Tet_sd,
                                    treatment$sample_size,
                                    control$Tet_mean,
                                    control$Tet_sd,
                                    control$sample_size
                                  )
      
      ds_patches_averaged$Tet_lnRR[ds_patches_averaged$disturbance == disturbance_input &
                                                    ds_patches_averaged$eco_metaeco_type == eco_metaeco_treatment &
                                                    ds_patches_averaged$time_point == time_point_input] = ln(treatment$Tet_mean / control$Tet_mean)
    }
  }
}
```

```{r ds_patches_averaged-datatable}
saveRDS(ds_patches_averaged, file = here("results", "ds_patches_averaged.RData"))

datatable(ds_patches_averaged,
          rownames = FALSE,
          options = list(scrollX = TRUE),
          filter = list(position = 'top', 
                        clear = FALSE))
```

#### Meta-ecosystem biomass (`ds_regional_biomass`)

This is the dataset of the regional biomass of different meta-ecosystems. It contains also the regional biomass of the combination of a small isolated and a large isolated patch (`S_L_from_isolated`).

```{r ds_regional_biomass-create-dataset}
ds_regional_biomass = ds_biomass_abund %>%
  filter(metaecosystem == "yes",!system_nr %in% metaecosystems_to_take_off) %>%
  group_by(culture_ID, time_point) %>%
  mutate(bioarea_per_volume_video_averaged = mean(bioarea_per_volume)) %>%
  ungroup() %>%
  mutate(total_patch_bioarea = bioarea_per_volume_video_averaged * patch_size_volume) %>%
  group_by(system_nr, time_point) %>%
  mutate(total_regional_bioarea = sum(total_patch_bioarea)) %>%
  ungroup()
```

```{r ds_regional_biomass-create-SL_SL_from_isolated, message=FALSE, results='hide', eval = recompute_analyses}
isolated_S_and_L = ds_biomass_abund %>%
  filter(eco_metaeco_type == "S" | eco_metaeco_type == "L") %>%
  group_by(system_nr, time_point) %>%
  mutate(bioarea_per_volume_across_videos = mean(bioarea_per_volume)) %>%
  ungroup()

isolated_S_low = isolated_S_and_L %>%
  filter(eco_metaeco_type == "S",
         disturbance == "low")
isolated_L_low = isolated_S_and_L %>%
  filter(eco_metaeco_type == "L",
         disturbance == "low")
isolated_S_high = isolated_S_and_L %>%
  filter(eco_metaeco_type == "S",
         disturbance == "high")
isolated_L_high = isolated_S_and_L %>%
  filter(eco_metaeco_type == "L",
         disturbance == "high")

S_low_system_nrs = unique(isolated_S_low$system_nr)
S_high_system_nrs = unique(isolated_S_high$system_nr)
L_low_system_nrs = unique(isolated_L_low$system_nr)
L_high_system_nrs = unique(isolated_L_high$system_nr)

low_system_nrs_combination = expand.grid(S_low_system_nrs, L_low_system_nrs) %>%
  mutate(disturbance = "low")
high_system_nrs_combination = expand.grid(S_high_system_nrs, L_high_system_nrs) %>%
  mutate(disturbance = "high")
system_nr_combinations = rbind(low_system_nrs_combination, high_system_nrs_combination) %>%
  rename(S_system_nr = Var1) %>%
  rename(L_system_nr = Var2)

number_of_combinations = nrow(system_nr_combinations)
SL_from_isolated_all_combinations = NULL
for (pair in 1:number_of_combinations){
  
  SL_from_isolated_one_combination = 
    ds_biomass_abund %>%
    filter(system_nr %in% system_nr_combinations[pair,]) %>%
    group_by(disturbance, day, time_point, system_nr) %>%
    summarise(regional_bioarea_across_videos = mean(bioarea_per_volume)) %>%
    group_by(disturbance, day, time_point) %>%
    summarise(total_regional_bioarea = sum(regional_bioarea_across_videos)) %>%
    mutate(system_nr = 1000 + pair) %>%
    mutate(metaecosystem_type = "S_L_from_isolated")
  
  SL_from_isolated_all_combinations[[pair]] = SL_from_isolated_one_combination}


SL_from_isolated_all_combinations_together = NULL
for (combination in 1:number_of_combinations){
 
  SL_from_isolated_all_combinations_together = 
    rbind(SL_from_isolated_all_combinations_together,
          SL_from_isolated_all_combinations[[pair]])}

ds_regional_biomass = rbind(ds_regional_biomass, SL_from_isolated_all_combinations_together)

saveRDS(ds_regional_biomass, file = here("results", "ds_regional_biomass.RData"))
```

```{r ds_regional_biomass-read-after-heavy-computation}
ds_regional_biomass = readRDS(here("results", "ds_regional_biomass.RData"))
```

```{r ds_regional_biomass-calculate-beta-diversity}
ds_for_beta_diversity = ds_biomass_abund %>%
  filter(!metaecosystem_type == "S_L from isolated") %>%
  group_by(culture_ID, system_nr, time_point) %>%
  summarise(
    Ble = mean(Ble),
    Cep = mean(Cep),
    Col = mean(Col),
    Eug = mean(Eug),
    Eup = mean(Eup),
    Lox = mean(Lox),
    Pau = mean(Pau),
    Pca = mean(Pca),
    Spi = mean(Spi),
    Spi_te = mean(Spi_te),
    Tet = mean(Tet)
  )

ds_regional_biomass$beta_diversity = NA
ds_regional_biomass$gamma_diversity = NA

for (system_nr_input in 16:70) {
  for (time_point_input in 0:(n_time_points-1)) {
    
    if(system_nr_input %in% metaecosystems_to_take_off) next
    
    abundances_two_patches = ds_for_beta_diversity %>%
      filter(system_nr == system_nr_input,
             time_point == time_point_input) %>%
      ungroup() %>%
      select(Ble:Tet)
    
    pres_abs_two_patches = ifelse(test = abundances_two_patches > 0,
                                  yes = 1,
                                  no = 0) 
    
    distance_list = beta.pair(pres_abs_two_patches, index.family = "jaccard")
    beta_diversity = distance_list$beta.jac
    
    summed_columns = colSums(pres_abs_two_patches)
    vector_for_gamma = ifelse(test = summed_columns > 0,
                                  yes = 1,
                                  no = 0) 
    gamma_diversity = sum(vector_for_gamma)
    
    ds_regional_biomass$beta_diversity[ds_regional_biomass$system_nr == system_nr_input &
                                         ds_regional_biomass$time_point == time_point_input] = beta_diversity
    ds_regional_biomass$gamma_diversity[ds_regional_biomass$system_nr == system_nr_input &
                                         ds_regional_biomass$time_point == time_point_input] = gamma_diversity
    
    
  }
}
```

```{r ds_regional_biomass-datatable}
saveRDS(ds_regional_biomass, file = here("results", "ds_regional_biomass.RData"))

datatable(ds_regional_biomass,
          rownames = FALSE,
          options = list(scrollX = TRUE),
          filter = list(position = 'top', 
                        clear = FALSE))
```