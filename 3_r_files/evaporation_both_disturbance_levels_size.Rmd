---
title: "Untitled"
output: html_document
date: "2024-09-13"
editor_options: 
  chunk_output_type: console
---

We want to know whether the size of an ecosystem influenced its evaporation rate. We first start from plotting how the water that was added to the cultures changed across size through its mean ± 95 confidence interval:

```{r}

# --- FILTER DATASET --- #

response_variable = "water_addition_ml"

ds_ecosystems_both_disturbances_filtered = ds_ecosystems_both_disturbances %>%
  filter(!is.na(water_addition_ml)) %>%
  mutate(sqrt_water_addition_ml = sqrt(water_addition_ml),
         log_water_addition_ml = log(water_addition_ml),
         inv_water_addition_ml = 1 / water_addition_ml)
```

```{r}

# --- PLOT WATER ADDITION MEAN ± 95 CI --- #

ds_ecosystems_both_disturbances_filtered %>%
  summarySE(measurevar = response_variable,
            groupvars = c("day", "ecosystem_size")) %>%
  ggplot(aes(x = day,
             y = get(response_variable),
             group = interaction(day, ecosystem_size),
             color = ecosystem_size)) +
  geom_point(stat = "summary",
             fun = "mean",
             position = position_dodge(dodging),
             size = treatment_points_size) + 
  geom_line(stat = "summary",
            fun = "mean",
            aes(group = ecosystem_size),
            position = position_dodge(dodging),
            linewidth = treatment_lines_linewidth) +
  geom_errorbar(aes(ymax = get(response_variable) + ci,
                    ymin = get(response_variable) - ci),
                width = width_errorbar,
                position = position_dodge(dodging)) +
  labs(x = "Day",
       y = "Water addition (ml)",
       color = "") +
  theme_bw() +
  theme(panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        legend.position = legend_position) +
  scale_color_manual(values = c("#000000", "#737373", "#bdbdbd"))
```

<details>
<summary>View single replicates</summary>
```{r}

# --- PLOT WATER ADDITION SINGLE REPLICATES --- #

ds_ecosystems_both_disturbances_filtered %>%
  ggplot(aes(x = day,
             y = get(response_variable),
             group = interaction(culture_ID, day),
             color = ecosystem_size)) +
  geom_point() + 
  geom_line(aes(group = culture_ID)) +
  scale_x_continuous(breaks = unique(ds_ecosystems$day)) +
    theme_bw() +
    theme(panel.grid.major = element_blank(),
          panel.grid.minor = element_blank(),
          legend.position = legend_position) +
      geom_rect(xmin = grey_background_xmin, 
                xmax = grey_background_xmax,
                ymin = grey_background_ymin, 
                ymax = grey_background_ymax, 
                fill = grey_background_fill, 
                alpha = grey_background_alpha,
                color = grey_background_color) +
  labs(x = "Day",
       y = "Water addition (ml)",
       color = "") +
  scale_color_manual(values = c("#000000", "#737373", "#bdbdbd"))

```
</details>

<br>

Following the initial inspection, we proceed to analyse differences among ecosystems.

```{r}

# --- CONSTRUCT MODEL AND SHOW CONSTRASTS ---- #

full_model = lmer(get(response_variable) ~
                  ecosystem_size +
                    (1 | time_point),
                  data = ds_ecosystems_both_disturbances_filtered,
                  REML = FALSE)

# null_model = lmer(get(response_variable) ~
#                     (1 | time_point),
#                   data = ds_ecosystems_both_disturbances_filtered,
#                   REML = FALSE)
# 
# compute.model.stats(full_model,
#                     null_model,
#                     "mixed_model")

anova(full_model)

emmeans(full_model,
        specs = pairwise ~ ecosystem_size,
        adjust = "tukey",
        bias.adj = TRUE,
        lmer.df = "satterthwaite")
```

Finally, we perform model diagnostics. 

```{r}

# --- PERFORM MODEL DIAGNOSTICS --- #

# Random Effects Diagnostics: Plot the random effects to ensure they are normally distributed.

ranef_df <- ranef(full_model)$time_point %>% 
  as.data.frame() %>% 
  mutate(ID = rownames(.))

ggplot(ranef_df, 
       aes(x = ID, y = `(Intercept)`)) +
  geom_point() +
  labs(title = "Random Effects",
       x = "Time Point",
       y = "Random Effect (ml)") +
  theme_minimal()

# Check if the residuals are normally distributed

qqnorm(resid(full_model))
qqline(resid(full_model))

# Check if the residuals show any pattern according to their fitted value

ds_ecosystems_both_disturbances_filtered %>%
    mutate(predicted = fitted(full_model),
           residuals = resid(full_model)) %>%
    plot_ly(x = ~predicted,
            y = ~residuals,
            type = "scatter",
            mode = "markers",
            marker = list(size = 5, color = "#4C78A8"),
            text = paste(" ID: ", 
                         ds_ecosystems_both_disturbances_filtered$culture_ID, 
                         "<br>",
                         "Day: ", 
                         ds_ecosystems_both_disturbances_filtered$day, 
                         "<br>",
                         "Ecosystem Type: ", 
                         ds_ecosystems_both_disturbances_filtered$ecosystem_type),
            hoverinfo = "text") %>%
    plotly::layout(title = "Residuals vs. Fitted Values",
                   xaxis = list(title = "Fitted Values"),
                   yaxis = list(title = "Residuals"))

# Check the homoscedasticity of the residuals (scale-location plot)

ds_ecosystems_both_disturbances_filtered %>%
  mutate(predicted = fitted(full_model), 
         residuals = resid(full_model), 
         sqrt_abs_residuals = sqrt(abs(residuals))) %>%
  ggplot(aes(x = predicted, y = sqrt_abs_residuals)) +
  geom_point() +
  geom_smooth(method = "loess", color = "red") +
  labs(title = "Scale-Location Plot",
       x = "Fitted Values",
       y = "Square Root of Absolute Residuals") +
  theme_minimal()

# Check the normality of the residuals (histogram of residuals)

ds_ecosystems_both_disturbances_filtered %>%
  mutate(residuals = resid(full_model)) %>%
  ggplot(aes(x = residuals)) +
  geom_histogram(binwidth = 0.5, fill = "blue", color = "black", alpha = 0.7) +
  labs(title = "Histogram of Residuals",
       x = "Residuals",
       y = "Frequency") +
  theme_minimal()

# Identify influential data points (Leverage vs. Residuals:)

model_data <- augment(full_model)

ggplot(model_data, aes(x = .fitted, y = .resid)) +
  geom_point(aes(size = .cooksd)) +
  geom_smooth(method = "loess", color = "red") +
  labs(title = "Leverage vs. Residuals",
       x = "Fitted Values",
       y = "Residuals") +
  theme_minimal()

```


