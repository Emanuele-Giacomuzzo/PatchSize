---
title: "Untitled"
output: html_document
date: "2024-09-16"
editor_options: 
  chunk_output_type: console
---

We want to know whether the connection influenced this response variable. We first start from plotting how this response variable changed in connected and unconnected ecosystems throughout the experiment through its mean ± 95 confidence interval:

```{r}

# --- PLOT MEAN ± 95% CI --- #

"High disturbance"
plot.all.patches.points(data = ds_ecosystems_both_disturbances %>% filter(disturbance == "high"),
                        response_variable)

"Low disturbance"
plot.all.patches.points(data = ds_ecosystems_both_disturbances %>% filter(disturbance == "low"),
                        response_variable)
```

 <br>

Following the initial inspection, we proceed to analyse differences among ecosystems. To do so, we go through the following steps.

1. Add baseline level of this response variable (time point 1) to the cultures. 
2. Filter the data to isolate the relevant data for analysis. Specifically, we exclude data points where the response variable couldn't be computed, the time points preceding the initial disturbance and resource flow, and the last time point which we are not including because we do not know how much water evaporated previously from the water addition. 
3. Plot the data to make sure that what filtered in the right way.
4. Develop mixed effect models to examine how ecosystem type influenced this variable. 

```{r}

# --- ADD BASELINES --- #

baselines = ds_ecosystems_both_disturbances %>%
  filter(time_point == time_point_of_baselines) %>%
  select(culture_ID,
         all_of(response_variable)) %>%
  rename(baseline = all_of(response_variable))

data_for_analysis = ds_ecosystems_both_disturbances %>%
  left_join(baselines)
```

```{r}

# --- FILTER DATA AND CHANGE THE NAME OF LEVELS --- #

data_for_analysis = data_for_analysis %>%
  filter(time_point %in% time_points_model,
         !is.na(!!sym(response_variable)),
         !is.na(water_addition_ml)) %>%
  mutate(ecosystem_type = case_when(ecosystem_type == "Small unconnected" ~ "S",
                                    ecosystem_type == "Medium unconnected" ~ "M",
                                    ecosystem_type == "Large unconnected" ~ "L",
                                    ecosystem_type == "Small connected to small" ~ "S_S",
                                    ecosystem_type == "Small connected to large" ~ "S_L",
                                    ecosystem_type == "Medium connected to medium" ~ "M_M",
                                    ecosystem_type == "Large connected to large" ~ "L_L",
                                    ecosystem_type == "Large connected to small" ~ "L_S",
                                    TRUE ~ ecosystem_type))
  
```

```{r eval = FALSE}

# --- ADD EVAPORATION RATES RESIDUALS --- #

evaporation_model = lm(get(response_variable) ~
                    ecosystem_type * disturbance * day + 
                    baseline * day,
                  data = data_for_analysis) 

par(mfrow = c(2, 2))
plot(evaporation_model)

data_for_analysis = data_for_analysis %>%
  mutate(evaporation_residuals = residuals(evaporation_model))
```

```{r}

# --- PLOT MEAN ± 95% CI OF FILTERED DATA --- #

"High disturbance"
plot.all.patches.points(data = data_for_analysis %>% filter(disturbance == "high"),
                        response_variable)

"Low disturbance"
plot.all.patches.points(data = data_for_analysis %>% filter(disturbance == "low"),
                        response_variable)
```

```{r class.source = "fold-show"}

# --- CONSTRUCT MODEL --- #

full_model = lmer(get(response_variable) ~
                    ecosystem_type * disturbance * day + 
                    water_addition_ml * day +
                    baseline * day +
                    (day | culture_ID),
                  data = data_for_analysis,
                  REML = FALSE)
```

```{r}

# --- SHOW MODEL SUMMARY --- #

print(summary(full_model), digits = 1)
```

```{r}

# --- RUN ANOVA --- #

car::Anova(full_model, type = "III")
```


<details>
<summary>Model contrast coding</summary>
```{r}

# --- GET ECOSYSTEM TYPE CONSTRASTS --- #

emmeans_output = emmeans(full_model,
        specs = pairwise ~ ecosystem_type * disturbance,
        adjust = "tukey",
        bias.adj = TRUE,
        lmer.df = "satterthwaite") 


emmeans_output

high_L = c(1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0)
high_L_L = c(0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0)
high_L_S = c(0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0)
high_M = c(0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0)
high_M_M = c(0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0)
high_S = c(0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0)
high_S_L = c(0, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0)
high_S_S = c(0, 0, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0)
low_L = c(rep(0,8), 1, rep(0,7))
low_L_L = c(rep(0,9), 1, rep(0,6))
low_L_S = c(rep(0,10), 1, rep(0,5))
low_M = c(rep(0,11), 1, rep(0,4))
low_M_M = c(rep(0,12), 1, rep(0,3))
low_S = c(rep(0,13), 1, rep(0,2))
low_S_L = c(rep(0,14), 1, rep(0,1))
low_S_S = c(rep(0,15), 1)

n_of_digits = 3
contrasts = contrast(emmeans_output, 
                     method = list("high S_L - S" = high_S_L - high_S,
                                   "high S_L - S_S" = high_S_L - high_S_S,
                                   "high S_S - S" = high_S_S - high_S,
                                   "high M_M - M" = high_M_M - high_M,
                                   "high L_S - L" = high_L_S - high_L,
                                   "high L_S - L_L" = high_L_S - high_L_L,
                                   "high L_L - L" = high_L_L - high_L,
                                   "low S_L - S" = low_S_L - low_S,
                                   "low S_L - S_S" = low_S_L - low_S_S,
                                   "low S_S - S" = low_S_S - low_S,
                                   "low M_M - M" = low_M_M - low_M,
                                   "low L_S - L" = low_L_S - low_L,
                                   "low L_S - L_L" = low_L_S - low_L_L,
                                   "low L_L - L" = low_L_L - low_L)) %>%
  as.data.frame() %>%
  mutate(p.value = round(p.value, digits = n_of_digits),
         estimate = round(estimate, digits = n_of_digits),
         SE = round(SE, digits = n_of_digits),
         df = round(df, digits = n_of_digits),
         t.ratio = round(t.ratio, digits = n_of_digits),
         e = "",
         e = ifelse(p.value > 0.1, 
                           "",
                           e),
         e = ifelse(p.value < 0.05, 
                           "*",
                           e),
         e = ifelse(p.value < 0.01, 
                           "**",
                           e),
         e = ifelse(p.value < 0.001, 
                           "***",
                           e)) %>%
  rename(" " = e)
```
</details>

```{r}

# --- SHOW ECOSYSTEM TYPE CONSTRASTS --- #
contrasts
```

<br>

```{r}

# --- CONSTRUCT RESIDUALS VS FITTED VALUES PLOT --- #

res_vs_fit = data_for_analysis %>%
    mutate(predicted = fitted(full_model),
           residuals = resid(full_model)) %>%
    plot_ly(x = ~predicted,
            y = ~residuals,
            type = "scatter",
            mode = "markers",
            marker = list(size = 5, color = "#4C78A8"),
            text = paste(" ID: ", 
                         data_for_analysis$culture_ID, 
                         "<br>",
                         "Day: ", 
                         data_for_analysis$day, 
                         "<br>",
                         "Patch Type: ", 
                         data_for_analysis$ecosystem_type, 
                         "<br>",
                         "Biomass density: ", 
                         round(data_for_analysis$bioarea_mm2_per_ml, digits = 2), 
                         "<br>",
                         "Species richness: ", 
                         data_for_analysis$species_richness, 
                         "<br>"),
            hoverinfo = "text") %>%
    plotly::layout(title = "Residuals vs. Fitted Values",
                   xaxis = list(title = "Fitted Values"),
                   yaxis = list(title = "Residuals"))
```

```{r}

# --- PLOT RESIDUALS --- #

qqnorm(resid(full_model))
qqline(resid(full_model))
res_vs_fit
```