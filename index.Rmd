---
title: "PatchSizePilot"
author: "Emanuele Giacomuzzo"
date: "2022-08-03"
output: 
  html_document:
    code_folding: hide
bibliography: library.bib
html_document:
    toc: true
    toc_float: true
    code_folding: hide
    number_sections: true
    includes:
      after_body: tabset-dropdown.html
editor_options: 
  chunk_output_type: console
---

```{r renv-seetings, eval = FALSE, echo = FALSE}

#Manage package versions using the package "renv". 

#renv::repair()
#renv::restore()
#renv::snapshot()
```

```{r eval = FALSE, echo = FALSE}

#Import data sets (useful to avoid knitting/going through every child when working in rmd). 

library(here)
culture_info = read.csv(here("data", "PatchSizePilot_culture_info.csv"), header = TRUE)
ds_patches = readRDS(here("results", "ds_patches.RData"))
ds_patches_effect_size = readRDS(here("results", "ds_patches_effect_size.RData"))
ds_metaecosystems = readRDS(here("results", "ds_metaecosystems.RData"))
ds_individuals = readRDS(here("results", "ds_individuals.RData"))
ds_classes = readRDS(here("results", "ds_classes.RData"))
ds_classes_effect_size = readRDS(here("results", "ds_classes_effect_size.RData"))
ds_for_evaporation = readRDS(here("results", "ds_for_evaporation.RData"))
```

```{r set-up-environment, echo = FALSE}

#Set up the environment. 

start_time = Sys.time()

knitr::opts_chunk$set(message = FALSE, cache = FALSE)
recompute_analyses = FALSE #Lengthy analyses have been suppressed. Set recompute_analyses = TRUE to redo them. 
compute_n_display_datasets = TRUE
include_non_clean_scripts = FALSE
include_incomplete_time_series = FALSE
include_GIFS = TRUE
save_figures = TRUE
disturbance_input = "low"
displays_datasets = FALSE
```

```{r packages, echo = FALSE, results = FALSE, message = FALSE, cache = FALSE}

#Packages, conflicts, functinos

library("conflicted")
library("tidyverse")
library("grid")
library("gridExtra") 
library("lme4")
library("here")
library("MuMIn")
library("equatiomatic")
library("knitr")
library("optimx")
library("GenSA")
library("purrr")
library("kableExtra")
library("DT")
library("renv")
library("broom")
library("patchwork")
library("gganimate") 
library("gapminder")
library("gifski")
library("av")
library("transformr")
library("gifski")
library("GGally")
#library("strengejacke")
library("sjPlot")
library("sjstats")
library("partR2")
library("SciViews")
library("effsize")
library("boot")
library("vegan")
library("betapart")
library("caret")
library("leaps")
library("MASS")
library("glmulti")
library("metafor")
library("job")
library("scales")
library("Rmisc")
library("ggpubr")


conflict_prefer("load", "base")
conflict_prefer("here", "here")
conflict_prefer("filter", "dplyr")
conflict_prefer("select", "dplyr")
conflict_prefer("mutate", "dplyr")
conflict_prefer("arrange", "dplyr")
conflict_prefer("summarise", "dplyr")
conflict_prefer("rename", "dplyr")

source(here("r_files", "functions", "calculate.hedges_d.R"))
```

```{r various-parameters, echo = FALSE}

#Experiment parameters

nr_videos = c(12,1,1,1,1,1,2,2)
first_time_point = 0
last_time_point = 7
n_time_points = 8

first_perturbation_day = 5
resource_flow_days = c(5, 9, 13, 17, 21, 25)
sampling_days = c(0, 4, 8, 12, 16, 20, 24, 28)

system_nr_metaecosystems = 16:70
ecosystems_to_take_off = 60 #Culture ID = 60 because it was spilled (isolated small patch, high disturbance, system nr = 40)
metaecosystems_to_take_off = 40 #System 40 was the system of culture 60 that I spilled
protist_species = c("Ble", "Cep", "Col", "Eug", "Eup", "Lox", "Pau", "Pca", "Spi", "Spi_te", "Tet")
n_protist_species = length(protist_species)
n_metaecosystems = 55
n_cultures = 110
culture_info = read.csv(here("data", "PatchSizePilot_culture_info.csv"), header = TRUE)
eco_metaeco_types = unique(culture_info$eco_metaeco_type)

first_time_point_model = 2
last_time_point_model = 7

publication_width = 12
publication_height = 12
publication_unit = "cm"
presentation_size = 15

name_SS = "Small-Small connected"
name_MM = "Medium-Medium connected"
name_LL = "Large-Large connected"
name_SL = "Small-Large connected"
name_MM_from_isolated = "Medium-Medium isolated"
name_SL_from_isolated = "Small-Large isolated"

name_S_isolated = "Small isolated"
name_S_connected_to_S = "Small connected to small"
name_S_connected_to_L = "Small connected to large"
name_M_isolated = "Medium isolated"
name_M_connected_to_M = "Medium connected to medium"
name_L_isolated = "Large isolated"
name_L_connected_to_L = "Large connected to large"
name_L_connected_to_S = "Large connected to small"

name_S = "Small isolated"
name_M = "Medium isolated"
name_L = "Large isolated"

name_y_axis_bioarea_density = "Bioarea Density (µm²/ml)"
name_y_axis_total_bioarea = "Total Bioarea (µm²)"
name_y_axis_alpha_diversity = "Alpha Diversity (Shannon Index)"
name_y_axis_beta_diversity = "Beta Diversity (Bray-Curtis Index)"
name_y_axis_gamma_diversity = "Gamma Diversity (Shannon Index)"

name_y_axis_alpha_diversity_effect_size = "Alpha Diversity Effect Size (Hedge\'s d)"
name_y_axis_size_class_effect_size = 'Abundance Effect Size (Hedge\'s d)'

caption_resource_flow = "Vertical grey line: resource flow"

#Choose colours. 

colour_isolated = "#d9d9d9"
colour_different_size = "#4992c6"
colour_same_size = "#bc9960"
colour_small = "#ffeda0"
colour_medium = "#feb24c"
colour_large = "#f03b20"
colour_MM = "#dd7f42" #Colour of the Medium-Medium meta-ecosystem
colour_MM_from_isolated = "#ffeda0"
colour_SL = "#438cbe" #Colour of the Small-Large meta-ecosystem 
colour_SL_from_isolated = "#9ecae1"
```

#  {.tabset}

## Overview {.tabset .tabset-pills}

```{r overview-experiment, child = here("r_files", "overview.Rmd"), eval = compute_n_display_datasets}
```

## Data {.tabset .tabset-dropdown}

```{r child = here("r_files", "data_culture_info.Rmd"), eval = compute_n_display_datasets}
```

```{r child = here("r_files", "data_patches.Rmd"), eval = compute_n_display_datasets}
```

```{r child = here("r_files", "data_patches_effect_size.Rmd"), eval = compute_n_display_datasets}
```

```{r child = here("r_files", "data_metaecosystems.Rmd"), eval = compute_n_display_datasets}
```

```{r child = here("r_files", "data_individuals.Rmd"), eval = compute_n_display_datasets}
```

```{r child = here("r_files", "data_classes.Rmd"), eval = compute_n_display_datasets}
```

```{r child = here("r_files", "data_classes_effect_size.Rmd"), eval = compute_n_display_datasets}
```

## Meta-ecosystems {.tabset .tabset-dropdown}

### All

```{r child = here("r_files", "all_metaecos_biomass.Rmd")}
```

### Equally sized {.tabset .tabset-pills}

```{r child = here("r_files", "equally_sized_metaecos_biomass.Rmd")}
```

```{r child = here("r_files", "equally_sized_metaecos_beta_diversity.Rmd")}
```

```{r child = here("r_files", "equally_sized_metaecos_gamma_diversity.Rmd")}
```

### MM (and isolated) vs SL (and isolated) {.tabset .tabset-pills}

```{r child = here("r_files", "MM_all_vs_SL_all_biomass.Rmd")}
```

```{r child = here("r_files", "MM_all_vs_SL_all_beta_diversity.Rmd")}
```

```{r child = here("r_files", "MM_all_vs_SL_all_gamma_diversity.Rmd")}
```

### MM vs SL {.tabset .tabset-pills}

```{r child = here("r_files", "MM_vs_SL_biomass.Rmd")}
```

```{r child = here("r_files", "MM_vs_SL_alpha_diversity.Rmd")}
```

```{r child = here("r_files", "MM_vs_SL_beta_diversity.Rmd")}
```

```{r child = here("r_files", "MM_vs_SL_gamma_diversity.Rmd")}
```

```{r child = here("r_files", "MM_vs_SL_species_total.Rmd")}
```

### MM vs MM from isolated {.tabset .tabset-pills}

```{r child = here("r_files", "MM_vs_MM_from_isolated_biomass.Rmd")}
```

```{r child = here("r_files", "MM_vs_MM_from_isolated_beta_diversity.Rmd"), eval = include_non_clean_scripts}
```

```{r child = here("r_files", "MM_vs_MM_from_isolated_gamma_diversity.Rmd"), eval = include_non_clean_scripts}
```

```{r child = here("r_files", "MM_vs_MM_from_isolated_species_total.Rmd"), eval = include_non_clean_scripts}
```

### SL vs SL from isolated {.tabset .tabset-pills}

```{r child = here("r_files", "SL_vs_SL_from_isolated_biomass.Rmd")}
```

```{r child = here("r_files", "SL_vs_SL_from_isolated_beta_diversity.Rmd"), eval = include_non_clean_scripts}
```

```{r child = here("r_files", "SL_vs_SL_from_isolated_gamma_diversity.Rmd"), eval = include_non_clean_scripts}
```

```{r child = here("r_files", "SL_vs_SL_from_isolated_species_total.Rmd")}
```

### MM from isolated vs SL from isolated {.tabset .tabset-pills}

```{r child = here("r_files", "MM_from_isolated_vs_SL_from_isolated_biomass.Rmd")}
```

```{r child = here("r_files", "MM_from_isolated_vs_SL_from_isolated_beta_diversity.Rmd"), eval = include_non_clean_scripts}
```

```{r child = here("r_files", "MM_from_isolated_vs_SL_from_isolated_gamma_diversity.Rmd"), eval = include_non_clean_scripts}
```

```{r child = here("r_files", "MM_from_isolated_vs_SL_from_isolated_species_total.Rmd")}
```

### SL {.tabset .tabset-pills}

```{r child = here("r_files", "SL_biomass.Rmd")}
```

```{r child = here("r_files", "SL_alpha_diversity.Rmd")}
```

```{r child = here("r_files", "SL_species_densities.Rmd")}
```

## Patches {.tabset .tabset-dropdown}

### All {.tabset .tabset-pills}

```{r child = here("r_files", "all_patches_biomass.Rmd"), eval = include_non_clean_scripts}
```

### Isolated {.tabset .tabset-pills}

```{r child = here("r_files", "isolated_patches_biomass.Rmd")}
```

```{r child = here("r_files", "isolated_patches_alpha_diversity.Rmd")}
```

```{r child = here("r_files", "isolated_patches_species_densities.Rmd")}
```

```{r child = here("r_files", "isolated_patches_body_size_distribution.Rmd"), eval = include_non_clean_scripts}
```

### Small {.tabset .tabset-pills}

```{r child = here("r_files", "small_patches_biomass.Rmd")}
```

```{r child = here("r_files", "small_patches_alpha_diversity.Rmd")}
```

```{r child = here("r_files", "small_patches_species_densities.Rmd")}
```

```{r child = here("r_files", "small_patches_body_size_distribution.Rmd"), eval = include_non_clean_scripts}
```

```{r child = here("r_files", "small_patches_size_classes.Rmd"), eval = include_non_clean_scripts}
```

### Medium {.tabset .tabset-pills}

```{r child = here("r_files", "medium_patches_biomass.Rmd")}
```

```{r child = here("r_files", "medium_patches_alpha_diversity.Rmd")}
```

```{r child = here("r_files", "medium_patches_species_densities.Rmd"), eval = include_non_clean_scripts}
```

### Large {.tabset .tabset-pills}

```{r child = here("r_files", "large_patches_biomass.Rmd")}
```

```{r child = here("r_files", "large_patches_alpha_diversity.Rmd")}
```

```{r child = here("r_files", "large_patches_species_densities.Rmd"), eval = include_non_clean_scripts}
```

```{r child = here("r_files", "large_patches_body_size_distribution.Rmd"), eval = include_non_clean_scripts}
```

## Evaporation {.tabset .tabset-pills}

```{r child = here("r_files", "evaporation.Rmd")}
```

```{r child = here("r_files", "evaporation_tests.Rmd")}
```

## Video analysis script

```{r child = here("r_files", "video_analysis_script.Rmd"), class.source = "fold-show"}
```

## Paper

### Introduction

### Methods

Put here a methods figure.

### Results

#### Isolated systems: effect of patch size

In isolated ecosystems, the larger the patch, the more productive it was, as it also had higher biodiversity.

```{r}
ggarrange(
  p_isolated_biomass,
  p_isolated_alpha,
  ncol = 2,
  common.legend = TRUE,
  legend = "bottom"
)
```

Driven by the non-linear relationship between size and function (reference?), we see that the small-large isolated systems were more productive than medium-medium systems.

```{r}
ggarrange(
  p_all_metaecos_biomass,
  p_all_metaecos_beta,
  ncol = 2,
  common.legend = TRUE,
  legend = "bottom"
)
#take off connected systems
```

Furthermore, small-large systems had more beta-diversity than medium-medium systems, as their patches had different size. However, the gamma diversity of small-large and medium-medium systems stayed the same (I don't know how to interpret).

#### Connected systems: effects of resource flow

When patches were connected into small-large and medium-medium meta-ecosystems, we notice that: (i) medium patches stay the same, as there is no difference between the two medium patches (ii) small patches are increased in productivity by receiving high amount of detritus, which in turn increases biodiversity (iii) large patches are decreased in productivity by receiving low amount of detritus, which in turn decreases biodiversity

```{r}
ggarrange(
  p_connected_biomass_effect_size,
  p_connected_alpha_effect_size,
  ncol = 2,
  common.legend = TRUE,
  legend = "bottom"
)
```

As we can see here, the function in the larger was decreased more than the function in the smaller was increased. Therefore, the connection between the two patches was detrimental for meta-ecosystem function. This means that when we connect a small and a large patch, the large patch might receive so little detritus that it basically receiving nothing. The function of the small is increased, but when taken the whole meta-ecosystem that doesn't add up too much.

```{r}
ggarrange(
  p_all_metaecos_biomass,
  p_all_metaecos_beta,
  ncol = 2,
  common.legend = TRUE,
  legend = "bottom"
)
```

Furthermore, as small and large ecosystems have more and more similar productivity they becomes more and more similar, which decreases beta diversity.

I need to add here a figure with the body size distribution but first I need to run the code, as I haven't done it since I have the data on Spi.

#### Discussion

Patch size has an effect on meta-ecosystem function. However, this will depend upon the amount of resource flow happening between the two ecosystems. When there isn't any flow between the two ecosystems, small-large meta-ecosystems are the most productive (opposed to what @Benedetti-Cecchi2005 predicted). However, the more detritus is exchanged, the less the function of the meta-ecosystem, as it is mainly driven by the largest system. The small patch increases in function in

The higher species richness experienced by small patches is in line with the Subsidized Island Biogeography Hypothesis (@Anderson2001). I need to read @Menegotto2020.

## Running time

```{r running-time, echo = FALSE, eval = TRUE}
end_time = Sys.time()
end_time - start_time
```

## Bibliography
