---
title: "PatchSizePilot"
author: "Emanuele Giacomuzzo"
date: "`r Sys.time()`"
output: 
  html_document:
    code_folding: hide
bibliography: library.bib
html_document:
    toc: true
    toc_float: true
    code_folding: hide
    number_sections: true
    includes:
      after_body: tabset-dropdown.html
editor_options: 
  chunk_output_type: console
---

```{r renv-seetings, eval = FALSE, echo = FALSE}

#Manage package versions using the package "renv". 

#renv::repair()
#renv::restore()
#renv::snapshot()
```

```{r eval = FALSE, echo = FALSE}

#Import data sets (useful to avoid knitting/going through every child when working in rmd). 

library(here)
culture_info = read.csv(here("data", "PatchSizePilot_culture_info.csv"), header = TRUE)
ds_patches = readRDS(here("results", "ds_patches.RData"))
ds_patches_effect_size = readRDS(here("results", "ds_patches_effect_size.RData"))
ds_metaecosystems = readRDS(here("results", "ds_metaecosystems.RData"))
ds_individuals = readRDS(here("results", "ds_individuals.RData"))
ds_classes = readRDS(here("results", "ds_classes.RData"))
ds_classes_effect_size = readRDS(here("results", "ds_classes_effect_size.RData"))
ds_for_evaporation = readRDS(here("results", "ds_for_evaporation.RData"))
```

```{r set-up-environment, echo = FALSE}

#Set up the environment. 

start_time = Sys.time()

knitr::opts_chunk$set(message = FALSE, cache = FALSE)
recompute_analyses = FALSE #Lengthy analyses have been suppressed. Set recompute_analyses = TRUE to redo them. 
compute_n_display_datasets = TRUE
include_non_clean_scripts = FALSE
include_incomplete_time_series = FALSE
include_GIFS = FALSE
save_figures = TRUE
disturbance_input = "low"
displays_datasets = FALSE
```

```{r packages, echo = FALSE, results = FALSE, message = FALSE, cache = FALSE}

#Packages, conflicts, functions

library("conflicted")
library("tidyverse")
library("grid")
library("gridExtra") 
library("lme4")
library("here")
library("MuMIn")
library("equatiomatic")
library("knitr")
library("optimx")
library("GenSA")
library("purrr")
library("kableExtra")
library("DT")
library("renv")
library("broom")
library("patchwork")
library("gganimate") 
library("gapminder")
library("gifski")
library("av")
library("transformr")
library("gifski")
library("GGally")
#library("strengejacke")
library("sjPlot")
library("sjstats")
library("partR2")
library("SciViews")
library("effsize")
library("boot")
library("vegan")
library("betapart")
library("caret")
library("leaps")
library("MASS")
library("glmulti")
library("metafor")
library("job")
library("scales")
library("Rmisc")
library("ggpubr")
library("patchwork")
library("viridis") #To create small multiple plots
library("hrbrthemes") #To create small multiple plots
library("treemapify")

conflict_prefer("load", "base")
conflict_prefer("here", "here")
conflict_prefer("filter", "dplyr")
conflict_prefer("select", "dplyr")
conflict_prefer("mutate", "dplyr")
conflict_prefer("arrange", "dplyr")
conflict_prefer("summarise", "dplyr")
conflict_prefer("rename", "dplyr")

source(here("r_files", "functions", "calculate.hedges_d.R"))
```

```{r various-parameters, echo = FALSE}

#Experiment parameters

nr_videos = c(12,1,1,1,1,1,2,2)
first_time_point = 0
last_time_point = 7
n_time_points = 8

first_perturbation_day = 5
resource_flow_days = c(5, 9, 13, 17, 21, 25)
sampling_days = c(0, 4, 8, 12, 16, 20, 24, 28)

system_nr_metaecosystems = 16:70
ecosystems_to_take_off = 60 #Culture ID = 60 because it was spilled (isolated small patch, high disturbance, system nr = 40)
metaecosystems_to_take_off = 40 #System 40 was the system of culture 60 that I spilled
protist_species = c("Ble", "Cep", "Col", "Eug", "Eup", "Lox", "Pau", "Pca", "Spi", "Spi_te", "Tet")
n_protist_species = length(protist_species)
n_metaecosystems = 55
n_cultures = 110
culture_info = read.csv(here("data", "PatchSizePilot_culture_info.csv"), header = TRUE)
eco_metaeco_types = unique(culture_info$eco_metaeco_type)

first_time_point_model = 2
last_time_point_model = 7

publication_width = 12
publication_height = 12
publication_unit = "cm"
presentation_size = 15

dodging = 0.5 
boxplot_width = 0.9

name_SS = "Small-Small meta-ecosystem"
name_MM = "Medium-Medium meta-ecosystem"
name_LL = "Large-Large meta-ecosystem"
name_SL = "Small-Large meta-ecosystem"
name_MM_from_isolated = "Medium-Medium isolated"
name_SL_from_isolated = "Small-Large isolated"

name_S_isolated = "Small isolated"
name_S_connected_to_S = "Small connected to small"
name_S_connected_to_L = "Small connected to large"
name_M_isolated = "Medium isolated"
name_M_connected_to_M = "Medium connected to medium"
name_L_isolated = "Large isolated"
name_L_connected_to_L = "Large connected to large"
name_L_connected_to_S = "Large connected to small"

name_S = "Small isolated"
name_M = "Medium isolated"
name_L = "Large isolated"

name_y_axis_bioarea_density = "Bioarea Density (µm²/ml)"
name_y_axis_bioarea_density_effect_size = "Bioarea Density Effect Size"
name_y_axis_total_bioarea = "Tot Bioarea (µm²)"
name_y_axis_alpha_diversity = "α Diversity"
name_y_axis_alpha_diversity_effect_size = "α Diversity Effect Size"
name_y_axis_beta_diversity = "β Diversity"
name_y_axis_gamma_diversity = "γ Diversity"
name_y_axis_size_class = 'Abundance (Indiv/ml)'
name_y_axis_size_class_effect_size = "Abundance Effect Size"
name_y_axis_median_body_size = "Median body size (µm²)"
name_y_axis_median_body_size_effect_size = "Median Body Size Effect Size"

name_y_axis_dominance_Ble = "Ble Dominance %"
name_y_axis_dominance_Cep = "Cep Dominance %"
name_y_axis_dominance_Col = "Col Dominance %"
name_y_axis_dominance_Eug = "Eug Dominance %"
name_y_axis_dominance_Eup = "Eup Dominance %"
name_y_axis_dominance_Lox = "Lox Dominance %"
name_y_axis_dominance_Pau = "Pau Dominance %"
name_y_axis_dominance_Pca = "Pca Dominance %"
name_y_axis_dominance_Spi = "Spi Dominance %"
name_y_axis_dominance_Spi_te = "Spi te Dominance %"
name_y_axis_dominance_Tet = "Tet Dominance %"

name_time_axis = "Day"
name_x_axis_size_class = "Log size (μm2)"

caption_resource_flow = ""

size_legend = 12
size_x_axis = 16
size_y_axis = 13

#Choose colours. 

colour_isolated = "#d9d9d9"
colour_different_size = "#4992c6"
colour_same_size = "#bc9960"

colour_S = "#ffeda0"
colour_M = "#feb24c"
colour_L = "#f03b20"

colour_S_connected_to_L = "#deebf7"  
colour_L_connected_to_S = "#3182bd" 


colour_MM = "#238b45"
colour_MM_from_isolated = "#c7e9c0"
colour_SL = "#8856a7" 
colour_SL_from_isolated = "#dadaeb"
```

#  {.tabset}

## Overview {.tabset .tabset-pills}

```{r overview-experiment, child = here("r_files", "overview.Rmd"), eval = compute_n_display_datasets}
```

## Data {.tabset .tabset-dropdown}

```{r child = here("r_files", "data_culture_info.Rmd"), eval = compute_n_display_datasets}
```

```{r child = here("r_files", "data_patches.Rmd"), eval = compute_n_display_datasets}
```

```{r child = here("r_files", "data_patches_effect_size.Rmd"), eval = compute_n_display_datasets}
```

```{r child = here("r_files", "data_metaecosystems.Rmd"), eval = compute_n_display_datasets}
```

```{r child = here("r_files", "data_individuals.Rmd"), eval = compute_n_display_datasets}
```

```{r child = here("r_files", "data_median_body_size.Rmd"), eval = compute_n_display_datasets}
```

```{r child = here("r_files", "data_median_body_size_effect_size.Rmd"), eval = compute_n_display_datasets}
```

```{r child = here("r_files", "data_classes.Rmd"), eval = compute_n_display_datasets}
```

```{r child = here("r_files", "data_classes_effect_size.Rmd"), eval = compute_n_display_datasets}
```

## Meta-ecosystems {.tabset .tabset-dropdown}

### All

```{r child = here("r_files", "all_metaecos_biomass.Rmd")}
```

### Equally sized {.tabset .tabset-pills}

```{r child = here("r_files", "equally_sized_metaecos_biomass.Rmd")}
```

```{r child = here("r_files", "equally_sized_metaecos_beta_diversity.Rmd")}
```

```{r child = here("r_files", "equally_sized_metaecos_gamma_diversity.Rmd")}
```

### MM vs SL (meta-ecosystems and isolated) {.tabset .tabset-pills}

```{r child = here("r_files", "MM_all_vs_SL_all_biomass.Rmd")}
```

```{r child = here("r_files", "MM_all_vs_SL_all_alpha_diversity.Rmd")}
```

```{r child = here("r_files", "MM_all_vs_SL_all_beta_diversity.Rmd")}
```

```{r child = here("r_files", "MM_all_vs_SL_all_gamma_diversity.Rmd")}
```

## Patches {.tabset .tabset-dropdown}

### All {.tabset .tabset-pills}

```{r child = here("r_files", "all_patches_biomass.Rmd"), eval = include_non_clean_scripts}
```

### Isolated {.tabset .tabset-pills}

```{r child = here("r_files", "isolated_patches_biomass.Rmd")}
```

```{r child = here("r_files", "isolated_patches_alpha_diversity.Rmd")}
```

```{r child = here("r_files", "isolated_patches_species_densities.Rmd")}
```

```{r child = here("r_files", "isolated_patches_species_dominance.Rmd")}
```

```{r child = here("r_files", "isolated_patches_species_composition.Rmd")}
```

```{r child = here("r_files", "isolated_patches_body_size_distribution.Rmd")}
```

```{r child = here("r_files", "isolated_patches_size_classes.Rmd")}
```

### Small {.tabset .tabset-pills}

```{r child = here("r_files", "small_patches_biomass.Rmd")}
```

```{r child = here("r_files", "small_patches_alpha_diversity.Rmd")}
```

```{r child = here("r_files", "small_patches_species_densities.Rmd")}
```

```{r child = here("r_files", "small_patches_median_body_size.Rmd")}
```

```{r child = here("r_files", "small_patches_body_size_distribution.Rmd")}
```

```{r child = here("r_files", "small_patches_size_classes.Rmd")}
```

### Medium {.tabset .tabset-pills}

```{r child = here("r_files", "medium_patches_biomass.Rmd")}
```

```{r child = here("r_files", "medium_patches_alpha_diversity.Rmd")}
```

```{r child = here("r_files", "medium_patches_species_densities.Rmd"), eval = include_non_clean_scripts}
```

### Large {.tabset .tabset-pills}

```{r child = here("r_files", "large_patches_biomass.Rmd")}
```

```{r child = here("r_files", "large_patches_alpha_diversity.Rmd")}
```

```{r child = here("r_files", "large_patches_species_densities.Rmd")}
```

```{r child = here("r_files", "large_patches_body_size_distribution.Rmd")}
```

```{r child = here("r_files", "large_patches_median_body_size.Rmd")}
```

```{r child = here("r_files", "large_patches_size_classes.Rmd")}
```

### SL {.tabset .tabset-pills}

```{r child = here("r_files", "SL_biomass.Rmd")}
```

```{r child = here("r_files", "SL_alpha_diversity.Rmd")}
```

```{r child = here("r_files", "SL_species_densities.Rmd")}
```

```{r child = here("r_files", "SL_species_dominance.Rmd")}
```

```{r child = here("r_files", "SL_species_composition.Rmd")}
```

```{r child = here("r_files", "SL_size_classes.Rmd")}
```

## Evaporation {.tabset .tabset-dropdown}

```{r child = here("r_files", "evaporation.Rmd")}
```

```{r child = here("r_files", "evaporation_tests.Rmd")}
```

## Video analysis script

```{r child = here("r_files", "video_analysis_script.Rmd"), class.source = "fold-show"}
```

## Paper

```{r child = here("r_files", "paper.Rmd")}
```

## Running time

```{r running-time, echo = FALSE, eval = TRUE}
end_time = Sys.time()
end_time - start_time
```

## Other

In the .bib file get rid of:

-   book_section

-   computer_program

-   web_page

## Bibliography
