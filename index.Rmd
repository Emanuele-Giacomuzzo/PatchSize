---
html_document:
  toc: yes
  toc_float: yes
  code_folding: hide
  number_sections: yes
  includes:
    after_body: "tabset-dropdown.html"
author: "Emanuele Giacomuzzo"
date: "`r Sys.time()`"
output:
  html_document:
    code_folding: hide
    profiling: yes
bibliography: library.bib
title: "PhD Chapter 1 - PatchSize"
editor_options:
  chunk_output_type: console
---

```{r echo=FALSE, results = FALSE}
disturbance_global_input = "high"
```

```{r echo = FALSE}
print(paste("!!", disturbance_global_input, "!!", "(this document showcases only the analysis done for the", disturbance_global_input, "disturbance)"))
```

```{r echo=FALSE, results = FALSE, message = FALSE}
knitr::opts_chunk$set(message = FALSE,
                      cache = FALSE,
                      autodep = FALSE)

start_time = Sys.time()

library("here")

show_results = TRUE
recompute_lengthy_analyses = FALSE
recompute_datasets = TRUE
```

#  {.tabset}

```{r child = here("r_files", "packages.Rmd"), echo = FALSE}
```

```{r echo=FALSE, message=FALSE, results=FALSE}
functions_paths = list.files(here("..", "Functions"), pattern = ".R$", full.names = TRUE)
lapply(functions_paths, source)
```

```{r child = here("r_files", "parameters.Rmd"), echo = FALSE}
```

## Overview {.tabset .tabset-pills}

```{r overview-experiment, child = here("r_files", "overview.Rmd")}
```

## Data {.tabset .tabset-dropdown}

### Experimental cultures (`culture_info`)

This table contains information about the 110 cultures of the experiment.

```{r experimental-cultures}
culture_info = read.csv(here("data", "PatchSizePilot_culture_info.csv"), header = TRUE)
```

### Individuals (ds_individuals)

```{r child = here("r_files", "ds_individuals.Rmd"), eval = recompute_datasets}
```

### Patches (`ds_patches`) 

```{r child = here("r_files", "ds_patches.Rmd"), eval = recompute_datasets}
```

### Patch effect sizes (`ds_patches_effect_size`)

```{r child = here("r_files", "ds_patches_effect_size.Rmd"), eval = recompute_datasets}
```

### Meta-ecosystems (`ds_metaecosystems`)

```{r child = here("r_files", "combinations_patches.Rmd")}
```

```{r child = here("r_files", "ds_metaecosystems.Rmd"), eval = recompute_datasets}
```

### Size classes (`ds_classes`)

```{r child = here("r_files", "ds_classes.Rmd"), eval = recompute_datasets}
```

### Size classes effect size (`ds_classes_effect_size`)

```{r child = here("r_files", "ds_classes_effect_size.Rmd"), eval = recompute_datasets}
```

```{r}
files <- list.files(path = here("results", "ds"))
for (i in 1:length(files)) {
  load(here("results", "ds", files[i]))
}
```

### Filter according to disturbance

Here I'm filtering patches to have only the ones with disturbance `r disturbance_global_input`.

```{r}
ds_individuals = ds_individuals %>%
  filter(disturbance == disturbance_global_input)
ds_patches = ds_patches %>%
  filter(disturbance == disturbance_global_input)
ds_patches_effect_size = ds_patches_effect_size %>%
  filter(disturbance == disturbance_global_input)
ds_metaecosystems = ds_metaecosystems %>%
  filter(disturbance == disturbance_global_input)
ds_classes = ds_classes %>%
  filter(disturbance == disturbance_global_input)
ds_classes_effect_size = ds_classes_effect_size %>%
  filter(disturbance == disturbance_global_input)
```

## Meta-ecosystems {.tabset .tabset-pills}

### All {.tabset .tabset-pills}

```{r}
metaecosystem_type_input = c("Small-Small meta-ecosystem",
                             "Medium-Medium meta-ecosystem",
                             "Medium-Medium isolated",
                             "Large-Large meta-ecosystem",
                             "Small-Large meta-ecosystem",
                             "Small-Large isolated")
```

#### Biomass {.tabset .tabset-dropdown}

```{r child = here("r_files", "all_metaecos_biomass.Rmd"), eval = show_results}
```

#### Shannon {.tabset .tabset-dropdown}

```{r child = here("r_files", "all_metaecos_alpha_diversity.Rmd"), eval = show_results}
```

#### Beta diversity {.tabset .tabset-dropdown}

```{r child = here("r_files", "all_metaecos_beta_diversity.Rmd"), eval = show_results}
```

#### Gamma diversity {.tabset .tabset-dropdown}

```{r child = here("r_files", "all_metaecos_gamma_diversity.Rmd"), eval = show_results}
```

### MM vs SL (meta-ecosystems and isolated) {.tabset .tabset-pills}

```{r}
metaecosystem_type_input = c(
  "Medium-Medium meta-ecosystem",
  "Medium-Medium isolated",
  "Small-Large meta-ecosystem",
  "Small-Large isolated"
)
```

#### Biomass {.tabset .tabset-dropdown}

```{r child = here("r_files", "MM_all_vs_SL_all_biomass.Rmd"), eval = show_results}
```

#### Shannon {.tabset .tabset-dropdown}

```{r child = here("r_files", "MM_all_vs_SL_all_alpha_diversity.Rmd"), eval = show_results}
```

#### Beta diversity {.tabset .tabset-dropdown}

```{r child = here("r_files", "MM_all_vs_SL_all_beta_diversity.Rmd"), eval = show_results}
```

#### Gamma diversity {.tabset .tabset-dropdown}

```{r child = here("r_files", "MM_all_vs_SL_all_gamma_diversity.Rmd"), eval = show_results}
```

## Patches {.tabset .tabset-pills}

### All {.tabset .tabset-dropdown}

```{r}
patch_type_input = c(
      "Small isolated",
      "Medium isolated",
      "Large isolated",
      "Small connected to large",
      "Large connected to small"
    )
```

#### BEF

```{r child = here("r_files", "all_patches_BEF.Rmd"), eval = FALSE}
```

### Isolated {.tabset .tabset-pills}

```{r}
patch_type_input = c("Small isolated",
                     "Medium isolated",
                     "Large isolated")
```

#### Biomass {.tabset .tabset-dropdown}

```{r child = here("r_files", "isolated_patches_biomass.Rmd"), eval = show_results}
```

#### Shannon {.tabset .tabset-dropdown}

```{r child = here("r_files", "isolated_patches_alpha_diversity.Rmd"), eval = show_results}
```

#### Evenness {.tabset .tabset-dropdown}

```{r child = here("r_files", "isolated_patches_evenness.Rmd"), eval = show_results}
```

#### Species densities {.tabset .tabset-dropdown}

```{r child = here("r_files", "isolated_patches_species_densities.Rmd"), eval = show_results}
```

#### Species dominance {.tabset .tabset-dropdown}

```{r child = here("r_files", "isolated_patches_species_dominance.Rmd"), eval = show_results}
```

#### Species composition {.tabset .tabset-dropdown}

```{r child = here("r_files", "isolated_patches_species_composition.Rmd"), eval = show_results}
```

#### Size classes densities {.tabset .tabset-dropdown}

```{r child = here("r_files", "isolated_patches_size_classes.Rmd"), eval = show_results}
```

#### Body size distribution {.tabset .tabset-dropdown}

```{r child = here("r_files", "isolated_patches_body_size_distribution.Rmd"), eval = FALSE}
```

#### Median body size {.tabset .tabset-dropdown}

```{r child = here("r_files", "isolated_patches_median_body_size.Rmd"), eval = show_results}
```

### Connected 

```{r}
patch_type_input = c("Small connected to large",
                     "Medium connected to medium",
                     "Large connected to small")
```

#### Biomass

```{r child = here("r_files", "connected_patches_biomass.Rmd"), eval = show_results}
```

### Small {.tabset .tabset-pills}

```{r}
patch_type_input = c("Small isolated",
                     "Small connected to small",
                     "Small connected to large")
```

#### Biomass {.tabset .tabset-dropdown}

```{r child = here("r_files", "small_patches_biomass.Rmd"), eval = show_results}
```

#### Shannon {.tabset .tabset-dropdown}

```{r child = here("r_files", "small_patches_alpha_diversity.Rmd"), eval = show_results}
```

#### Species richness {.tabset .tabset-dropdown}

```{r child = here("r_files", "small_patches_species_richness.Rmd"), eval = show_results}
```

#### Evenness {.tabset .tabset-dropdown}

```{r child = here("r_files", "small_patches_evenness.Rmd"), eval = show_results}
```

#### Species densities {.tabset .tabset-dropdown}

```{r child = here("r_files", "small_patches_species_densities.Rmd"), eval = show_results}
```

#### Species dominance {.tabset .tabset-dropdown}

```{r child = here("r_files", "small_patches_species_dominance.Rmd"), eval = show_results}
```

#### Species composition {.tabset .tabset-dropdown}

```{r child = here("r_files", "small_patches_species_composition.Rmd"), eval = show_results}
```
 
#### Treatment divergence {.tabset .tabset-dropdown}

```{r child = here("r_files", "small_patches_treatment_divergence.Rmd"), eval = show_results}
```

#### Temporal divergence {.tabset .tabset-dropdown}

```{r child = here("r_files", "small_patches_temporal_divergence.Rmd"), eval = show_results}
```

#### Size classes densities {.tabset .tabset-dropdown}

```{r child = here("r_files", "small_patches_size_classes.Rmd"), eval = show_results}
```

#### Body size distribution {.tabset .tabset-dropdown}

```{r child = here("r_files", "small_patches_body_size_distribution.Rmd"), eval = FALSE}
```

#### Median body size {.tabset .tabset-dropdown}

```{r child = here("r_files", "small_patches_median_body_size.Rmd"), eval = show_results}
```

### Medium {.tabset .tabset-pills}

```{r}
patch_type_input = c("Medium isolated",
                     "Medium connected to medium")
```

#### Biomass {.tabset .tabset-dropdown}

```{r child = here("r_files", "medium_patches_biomass.Rmd"), eval = show_results}
```

### Large {.tabset .tabset-pills}

```{r}
patch_type_input = c("Large isolated",
                     "Large connected to large",
                     "Large connected to small")
```

#### Biomass {.tabset .tabset-dropdown}

```{r child = here("r_files", "large_patches_biomass.Rmd"), eval = show_results}
```

#### Shannon {.tabset .tabset-dropdown}

```{r child = here("r_files", "large_patches_alpha_diversity.Rmd"), eval = show_results}
```

#### Species richness {.tabset .tabset-dropdown}

```{r child = here("r_files", "large_patches_species_richness.Rmd"), eval = show_results}
```

#### Evenness {.tabset .tabset-dropdown}

```{r child = here("r_files", "large_patches_evenness.Rmd"), eval = show_results}
```

#### Species densities {.tabset .tabset-dropdown}

```{r child = here("r_files", "large_patches_species_densities.Rmd"), eval = show_results}
```

#### Species dominance {.tabset .tabset-dropdown}

```{r child = here("r_files", "large_patches_species_dominance.Rmd"), eval = show_results}
```

#### Species composition {.tabset .tabset-dropdown}

```{r child = here("r_files", "large_patches_species_composition.Rmd"), eval = show_results}
```
 
#### Treatment divergence {.tabset .tabset-dropdown}

```{r child = here("r_files", "large_patches_treatment_divergence.Rmd"), eval = show_results}
```

#### Temporal divergence {.tabset .tabset-dropdown}

```{r child = here("r_files", "large_patches_temporal_divergence.Rmd"), eval = show_results}
```

#### Size classes densities {.tabset .tabset-dropdown}

```{r child = here("r_files", "large_patches_size_classes.Rmd"), eval = show_results}
```

#### Body size distribution {.tabset .tabset-dropdown}

```{r child = here("r_files", "large_patches_body_size_distribution.Rmd"), eval = FALSE}
```

#### Median body size {.tabset .tabset-dropdown}

```{r child = here("r_files", "large_patches_median_body_size.Rmd"), eval = show_results}
```

### SL {.tabset .tabset-pills}

```{r}
patch_type_input = c("Small connected to large",
                     "Small connected to small",
                     "Large connected to small",
                     "Large connected to large")
```

#### Biomass {.tabset .tabset-pills}

```{r child = here("r_files", "SL_biomass.Rmd"), eval = show_results}
```

#### Shannon {.tabset .tabset-pills}

```{r child = here("r_files", "SL_alpha_diversity.Rmd"), eval = show_results}
```

#### Species richness {.tabset .tabset-dropdown}

```{r child = here("r_files", "SL_species_richness.Rmd"), eval = show_results}
```

#### Evenness {.tabset .tabset-dropdown}

```{r child = here("r_files", "SL_evenness.Rmd"), eval = show_results}
```

#### Species densities {.tabset .tabset-dropdown}

```{r child = here("r_files", "SL_species_densities.Rmd"), eval = show_results}
```

#### Species dominance {.tabset .tabset-dropdown}

```{r child = here("r_files", "SL_species_dominance.Rmd"), eval = show_results}
```

#### Temporal divergence {.tabset .tabset-dropdown}

```{r child = here("r_files", "SL_temporal_divergence.Rmd"), eval = show_results}
```

#### Size classes densities {.tabset .tabset-dropdown}

```{r child = here("r_files", "SL_size_classes.Rmd"), eval = show_results}
```

#### Median body size {.tabset .tabset-dropdown}

```{r child = here("r_files", "SL_median_body_size.Rmd"), eval = show_results}
```

## Productivity drivers {.tabset .tabset-pills}

```{r child = here("r_files", "relationship_productivity_richness.Rmd"), eval = show_results}
```

```{r child = here("r_files", "relationship_productivity_shannon.Rmd"), eval = show_results}
```

```{r child = here("r_files", "relationship_productivity_evenness.Rmd"), eval = show_results}
```

```{r child = here("r_files", "relationship_productivity_dominance.Rmd"), eval = show_results}
```

## Evaporation {.tabset .tabset-pills}

```{r child = here("r_files", "model_evaporation.Rmd"), eval = FALSE}
```

```{r child = here("r_files", "test_evaporation.Rmd"), eval = show_results}
```

## Analysis scripts {.tabset .tabset-pills}

### Video analysis

```{r child = here("r_files", "BEMOVI_script_video_analysis.Rmd"), class.source = "fold-show"}
```

### Species identification 

```{r child = here("r_files", "BEMOVI_script_species_id.Rmd"), class.source = "fold-show"}
```

## Running time

```{r running-time, echo = FALSE, eval = TRUE}
end_time = Sys.time()
round(end_time - start_time, digits = 1)
```

## Other

In the .bib file get rid of:

-   book_section

-   computer_program

-   web_page

Check that disturbance_global_input is what you set:

```{r}
print(paste0("Disturbance = ", disturbance_global_input))
```

If you want to change a certain part of the code:

```{batch eval = FALSE}
cd /Users/ema/Documents/GitHub/PatchSizePilot/r_files
sed -i '' 's/total_metaecosystem_bioarea/total_metaecosystem_bioarea_mm2/g' *.Rmd
cd /Users/ema/Documents/GitHub/Functions 
sed -i '' 's/old/new/g' *.R

critical_rows=ds_patches %>% filter(disturbance == "high", patch_size == "Small", time_point == 7)
critical_rows_ES=ds_effect_size %>% filter(disturbance == "high", patch_size == "Small", time_point == 7)

#Why is median_body_area_µm2_d of small connected to large NaN at time_point == 7, disturbance == "high"?

treatment_row$beta_diversity_from_isolated_mean
control_row$beta_diversity_from_isolated_mean
```

```{bash eval = FALSE}
# Navigate to the directory
cd /Users/ema/Documents/GitHub/PatchSizePilot

# Define the value of disturbance_level
disturbance_level="low"

# Rename the index.html file to index_disturbance_level.html
mv index.html index_${disturbance_level}.html
```

The only type of patch where all cultures crashed was small connected to small at high disturbance.

## Paper outline

```{r child = here("r_files", "paper_outline.Rmd"), eval = show_results}
```

## Paper

```{r child = here("r_files", "paper.Rmd"), eval = show_results}
```

```{r echo=FALSE, message=FALSE}
save.image(file = "environment_at_the_end_of_knitting.RData")
```

```{r echo = FALSE}
beepr::beep("fanfare")
```